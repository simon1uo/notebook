(window.webpackJsonp=window.webpackJsonp||[]).push([[111],{441:function(t,s,a){"use strict";a.r(s);var n=a(3),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("浏览器中 JavaScript 的执行流程和 Node.js 中的流程都是基于 "),s("strong",[t._v("事件循环")]),t._v(" 的。理解事件循环的工作方式对于代码优化很重要，有时对于正确的架构也很重要。")]),t._v(" "),s("h2",{attrs:{id:"事件循环"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事件循环"}},[t._v("#")]),t._v(" 事件循环")]),t._v(" "),s("p",[t._v("是一个在 JavaScript 引擎 "),s("strong",[t._v("等待任务")]),t._v("，"),s("strong",[t._v("执行任务")]),t._v(" 和 "),s("strong",[t._v("进入休眠状态等待更多任务")]),t._v(" 这几个状态之间转换的无限循环。")]),t._v(" "),s("p",[t._v("引擎的一般算法：")]),t._v(" "),s("ol",[s("li",[t._v("当有任务时："),s("strong",[t._v("从最先进入的任务开始执行")]),t._v("。")]),t._v(" "),s("li",[t._v("休眠直到出现任务，然后转到第 1 步。")])]),t._v(" "),s("p",[t._v("设置任务 —— 引擎处理它们 —— 然后等待更多任务（即休眠，几乎不消耗 CPU 资源）。")]),t._v(" "),s("blockquote",[s("p",[t._v("一般浏览网页就是这种形式，JavaScript 引擎大多数时候不执行任何操作，它仅在脚本 / 处理程序 / 事件激活时执行。")]),t._v(" "),s("p",[t._v("浏览器任务一般有：")]),t._v(" "),s("ul",[s("li",[t._v("当外部脚本  "),s("code",[t._v('<script src="...">')]),t._v("  加载完成时，任务就是执行它；")]),t._v(" "),s("li",[t._v("当用户移动鼠标时，任务就是派生出  "),s("code",[t._v("mousemove")]),t._v("  事件和执行处理程序；")]),t._v(" "),s("li",[t._v("当安排的（scheduled） "),s("code",[t._v("setTimeout")]),t._v("  时间到达时，任务就是执行其回调等。")])])]),t._v(" "),s("p",[t._v("一个任务到来时，引擎可能正处于繁忙状态，那么这个任务就会被排入队列。多个任务组成了一个队列，为 "),s("strong",[t._v("宏任务队列")]),t._v(" （V8 引擎）。")]),t._v(" "),s("p",[t._v("🌰 例子：")]),t._v(" "),s("p",[t._v("当引擎正在忙于执行一段  "),s("code",[t._v("script")]),t._v("  时，用户可能会移动鼠标而产生  "),s("code",[t._v("mousemove")]),t._v("  事件， "),s("code",[t._v("setTimeout")]),t._v("  或许也刚好到期，以及其他任务，这些任务组成了一个队列。")]),t._v(" "),s("p",[t._v("这个队列的任务基于 「先进先出」 的原则执行。当浏览器引擎执行完  "),s("code",[t._v("script")]),t._v("  后，它会处理  "),s("code",[t._v("mousemove")]),t._v("  事件，然后处理  "),s("code",[t._v("setTimeout")]),t._v("  处理程序，依此类推。")]),t._v(" "),s("blockquote",[s("ul",[s("li",[t._v("引擎执行任务时永远不会进行渲染（render）。如果任务执行需要很长一段时间也没关系。仅在任务完成后才会绘制对 DOM 的更改。")]),t._v(" "),s("li",[t._v("如果一项任务执行花费的时间过长，浏览器将无法执行其他任务，例如处理用户事件。因此，在一定时间后，浏览器会抛出一个如 “页面未响应” 之类的警报，建议终止这个任务。这种情况常发生在有大量复杂的计算或导致死循环的程序错误时。")])])]),t._v(" "),s("h2",{attrs:{id:"宏任务-微任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#宏任务-微任务"}},[t._v("#")]),t._v(" 宏任务 / 微任务")]),t._v(" "),s("p",[t._v("微任务仅来自于代码。它们通常是由 promise 创建的：对  "),s("code",[t._v(".then/catch/finally")]),t._v("  处理程序的执行会成为微任务。微任务也被用于  "),s("code",[t._v("await")]),t._v("  的「幕后」，因为它是 promise 处理的另一种形式。")]),t._v(" "),s("p",[t._v("特殊的函数  "),s("code",[t._v("queueMicrotask(func)")]),t._v(" ，它对  "),s("code",[t._v("func")]),t._v("  进行排队，以在微任务队列中执行。")]),t._v(" "),s("p",[t._v("🌰 例子：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"timeout"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nPromise"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promise"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"code"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("blockquote",[s("p",[t._v("按照上面的代码，执行顺序应该为：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("code")]),t._v("  显示；")]),t._v(" "),s("li",[s("code",[t._v("promise")]),t._v("  第二个出现。因为  "),s("code",[t._v("then")]),t._v("  会通过微任务队列，并在当前代码之后执行。")]),t._v(" "),s("li",[s("code",[t._v("timeout")]),t._v("  最后显示，因为它是一个宏任务。")])])]),t._v(" "),s("p",[t._v("按照更加详细的事件循环：（首先是脚本，然后是微任务，渲染等）")]),t._v(" "),s("img",{staticStyle:{zoom:"33%"},attrs:{src:"https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/D4kLn9.png",alt:"image-20220528140052957"}}),t._v(" "),s("ul",[s("li",[t._v("微任务 会在执行任何其他事件处理，或渲染，或执行任何其他宏任务 "),s("strong",[t._v("之前完成")]),t._v("。（这确保了微任务之间的应用程序环境基本相同）")]),t._v(" "),s("li",[t._v("如果想异步执行（在当前代码之后）一个函数，但是要在更改被渲染或新事件被处理之前执行，那么可以使用  "),s("code",[t._v("queueMicrotask")]),t._v("  来对其进行安排。")])]),t._v(" "),s("p",[t._v("🌰 例子 / 计数进度条的实现，使用了  "),s("code",[t._v("queueMicrotask")]),t._v("  安排：")]),t._v(" "),s("div",{staticClass:"language-html line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("progress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token script"}},[s("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("count")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 做繁重的任务的一部分 (*)")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      i"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      progress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("innerHTML "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1e3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1e6")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("queueMicrotask")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("count")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br")])]),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("详细的 事件循环 算法：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("从 "),s("strong",[t._v("宏任务")]),t._v(" 队列中出队并执行最早的任务。")])]),t._v(" "),s("li",[s("p",[t._v("执行所有的微任务：")]),t._v(" "),s("ul",[s("li",[t._v("当微任务队列非空时：\n"),s("ul",[s("li",[t._v("出队并执行最早的微任务。")])])])])]),t._v(" "),s("li",[s("p",[t._v("如果有变更，则将变更渲染出来。")])]),t._v(" "),s("li",[s("p",[t._v("如果宏任务队列为空，则休眠直到出现宏任务。")])]),t._v(" "),s("li",[s("p",[t._v("转到步骤 1。")])])])]),t._v(" "),s("li",[s("p",[t._v("安排新的宏任务：")]),t._v(" "),s("ul",[s("li",[t._v("使用零延迟的  "),s("code",[t._v("setTimeout(f)")]),t._v(" 。")])]),t._v(" "),s("blockquote",[s("p",[t._v("它可被用于将繁重的计算任务拆分成多个部分，以使浏览器能够对用户事件作出反应，并在任务的各部分之间显示任务进度。")]),t._v(" "),s("p",[t._v("此外，也被用于在事件处理程序中，将一个行为安排在事件被完全处理（冒泡完成）后。")])])]),t._v(" "),s("li",[s("p",[t._v("安排新的为任务：")]),t._v(" "),s("ul",[s("li",[t._v("使用  "),s("code",[t._v("queueMicrotask(f)")]),t._v(" ；")]),t._v(" "),s("li",[t._v("promise 处理程序也会通过微任务队列。")])]),t._v(" "),s("blockquote",[s("p",[t._v("在微任务之间没有 UI 或网络事件的处理：它们一个立即接一个地执行。所以，可以使用  "),s("code",[t._v("queueMicrotask")]),t._v("  来在保持环境状态一致的情况下，异步地执行一个函数。")])])])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),s("p",[t._v("Web Workers 的使用，当有 不应该阻塞事件循环的耗时长的繁重计算任务，这时另一个并行线程运行代码的方式：")]),t._v(" "),s("ul",[s("li",[t._v("Web Workers 可以与主线程交换消息，但是它们具有自己的变量和事件循环。")]),t._v(" "),s("li",[t._v("Web Workers 没有访问 DOM 的权限，因此，它们对于同时使用多个 CPU 内核的计算非常有用。")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);