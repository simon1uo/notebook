(window.webpackJsonp=window.webpackJsonp||[]).push([[268],{737:function(s,e,t){"use strict";t.r(e);var a=t(29),v=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("blockquote",[t("p",[s._v("至此，所有的 axios 重构的代码编写和单元测试都完成了。这已经是一个几乎成熟可供使用的 TypeScript 库了。")]),s._v(" "),t("p",[s._v("在目前，并不是所有人都会使用 TypeScript 开发，仍然有大量的 JavaScript 用户，它们是不能直接引用 TypeScript 代码的，因此我们需要先对源码做编译和打包，然后再发布。")]),s._v(" "),t("p",[s._v("如果要将这个包发布到 npm 源，需要注册账号，并且在终端使用  "),t("code",[s._v("npm login")]),s._v("  登录。")])]),s._v(" "),t("h2",{attrs:{id:"编译与打包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编译与打包"}},[s._v("#")]),s._v(" 编译与打包")]),s._v(" "),t("p",[s._v("利用 "),t("a",{attrs:{href:"https://github.com/rollup/rollup",target:"_blank",rel:"noopener noreferrer"}},[s._v("rollup"),t("OutboundLink")],1),s._v(" 来打包")]),s._v(" "),t("blockquote",[t("p",[s._v("它是一个非常著名的编译打包工具，Vue.js 也是利用 rollup 编译打包的。相比 webpack，它非常适合去编译和打包一些 JS 库。")])]),s._v(" "),t("blockquote",[t("p",[s._v("由于使用  "),t("code",[s._v("typescript-library-starter")]),s._v("  初始化我们的项目，我们已经拥有了 "),t("strong",[s._v("rollup")]),s._v(" 打包的相关配置和相关插件的安装。")])]),s._v(" "),t("p",[s._v("对生成的  "),t("code",[s._v("rollup.config.ts")]),s._v("  做小小的修改：")]),s._v(" "),t("ul",[t("li",[s._v("将  "),t("code",[s._v("libraryName")]),s._v("  修改为项目名称；")]),s._v(" "),t("li",[t("code",[s._v("input")]),s._v("  修改为  "),t("code",[s._v("src/index.ts")]),s._v(" 。")])]),s._v(" "),t("blockquote",[t("ul",[t("li",[t("code",[s._v("input")]),s._v(" ： 表示打包入口文件。")]),s._v(" "),t("li",[t("code",[s._v("output")]),s._v(" ：表示输出的目标文件，它是一个对象数组，可以指定输出的格式，比如  "),t("code",[s._v("umd")]),s._v("  格式、 "),t("code",[s._v("es")]),s._v("  模式等。")]),s._v(" "),t("li",[t("code",[s._v("external")]),s._v(" ：外部依赖，可以不被打包进去。")]),s._v(" "),t("li",[t("code",[s._v("watch")]),s._v(" ：监听文件的变化，重新编译，只有在编译的时候开启  "),t("code",[s._v("--watch")]),s._v("  才生效。")]),s._v(" "),t("li",[t("code",[s._v("plugins")]),s._v(" ：")]),s._v(" "),t("li",[s._v("编译过程中使用的插件，其中  "),t("code",[s._v("rollup-plugin-typescript2")]),s._v("  就是用来编译 TypeScript 文件， "),t("code",[s._v("useTsconfigDeclarationDir")]),s._v("  表示使用  "),t("code",[s._v("tsconfig.json")]),s._v("  文件中定义的  "),t("code",[s._v("declarationDir")]),s._v(" 。更多插件可以查阅文档。")])])]),s._v(" "),t("p",[s._v("修改  "),t("code",[s._v("package.json")]),s._v(" ，确保一下：")]),s._v(" "),t("div",{staticClass:"language-typescript line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-typescript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"main"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dist/axios-typescript.umd.js"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"module"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dist/axios-typescript.es5.js"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string-property property"}},[s._v('"typings"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dist/types/axios-typescript.d.ts"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("为项目名称。")]),s._v(" "),t("p",[s._v("然后在在控制台执行  "),t("code",[s._v("npm run build")]),s._v(" ，会编译输出  "),t("code",[s._v("dist")]),s._v("  目录，其中 ：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("lib")]),s._v("  目录是单个  "),t("code",[s._v(".ts")]),s._v("  文件编译后的  "),t("code",[s._v(".js")]),s._v("  文件。")]),s._v(" "),t("li",[t("code",[s._v("types")]),s._v("  目录是所有  "),t("code",[s._v(".ts")]),s._v("  文件编译后生产的  "),t("code",[s._v(".d.ts")]),s._v("  声明文件。")]),s._v(" "),t("li",[t("code",[s._v("axios.es5.js")]),s._v("  是编译后生成的 es 模式的入口文件，用在  "),t("code",[s._v("package.json")]),s._v("  的  "),t("code",[s._v("module")]),s._v("  字段， "),t("code",[s._v("axios.umd.js")]),s._v("  文件是编译后生成的  "),t("code",[s._v("umd")]),s._v("  模式的入口文件，用在  "),t("code",[s._v("package.json")]),s._v("  的  "),t("code",[s._v("main")]),s._v("  字段。")])]),s._v(" "),t("h2",{attrs:{id:"自定义部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自定义部署"}},[s._v("#")]),s._v(" 自定义部署")]),s._v(" "),t("blockquote",[t("p",[s._v("由于  "),t("code",[s._v("semantic-release")]),s._v("  插件过于黑盒也略微重量，自己编写自动化部署脚本更加灵活意义更大。")])]),s._v(" "),t("p",[s._v("首先修改  "),t("code",[s._v("package.json")]),s._v(" ：")]),s._v(" "),t("blockquote",[t("p",[s._v("需要为这个包命名一个 npm 中没有被占用的名字。可以使用  "),t("code",[s._v("npm view")]),s._v("  搜索包名是否存在。")])]),s._v(" "),t("p",[s._v("如果要关联这个发布的包对应的仓库，可以配置  "),t("code",[s._v("repository")]),s._v("  字段。")]),s._v(" "),t("p",[s._v("添加两个  "),t("code",[s._v("npm scripts")]),s._v(" ：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"prepub"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"npm run test:prod && npm run build"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"pub"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh release.sh"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("blockquote",[t("ul",[t("li",[s._v("当运行  "),t("code",[s._v("npm run pub")]),s._v("  的时候，会优先执行  "),t("code",[s._v("prepub")]),s._v("  脚本，在  "),t("code",[s._v("prepub")]),s._v("  中运行了  "),t("code",[s._v("test:prod")]),s._v("  和  "),t("code",[s._v("build")]),s._v("  2 个脚本。 "),t("code",[s._v("&&")]),s._v("  符号表示前面一个命令执行成功后才会执行后面的任务。")]),s._v(" "),t("li",[t("code",[s._v("npm run test:prod")]),s._v("  实际上运行了  "),t("code",[s._v("npm run lint && npm run test -- --no-cache")]),s._v(" 。 先运行  "),t("code",[s._v("lint")]),s._v("  去校验的源码和测试文件是否遵循  "),t("code",[s._v("tslint")]),s._v("  规范，再运行  "),t("code",[s._v("test")]),s._v("  去跑测试。")]),s._v(" "),t("li",[t("code",[s._v("npm run build")]),s._v("  实际上运行了  "),t("code",[s._v("tsc --module commonjs")]),s._v(" 、 "),t("code",[s._v("rollup -c rollup.config.ts")]),s._v("  和  "),t("code",[s._v("typedoc --out docs --target es6 --theme minimal --mode file src")]),s._v(" 。先运行  "),t("code",[s._v("tsc")]),s._v("  去编译的  "),t("code",[s._v("TypeScript")]),s._v("  文件， "),t("code",[s._v("dist/lib")]),s._v("  和  "),t("code",[s._v("dist/types")]),s._v("  下的文件就是该命令产生的，然后运行  "),t("code",[s._v("rollup")]),s._v("  去构建  "),t("code",[s._v("axios.umd.js")]),s._v("  及  "),t("code",[s._v("axios.es.js")]),s._v(" ，最后运行  "),t("code",[s._v("typedoc")]),s._v("  去构建项目的文档。")]),s._v(" "),t("li",[s._v("运行完  "),t("code",[s._v("prepub")]),s._v("  后就会再运行  "),t("code",[s._v("pub")]),s._v("  命令，实际上执行了  "),t("code",[s._v("sh release.sh")]),s._v("  命令。")])])]),s._v(" "),t("h3",{attrs:{id:"编写部署脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写部署脚本"}},[s._v("#")]),s._v(" 编写部署脚本")]),s._v(" "),t("p",[s._v("创建文件  "),t("code",[s._v("release.sh")]),s._v(" ：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/usr/bin/env sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" -e\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Enter release version: "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("read")]),s._v(" VERSION\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("read")]),s._v(" -p "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Releasing '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$VERSION")]),s._v(' - are you sure? (y/n)"')]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" -r\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# (optional) move to a new line")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$REPLY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=~")]),s._v(" ^"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Yy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Releasing '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$VERSION")]),s._v(' ..."')]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# commit")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" -A\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" commit -m "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[build] '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$VERSION")]),s._v('"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" version "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$VERSION")]),s._v(" --message "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[release] '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$VERSION")]),s._v('"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" push origin master\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# publish")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" publish\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("blockquote",[t("ul",[t("li",[t("p",[t("code",[s._v("#!/usr/bin/env sh")]),s._v("  用来表示它是一个 shell 脚本。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("set -e")]),s._v("  告诉脚本如果执行结果不为 true 则退出。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("read VERSION")]),s._v("  表示从标准输入读取值，并赋值给  "),t("code",[s._v("$VERSION")]),s._v("  变量。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v('read -p "Releasing $VERSION - are you sure? (y/n)" -n 1 -r')]),s._v(" ，其中  "),t("code",[s._v("read -p")]),s._v("  表示给出提示符，后面接着  "),t("code",[s._v("Releasing $VERSION - are you sure? (y/n)")]),s._v("  提示符； "),t("code",[s._v("-n 1")]),s._v("  表示限定最多可以有 1 个字符可以作为有效读入； "),t("code",[s._v("-r")]),s._v("  表示禁止反斜线的转义功能。因为  "),t("code",[s._v("read")]),s._v("  并没有指定变量名，那么默认这个输入读取值会赋值给  "),t("code",[s._v("$REPLY")]),s._v("  变量。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("if [[ $REPLY =~ ^[Yy]$ ]]")]),s._v("  表示 shell 脚本中的流程控制语句，判断  "),t("code",[s._v("$REPLY")]),s._v("  是不是大小写的  "),t("code",[s._v("y")]),s._v(" ，如果满足，则走到后面的  "),t("code",[s._v("then")]),s._v("  逻辑。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("git add -A")]),s._v("  表示把代码所有变化提交到暂存区。")]),s._v(" "),t("p",[t("code",[s._v('git commit -m "[build] $VERSION"')]),s._v("  表示提交代码，提交注释是  "),t("code",[s._v("[build] $VERSION")]),s._v(" 。")]),s._v(" "),t("p",[t("code",[s._v('npm version $VERSION --message "[release] $VERSION"')]),s._v("  是修改  "),t("code",[s._v("package.json")]),s._v("  中的  "),t("code",[s._v("version")]),s._v("  字段到  "),t("code",[s._v("$VERSION")]),s._v(" ，并且提交一条修改记录，提交注释是  "),t("code",[s._v("[release] $VERSION")]),s._v(" 。")]),s._v(" "),t("p",[t("code",[s._v("git push origin master")]),s._v("  是把代码发布到主干分支。")]),s._v(" "),t("p",[t("code",[s._v("npm publish")]),s._v("  是把仓库发布到  "),t("code",[s._v("npm")]),s._v("  上，我们会把  "),t("code",[s._v("dist")]),s._v("  目录下的代码都发布到  "),t("code",[s._v("npm")]),s._v("  上，因为我们在  "),t("code",[s._v("package.json")]),s._v("  中配置的是  "),t("code",[s._v("files")]),s._v("  是  "),t("code",[s._v('["dist"]')])])])])])])}),[],!1,null,null,null);e.default=v.exports}}]);