---
title:  ğŸ™ Custom Elements è‡ªå®šä¹‰æ ‡ç­¾md
date: 2022-06-05 16:29:52
permalink: /pages/a3a824/
categories:
  -  ğŸƒ å‰ç«¯æ ¸å¿ƒæ¡†æ¶
  -  ğŸ¹ Web Components ç»„ä»¶åŒ–
tags:
  - 
---

å¯ä»¥é€šè¿‡æè¿°å¸¦æœ‰ **è‡ªå·±çš„æ–¹æ³•ã€å±æ€§ã€äº‹ä»¶ç­‰çš„ç±»** åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾ã€‚è‡ªå®šä¹‰æ ‡ç­¾åˆ›å»ºä¹‹åï¼Œå¯ä»¥ä¸ åŸç”Ÿ HTML å†…å»ºä¸€åŒä½¿ç”¨ã€‚

> è™½ç„¶ HTML å†…å»ºçš„æ ‡ç­¾æœ‰å¾ˆå¤šï¼Œä½†æœ‰æ—¶æœªå¿…èƒ½æ»¡è¶³å¼€å‘çš„è¦æ±‚ã€‚



æœ‰ä¸¤ç§ç±»å‹çš„è‡ªå®šä¹‰æ ‡ç­¾ï¼š

+ **è‡ªä¸»è‡ªå®šä¹‰æ ‡ç­¾** / Autonomous custom element ï¼Œç»§æ‰¿è‡ª HTMLElement çš„æŠ½è±¡ç±»ï¼›
+ **è‡ªå®šä¹‰å†…å»ºå…ƒç´ ** / Customized built-in elementï¼šç»§æ‰¿è‡ª HTML çš„å…ƒç´ ï¼Œä¾‹å¦‚å¯ä»¥è‡ªå®šä¹‰ HTMLButton Elementã€‚



## åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾

åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾æ—¶ï¼Œéœ€è¦å‘Šè¯‰æµè§ˆå™¨ä¸€äº›ç»†èŠ‚ï¼šå¦‚ä½•å±•ç¤ºã€æ·»åŠ å…ƒç´ åˆ°é¡µé¢å’Œå°†å…¶ä»é¡µé¢ç§»é™¤æ—¶è¦åšä»€ä¹ˆã€‚

å¯ä»¥é€šè¿‡åˆ›å»ºå¸¦æœ‰å‡ ä¸ªç‰¹æ®Šæ–¹æ³•çš„ç±»å®ç°ï¼š

```js
class MyElement extends HTMLElement {
  constructor() {
    super(); 
    // åœ¨æ­¤åˆ›å»ºå…ƒç´ 
  }
  
  connectedCallback() {
    // å…ƒç´ è¢«æ·»åŠ åˆ°æ–‡æ¡£ä¹‹åï¼Œæµè§ˆå™¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•
    // å¦‚æœåå¤è¢«æ·»åŠ /ç§»é™¤ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¼šåå¤è¢«è°ƒç”¨
  }
  
  disconnectedCallback() {
    // å…ƒç´ è¢«æ·»åŠ åˆ°æ–‡æ¡£ä¹‹åï¼Œæµè§ˆå™¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•
    // å¦‚æœåå¤è¢«æ·»åŠ /ç§»é™¤ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¼šåå¤è¢«è°ƒç”¨
  }
  
  static get observedAttributes() {
    return [/*è¢«ç›‘è§†çš„å±æ€§ï¼Œå‘ç”Ÿå˜åŒ–æ—¶è¿”å›*/]
  }
  
  attributeChangedCallback(name, oldValue, newValue) {
    // å½“ä¸Šé¢æ•°ç»„ä¸­çš„å±æ€§å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¢«è°ƒç”¨
  }

  adoptedCallback() {
    // åœ¨å…ƒç´ è¢«ç§»åŠ¨åˆ°æ–°çš„æ–‡æ¡£çš„æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¢«è°ƒç”¨
    // ï¼ˆdocument.adoptNode ä¼šç”¨åˆ°, éå¸¸å°‘è§ï¼‰
  }
}
```

å£°æ˜ä¸Šé¢çš„æ–¹æ³•ä¹‹åï¼Œéœ€è¦**æ³¨å†Œå…ƒç´ **ï¼š

```js
customElements.define("my-element", MyElement)
```

> æ­¤æ—¶ï¼Œæµè§ˆå™¨çŸ¥é“è¿™ä¸ªå…ƒç´ æ˜¯ `MyElement` ç±»æœåŠ¡çš„ã€‚ä»»ä½•å¸¦æœ‰ `<my-element>` æ ‡ç­¾çš„å…ƒç´ è¢«åˆ›å»ºçš„æ—¶å€™ï¼Œä¸€ä¸ª `MyElement` çš„å®ä¾‹ä¹Ÿä¼šè¢«åˆ›å»ºï¼Œå¹¶ä¸”å‰é¢æåˆ°çš„æ–¹æ³•ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚
>
> åŒæ ·å¯ä»¥ä½¿ç”¨ `document.createElement('my-element')` åœ¨ JavaScript é‡Œåˆ›å»ºå…ƒç´ ã€‚

::: tip

**å‘½åç›¸å…³é—®é¢˜**ï¼š

+ **è‡ªå®šä¹‰å…ƒç´ æ ‡ç­¾çš„åç§°å¿…é¡»åŒ…æ‹¬ä¸€ä¸ª `-`ã€‚** 
+ è¿™æ ·ç¡®ä¿äº†ä¸ä¼šä¸å†…å»ºçš„å…ƒç´ æ ‡ç­¾å‘ç”Ÿå†²çªã€‚

:::



### ğŸŒ° ä¾‹å­ / è‡ªå®šä¹‰æ ¼å¼åŒ–æ—¶é—´å…ƒç´ æ ‡ç­¾

> åŸç”Ÿ HTML æ ‡ç­¾ä¸­ `<time>` å¯ä»¥æ˜¾ç¤º æ—¥æœŸå’Œæ—¶é—´ã€‚ä½†æ˜¯ä¸ä¼šè¿›è¡Œä»»ä½•çš„æ ¼å¼åŒ–å¤„ç†ã€‚

åˆ›å»ºä¸€ä¸ªå¯ä»¥é€‚ç”¨å½“å‰æµè§ˆå™¨è¯­è¨€çš„æ—¶é—´æ ¼å¼çš„ `<time-formatted>` å…ƒç´ ã€‚

JavaScript éƒ¨åˆ†ï¼š

```js
class TimeFormatted extends HTMLElement {
  connectedCallback() {
    let date = new Date(this.getAttribute('datetime') || Date.now())
    
    this.innerHTML = new Intl.DateTimeFormat("default", {
      year: this.getAttribute('yaer') || undefined,
      month: this.getAttribute('month') || undefined,
      day: this.getAttribute('day') || undefined,
      hour: this.getAttribute('hour') || undefined,
      minute: this.getAttribute('minute') || undefined,
      second: this.getAttribute('second') || undefined,
      timeZoneName: this.getAttribute('time-zone-name') || undefined,
    }).format(date)
  }
}

customElements.define('time-formatted', TimeFormatted)
```

HTMLï¼š

```html
<time-formatted
  year="numeric" month="long" day="numeric"
  hour="numeric" minute="numeric" second="numeric"
  time-zone-name="short"
></time-formatted>
```

> `connectedCallback()`ï¼šåœ¨å…ƒç´ è¢«æ·»åŠ åˆ°é¡µé¢æ—¶ï¼ˆæˆ–è€… HTML è§£æå™¨æ£€æµ‹åˆ°è¿™ä¸ªå…ƒç´ ï¼‰ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ä½¿ç”¨å†…å»ºçš„æ—¶é—´æ—¥æœŸæ ¼å¼åŒ–å·¥å…· `Intl.DateTimeFormat()`ã€‚



> è‡ªå®šä¹‰å…ƒç´ çš„å‡çº§ï¼š
>
> + å¦‚æœæµè§ˆå™¨åœ¨ `customElements.define` ä¹‹å‰çš„ä»»ä½•åœ°æ–¹è§åˆ°äº† `<time-formatted>` å…ƒç´ ï¼Œ**å¹¶ä¸ä¼šæŠ¥é”™**ã€‚ä½†ä¼šæŠŠè¿™ä¸ªå…ƒç´ å½“ä½œæœªçŸ¥å…ƒç´ ï¼Œå°±åƒä»»ä½•éæ ‡å‡†æ ‡ç­¾ä¸€æ ·ã€‚
> + `:not(:defined)` CSS é€‰æ‹©å™¨å¯ä»¥å¯¹è¿™æ ·ã€Œæœªå®šä¹‰ã€çš„å…ƒç´ åŠ ä¸Šæ ·å¼ã€‚
>
> + å½“ `customElement.define` è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒä»¬è¢«ã€Œå‡çº§ã€äº†ï¼šä¸€ä¸ªæ–°çš„ `TimeFormatted` å…ƒç´ ä¸ºæ¯ä¸€ä¸ªæ ‡ç­¾åˆ›å»ºäº†ï¼Œå¹¶ä¸” `connectedCallback` è¢«è°ƒç”¨ã€‚å®ƒä»¬å˜æˆäº† `:defined`ã€‚
>
> å¯ä»¥é€šè¿‡è¿™äº›æ–¹æ³•æ¥è·å–æ›´å¤šçš„è‡ªå®šä¹‰æ ‡ç­¾çš„ä¿¡æ¯ï¼š
>
> + `customElements.get(name)` ï¼šè¿”å›æŒ‡å®š custom element `name` çš„ç±»ã€‚
> + `customElements.whenDefined(name)` ï¼šè¿”å›ä¸€ä¸ª promiseï¼Œå°†ä¼šåœ¨è¿™ä¸ªå…·æœ‰ç»™å®š `name` çš„è‡ªå®šä¹‰å…ƒç´ å˜ä¸ºå·²å®šä¹‰çŠ¶æ€çš„æ—¶å€™ resolveï¼ˆä¸å¸¦å€¼ï¼‰ã€‚

> æ³¨æ„å…ƒç´ çš„å†…å®¹æ˜¯åœ¨ `connectedCallback` ä¸­æ¸²æŸ“ï¼ˆåˆ›å»ºï¼‰çš„ã€‚
>
> + å¦‚æœåœ¨ `constructor` è¢«è°ƒç”¨çš„æ—¶å€™æ¸²æŸ“ï¼Œä¸ºæ—¶è¿‡æ—©ã€‚å› ä¸ºè™½ç„¶è¿™ä¸ªå…ƒç´ å®ä¾‹è¢«åˆ›å»ºï¼Œä½†æ˜¯è¿˜æ²¡æ’å…¥é¡µé¢ï¼Œæµè§ˆå™¨è¿˜ä¸èƒ½å¤„ç† / åˆ›å»ºå…ƒç´ å±æ€§ï¼Œæ­¤æ—¶è·å–ç‰¹æ€§ `getAttribute()` ä¼šå¾—åˆ° `null`ã€‚
> + åœ¨ `connectedCallback` æœ‰åˆ©äºæ€§èƒ½ã€‚è¿™ä¸ªå…ƒç´ ä¸ä»…ä»…æ˜¯è¢«æ·»åŠ ä¸ºäº†å¦ä¸€ä¸ªå…ƒç´ çš„å­å…ƒç´ ï¼ŒåŒæ ·ä¹Ÿæˆä¸ºäº†é¡µé¢çš„ä¸€éƒ¨åˆ†ã€‚å› æ­¤å¯ä»¥**æ„å»ºåˆ†ç¦»çš„ DOM**ï¼Œåˆ›å»ºå…ƒç´ å¹¶ä¸”è®©å®ƒä»¬ä¸ºä¹‹åçš„ä½¿ç”¨å‡†å¤‡å¥½ã€‚**å®ƒä»¬åªæœ‰åœ¨æ’å…¥é¡µé¢çš„æ—¶å€™æ‰ä¼šçœŸçš„è¢«æ¸²æŸ“**ã€‚



ä¸ºäº†è®©è¿™ä¸ªæ—¶é—´æ ¼å¼åŒ–ç»„ä»¶çš„å±æ€§éšç€å½“å‰çš„æ—¶é—´å‘ç”Ÿå˜åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ **ç›‘è§†å±æ€§** `observedAttributes()` æ–¹æ³•ï¼Œå½“å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ `attributeChangedCallback` æ–¹æ³•è°ƒç”¨ï¼Œå¹¶ä¸”åªæœ‰æŒ‡å®šçš„å±æ€§å‘ç”Ÿå˜åŒ–æ‰ä¼šè°ƒç”¨ï¼Œä¼˜åŒ–æ€§èƒ½ã€‚

```js
class TimeFormatted extends HTMLElement {

  render() { // (1)
    let date = new Date(this.getAttribute('datetime') || Date.now());

    this.innerHTML = new Intl.DateTimeFormat("default", {
      year: this.getAttribute('year') || undefined,
      month: this.getAttribute('month') || undefined,
      day: this.getAttribute('day') || undefined,
      hour: this.getAttribute('hour') || undefined,
      minute: this.getAttribute('minute') || undefined,
      second: this.getAttribute('second') || undefined,
      timeZoneName: this.getAttribute('time-zone-name') || undefined,
    }).format(date);
  }

	connectedCallback() {
    if(!this.rendered) {
      this.render();
      this.redered = true;
    }
  }
  
  static get observedAttributes() {
    return ['datetime', 'year', 'month', 'day', 'hour', 'minute', 'second', 'time-zone-name'];
  }

	attributeChangedCallback(name, oldValue, newValue) { 
    this.render();
  }
}

customElements.define("time-formatted", TimeFormatted);
```

åˆ›å»ºå…ƒç´ ï¼š
```html
<time-formatted
  id="elem"
  year="numeric" month="long" day="numeric"
  hour="numeric" minute="numeric" second="numeric"
  time-zone-name="short"
></time-formatted>
```

è°ƒç”¨å®šæ—¶å™¨ï¼Œæ¯ç§’æ¸²æŸ“ï¼š

```html
<script>
setInterval(() => elem.setAttribute('datetime', new Date()), 1000); // (5)
</script>
```

> + å°†æ¸²æŸ“çš„é€»è¾‘ç§»åŠ¨åˆ° `render()` æ–¹æ³•ä¸­ã€‚è¿™ä¸ªæ–¹æ³•åœ¨å…ƒç´ è¢«æ’å…¥åˆ°é¡µé¢çš„æ—¶å€™è°ƒç”¨ã€‚ 
> + `attributeChangedCallback` åœ¨ `observedAttributes()` é‡Œçš„å±æ€§æ”¹å˜çš„æ—¶å€™è¢«è°ƒç”¨ã€‚åœ¨å±æ€§æ”¹å˜æ—¶é‡æ–°æ¸²æŸ“ã€‚
> + è®¡æ—¶å™¨ä¿®æ”¹ `datetime` ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ã€‚



## è‡ªå®šä¹‰æ ‡ç­¾å…ƒç´ çš„æ¸²æŸ“é¡ºåº

åœ¨ HTML è§£æå™¨æ„å»º DOM çš„æ—¶å€™ï¼Œä¼š**æŒ‰ç…§å…ˆåé¡ºåºå¤„ç†å…ƒç´ **ï¼Œ**å…ˆå¤„ç†çˆ¶çº§å…ƒç´ å†å¤„ç†å­å…ƒç´ **ã€‚

> ğŸŒ° ä¾‹å­ï¼šå¦‚æœæœ‰  `<outer><inner></inner></outer>`ï¼Œé‚£ä¹ˆ `<outer>` å…ƒç´ ä¼šé¦–å…ˆè¢«åˆ›å»ºå¹¶æ¥å…¥åˆ° DOMï¼Œç„¶åæ‰æ˜¯ `<inner>`ã€‚

è¿™ä¸ªæ¸²æŸ“é¡ºåºå¯¹ è‡ªå®šä¹‰æ ‡ç­¾å…ƒç´ çš„æ¸²æŸ“é¡ºåº äº§ç”Ÿäº†å½±å“ã€‚

ğŸŒ° ä¾‹å­ / å¦‚æœæƒ³è¦åœ¨ `connectedCallback` ä¸­è®¿é—® `this.innerHTML`ï¼Œä»€ä¹ˆä¹Ÿè·å–ä¸åˆ°ã€‚å› ä¸ºæ­¤æ—¶å­å…ƒç´ è¿˜ä¸å­˜åœ¨ï¼Œ DOM è¿˜æ²¡æœ‰å®Œæˆæ„å»ºï¼Œ HMTL è§£æå™¨ä¼šå…ˆåˆ›å»º `<user-info>` ç„¶åå†å¤„ç†å­å…ƒç´ ï¼Œè€Œå­å…ƒç´ è¿˜æ²¡åŠ è½½ã€‚

```html
<script>
customElements.define('user-info', class extends HTMLElement {
  connectedCallback() {
    alert(this.innerHTML); 
  }
});
</script>

<user-info>John</user-info>
```



å¦‚æœè¦ç»™è‡ªå®šä¹‰æ ‡ç­¾å…ƒç´  **ä¼ å…¥ä¿¡æ¯**ï¼Œå¯ä»¥ä½¿ç”¨ **å…ƒç´ å±æ€§**ï¼Œ**å®ƒä»¬æ˜¯å³æ—¶ç”Ÿæ•ˆçš„**ã€‚æˆ–è€…ï¼Œå¦‚æœéœ€è¦å­å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨å»¶è¿Ÿæ—¶é—´ä¸ºé›¶çš„ `setTimeout` æ¥**æ¨è¿Ÿè®¿é—®å­å…ƒç´ **ã€‚

ğŸŒ° ä¾‹å­ï¼š

```html
<script>
customElements.define('user-info', class extends HTMLElement {
  connectedCallback() {
    setTimeout(() => alert(this.innerHTML)); // John (*)
  }
});
</script>

<user-info>John</user-info>
```

> ç°åœ¨å¯ä»¥è®¿é—®å­å…ƒç´ çš„å†…å®¹äº†ã€‚å› ä¸ºæ˜¯åœ¨ HTML è§£æå®Œæˆä¹‹åï¼Œæ‰å¼‚æ­¥æ‰§è¡Œè¿™æ®µç¨‹åºï¼Œå¯ä»¥åœ¨è¿™é‡Œå¤„ç†å¿…è¦çš„å­å…ƒç´ å¹¶ä¸”ç»“æŸåˆå§‹åŒ–è¿‡ç¨‹ã€‚
>
> ä½†æ˜¯è¿™ä¸ªæ–¹æ³•ä¸æ˜¯å®Œç¾çš„ã€‚å¦‚æœåµŒå¥—çš„ è‡ªå®šä¹‰æ ‡ç­¾å…ƒç´ åŒæ ·ä½¿ç”¨äº† `setTimeout` åˆå§‹åŒ–è‡ªèº«ï¼Œé‚£ä¹ˆå®ƒä»¬ä¼š **æŒ‰ç…§å…ˆåé¡ºåºæ‰§è¡Œ**ï¼šå¤–å±‚çš„ `setTimeout` é¦–å…ˆè§¦å‘ï¼Œç„¶åæ‰æ˜¯å†…å±‚çš„ã€‚**è¿™æ ·å¤–å±‚å…ƒç´ è¿˜æ˜¯æ—©äºå†…å±‚å…ƒç´ ç»“æŸåˆå§‹åŒ–**ã€‚
>
> ğŸŒ° ä¾‹å­ï¼š
> ```html
> <script>
> customElements.define('user-info', class extends HTMLElement {
>   connectedCallback() {
>     alert(`${this.id} å·²è¿æ¥ã€‚`);
>     setTimeout(() => alert(`${this.id} åˆå§‹åŒ–å®Œæˆã€‚`));
>   }
> });
> </script>
> 
> <user-info id="outer">
>   <user-info id="inner"></user-info>
> </user-info>
> ```
>
> > å¯ä»¥çœ‹åˆ°ï¼Œ**å¤–å±‚çš„å…ƒç´ å¹¶æ²¡æœ‰ç­‰å¾…å†…å±‚çš„å…ƒç´ **ã€‚

å¹¶æ²¡æœ‰å†…å»ºçš„å›è°ƒæ–¹æ³•å¯ä»¥åœ¨åµŒå¥—å…ƒç´ æ¸²æŸ“å®Œæˆä¹‹åè§¦å‘çš„äº‹ä»¶ã€‚å¦‚æœè¦å®ç°è¿™æ ·çš„å›è°ƒã€‚æ¯”å¦‚ï¼Œå†…å±‚å…ƒç´ å¯ä»¥åˆ†æ´¾åƒ `initialized` è¿™æ ·çš„äº‹ä»¶ï¼ŒåŒæ—¶å¤–å±‚çš„å…ƒç´ ç›‘å¬è¿™æ ·çš„äº‹ä»¶å¹¶åšå‡ºå“åº”ã€‚



## è‡ªå®šä¹‰å†…å»ºçš„æ ‡ç­¾å…ƒç´ 

ä¸Šé¢ä¸€ç§çš„è‡ªå®šä¹‰æ ‡ç­¾å…ƒç´ å¯èƒ½æ— æ³•è¢«æœç´¢å¼•æ“è¯†åˆ«æˆ–è€…æ— éšœç¢è®¾å¤‡å¤„ç†ã€‚

å¤ç”¨ç»§æ‰¿å·²æœ‰çš„å†…å»ºå…ƒç´ çš„ç±»ï¼š

ğŸŒ° ä¾‹å­ / æŒ‰é’® `HTMLButtonElement`ï¼š

```js
class HelloButton extends HTMLButtonElement { /* custom element æ–¹æ³• */ }

customElements.define('hello-button', HelloButton, {extends: 'button'});
```

> åœ¨ `createElements.define` æ—¶è¦ä½¿ç”¨ç¬¬ä¸‰ä¸ªå‚æ•°ã€‚ä¿è¯ `hello-button` æ ‡ç­¾å…±äº«çš„ç±»æ˜¯ `button`ã€‚

æ’å…¥ä¸€ä¸ªæ™®é€šçš„ `<button>` æ ‡ç­¾ï¼Œ æ·»åŠ  `is="hello-button"` ç‰¹æ€§ï¼š

```html
<button is="hello-button">...</button>
```



å®Œæ•´çš„ä¾‹å­ï¼š
```html
<script>
// è¿™ä¸ªæŒ‰é’®åœ¨è¢«ç‚¹å‡»çš„æ—¶å€™è¯´ "hello"
class HelloButton extends HTMLButtonElement {
  constructor() {
    super();
    this.addEventListener('click', () => alert("Hello!"));
  }
}
</script>

<button is="hello-button">Click me</button>

<button is="hello-button" disabled>Disabled</button>
```

> æ–°å®šä¹‰çš„æŒ‰é’®ç»§æ‰¿äº†å†…å»ºæŒ‰é’®ï¼Œæ‰€ä»¥å®ƒæ‹¥æœ‰å’Œå†…å»ºæŒ‰é’®ç›¸åŒçš„æ ·å¼å’Œæ ‡å‡†ç‰¹æ€§ï¼Œæ¯”å¦‚ `disabled` å±æ€§ã€‚

