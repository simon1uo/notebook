---
title: 💈 MyBatis 延迟加载
date: 2022-03-21 09:54:02
permalink: /pages/cf58e4/
categories: 
  - _pages
  - 🧋 JavaEE
  - 🗺 MyBatis
tags: 
  - null
author: 
  name: Simon
  link: https://github.com/simon1uo
---
> MyBatis 支持延迟加载，我们希望一次性把常用的级联数据通过 SQL 直接查询出来，而对于那些不常用的关联映射数据不要取出，而是等待要用时才取出，这些不常用的关联映射数据可以采用了延迟加载的功能。
>
> 比如前面提到的例子中，假设一个用户拥有上万张电话卡，每次我查询用户时不希望其电话卡信息同时显示（影响查询的速度），可以使用延迟加载。



延迟加载：就是在需要用到数据时才进行加载，不需要用到教据时就不加载数据。延迟加载也称懒加载。

+ 好处：先从革表查询，需要时再从关联表去关联查询，大大提高教据库性能，因为查询单表要比关联查询多张表速度要快。
+ 坏处：因为只有当需要用到数据时，才会进行数据库查询，这样在大批量教据查询时，因为查询工作也要洧耗时间，所以可能造成用户等待时间变长，造成用户体验下降。



实现方法：

+ 全局延迟
+ 局部延迟





🌰 全局延迟：

在核心配置文件中设置全局配置信息 （`settings` 标签）：

+ `lazyLoadingEnabled` ：延迟加载的全局开关，当开启时，所有关联对象都会延迟加载。

+ `aggressiveLazyLoading`：开启时任何方法都会加载该对象的**所有属性**，否则会按需加载。默认为 `false`。

  ```xml
  <settings>
      <setting name="lazyLoadingEnabled" value="true"/>
  </settings>
  ```

+ 设置延迟加载后：可以按需加载，就只会执行相应的 sql。

  🌰 例子：

:::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }" 

::: tab java 

开启延迟加载后，单独获取员工的信息和部门信息：

```java
@Test
public void testgetEmpAndDeptByStep(){
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    EmpMapper mapper = sqlSession.getMapper(EmpMapper.class);
    Emp emp = mapper.getEmpAndDeptByStepOne(3);
    System.out.println(emp.getEmpName());
    System.out.println("-----------");
    System.out.println(emp.getDept());
}
```

:::

::: tab result

```sql
DEBUG 03-08 13:58:46,720 ==>  Preparing: select * from emp where eid = ? (BaseJdbcLogger.java:137) 
DEBUG 03-08 13:58:46,754 ==> Parameters: 3(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-08 13:58:46,807 <==      Total: 1 (BaseJdbcLogger.java:137) 
王五
-----------
DEBUG 03-08 13:58:46,808 ==>  Preparing: select * from dept where did = ? (BaseJdbcLogger.java:137) 
DEBUG 03-08 13:58:46,809 ==> Parameters: 3(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-08 13:58:46,810 <==      Total: 1 (BaseJdbcLogger.java:137) 
Dept{did=3, deptName='C'}
```

可以看到，需要那一部分的信息就只会运行某一部分的查询语句，而不会全部查询全部运行。

:::

::::

+ 某个查询不需要延迟加载时，在全局开启延迟加载的情况下，可以通过在 `association` 标签中设置属性 `fetchType="lazy|eager"`，默认 `lazy` 值表示需要延迟加载，`eager` 值表示为当前 `resultMap` 立即加载。

  🌰 例子，关闭延迟加载后：

:::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }" 

::: tab java 

mapper 配置中：

```xml
<resultMap id="getEmpAndDeptByStepResultMapOne" type="Emp">
    <id property="eid" column="eid"></id>
    <result property="empName" column="emp_name"></result>
    <result property="age" column="age"></result>
    <result property="sex" column="sex"></result>
    <result property="email" column="email"></result>
    <association property="dept" select="com.mybatis.mapper.DeptMapper.getEmpAndDeptByStepTwo"
                 column="did" fetchType="eager"></association>
</resultMap>
```

:::

::: tab result

运行前面例子：分别查询员工信息和部门信息时：

```sql
DEBUG 03-08 14:03:48,605 ==>  Preparing: select * from emp where eid = ? (BaseJdbcLogger.java:137) 
DEBUG 03-08 14:03:48,636 ==> Parameters: 3(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-08 14:03:48,655 ====>  Preparing: select * from dept where did = ? (BaseJdbcLogger.java:137) 
DEBUG 03-08 14:03:48,656 ====> Parameters: 3(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-08 14:03:48,660 <====      Total: 1 (BaseJdbcLogger.java:137) 
DEBUG 03-08 14:03:48,660 <==      Total: 1 (BaseJdbcLogger.java:137) 
王五
-----------
Dept{did=3, deptName='C'}
```

:::

::::



🌰 局部延迟：

