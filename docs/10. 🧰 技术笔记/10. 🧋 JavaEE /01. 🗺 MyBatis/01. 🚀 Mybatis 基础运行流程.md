---
title: 🚀 Mybatis 基础
date: 2022-02-28 15:00:47
permalink: /pages/d16430/
categories: 
  - 🧋 JavaEE
  - MyBatis
tags: 
  - MyBatis
  - SSM
  - 框架
author: 
  name: Simon
  link: https://github.com/simon1uo
---
🔗 **相关链接**：

+ 📑 Mybatis 文档：[mybatis – MyBatis 3 | Getting started](https://mybatis.org/mybatis-3/getting-started.html)
  + 🇨🇳 中文文档：[mybatis – MyBatis 3 | 入门](https://mybatis.org/mybatis-3/zh/getting-started.html)
+ 📦 MyBatis Github：[mybatis/mybatis-3: MyBatis SQL mapper framework for Java (github.com)](https://github.com/mybatis/mybatis-3)
+ 🍿 配合本笔记食用视频推荐：[【尚硅谷】2022版MyBatis教程（细致全面，快速上手）](https://www.bilibili.com/video/BV1VP4y1c7j7)

## Mybatis 特性

+ 是支持**定制化 SQL** 、**存储过程**以及**高级映射**的优秀持久框架。
+ 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。
+ 可以使用简单的 XM L 或者注解用于配制和原始映射，将接口和 Java 的 POJO （*普遍 Java 对象*）映射成数据库中的记录。
+ 是一个半自动的 ORM 框架。

> 相关概念：
>
> + 持久化：将数据保存在可掉电的存储介质上。
> + 持久层：将业务数据存储到硬盘，具备长期存储能力（只要硬盘不损坏，大部分重要数据都有相关的备份机制），断电或者其他情况重新开启系统仍然可以读取数据。



**与其他持久化层技术对比**：

+ JDBC：（*是规范，不是框架）
  + SQL 夹杂在 Java 代码中**耦合度高**，导致硬编码内伤。
  + 维护不易且实际开发需求中 SQL 有变化，频繁修改的情况多见。
  + 代码冗长，开发效率低。
+ Hiberante 和 JPA
  + 操作简便，开发效率高。
  + 程序中的长难复杂 SQL 需要绕过框架。
  + 内部自动生产的SQL，不容易做特殊优化。
  + 基于全映射的**全自动框架**，大量字段的 POJO 进行部分映射时比较困难。
  + 反射操作太多，导致数据库性能下降。
+ 🌟 **MyBatis**：
  + 轻量级、性能出色。
  + SQL 和 Java 编码分开，功能边界清晰，Java 代码专注业务、SQL语句专注数据。
  + 开发效率稍逊于 Hibernate，但完全能接受。



## My Batiste 搭建、使用、测试


### 环境搭建与配置

+ 设置 maven 的打包方式为 `jar` ：

  ```xml
  <packaging>jar</packaging>
  ```

+ maven **引入依赖**：

  ```xml
  <dependencies>
    <!-- Mybatis核心 -->
    <dependency>
      <groupId>org.mybatis</groupId>
      <artifactId>mybatis</artifactId>
      <version>3.5.7</version>
    </dependency>
    <!-- junit测试 -->
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.12</version>
      <scope>test</scope>
    </dependency>
    <!-- MySQL驱动 -->
    <dependency>
      <groupId>mysql</groupId>
      <artifactId>mysql-connector-java</artifactId>
      <version>5.1.3</version>
    </dependency>
  </dependencies>
  ```

+ 创建**核心配置文件** （**一般在 Spring 整合时，会忽略以下配置）：

  + 用于配制连接数据库的环境以及 MyBatis 的全局配置信息
  + 存放的位置为 `src/main/resources`

  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <!DOCTYPE configuration
          PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
          "http://mybatis.org/dtd/mybatis-3-config.dtd">
  <configuration>
      <!--设置连接数据库的环境-->
      <environments default="development">
          <environment id="development">
              <transactionManager type="JDBC"/>
              <dataSource type="POOLED">
                  <property name="driver" value="com.mysql.jdbc.Driver"/>
                  <property name="url"
                            value="jdbc:mysql://localhost:3306/MyBatis"/>
                  <property name="username" value="root"/>
                  <property name="password" value="********"/>
              </dataSource>
          </environment>
      </environments>
      <!--引入映射文件-->
      <mappers>
          <mapper resource="mappers/UserMapper.xml"/>
      </mappers>
  </configuration>
  ```

+ 编写 mapper 接口：

  mapper 接口相当于 DAO，但区别是 mapper 不需要提供实现类。（与 POJO 对应的 mapper）

  例如：

  ```java
  public interface UserMapper {
    // ...
  }
  ```

+ 创建 MyBatis 映射文件：用于编写 SQL 语句，访问、操作表中的数据。存放位置：`src/main/resources/mappers` 目录下。

  > **相关概念 / 规则**：
  >
  > + ORM（Object Relationship Mapping）对象关系映射；
  >
  >   对象：实体类对象 
  >
  >   关系：关系型数据库
  >
  >   映射：两者对应关系
  >
  >   | Java 中 | 数据库中  |
  >   | ------- | --------- |
  >   | 类      | 数据表    |
  >   | 属性    | 字段 / 列 |
  >   | 对象    | 记录 / 行 |
  >
  > + **映射文件命名规则**：以表对应的实体类的 `类名` + `Mapper.xml` ，例如表名 `t_user` ，映射的实体类为 `User` 则映射文件命名为 `UserMapper.xml`。**一个映射文件对应一个实体类， 对应一张表的操作**。
  >
  > + MyBatis 可以面向接口操作数据，要保持「**两个一致**」：
  >
  >   + mapper **接口的全类名**和映射文件命名空间（`namespace`）保持一致。
  >   + mapper 接口中的方法的方法名和映射文件中编写 SQL 的标签**id属性**保持一致。

	🌰例如：

  1. 配置文件 `UserMapper.xml` ：

  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <!DOCTYPE mapper
          PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
          "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.mybatis.mapper.UserMapper">
      <!--int insertUser();-->
      <insert id="insertUser">
          insert into user(username) values ('张三')
      </insert>
	</mapper>
  ```
  2. 接口 `UserMapper`：

  ```java
  public interface UserMapper {
      int insertUser(); // 添加用户信息
  }
  ```

### 测试

+ 通过 junit 测试：

  > **相关概念**：
  >
  > + `SqlSession`：代表 **Java 程序和数据库**之间的会话。（区别 `HttpSession` 是 Java 程序与浏览器之间的会话）；默认不自动提交事务，通过设置参数 `OpenSession(true)` 实现自动提交事务。
  > + `SqlSessionFactory` ：生产 `SqlSession` 的「工厂」。

  🌰： 例如，在 `src/test/java` 目录下创建测试类 `MyBatisTest`：

  ```java
  public class MyBatisTest {
      @Test
      public void testMyBatis() throws IOException {
          // 加载核心配置文件
          InputStream is = Resources.getResourceAsStream("mybatis-config.xml");
          // 创建SqlSessionFactoryBuilder对象
          SqlSessionFactoryBuilder sqlSessionFactoryBuilder = new SqlSessionFactoryBuilder();
          // 通过核心配置文件所对应的字节输入流创建工厂类SqlSessionFactory，生产SqlSession对象
          SqlSessionFactory sqlSessionFactory = sqlSessionFactoryBuilder.build(is);
          // 创建SqlSession对象，添加true参数实现自动提交
          SqlSession sqlSession = sqlSessionFactory.openSession(true);
          // 通过代理模式创建UserMapper接口的代理实现类对象
          UserMapper mapper = sqlSession.getMapper(UserMapper.class); 
          // 测试功能
          int result = mapper.insertUser(); 
          // 调用UserMapper中的方法，就可以根据UserMapper中的全类名匹配元素文件，通过调用的方法名匹配映射文件中的SQL标签，并执行标签中的SQL语句
          // 提交事务
          // sqlSession.commit();
          System.out.println(result);
      }
  }
  ```
  
  > MyBatis 运行流程：
  > <img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/HskP9r.png" alt="image-20220307202719285" style="zoom:50%;" />
  >
  > 相关阅读： [🚕 Java 代理模式](/pages/f43979/) | [🔧 MyBatis 核心组件](/pages/d36c99/) 

### 日志功能

+ 加入 **log4j** 日志功能：

  1. 添加 **maven** 依赖：

     ```xml
     <!-- log4j -->
     <dependency>
     	<groupId>log4j</groupId>
     	<artifactId>log4j</artifactId>
     	<version>1.2.17</version>
     </dependency>
     ```

  2. 在 `src/main/resources` 目录下新建配置文件 `log4j.xml`:

     ```xml
     <?xml version="1.0" encoding="UTF-8" ?>
     <!DOCTYPE log4j:configuration SYSTEM "log4j.dtd">
     <log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/">
         <appender name="STDOUT" class="org.apache.log4j.ConsoleAppender">
             <param name="Encoding" value="UTF-8" />
             <layout class="org.apache.log4j.PatternLayout">
                 <param name="ConversionPattern" value="%-5p %d{MM-dd HH:mm:ss,SSS}
     %m (%F:%L) \n" />
             </layout>
         </appender>
         <logger name="java.sql">
             <level value="debug" />
         </logger>
         <logger name="org.apache.ibatis">
             <level value="info" />
         </logger>
         <root>
             <level value="debug" />
             <appender-ref ref="STDOUT" />
         </root>
     </log4j:configuration>
     ```

     > 日志级别：（**从左到右**打印的内容越来越详细）
     >
     > `fatal`（致命）> `error`（错误）> `warn`（警告）> `info`（信息）> `debug`（调试）

🌰： 使用 log4j 可以记录 MyBatis 运行的 SQL 语句和使用的参数，方便 debug：
![image-20220304145920433](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/ZdQGp6.png)

## MyBatis 增删改查


🌰：以对一个 `User` 表为例：

+ `com.*.pojo.User` 实体类：

```java
public class User {

    private Integer id;
    private String username;
    private String password;
    private Integer age;
    private String sex;
    private String email;
  
  // ... getter and setter
}
```

+ `com.*.mapper.UserMapper` （mapper 接口）：

```java
public interface UserMapper {

    int insertUser(); // 添加用户

    void updateUser(); // 修改用户

    void deleteUser(); // 删除用户

    User getUserById(); // 通过id查询用户
}
```

+ `src/main/resources/mappers` 目录下的  `UserMapper.xml`（mapper 配置）：

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mybatis.mapper.UserMapper">
    <!--int insertUser();-->
    <insert id="insertUser">
        insert into user(username)
        values ('张三')
    </insert>

    <!--void updateUser();-->
    <update id="updateUser">
        update user
        set username = 'admin'
        where id = 2  </update>

    <!--void deleteUser();-->
    <delete id="deleteUser">
        delete from user where id = 4
    </delete>

    <!--User getUserById();-->
    <select id="getUserById" resultType="com.mybatis.pojo.User">
        select * from user where id = 3
    </select>
</mapper>
```

>注意：
>
>+ **查询功能的标签必须设置 `resultType` 或者 `resultMap`**：
>
>  + `resultType` ：设置默认的映射关系（自动映射），用于**属性名和表中的字段名一致**的情况。
>
>  + `resultMap`：设置自定义的映射关系，用于**一对多或者多对多和属性名不一致的情况**；
>
>+ 查询的数据较多条时，不应该使用实体类作为返回值，而使用以实体类为类型的集合，否则抛出异常 `TooManyResultException` ；查询的数据只有一条时，返回值使用实体类或者集合都可。

+ 测试类 `testCRUD`：

```java
    @Test
    public void testCRUD() throws IOException {
        InputStream inputStream = Resources.getResourceAsStream("mybatis-config.xml");
        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
        SqlSession sqlSession = sqlSessionFactory.openSession(true);
        UserMapper mapper = sqlSession.getMapper(UserMapper.class);
        // mapper.updateUser();
        // mapper.deleteUser();
        // User user = mapper.getUserById();
        List<User> list = mapper.getAllUser();
        System.out.println(list);
    }
```



## MyBatis 配置/映射文件模版

+ 配置文件模版：进入 IDEA Settings（Preferences） 搜索 `File and Code Templates` 配置，按 `+` 添加模版，添加 `Mybatis Config XML File` ：（注意 Extension 文件拓展名为 `xml`）

![image-20220303164352687](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/QEbzOJ.png)

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <properties resource="jdbc.properties"/>

    <typeAliases>
        <package name=""/>
    </typeAliases>

    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="${jdbc.driver}"/>
                <property name="url" value="${jdbc.url}"/>
                <property name="username" value="${jdbc.username}"/>
                <property name="password" value="${jdbc.password}"/>
            </dataSource>
        </environment>
    </environments>
    <mappers>
        <package name=""/>
    </mappers>
</configuration>
```



+ mapper 配置文件同上设置：

![image-20220303164825180](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/rPJHJX.png)

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="">

</mapper>
```



+ 封装 `SqlSessionUtils` 工具类：

```java
public class SqlSessionUtils {
    public static SqlSession getSqlSession() {
        SqlSession sqlSession = null;
        try {
            InputStream is = Resources.getResourceAsStream("mybatis-config.xml");
            SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(is);
            sqlSession = sqlSessionFactory.openSession(true);
        } catch (IOException e) {
            e.printStackTrace();
        }
        return sqlSession;
    }
}
```



🌰 例子：测试上述工具类：

```java
public class ParameterMapperTest {
    @Test
    public void testGetAllUser(){
        SqlSession sqlSession = SqlSessionUtils.getSqlSession();
        ParameterMapper mapper = sqlSession.getMapper(ParameterMapper.class);
        List<User> userList = mapper.getAllUser();
        userList.forEach(user -> System.out.println(user));
    }
}
```

