---
title: 🪞 MyBatis 映射文件
date: 2022-03-22 11:47:53
permalink: /pages/269652/
categories: 
  - _pages
  - 🧋 JavaEE
  - 🗺 MyBatis
tags: 
  - null
author: 
  name: Simon
  link: https://github.com/simon1uo
---
### MyBaits  映射器
+ 映射器是 MyBatis 最复杂且最重要的组件。它是由**一个接口加上 XML 文件（或注解）**组成。
+ 在映射器中可以配置参数、各类 SQL 语句、存储过程、缓存、级联等复杂的内容，并且通过简易的映射规则映射到指定的 POJO 或者其他对象上，映射器消除 JDBC 底层代码。
+ 在 MyBatis 开发中主要就是映射器开发。其实与 Spring 组合之后前面的核心组件运行、全局配置文件都不需要我们亲自去做，MyBatis 中我们唯一主要做的就是写映射器。



### XML 映射文件结构

在映射文件中， `<mapper>` 元素是映射文件的根元素，其他元素都是它的子元素：

```xml
<mapper>
	<insert/>
  <upadte/>
  <delete/>
  <select/>
  <resultMap/>
  <sql/>
  <cache/>
  <cache-ref/>
</mapper>
```

使用XML文件时，映射文件常用的元素如下：

+ `insert` 元素：插入语句
+ `update` 元素：更新语句
+ `delete` 元素：删除话句
+ `select` 元素：查询语句
+ `resultMap` 元素：用来描述如何从数据库结果集中加载对象
+ `sql` 元素：可被其它语句引用的可重用话句块（了解）
+ `cache` 和 `cache-ref` 元素：命名空间的缓存配置的引用（了解）



### `insert` 元素

用于增加数据记录，在映射文件中使用 `insert` 标签：

```xml
<mapper namespace="对应接口位置">
  <insert id="接口对应方法" parameterType="进参类型" />
  	<!--插入的SQL语句 如insert into user(age) values(#{age})-->
  </insert>
</mapper>
```

+ `namespace` 属性指明对应接口的位置。
+ `id` 配合 Mapper 的命名空问，构成全限定名，用于标示这条 SQL 语句作用于谁。
+ `parameterType` 表示这条 SQL 语句接受的参数类型，可以是 MyBatis 系统定义（`int`，`string` 等），也可以是自定义的（例如 `User` 等）。
+ `#{userName}` 是被传进去的参数。

（详细的属性与说明参考文档）



🌰 例子：`insert` 新增数据例子：
::: details

+ 在 `UserMapper.java` Mapper 接口新增 `addUser` 方法：

```java
int addUser(User user);
```

+ 在 `UserMapper.xml` Mapper 映射配置文件中添加：

```xml
<!--int addUser(User user);-->
<insert id="addUser" parameterType="User">
    insert into user(name, age, sex, address)
    values (#{name}, #{age}, #{sex}, #{address});
</insert>
```

+ 运行测试：

```java
@Test
public void addUserTest(){
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    int i = mapper.addUser(new User("小罗", 18, "M", "佛山"));
}
```

:::



### `update` 元素

用于修改数据记录，在映射文件中使用 `update` 标签：
```xml
<mapper namespace="对应接口位置">
  <update id="接口对应方法" parameterType="进参美型">
    <!--更新的SQL语句-->
  </update>
</mapper>
```



🌰 例子：`update` 修改数据记录例子：
::: details

+ 首先在 `UserMapper.java` 接口中新增方法：

```java
int updateUserById(@Param("id") int id,@Param("name") String name);
```

+ 在 `UserMapper.xml` Mapper 映射配置文件中添加：

```xml
<!--int updateUserById(@Param("id") int id,@Param("name") String name);-->
<update id="updateUserById">
    update user set name = #{name} where id = #{id}
</update>
```

+ 运行测试：

```java
@Test
public void testUpdateUserById() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    int i = mapper.updateUserById(2, "小王");
}
```

:::



### `delete` 元素

用于删除数据记录，在映射文件中使用 `delete` 标签：

```xml
<mapper namespace="对应接口住置">
  <delete id="接口对应方法"parameterType="进参类型">
    <!--测试的SQL语句，如delete from user where id=#(id} -->
  </delete>
</mapper>
```



🌰 例子：`delete` 删除数据的例子

::: details

+ 首先在 `UserMapper.java` 接口中新增方法：

```java
int deleteUserById(int id);
```

+ 在 `UserMapper.xml` Mapper 映射配置文件中添加：

```xml
<!--int deleteUserById(int id);-->
<delete id="deleteUserById" parameterType="int">
    delete from user where id = #{id}
</delete>
```

+ 运行测试:

```java
@Test
public void testDeleteUserById() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    int i = mapper.deleteUserById(6);
}
```


![image-20220322175810902](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/ZtS9Jw.png)

:::



### `sql` 标签

`sql` 片段，可以记录一段**公共 `sql` 片段**，在使用的地方通过 `include` 标签进行引入：

🌰 例子：将常用查询员工信息的字段名包含为 `sql` 片段：

```xml
<sql id="empColumns">
    eid,emp_name,age,sex,email
</sql>
```

引用方法，在要使用的地方 `include` 引入：

```xml
<include refid="empColumns"></include>
```



### `cache` 和 `cache-ref` 元素

+ 在映射文件加入 `cache` 元素，可以开启二级缓存。
+ 想要**在不同的命名空间里共享同一个缓存配置或者实例**，在这种情况下就可以使用 `cache-ref` 元素来引用另一个缓存。

🔎 详细链接 [💾 MyBatis 缓存 | notebook by simon (simon1uo.github.io)](https://simon1uo.github.io/notebook/pages/4341f6/)

🌰 例子： 使用 `cache-ref` 的例子：
```xml
<cache-ref namespace="com.simon.mapper.UserMapper"/>
```



## 使用注解方式实现映射


除了使用映射文件实现映射器，Mybatis 也可以使用注解方式实现映射器：

+ `@Insert`：实现新增数据
+ `@Update`：实现更新数据
+ `@Delete`：实现删除数据
+ `@Select`：实现查询数据
+ `@Options`：提供配置选项的附加值
+ `@Param`：当映射方法需要多个参教时，这个注解可以被应用
  于映射器方法参数来给每个参数取一个名字来对应
+ `@CacheNamespace`：同 `<cache>` 标签注解二级缓存（了解）
+ `@CacheNamespaceRef`：同 `<cache-ref>` 标签注解二级缓存（了解）
+ `@Result`：实现结果集封装 
+ `@Results`：可以与 `@Result` 一起使用，封装多个结果集
+ `@ResultMap`：实现**引用** `@Results` 定义的封裝

***

以下部分可跳转至 [🚲 MyBatis 动态SQL | notebook by simon (simon1uo.github.io)](/pages/a1647a/#映射文件实现动态-sql))

+ `@InsertProvider`：实现动态SQL映射-新增数据
+ `@UpdateProvider`：实现动态SQL映射-更新数据
+ `@DeleteProvider`：实现动态SQL映射-删除数据
+ `@SelectProvider`：实现动态SQL映射-查询数据
+ `@One`：实现一对一结果集封裝
+ `@Many`：实现一对多结果集封裝

::: warning

使用注解方法时，应该在 MyBatis 全局配置文件中引入 Mapper 接口。建议直接导入存放 Mapper 接口的包。

```xml
<mapper>
	<pakage name="com.simon.mapper"/>
</mapper>
```

:::



### `@insert` 注解

🌰 例子：

::: details

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Insert("insert into user(name, age, sex, address) values(#{name}, #{age}, #{sex}, #{address})")
int newInsertUser(User user);
```

+ 测试：

```java
@Test
public void NewAddUserTest() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    int i = mapper.newInsertUser(new User("小罗", 18, "M", "佛山"));
}
```

:::



### `@options` 注解

配合主注解，此外 `@Options` 注解还可以使用 `useCache`、 `flushCache` 、 `timeout` 等属性，作用与 XML 文件中的 `useCache`、 `flushCache`、 `timeout` 非常类似。


🌰 ：以配置主键回填的 `useGeneratedKeys` 为例：

::: details

- 在 Mapper 接口 `UserMapper` 中：

```java
@Insert("insert into user(name, age, sex, address) values(#{name}, #{age}, #{sex}, #{address})")
@Options(useGeneratedKeys = true, keyProperty = "id")
int newInsertUser(User user);
```

+ 测试：

```java
@Test
public void NewAddUserTest() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    User user = new User( "小罗", 18, "M", "佛山");
    int i = mapper.newInsertUser(user);
    System.out.println(user);
}
```

![image-20220322201936559](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/apcQSB.png)

:::



### `@update` 注解

🌰 例子：

::: details

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Update("update user set name = #{name} where id = #{id}")
int newUpdateUserById(@Param("id") int id, @Param("name") String name);
```

+ 测试：

```java
@Test
public void testNewUpdateUserById() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    int i = mapper.newUpdateUserById(2, "小王");
}
```

:::



### `@Delete` 注解



🌰 例子：
::: details

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Delete("delete from user where id = #{id}")
int newDeleteUserById(int id);
```

+ 测试：

```java
@Test
public void testNewDeleteUserById() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    int i = mapper.newDeleteUserById(8);
}
```

:::



### `@Select` 注解

🌰 例子：
::: details

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Select("select * from user")
List<User> newGetAllUser();
```

+ 测试：

```java
@Test
public void newGetAllUserTest(){
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    List<User> allUser = mapper.newGetAllUser();
    allUser.forEach(user -> System.out.println(user));
}
```

:::



### 自动映射

MyBatis 提供了自动映射功能，可以使用 `as  `别名实现，而且默认是开启的，可以减少工作量。另外还可以开启驼峰映射。

🌰 例子：
::: details

+ 创建新的持久化类 `UserResult` ：

```java
public class UserResult {
    private int idResult;
    private String nameResult;
    private int ageResult;
    private String sexResult;
    private String addressResult;
    
}
```

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Select("select name as nameResult from user")
List<UserResult> findNameWithAs();
```

+ 测试：

```java
@Test
public void testFindNameWithAs() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    List<UserResult> users = mapper.findNameWithAs();
    users.forEach(userResult -> System.out.println(userResult.getNameResult()));
}
```

:::



模糊查询

🌰 例子：

::: details

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Select("select * from user where name like '%${name}%'")
List<User> findByName(String name);
```

+ 测试：

```java
@Test
public void testFindByName() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    List<User> users = mapper.findByName("张");
    users.forEach(user -> System.out.println(user));
}
```

:::

（模糊查询其他方法参考 🔗[🔍 MyBatis 进阶查询 | notebook by simon (simon1uo.github.io)](/pages/991773/#模糊查询)）



### 聚合查询

🌰 例子 :one:： （使用 `count(*)` 方法）

::: details

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Select("select count(id) from user")
int findWithCount();
```

+  测试：

```java
@Test
public void testFindWithCount() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    int count = mapper.findWithCount();
    System.out.println(count + "条用户记录数");
}
```

:::



🌰 例子 :two: ：（使用 `group by ` 方法）

::: details

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Select("select count(id), address from user group by address")
List<Map> findWithAddressGroup();
```

+ 测试：

```java
@Test
public void testFindWithAddressGroup() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    List<Map> maps = mapper.findWithAddressGroup();
    maps.forEach(map -> System.out.println(map));
}
```

:::



### 分页查询

🌰 例子：

::: details

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Select("select * from user where age > #{age}")
List<User> findByRowBounds(int age, RowBounds rowBounds);
```

+ 测试：

```java
@Test
public void testFindByRowBounds() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    RowBounds rowBounds = new RowBounds(1, 3);
    List<User> users = mapper.findByRowBounds(20, rowBounds);
    users.forEach(user -> System.out.println(user));
}
```

:::



### `@Result` 和 `@Results` 注解

当持久化类中属性名称与数据库字段名称不对应时，可以使用 `@Result` 相关注解解决。

🌰 例子：（以持久化类 `UserResult` 为例子）

::: details

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Select("select * from user")
@Results(id = "userResultMap", value = {
        @Result(id = true, column = "id", property = "idResult"),
        @Result(column = "name", property = "nameResult"),
        @Result(column = "age", property = "ageResult"),
        @Result(column = "sex", property = "sexResult"),
        @Result(column = "address", property = "addressResult"),
})
List<UserResult> findAllUserResult();
```

+ 测试：

```java
@Test
public void testFindAllUserResult() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    List<UserResult> users = mapper.findAllUserResult();
    users.forEach(user -> System.out.println(user));
}
```

:::



🌰 例子（使用 `ResultMap` 通过 `id` 引用其他已定义的 `ResultMap`）

::: details

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Select("select * from user where id = #{id}")
@ResultMap("userResultMap")
UserResult findByIdResult(int id);
```

+ 测试：

```java
@Test
public void testFindByIdResult() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    UserResult userResult = mapper.findByIdResult(2);
    System.out.println(userResult);
}
```

:::



🌰 例子（使用 `group by` **聚合查询**形成结果集）

::: details

+ 在 Mapper 接口 `UserMapper` 中：

```java
@Select("select count(id), address from user group by address")
@Results(id = "AddressMap", value = {
        @Result(column = "count(id)", property = "count"),
        @Result(column = "address", property = "addresds")
})
List<Map> findWithGroupMap();
```

+ 测试：

```java
@Test
public void testFindWithGroupMap() {
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    UserMapper mapper = sqlSession.getMapper(UserMapper.class);
    List<Map> maps = mapper.findWithGroupMap();
    maps.forEach(map -> System.out.println(map));
}
```

:::



### `@CacheNamespace` 相关注解



🌰 例子（开启二级缓存）：

::: details

```java
@CacheNamespace(blocking = true)
public interface UserMapper{
   // ... 
}
```

:::



### `@Param` 注解

主要用于标识参数，🔎 详细：[🔦 MyBatis 获取参数 | notebook by simon (simon1uo.github.io)](/pages/33f653/#使用-param-标识参数)
