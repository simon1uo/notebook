---
title: â˜˜ï¸ Spring å£°æ˜å¼äº‹åŠ¡
date: 2022-03-30 10:52:19
permalink: /pages/9f2a81/
categories: 
  - _pages
  - ğŸ§‹ JavaEE
  - ğŸƒ Spring
tags: 
  - Spring
author: 
  name: Simon
  link: https://github.com/simon1uo
---



## äº‹åŠ¡

+ äº‹åŠ¡æ˜¯æ•°æ®åº“æ“ä½œçš„**æœ€åŸºæœ¬å•å…ƒ**ï¼Œé€»è¾‘ä¸Šæ˜¯ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œå¦‚æœæœ‰ä¸€ä¸ªå¤±è´¥æ‰€æœ‰æ“ä½œéƒ½å¤±è´¥ã€‚
+ å…¸å‹åœºæ™¯ï¼šé“¶è¡Œè½¬å¸ï¼ˆåªè¦æœ‰å‡ºé”™ï¼Œäº¤æ˜“éƒ½ä¼šä¸­æ–­ï¼‰ã€‚



> ğŸ”— **äº‹åŠ¡çš„ç‰¹æ€§**ï¼š
>
> - åŸå­æ€§ï¼ˆ**A**tomicityï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸å¯åˆ†å‰²ã€‚
>
> - ä¸€è‡´æ€§ï¼ˆ**C**onsistencyï¼‰ï¼šäº‹åŠ¡æ“ä½œä¹‹å‰å’Œæ“ä½œä¹‹åï¼Œæ€»é‡ä¿æŒä¸å˜ã€‚
>
> - éš”ç¦»æ€§ï¼ˆ**I**solationï¼‰ï¼šå¤šäº‹åŠ¡æ“ä½œæ—¶ï¼Œç›¸äº’ä¹‹é—´ä¸ä¼šäº§ç”Ÿå½±å“ã€‚
>
> - æŒä¹…æ€§ï¼ˆ**D**urabilityï¼‰ï¼šäº‹åŠ¡æœ€ç»ˆæäº¤åï¼Œæ•°æ®åº“è¡¨ä¸­æ•°æ®æ‰ä¼šçœŸæ­£å‘ç”Ÿå˜åŒ–ã€‚



## äº‹åŠ¡æ“ä½œ

 å¯ä»¥æŒ‰ç…§ JavaEE çš„å…¸å‹ä¸‰å±‚ç»“æ„å®ç°ï¼Œç›®å‰é¦–å…ˆå…³æ³¨ `Service` ä¸šåŠ¡æ“ä½œå±‚å’Œ `DAO` æ•°æ®åº“æ“ä½œå±‚ã€‚

### å‡†å¤‡äº‹åŠ¡æ“ä½œ

+ ä¸»è¦æ­¥éª¤ï¼š
  + åˆ›å»ºæ•°æ®åº“è¡¨ `t_account` ï¼Œæ·»åŠ å‡ æ¡äº¤æ˜“è®°å½•ã€‚
  + åˆ›å»ºå¯¹åº”çš„ `Service` å’Œ `DAO` ç±»ï¼Œå®Œæˆå¯¹è±¡åˆ›å»ºå’Œå…³ç³»æ³¨å…¥ã€‚
  + åœ¨ `Service` å’Œ `DAO` ä¸­ç¼–å†™ç›¸åº”çš„ä»£ç å®ŒæˆåŠŸèƒ½é€»è¾‘éƒ¨åˆ†ã€‚



+ åˆ›å»ºæ•°æ®åº“è¡¨ `t_account` ï¼Œæ·»åŠ å‡ æ¡äº¤æ˜“è®°å½•ã€‚

```sql
create table t_account
(
    id       varchar(20) not null,
    username varchar(50) null,
    amount   int         null,
    constraint transfer_record_pk
        primary key (id)
);

INSERT INTO t_account (id, username, amount) VALUES ('1', 'Lucy', 1000);
INSERT INTO t_account (id, username, amount) VALUES ('2', 'Mary', 1000);
```



> Spring ä¸ Mybatis çš„æ•´åˆä½¿ç”¨åœ¨ä¸Šä¸€èŠ‚å·²ç»è¯¦ç»†è®°å½•æ­¥éª¤ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚

+ åˆ›å»º `TransferRecordDAO` æŠ½è±¡ç±»ã€‚

```java
@Repository
public interface TransferDAO {
    @Select("SELECT * FROM t_account")
    List<Account> findAll();

    @Update("UPDATE t_account set amount=amount-#{amount} where username=#{username}")
    void transferOut(@Param("amount") int amount,@Param("username") String username);

    @Update("update t_account set amount=amount+#{amount} where username=#{username}")
    void transferIn(@Param("amount") int amount,@Param("username") String username);
}
```



+ åˆ›å»º `TransferRecordService` ç±»ï¼Œå¹¶å®Œæˆ `TransferRecordDAO` çš„æ³¨å…¥ï¼Œè°ƒç”¨ `TransferRecordDAO` çš„æ–¹æ³•ï¼š

```java
@Service
public class TransferRecordService {
    @Autowired
    private TransferRecordDAO transferRecordDAO;

    public void getAllAccounts(){
        List<Account> accounts = transferDAO.findAll();
        for (Account account : accounts) {
            System.out.println(account);
        }
    }

    public void transferAccounts(int amount, String fromUser, String toUser) {
        System.out.println("transfer start ... ");
        transferDAO.transferOut(amount, fromUser);
        transferDAO.transferIn(amount, toUser);
        System.out.println("transfer end ... ");

    }
}
```



+ ç¼–å†™æµ‹è¯•æ–¹æ³•ï¼š

```java
@Test
public void testTransferAccounts(){
    ApplicationContext context = new AnnotationConfigApplicationContext(SpringConfig.class);
    TransferService transferService = context.getBean("transferService", TransferService.class);
    transferService.getAllAccounts();
    transferService.transferAccounts(100, "Lucy", "Mary");
    transferService.getAllAccounts();
}
```

> ä»¥ä¸Šæ— å¼‚å¸¸æƒ…å†µä¸‹ï¼Œ å¯ä»¥å®Œæˆä¸€æ¬¡äº¤æ˜“ã€‚



### å¼•å…¥äº‹åŠ¡åœºæ™¯

å½“è½¬è´¦ä¸­é€”å‘ç”Ÿå¼‚å¸¸æƒ…å†µï¼ˆä¾‹å¦‚ï¼Œç½‘ç»œå¼‚å¸¸ï¼‰ï¼Œå°è¯•æ¨¡æ‹Ÿå¼‚å¸¸æƒ…å†µï¼š

+ ä¿®æ”¹ `TransferRecordService` ä¸­çš„æ–¹æ³•ï¼š

```java
public void transferAccounts(int amount, String fromUser, String toUser) {
    int i = 1 / 0;
    transferRecordDAO.transferOut(amount, fromUser);
    transferRecordDAO.transferIn(amount, toUser);
}
```



+ ï¼ˆåœ¨æµ‹è¯•æ•°æ®å¤åŸï¼‰è¿è¡Œæµ‹è¯•æ–¹æ³•ï¼ŒæŠ›å‡ºæ— æ³•å®Œæˆæ“ä½œçš„å¼‚å¸¸ï¼š

```
java.lang.ArithmeticException: / by zero

	at com.simon.service.TransferRecordService.transferAccounts(TransferRecordService.java:13)
	at com.simon.service.TransferRecordTest.testTransferAccounts(TransferRecordTest.java:14)
```

**æ­¤æ—¶å‡ºç°è‡´å‘½æ€§çš„é—®é¢˜ï¼Œå›çœ‹æ•°æ®åº“çš„æ•°æ®ï¼Œå‘ç°è½¬å‡ºè´¦æ–¹è¢«è½¬å‡ºé‡‘é¢ï¼Œè€Œæ”¶è´¦æ–¹å´æ²¡æœ‰æ”¶åˆ°ç›¸åº”çš„é‡‘é¢ã€‚æ­¤æ—¶ï¼Œäº‹åŠ¡çš„ä½œç”¨å°±åœ¨è¿™é‡Œä½“ç°å‡ºæ¥äº†ã€‚**



### äº‹åŠ¡åŸºæœ¬æ“ä½œ

1. å¼€å¯ä¸€ä¸ªäº‹åŠ¡
2. è¿›è¡Œä¸šåŠ¡é€»è¾‘å®ç°
3. æ²¡æœ‰å¼‚å¸¸ï¼Œåˆ™**æäº¤äº‹åŠ¡**
4. å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™**å›æ»šäº‹åŠ¡**



ğŸŒ° å°†å‰è¿°è½¬è´¦ä¾‹å­ `TransferRecordService` ä¸­çš„æ–¹æ³•å¼•å…¥äº‹åŠ¡çš„åŸºæœ¬æ¡†æ¶ï¼š

```java
try {
    // Step1ã€å¼€å¯ä¸€ä¸ªäº‹åŠ¡
    // Step2ã€è¿›è¡Œä¸šåŠ¡é€»è¾‘å®ç°
    transferRecordDao.transferOut(amount, fromUser);
    //æ¨¡æ‹Ÿç½‘ç»œå¼‚å¸¸è€Œå¯¼è‡´æ“ä½œä¸­æ–­
    int i = 10 / 0;
    transferRecordDao.transferIn(amount, toUser);
    // Step3ã€æ²¡æœ‰å¼‚å¸¸ï¼Œåˆ™æäº¤äº‹åŠ¡
} catch (Exception e) {
    // Step4ã€å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™å›æ»šäº‹åŠ¡
}
```



## å£°æ˜å¼äº‹åŠ¡

### Spring äº‹åŠ¡ç®¡ç†

åœ¨ Spring ä¸­è¿›è¡Œäº‹åŠ¡ç®¡ç†æœ‰ä¸¤ç§æ–¹å¼ï¼š

+ ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†ï¼šåœ¨å‰è¿°çš„äº‹åŠ¡åŸºæœ¬æ“ä½œå®ç°å°±æ˜¯å…¸å‹çš„ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†ã€‚è¿™ç§æ–¹å¼è™½ç„¶å¹¶ä¸å¥½ï¼Œä½†æ˜¯å¯ä»¥äº†è§£è¿™ä¸ªäº‹åŠ¡çš„æ“ä½œè¿‡ç¨‹ï¼Œä¸€èˆ¬ç”±äºä¸æ–¹ä¾¿ã€å¯¼è‡´ä»£ç çš„è‡ƒè‚¿ã€ç»´æŠ¤èµ·æ¥éº»çƒ¦è€Œä¸ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚
+ **å£°æ˜å¼äº‹åŠ¡ç®¡ç†**ï¼ˆæ¨èä½¿ç”¨ï¼‰ï¼šåº•å±‚åŸç†å°±æ˜¯ [Spring AOP](/pages/dad650/) ï¼Œåœ¨ä¸æ”¹å˜åŸæ¥çš„ä»£ç é€»è¾‘çš„åŸºç¡€ä¸Šï¼Œæ‹“å±•ä»£ç çš„åŠŸèƒ½ã€‚æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š
  + **åŸºäºæ³¨è§£æ–¹å¼å®ç°**ï¼ˆæ¨èä½¿ç”¨ï¼‰
  + åŸºäº XML é…ç½®æ–‡ä»¶å®ç°



### Spring äº‹åŠ¡ç®¡ç† API

Spring æä¾›äº†ä¸€ä¸ªæ¥å£ä»£è¡¨äº‹åŠ¡ç®¡ç†å™¨ï¼Œé’ˆå¯¹ä¸åŒçš„ JDBC æ¡†æ¶å­˜åœ¨ä¸åŒçš„å®ç°ç±»ï¼š

- `PlatformTransactionManager` æ¥å£ï¼šå³äº‹åŠ¡ç®¡ç†å™¨ï¼Œæœ‰å¤šä¸ªä¸åŒçš„æŠ½è±¡ç±»å’Œå…·ä½“å®ç°ç±»ï¼Œå¯æ»¡è¶³ä¸åŒçš„æ¡†æ¶ã€‚

- `DataSourceTrasactionManager` å®ç°ç±»ï¼š`JdbcTemplate` å’Œ `MyBatis` æ¡†æ¶ä½¿ç”¨åˆ°å®ƒã€‚

- `HibernateTransactionManager` å®ç°ç±»ï¼š`Hibernate` æ¡†æ¶ä½¿ç”¨åˆ°å®ƒã€‚



### æ³¨è§£å®ç°å£°æ˜å¼äº‹åŠ¡ç®¡ç†

+ åœ¨ Spring é…ç½®æ–‡ä»¶ä¸­é…ç½®äº‹åŠ¡ç®¡ç†å™¨ `DataSourceTransactionManager`çš„å¯¹è±¡åˆ›å»ºã€‚

```xml
<!--é…ç½®äº‹åŠ¡ç®¡ç†å™¨-->
<bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    <property name="dataSource" ref="dataSource"/>
</bean>
```

> `property` è®¾ç½®çš„å±æ€§ä¸ºç›®å‰ä½¿ç”¨çš„ `dataSource` å¯¹è±¡ã€‚



+ åœ¨ Spring é…ç½®æ–‡ä»¶ä¸­å¼€å¯äº‹åŠ¡ï¼ˆæ³¨è§£æ–¹å¼ï¼‰ï¼š
  + å¼•å…¥ `xmlns:tx` çš„åç§°ç©ºé—´
  + é…ç½® `<tx:annotation-driven>` æ ‡ç­¾å¼€å¯äº‹åŠ¡æ³¨è§£é©±åŠ¨

```xml
<!--å¼€å¯äº‹åŠ¡æ³¨è§£-->
<tx:annotation-driven transaction-manager="transactionManager"/>
```

> `transaction-manager` å±æ€§é…ç½®å½“å‰çš„äº‹åŠ¡ç®¡ç†å™¨ã€‚

ï¼ˆæ­¤å¤„å®ç°æ³¨è§£å®ç°å£°æ˜å¼äº‹åŠ¡ç®¡ç†ä¾æ—§éœ€è¦ä¾é  Spring é…ç½®æ–‡ä»¶å¼€å¯äº‹åŠ¡æ³¨è§£ï¼Œè¦å®ç°å®Œæ•´æ³¨è§£å¼€å‘è¯·çœ‹åå¤„ä»‹ç»ã€‚ï¼‰



ğŸŒ° å»¶ç»­å‰è¿°çš„ä¾‹å­ï¼Œåœ¨ `TransferRecordService` ä¸­æ·»åŠ äº‹åŠ¡æ³¨è§£ `@Transactional`ï¼š

```java
@Service
@Transactional
public class TransferRecordService {
	// ... 
}
```





+ æ³¨è§£ `@Transactional` ä¸­é…ç½®äº‹åŠ¡ç›¸å…³çš„å‚æ•°ï¼š

  - `propagation`ï¼šäº‹åŠ¡ä¼ æ’­è¡Œä¸º

  - `isolation`ï¼šäº‹åŠ¡éš”ç¦»çº§åˆ«

  - `timeout`ï¼šè¶…æ—¶æ—¶é—´

  - `readOnly`ï¼šæ˜¯å¦åªè¯»

  - `rollbackFor`ï¼šå›æ»š

  - `noRollbackFor`ï¼šä¸å›æ»š



#### ä¼ æ’­è¡Œä¸º

+ **äº‹åŠ¡ä¼ æ’­è¡Œä¸º**ï¼šå¤šäº‹åŠ¡æ–¹æ³•ç›´æ¥è¿›è¡Œè°ƒç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­äº‹åŠ¡æ˜¯å¦‚ä½•è¿›è¡Œç®¡ç†çš„ã€‚
+ **äº‹åŠ¡æ–¹æ³•**ï¼šè®©æ•°æ®è¡¨æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ“ä½œã€‚



äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º**å¯ä»¥æœ‰ä¼ æ’­å±æ€§æŒ‡å®š**ã€‚Spring æ¡†æ¶ä¸­å®šä¹‰äº† 7 ç§ç±»ä¼ æ’­è¡Œä¸ºï¼š

| ä¼ æ’­å±æ€§        | æè¿°                                                         |
| --------------- | ------------------------------------------------------------ |
| `REQUIRED`      | å¦‚æœæœ‰äº‹åŠ¡åœ¨è¿è¡Œï¼Œå½“å‰æ–¹æ³•å°±åœ¨æ­¤äº‹åŠ¡å†…è¿è¡Œï¼›å¦åˆ™ï¼Œå°±å¯åŠ¨ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¹¶åœ¨è‡ªå·±çš„äº‹åŠ¡å†…è¿è¡Œ |
| `REQUIRED_NEW`  | å½“å‰æ–¹æ³•å¿…é¡»å¯åŠ¨æ–°äº‹åŠ¡ï¼Œå¹¶åœ¨å®ƒè‡ªå·±çš„äº‹åŠ¡å†…è¿è¡Œï¼›å¦‚æœæœ‰äº‹åŠ¡æ­£åœ¨è¿è¡Œï¼Œåº”è¯¥å°†å®ƒæŒ‚èµ· |
| `SUPPORTS`      | å¦‚æœæœ‰äº‹åŠ¡åœ¨è¿è¡Œï¼Œå½“å‰æ–¹æ³•å°±åœ¨æ­¤äº‹åŠ¡å†…è¿è¡Œï¼›å¦åˆ™ï¼Œå®ƒå¯ä»¥ä¸è¿è¡Œåœ¨äº‹åŠ¡ä¸­ |
| `NOT_SOPPORTED` | å½“å‰æ–¹æ³•ä¸åº”è¯¥è¿è¡Œåœ¨äº‹åŠ¡å†…éƒ¨ï¼Œå¦‚æœæœ‰è¿è¡Œçš„äº‹åŠ¡ï¼Œå°±å°†å®ƒæŒ‚èµ·   |
| `MANDATORY`     | å½“å‰æ–¹æ³•å¿…é¡»è¿è¡Œåœ¨äº‹åŠ¡å†…éƒ¨ï¼Œå¦‚æœæ²¡æœ‰æ­£åœ¨è¿è¡Œçš„äº‹åŠ¡ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ |
| `NEVER`         | å½“å‰æ–¹æ³•ä¸åº”è¯¥è¿è¡Œåœ¨äº‹åŠ¡ä¸­ï¼Œå¦‚æœæœ‰è¿è¡Œçš„äº‹åŠ¡ï¼Œå°±æŠ›å‡ºå¼‚å¸¸     |
| `NESTED`        | å¦‚æœæœ‰äº‹åŠ¡åœ¨è¿è¡Œï¼Œå½“å‰æ–¹æ³•å°±åº”è¯¥åœ¨æ­¤äº‹åŠ¡çš„åµŒå¥—äº‹åŠ¡å†…è¿è¡Œï¼›å¦åˆ™ï¼Œå°±å¯åŠ¨ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¹¶åœ¨å®ƒè‡ªå·±çš„äº‹åŠ¡å†…è¿è¡Œ |



ğŸŒ° ä¾‹å­ï¼š

+ ç°æœ‰æœ‰ä¸¤ä¸ªæ–¹æ³• `add()` å’Œ `update()` ï¼š

```java
@Transactional
public void add(){
    update();
}

public void update(){
    // do something
}
```



+ æŒ‰ç…§ä¸åŒçš„ä¼ æ’­è¡Œä¸ºï¼Œå¯ä»¥æœ‰ä¸¤ç§è§£é‡Šï¼š
  + `REQUIRED` ï¼š:one: å¦‚æœ `add()` æ–¹æ³•æœ¬èº«æœ‰äº‹åŠ¡ï¼Œè°ƒç”¨ `update()` æ–¹æ³•ä¹‹åï¼Œ`update()` ä½¿ç”¨å½“å‰ `add()` æ–¹æ³•é‡Œé¢äº‹åŠ¡ã€‚:two: å¦‚æœ `add()` æ–¹æ³•æœ¬èº«æ²¡æœ‰äº‹åŠ¡ï¼Œè°ƒç”¨ `update()` æ–¹æ³•ä¹‹åï¼Œåˆ›å»ºæ–°çš„äº‹åŠ¡ã€‚:warning: æ˜¯**é»˜è®¤äº‹åŠ¡ä¼ æ’­è¡Œä¸º**ã€‚
  + `REQUIRED_NEW`ï¼šä½¿ç”¨ `add()`  æ–¹æ³•è°ƒç”¨ `update()` æ–¹æ³•ï¼Œæ— è®º `add()` **æ˜¯å¦æœ‰äº‹åŠ¡ï¼Œéƒ½åˆ›å»ºæ–°çš„äº‹åŠ¡**ã€‚



ğŸŒ° ä¾‹å­ï¼š

+ ä¸º `TransferRecordService` è®¾ç½®äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼š

```java
@Service
@Transactional(propagation = Propagation.REQUIRED)
public class TransferRecordService {
    //...
}
```



#### éš”ç¦»çº§åˆ«

å½“ä¸è€ƒè™‘äº‹åŠ¡çš„å››ä¸ªç‰¹æ€§ä¹‹ä¸€éš”ç¦»æ€§æ—¶ï¼Œåœ¨å¹¶å‘æ—¶ä¼šäº§ç”Ÿä¸€ç³»åˆ—çš„é—®é¢˜ã€‚

+ æœ‰ä¸‰ä¸ªå…¸å‹çš„ã€Œè¯»ã€é—®é¢˜ï¼šè„è¯»ã€ä¸å¯é‡å¤è¯»ã€è™šï¼ˆå¹»ï¼‰è¯»ã€‚
  + **è„è¯»**ï¼šä¸€ä¸ªæœªæäº¤äº‹åŠ¡è¯»å–åˆ°äº†å¦ä¸€ä¸ªæœªæäº¤äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®ã€‚
  + **ä¸å¯é‡å¤è¯»**ï¼šä¸€ä¸ªæœªæäº¤äº‹åŠ¡è¯»å–åˆ°äº†å¦ä¸€ä¸ªå·²æäº¤äº‹åŠ¡**ä¿®æ”¹çš„æ•°æ®**ã€‚
  + **è™šï¼ˆå¹»ï¼‰è¯»**ï¼šä¸€ä¸ªæœªæäº¤äº‹åŠ¡è¯»å–åˆ°äº†å¦ä¸€ä¸ªå·²æäº¤äº‹åŠ¡**æ·»åŠ çš„æ•°æ®**ã€‚



+ é€šè¿‡è®¾ç½®éš”ç¦»çº§åˆ«ï¼Œè§£å†³ä¸Šè¿°çš„ã€Œè¯»ã€é—®é¢˜ï¼š

| äº‹åŠ¡éš”ç¦»çº§åˆ«                       | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» |
| ---------------------------------- | ---- | ---------- | ---- |
| `READ UNCOMMITTED`ï¼ˆ**è¯»æœªæäº¤**ï¼‰ | âœ…    | âœ…          | âœ…    |
| `READ COMMITTED`ï¼ˆ**è¯»å·²æäº¤**ï¼‰   | âŒ    | âŒ          | âœ…    |
| `REPEATABLE READ`ï¼ˆ**å¯é‡å¤è¯»**ï¼‰  | âŒ    | âŒ          | âœ…    |
| `SERIALIZABLE`ï¼ˆ**ä¸²è¡ŒåŒ–**ï¼‰       | âŒ    | âŒ          | âŒ    |

> åœ¨ MySQL ä¸­çš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸º `REPEATABLE READ` å¯é‡å¤è¯»ã€‚



ğŸŒ° ä¾‹å­ï¼š

+ ä¸º `TransferRecordService` è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š

```java
@Service
@Transactional(isolation = Isolation.REPEATABLE_READ)
public class TransferRecordService {
    //...
}
```



#### å…¶ä»–å‚æ•°

**`timeout`**ï¼šè®¾ç½®äº‹åŠ¡çš„è¶…æ—¶æ—¶é—´ã€‚

+ äº‹åŠ¡éœ€è¦åœ¨ä¸€å®šçš„æ—¶é—´å†…è¿›è¡Œæäº¤ï¼Œè‹¥è®¾å®šçš„æ—¶é—´å†…äº‹åŠ¡æœªå®Œæˆæäº¤ï¼Œåˆ™å¯¹äº‹åŠ¡è¿›è¡Œå›æ»šã€‚
+ é»˜è®¤å€¼ä¸º `-1`ï¼Œ**è®¾ç½®æ—¶é—´ä»¥ç§’ä¸ºå•ä½**ã€‚



ğŸŒ° ä¾‹å­ï¼š

+ åœ¨ `TransferRecordService` è®¾ç½®äº‹åŠ¡è¶…æ—¶çš„æ—¶é—´ä¸º 5 sã€‚

```java
@Service
@Transactional(timeout = 5)
public class TransferRecordService {
    @Autowired
    private TransferRecordDao transferRecordDao;

    public void transferAccounts(int amount, String fromUser, String toUser) {
        transferRecordDao.transferOut(amount, fromUser);
        //æ¨¡æ‹Ÿå¤„ç†è¶…æ—¶
        try {
            Thread.sleep(6000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        transferRecordDao.transferIn(amount, toUser);
    }
}
```

+ æ­¤æ—¶æäº¤çš„äº‹åŠ¡è¶…è¿‡è®¾ç½®çš„æ—¶é—´ï¼Œåˆ™ä¼šæŠ›å‡º `TransactionTimedOutException` äº‹åŠ¡è¶…æ—¶å¼‚å¸¸ã€‚



**`readOnly`**ï¼šè®¾ç½®åªè¯»å±æ€§ã€‚

+ é»˜è®¤å€¼ `false` ï¼šè¡¨ç¤ºè¯»å†™æ“ä½œéƒ½å…è®¸ï¼Œå¯ä»¥è¿›è¡Œå¢ã€åˆ ã€æŸ¥ã€æ”¹çš„äº‹åŠ¡æ“ä½œã€‚
+ `true`ï¼šè¡¨ç¤ºåªå…è®¸è¿›è¡Œè¯»å–æ“ä½œï¼ˆæŸ¥è¯¢ï¼‰ã€‚



ğŸŒ° ä¾‹å­ï¼š

+ ä¸º `TransferRecordService` è®¾ç½®åªè¯»å±æ€§ï¼š

```java
@Service
@Transactional(readOnly = true)
public class TransferRecordService {
    //...
}
```

+ è®¾ç½®åªè¯»åï¼Œåˆ™ä¼šæŠ›å‡º   `TransientDataAccessResourceException` å³**ç¬æ€æ•°æ®è®¿é—®èµ„æºå¼‚å¸¸**ï¼ŒåŒæ—¶è¿˜ä¼šæŠ›å‡º `SQLException` ï¼Œå¹¶æŒ‡å‡ºè¿æ¥æ˜¯åªè¯»çš„ï¼ŒæŸ¥è¯¢å¯¼è‡´æ•°æ®ä¿®æ”¹æ˜¯ä¸å…è®¸çš„ã€‚



**`rollbackFor`**ï¼šè®¾ç½®å‡ºç°å“ªäº›å¼‚å¸¸æ‰å›æ»šã€‚

ğŸŒ° ä¾‹å­ï¼š

+ ä¸º `TransferRecordService` è®¾ç½®æˆåªæœ‰æŠ›å‡º `ArithmeticException` å¼‚å¸¸æ—¶ï¼Œæ‰ä¼šè¿›è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œã€‚

```java
@Service
@Transactional(rollbackFor = ArithmeticException.class)
public class TransferRecordService {
    @Autowired
    private TransferRecordDao transferRecordDao;

    public void transferAccounts(int amount, String fromUser, String toUser) {
        transferRecordDao.transferOut(amount, fromUser);
        //æ¨¡æ‹Ÿç½‘ç»œå¼‚å¸¸è€Œå¯¼è‡´æ“ä½œä¸­æ–­
        int i = 10 / 0;
        transferRecordDao.transferIn(amount, toUser);
    }
}
```

`noRollbackFor`ï¼šä¸ä¸Šé¢çš„å±æ€§å€¼ç›¸åï¼Œè®¾ç½®å‡ºç°å“ªäº›å¼‚å¸¸ä¸è¿›è¡Œå›æ»šã€‚

ğŸŒ° ä¾‹å­ï¼š

+ ä¸º `TransferRecordService` è®¾ç½®æˆæŠ›å‡º `ArithmeticException` å¼‚å¸¸æ—¶ï¼Œä¸ä¼šè¿›è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œã€‚

```java
@Service
@Transactional(noRollbackFor = ArithmeticException.class)
public class TransferRecordService {
    @Autowired
    private TransferRecordDao transferRecordDao;

    public void transferAccounts(int amount, String fromUser, String toUser) {
        transferRecordDao.transferOut(amount, fromUser);
        //æ¨¡æ‹Ÿç½‘ç»œå¼‚å¸¸è€Œå¯¼è‡´æ“ä½œä¸­æ–­
        int i = 10 / 0;
        transferRecordDao.transferIn(amount, toUser);
    }
}
```



#### å®Œå…¨æ³¨è§£å¼€å‘

+ åˆ›å»ºé…ç½®ç±» `TransactionalConfig` ï¼š

```java
@Configuration // è¡¨ç¤ºæ­¤ç±»ä¸ºé…ç½®ç±»
@ComponentScan(basePackages = "com.simon") // è‡ªåŠ¨æ‰«æåŒ…
@EnableTransactionManagement // å¼€å¯äº‹åŠ¡
@PropertySource(value = {"classpath:jdbc.properties"}) // è¯»å–å¤–éƒ¨æ•°æ®åº“ä¿¡æ¯é…ç½®æ–‡ä»¶
public class TransactionalConfig {
    @Value(value = "${mysql.driverClassName}")
    private String driverClassName;
    @Value(value = "${mysql.url}")
    private String url;
    @Value(value = "${mysql.username}")
    private String username;
    @Value(value = "${mysql.password}")
    private String password;

		// å®Œæ•´çš„é…ç½®æ•°æ®åº“ä¸SqlSessionå®ä¾‹åˆ›å»ºå‚ç…§ä¸Šä¸€èŠ‚ç¬”è®°
  	// ...
  	
    // é…ç½®äº‹åŠ¡ç®¡ç†å™¨
    @Bean
    public DataSourceTransactionManager getDataSourceTransactionManger(DriverManagerDataSource dataSource) {
        DataSourceTransactionManager transactionManager = new DataSourceTransactionManager();
        transactionManager.setDataSource(dataSource);
        return transactionManager;
    }
}
```



ğŸŒ° æµ‹è¯•å®Œå…¨æ³¨è§£å¼€å‘ï¼š

+ ç¼–å†™æµ‹è¯•æ–¹æ³•ï¼š

```java
ApplicationContext context = new AnnotationConfigApplicationContext(TransactionalConfig.class);
TransferRecordService transferRecordService = context.getBean("transferRecordService", TransferRecordService.class);
transferRecordService.transferAccounts(100, "Lucy", "Mary");
```



### ä½¿ç”¨ XML é…ç½®å®ç°å£°æ˜å¼äº‹åŠ¡ç®¡ç†

::: details

åˆ›å»º Spring é…ç½®æ–‡ä»¶ç”¨äºå®ç°å£°æ˜å¼ç®¡ç†ï¼š

+ é…ç½®äº‹åŠ¡ç®¡ç†å™¨ï¼š

```xml
<bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    <property name="dataSource" ref="dataSource"></property>
</bean>
```

+ é…ç½®äº‹åŠ¡é€šçŸ¥

```xml
<tx:advice id="txAdvice">
    <tx:attributes>
        <tx:method name="transferAccounts" propagation="REQUIRED" isolation="REPEATABLE_READ" read-only="false"
                   timeout="5" rollback-for="java.lang.ArithmeticException"/>
    </tx:attributes>
</tx:advice>
```

+ é…ç½®åˆ‡å…¥ç‚¹å’Œåˆ‡é¢ï¼š

```xml
<aop:config>
    <aop:pointcut id="p"
                  expression="execution(* com.simon.service.TransferRecordService.*(..))"/>
    <aop:advisor advice-ref="txAdvice" pointcut-ref="p"></aop:advisor>
</aop:config>
```
