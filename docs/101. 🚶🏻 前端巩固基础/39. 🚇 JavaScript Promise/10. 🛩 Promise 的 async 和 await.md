---
title:  ğŸ›© Promise çš„ async å’Œ await
date: 2022-04-26 23:07:26
permalink: /pages/0eb0a7/
categories:
  -  ğŸš¶ğŸ» å‰ç«¯å·©å›ºåŸºç¡€
  -  ğŸš‡ JavaScript Promise
tags:
  - 
---

ğŸ”— ç›¸å…³é“¾æ¥ ï¼š

+ [asyncå‡½æ•° - JavaScript | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function)
+ [await - JavaScript | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/await)

ç®€è€Œè¨€ä¹‹ï¼Œ `async` / `await` çš„ä½¿ç”¨æ˜¯ æ›´åŠ èˆ’é€‚ä½¿ç”¨ Promise çš„æ–¹å¼ã€‚



### `async` å‡½æ•°

+ è¿”å›å€¼ä¸º Promise å¯¹è±¡
+ Promise å¯¹è±¡çš„ç»“æœ**ç”± `async` å‡½æ•°æ‰§è¡Œçš„è¿”å›å€¼**å†³å®šã€‚

ï¼ˆæ³¨ï¼šä¸ `.then` ç›¸ä¼¼ï¼‰

ä½¿ç”¨ `async` ã€Œä¿®é¥°ã€çš„å‡½æ•°è¡¨ç¤ºï¼šè¿™ä¸ªå‡½æ•°æ€»æ˜¯è¿”å›ä¸€ä¸ª Promise ï¼Œå…¶ä»–å€¼å°†è‡ªåŠ¨è¢«åŒ…è£…åœ¨ä¸€ä¸ª `resolved` çš„ promise ä¸­ã€‚



ğŸŒ° ä¾‹å­ï¼š

```js
async function main(){
    // è¿”å›å€¼ä¸ºépromise
    // return 123 // æˆåŠŸçš„promise
    // è¿”å›çš„æ˜¯promiseå¯¹è±¡
    /*return new Promise((resolve, reject)=>{
        resolve('ok') // ç»“æœç”±è¿™ä¸ªç»“æœå†³å®š
    })*/
    throw "error" 
}

let result = main()
console.log(result)
```



### `await` è¡¨è¾¾å¼

```js
async function func() {
  let value = await promise;
}
```

+ `await` å³ä¾§çš„è¡¨è¾¾å¼ä¸€èˆ¬ä¸º **Promise å¯¹è±¡**ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒçš„å€¼ã€‚
+ å¦‚æœè¡¨è¾¾å¼ä¸º Promise å¯¹è±¡ï¼Œawait è¿”å›çš„æ˜¯ **Promise æˆåŠŸçš„å€¼**ã€‚
+ å¦‚æœè¡¨è¾¾å¼æ˜¯**å…¶ä»–å€¼**ï¼Œ**ç›´æ¥å°†æ­¤å€¼ä½œä¸º `await` çš„è¿”å›å€¼**ã€‚

å…³é”®å­— `await` è®© JavaScript å¼•æ“ç­‰å¾…ç›´åˆ° promise å®Œæˆå¹¶è¿”å›ç»“æœã€‚

æ³¨æ„ï¼š

+ `await` å¿…é¡»å†™åœ¨ `async` å‡½æ•°ä¸­ï¼Œä½† `async` å‡½æ•°ä¸­å¯ä»¥æ²¡æœ‰ `await` ã€‚ï¼ˆ`await` å†™åœ¨æ™®é€šå‡½æ•°ä¸­ä¼šæŠ¥é”™ï¼‰
+ å¦‚æœ `await`  çš„ Promise å¤±è´¥äº†ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è¦é€šè¿‡ `try â€¦ catch â€¦ ` æ•è·å¤„ç†ã€‚

::: tip

`await` å®é™…ä¸Šä¼šæš‚åœå‡½æ•°çš„æ‰§è¡Œï¼Œç›´åˆ° promise çŠ¶æ€å˜ä¸º settledï¼Œç„¶åä»¥ promise çš„ç»“æœç»§ç»­æ‰§è¡Œã€‚è¿™ä¸ªè¡Œä¸ºä¸ä¼šè€—è´¹ä»»ä½• CPU èµ„æºï¼Œå› ä¸º JavaScript å¼•æ“å¯ä»¥åŒæ—¶å¤„ç†å…¶ä»–ä»»åŠ¡ï¼šæ‰§è¡Œå…¶ä»–è„šæœ¬ï¼Œå¤„ç†äº‹ä»¶ç­‰ã€‚

ç›¸æ¯”äº `promise.then`ï¼Œå®ƒåªæ˜¯è·å– promise çš„ç»“æœçš„ä¸€ä¸ªæ›´ä¼˜é›…çš„è¯­æ³•ã€‚å¹¶ä¸”ä¹Ÿæ›´æ˜“äºè¯»å†™ã€‚

:::

ğŸŒ° ä¾‹å­ï¼š

```js
async function main(){
  let p = new Promise((resolve, reject)=>{
    // resolve('ok')
    reject('error')
  })

  // let result = await p; // å³ä¾§ä¸ºpromiseçš„æƒ…å†µ
  // console.log(result);
  // let result2 = await 123; // å³ä¾§ä¸ºå…¶ä»–ç±»å‹
  // console.log(result2);

  try {
    let result3 = await p; // å³ä¾§ä¸ºpromiseå¤±è´¥
  } catch (e) {
    console.warn(e) // è·å–åˆ°å¤±è´¥çš„ç»“æœ
  }
}

main()
```



::: tip

`async` / `await` å¯ä»¥ä¸ `Promis.all` ç»“åˆä½¿ç”¨ï¼šå½“éœ€è¦åŒæ—¶ç­‰å¾…å¤šä¸ª   promise æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `Promise` åŒ…è£…èµ·æ¥ï¼Œç„¶åä½¿ç”¨ `await`ï¼š

```js
let results = await Promise.all([
  fetch(url1),
  fetch(url2),
  ...
]);
```

> å¦‚æœå‡ºç° errorï¼Œä¹Ÿä¼šæ­£å¸¸ä¼ é€’ï¼Œä»å¤±è´¥äº†çš„ promise ä¼ åˆ° `Promise.all`ï¼Œç„¶åå˜æˆèƒ½é€šè¿‡ä½¿ç”¨ `try..catch` åœ¨è°ƒç”¨å‘¨å›´æ•è·åˆ°çš„å¼‚å¸¸ã€‚

::: 



### `async` ä¸ `await` ç»“åˆ

ğŸŒ° ä¾‹å­ï¼ˆè¯»å–æ–‡ä»¶ï¼‰ï¼š

```js
const fs = require('fs')
const util = require('util')
const mineReadFile = util.promisify(fs.readFile)

// ä½¿ç”¨asyncä¸await
async function main() {
    try {
        let data1 = await mineReadFile('./resource/1.html')
        let data2 = await mineReadFile('./resource/2.html')
        let data3 = await mineReadFile('./resource/3.html')
        console.log(data1 + data2 + data3)
    } catch (err) {
        console.warn(err)
    }

}

main()
```

+ ç›¸æ¯”äºä½¿ç”¨å›è°ƒå‡½æ•°å®ç°ï¼Œå‡å°‘å†™æŠ›å‡ºå¼‚å¸¸ `try-catch` ç»“æ„ã€‚
+ åœ¨ `async` ä¸ `await` ç»“åˆåï¼Œå°‘ç”¨å›è°ƒå‡½æ•°ã€‚



ğŸŒ° ä¾‹å­ï¼ˆå‘é€ AJAX è¯·æ±‚ï¼‰ï¼š

```html
<button id="btn">è·å–</button>

<script>
    function sendAJAX(url) {
        return new Promise((resolve, reject)=>{
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url)
            xhr.send();
            xhr.onreadystatechange = function () {
                if(xhr.readyState === 4) {
                    if(xhr.status >= 200 && xhr.status < 300) {
                        // æˆåŠŸè¯·æ±‚
                        resolve(xhr.response)
                    } else {
                        // å¤±è´¥è¯·æ±‚
                        reject(xhr.status)
                    }
                }
            }
        })
    }

    let btn = document.querySelector("#btn")
    btn.addEventListener('click', async function(){
        let text = await sendAJAX('https://api.apiopen.top/getJoke')
        console.log(text)
    })

</script>
```



## æ€»ç»“

+ `async` å…³é”®å­—å¯¹å‡½æ•°çš„ä½œç”¨ï¼š
  + è®©è¿™ä¸ªå‡½æ•°æ€»æ˜¯è¿”å›ä¸€ä¸ª promiseã€‚
  + å…è®¸åœ¨è¯¥å‡½æ•°å†…ä½¿ç”¨ `await`ã€‚

+ Promise å‰çš„å…³é”®å­— `await` ä½¿ JavaScript å¼•æ“ç­‰å¾…è¯¥ promise ç¡®å®šçŠ¶æ€ï¼Œç„¶åï¼š
  1. å¦‚æœæœ‰ errorï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ ï¼Œå°±åƒé‚£é‡Œè°ƒç”¨äº† `throw error` ä¸€æ ·ã€‚
  2. å¦åˆ™ï¼Œå°±è¿”å›ç»“æœã€‚
