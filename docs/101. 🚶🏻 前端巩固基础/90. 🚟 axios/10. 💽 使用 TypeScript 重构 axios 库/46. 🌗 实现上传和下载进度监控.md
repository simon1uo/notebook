---
title:  ğŸŒ— å®ç°ä¸Šä¼ å’Œä¸‹è½½è¿›åº¦ç›‘æ§
date: 2022-06-17 14:43:23
permalink: /pages/2871e0/
categories:
  -  ğŸš¶ğŸ» å‰ç«¯å·©å›ºåŸºç¡€
  -  ğŸšŸ axios
  -  ğŸ’½ ä½¿ç”¨ TypeScript é‡æ„ axios åº“
tags:
  - 
---
## éœ€æ±‚åˆ†æ

å½“éœ€è¦ä¸Šä¼ æ–‡ä»¶æˆ–è€…è¯·æ±‚ä¸€ä¸ªå¤§ä½“ç§¯æ•°æ®æ—¶ï¼Œå¸Œæœ›çŸ¥é“å®æ—¶çš„è¿›åº¦ï¼Œæˆ–è€…ä¸€ä¸ªè¿›åº¦æ¡å±•ç¤ºã€‚

å¯ä»¥ç»™ `axios` çš„è¯·æ±‚é…ç½®æä¾›ä¸€ä¸ª `onDownloadProgress` å’Œ `onUploadProgress` ä¸¤ä¸ªå‡½æ•°å±æ€§ï¼Œç”¨æˆ·é€šè¿‡è¿™ä¸¤ä¸ªå‡½æ•°å®ç°å¯¹ä¸‹è½½è¿›åº¦å’Œä¸Šä¼ è¿›åº¦çš„ç›‘æ§ã€‚

> ä¾‹å¦‚ï¼š
>
> ```typescript
> axios.get('/more/get',{
>   onDownloadProgress(progressEvent) {
>     // ç›‘å¬ä¸‹è½½è¿›åº¦
>   }
> })
> 
> axios.post('/more/post',{
>   onUploadProgress(progressEvent) {
>     // ç›‘å¬ä¸Šä¼ è¿›åº¦
>   }
> })
> ```



`xhr` å¯¹è±¡æä¾›äº†ä¸€ä¸ª `progress` äº‹ä»¶ï¼Œå¯ä»¥é€šè¿‡ç›‘å¬è¿™ä¸ªäº‹ä»¶å¯¹æ•°æ®çš„ä¸‹è½½è¿›åº¦åšç›‘æ§ã€‚å¦å¤–ï¼Œ`xhr.upload` å¯¹è±¡ä¹Ÿæä¾›äº† `progress` äº‹ä»¶ï¼Œå¯ä»¥åŸºäºæ­¤å¯¹ä¸Šä¼ è¿›åº¦åšç›‘æ§ã€‚



## ä»£ç å®ç°

ä¿®æ”¹ `AxiosRequestConfig` çš„ç±»å‹å®šä¹‰ï¼Œ`src/types/index.ts`ï¼š

```typescript
export interface AxiosRequestConfig {
 	// ... 
  onDownloadProgress?: (e: ProgressEvent) => void
  onUploadProgress?: (e: ProgressEvent) => void
}
```



ç„¶åä¿®æ”¹ `src/core/xhr.ts` ï¼Œåœ¨å‘é€è¯·æ±‚ä¹‹å‰ï¼Œç»™ `xhr` å¯¹è±¡æ·»åŠ å±æ€§ï¼š

```typescript
export default function xhr(config: AxiosRequestConfig): AxiosPromise {
  return new Promise((resolve, reject) => {
    const {
      // ...
      onDownloadProgress,
      onUploadProgress
    } = config

    // ...
    
    if(onDownloadProgress) {
      request.onprogress = onDownloadProgress
    }
    
    if(onUploadProgress) {
      request.onprogress = onUploadProgress
    }
  }
}
```



å¦å¤–ï¼Œå¦‚æœè¯·æ±‚çš„æ•°æ®æ˜¯ `FormData` ç±»å‹ï¼Œåº”è¯¥ä¸»åŠ¨åˆ é™¤è¯·æ±‚ `headers` ä¸­çš„ `Content-Type` å­—æ®µï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨æ ¹æ®è¯·æ±‚æ•°æ®è®¾ç½® `Content-Type`ã€‚æ¯”å¦‚å½“é€šè¿‡ `FormData` ä¸Šä¼ æ–‡ä»¶çš„æ—¶å€™ï¼Œæµè§ˆå™¨ä¼šæŠŠè¯·æ±‚ `headers` ä¸­çš„ `Content-Type` è®¾ç½®ä¸º `multipart/form-data`ã€‚

å…ˆæ·»åŠ ä¸€ä¸ªåˆ¤æ–­ `FormData` çš„æ–¹æ³•ï¼Œåœ¨ `src/helpers/util.ts`ï¼š

```typescript
export function isFormData(val: any): boolean {
  return typeof val !== 'undefined' && val instanceof FormData
}
```

ç„¶åå†æ·»åŠ é€»è¾‘åˆ° `src/core/xhr.ts`ï¼š

```typescript
if(isFormData(data)) {
  delete headers['Content-Type']
}
```



`xhr.ts` éšç€éœ€æ±‚è¶Šæ¥è¶Šå¤šï¼Œä»£ç è¶Šæ¥è¶Šè‡ƒè‚¿ï¼Œå¯ä»¥æŠŠé€»è¾‘æ¢³ç†ä¸€ä¸‹ï¼ŒæŠŠå†…éƒ¨ä»£ç åšä¸€å±‚å°è£…ä¼˜åŒ–ã€‚

::: details

```typescript
import { AxiosPromise, AxiosRequestConfig, AxiosResponse } from '../types'
import { parseHeaders } from '../helpers/headers'
import { createError } from '../helpers/error'
import { isURLSameOrigin } from '../helpers/url'
import cookie from '../helpers/cookie'
import { isFormData } from '../helpers/util'

export default function xhr(config: AxiosRequestConfig): AxiosPromise {
  return new Promise((resolve, reject) => {
    const {
      data = null,
      url,
      method = 'get',
      headers,
      responseType,
      timeout,
      cancelToken,
      withCredentials,
      xsrfCookieName,
      xsrfHeaderName,
      onDownloadProgress,
      onUploadProgress
    } = config

    const request = new XMLHttpRequest()

    request.open(method.toUpperCase(), url, true)

    configureRequest()
    addEvents()
    processHeaders()
    processCancel()

    request.send(data)

    function configureRequest(): void {
      if (responseType) {
        request.responseType = responseType
      }

      if (timeout) {
        request.timeout = timeout
      }

      if (withCredentials) {
        request.withCredentials = true
      }
    }

    function addEvents(): void {
      request.onreadystatechange = function handleLoad() {
        if (request.readyState !== 4) return
        if (request.status === 0) return

        const responseHeaders = parseHeaders(request.getAllResponseHeaders())
        const responseData =
          responseType && responseType !== 'text' ? request.response : request.responseText
        const response: AxiosResponse = {
          data: responseData,
          status: request.status,
          statusText: request.statusText,
          headers: responseHeaders,
          config,
          request
        }

        handleResponse(response)
      }

      request.onerror = function handleError() {
        reject(createError('Network Error', config, null, request))
      }

      request.ontimeout = function handleTimeout() {
        reject(createError(`Timeout of ${timeout} ms exceeded`, config, 'ECONNABORTED', request))
      }

      if (onDownloadProgress) {
        request.onprogress = onDownloadProgress
      }

      if (onUploadProgress) {
        request.onprogress = onUploadProgress
      }
    }

    function processHeaders(): void {
      if (isFormData(data)) {
        delete headers['Content-Type']
      }

      if ((withCredentials || isURLSameOrigin(url!)) && xsrfCookieName) {
        const xsrfValue = cookie.read(xsrfCookieName)
        if (xsrfValue) headers[xsrfHeaderName!] = xsrfValue
      }

      Object.keys(headers).forEach(name => {
        if (data === null && name.toLowerCase() === 'content-type') {
          delete headers[name]
        } else {
          request.setRequestHeader(name, headers[name])
        }
      })
    }

    function processCancel(): void {
      if (cancelToken) {
        cancelToken.promise.then(reason => {
          request.abort()
          reject(reason)
        })
      }
    }

    function handleResponse(response: AxiosResponse) {
      if (response.status >= 200 && response.status < 300) {
        resolve(response)
      } else {
        reject(
          createError(
            `Request failed with status code ${response.status}`,
            config,
            null,
            request,
            response
          )
        )
      }
    }
  })
}
```

> æŠŠæ•´ä¸ªæµç¨‹åˆ†ä¸º 7 éƒ¨ï¼š
>
> + åˆ›å»ºä¸€ä¸ª `request` å®ä¾‹ã€‚
> + æ‰§è¡Œ `request.open` æ–¹æ³•åˆå§‹åŒ–ã€‚
> + æ‰§è¡Œ `configureRequest` é…ç½® `request` å¯¹è±¡ã€‚
> + æ‰§è¡Œ `addEvents` ç»™ `request` æ·»åŠ äº‹ä»¶å¤„ç†å‡½æ•°ã€‚
> + æ‰§è¡Œ `processHeaders` å¤„ç†è¯·æ±‚ `headers`ã€‚
> + æ‰§è¡Œ `processCancel` å¤„ç†è¯·æ±‚å–æ¶ˆé€»è¾‘ã€‚
> + æ‰§è¡Œ `request.send` æ–¹æ³•å‘é€è¯·æ±‚ã€‚

:::



## ç¼–å†™æµ‹è¯• DEMO

`examples/more/index.html`ï¼š

```html
<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <title>more example</title>
  <link rel='stylesheet' type='text/css'
        href='//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css' />
</head>
<body>
<h1>file download</h1>
<div>
  <button id='download' class='btn btn-primary'>download</button>
</div>

<h1>file upload</h1>
<div>
  <form role='form' class='form' onsubmit='return false'>
    <input type='file' id='title' class='form-control'>
    <button id='upload' class='btn btn-primary'>upload</button>
  </form>
</div>
<script src='/__build__/more.js'></script>
</body>
</html>
```

> æ·»åŠ ä¸‹è½½æŒ‰é’®å’Œä¸Šä¼ è¡¨å•ã€‚



`examples/more/app.ts`ï¼Œä¸ºäº†å±•ç¤ºä¸Šä¼ å’Œä¸‹è½½çš„è¿›åº¦ï¼Œå¼•å…¥ `nprogress	` ï¼Œåœ¨é¡µé¢çš„é¡¶éƒ¨å±•ç¤ºè¿›åº¦æ¡ï¼š

```typescript
const instance = axios.create()

function calculatePercentage(loaded: number, total: number) {
  return Math.floor(loaded * 1.0) / total
}

function loadProgressbar() {
  const setupStartProgress = () => {
    instance.interceptors.request.use(config => {
      NProgress.start()
      return config
    })
  }

  const setupUpdateProgress = () => {
    const update = (e: ProgressEvent) => {
      console.log(e)
      NProgress.set(calculatePercentage(e.loaded, e.total))
    }

    instance.defaults.onDownloadProgress = update
    instance.defaults.onUploadProgress = update
  }

  const setupStopProgress = () => {
    instance.interceptors.response.use(response => {
      NProgress.done()
      return response
    }, error => {
      NProgress.done()
      return Promise.reject(error)
    })
  }

  setupStartProgress()
  setupUpdateProgress()
  setupStopProgress()
}

loadProgressbar()

const downloadEl = document.getElementById('download')
downloadEl!.addEventListener('click', e => {
  instance.get('https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/jSQm90.jpeg')
})

const uploadEl = document.getElementById('upload')
uploadEl!.addEventListener('click', e => {
  const data = new FormData()
  const fileEl = document.getElementById('file') as HTMLInputElement
  if(fileEl.files) {
    data.append('file', fileEl.files[0])

    instance.post('/more/upload', data)
  }
})
```

> å¯¹äº `progress` äº‹ä»¶å‚æ•° `e`ï¼Œä¼šæœ‰ `e.total` å’Œ `e.loaded` å±æ€§ï¼Œè¡¨ç¤ºè¿›ç¨‹æ€»ä½“çš„å·¥ä½œé‡å’Œå·²ç»æ‰§è¡Œçš„å·¥ä½œé‡ï¼Œå¯ä»¥æ ¹æ®è¿™ 2 ä¸ªå€¼ç®—å‡ºå½“å‰è¿›åº¦ï¼Œç„¶åé€šè¿‡ `Nprogess.set` è®¾ç½®ã€‚å¦å¤–ï¼Œé€šè¿‡é…ç½®è¯·æ±‚æ‹¦æˆªå™¨å’Œå“åº”æ‹¦æˆªå™¨æ‰§è¡Œ `NProgress.start()` å’Œ `NProgress.done()`ã€‚
>
> ç»™ä¸‹è½½æŒ‰é’®ç»‘å®šäº†ä¸€ä¸ª `click` äº‹ä»¶ï¼Œè¯·æ±‚ä¸€å¼ å›¾ç‰‡ï¼Œå¯ä»¥çœ‹åˆ°å®æ—¶çš„è¿›åº¦ï¼›å¦å¤–ä¹Ÿç»™ä¸Šä¼ æŒ‰é’®ç»‘å®šäº†ä¸€ä¸ª `click` äº‹ä»¶ï¼Œä¸Šä¼ é€‰æ‹©çš„æ–‡ä»¶ï¼ŒåŒæ ·ä¹Ÿèƒ½çœ‹åˆ°å®æ—¶è¿›åº¦ã€‚



ä¸ºäº†å¤„ç†ä¸Šä¼ è¯·æ±‚ï¼Œéœ€è¦ä¸‹è½½å®‰è£…ä¸€ä¸ª `express` çš„ä¸­é—´ä»¶ `connect-multiparty`ï¼Œç„¶åä½¿ç”¨å®ƒã€‚

`examples/server.js`ï¼š

```typescript
const multipart = require('connect-multiparty')
app.use(multipart({
  uploadDir: path.resolve(__dirname, 'upload-file')
}))

router.post('more/upload', function(req, res) {
  console.log(req.body, req.files)
  res.end('upload success!')
})
```

> éœ€è¦åœ¨ `examples` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ `upload-file` ä½œä¸ºä¸Šä¼ æ–‡ä»¶çš„å­˜å‚¨ç›®å½•ã€‚é€šè¿‡è¿™ä¸ªä¸­é—´ä»¶ï¼Œå°±å¯ä»¥å¤„ç†ä¸Šä¼ è¯·æ±‚å¹¶ä¸”å¯ä»¥æŠŠä¸Šä¼ çš„æ–‡ä»¶å­˜å‚¨åœ¨ `upload-file` ç›®å½•ä¸‹ã€‚
>
> ä¸ºäº†ä¿è¯ä»£ç æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ `examples/webpack.config.js` ä¸­æ·»åŠ  `css-loader` å’Œ `css-loader`ï¼Œä¸è¦å¿˜è®°å…ˆå®‰è£…å®ƒä»¬ã€‚
>
> ```js
> {
>   test: /\.css?$/,
>   use: [
>     {
>       loader: ['style-loader', 'css-loader']
>     }
>   ]
> }
> ```

