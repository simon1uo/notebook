---
title:  ğŸŒ˜ å®ç°å¼‚å¸¸æƒ…å†µå¤„ç†
date: 2022-06-11 16:34:09
permalink: /pages/3de0b0/
categories:
  -  ğŸš¶ğŸ» å‰ç«¯å·©å›ºåŸºç¡€
  -  ğŸšŸ axios
  -  ğŸ’½ ä½¿ç”¨ TypeScript é‡æ„ axios åº“
tags:
  - 
---
## éœ€æ±‚åˆ†æ

å‰é¢å®ç°äº†è¯·æ±‚çš„åŸºæœ¬éœ€æ±‚åŠŸèƒ½ã€‚ç›®å‰ä¸ºæ­¢ï¼Œéƒ½æ˜¯å¤„ç†äº†æ­£å¸¸æ¥æ”¶è¯·æ±‚çš„é€»è¾‘ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘ä»»ä½•é”™è¯¯æƒ…å†µï¼Œæ‰€ä»¥å¯¹äºè¿™ä¸ªç¨‹åºçš„å¥å£®æ€§ä¸å¤Ÿï¼Œå› æ­¤éœ€è¦å¯¹ AJAX çš„å„ç§æƒ…å†µä½œå¤„ç†ã€‚

ç¨‹åºèƒ½å¤Ÿæ•è·åˆ°è¿™äº›é”™è¯¯ï¼Œå¹¶ä¸”åšè¿›ä¸€æ­¥çš„å¤„ç†ï¼š

```typescript
axios({
  method: 'get',
  url: 'error/get'
}).then(res => {
  console.log(res)
}).catch(e => {
  console.log(e)
})
```

å¦‚æœè¯·æ±‚çš„è¿‡ç¨‹ä¸­å‘ç”Ÿä»»ä½•å¤„ç†ï¼Œéƒ½å¯ä»¥åœ¨ `reject` å›è°ƒå‡½æ•°ä¸­æ•è·åˆ°ã€‚



å°†é”™è¯¯åˆ†ä¸ºå‡ ç±»å¤„ç†ã€‚

## å¤„ç†ç½‘ç»œå¼‚å¸¸é”™è¯¯

å½“ç½‘ç»œå‡ºç°å¼‚å¸¸æ—¶ï¼Œå‘é€è¯·æ±‚ä¼šè§¦å‘ `XMLHttpRequest` å¯¹è±¡å®ä¾‹ä¸­çš„ `error` äº‹ä»¶æ—¶ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ `onerror` ä¸­æ•è·ï¼š

åœ¨ `src/xhr.ts` ä¸­æ·»åŠ ï¼š

```typescript
export default function xhr(config: AxiosRequestConfig): AxiosPromise {
  return new Promise((resolve, reject) => {
    // ...
    
    request.onerror = function handleError() {
      reject(new Error('Network Error'))
    }
    
    // ... 
}
```



## å¤„ç†è¯·æ±‚è¶…æ—¶é”™è¯¯

å¯ä»¥è®¾ç½®æŸä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ `timeout`ï¼Œä¹Ÿå°±æ˜¯å½“è¯·æ±‚å‘é€åè¶…è¿‡æŸä¸ªæ—¶é—´åä»ç„¶æ²¡æœ‰æ”¶åˆ°å“åº”ï¼Œåˆ™è¯·æ±‚è‡ªåŠ¨ç»ˆæ­¢ï¼Œå¹¶ä¸”è§¦å‘ `timeout` äº‹ä»¶ã€‚

è¯·æ±‚é»˜è®¤çš„è¶…æ—¶æ—¶é—´ä¸º 0ï¼Œå³æ°¸ä¸è¶…æ—¶ï¼›

é¦–å…ˆå…ˆåœ¨ `AxiosRequestConfig` ç±»å‹ä¸­æ·»åŠ å¯é€‰é…ç½®å­—æ®µ `timeout`ï¼š

```typescript
export interface AxiosRequestConfig {
 	timeout?: number
}
```

ç„¶ååœ¨ `src/xhr.ts` ä¸­æ·»åŠ ï¼š

```typescript
export default function xhr(config: AxiosRequestConfig): AxiosPromise {
  return new Promise((resolve, reject) => {
    const { data = null, url, method = 'get', headers, responseType, timeout } = config

    // ... 
    
    if (timeout) {
      request.timeout = timeout
    }

    //... 
    
    request.ontimeout = function handleTimeout() {
      reject(new Error(`Timeout of ${timeout} ms exceeded`))
    }
    
    // ...
}
```



## å¤„ç†é `200` çŠ¶æ€ç 

å¯¹äºä¸€ä¸ªæ­£å¸¸çš„è¯·æ±‚ï¼Œå¾€å¾€ä¼šè¿”å› 200-300 ä¹‹é—´çš„ HTTP çŠ¶æ€ç ï¼Œå¯¹äºä¸åœ¨è¿™ä¸ªåŒºé—´çš„çŠ¶æ€ç ï¼Œä¹ŸæŠŠå®ƒä»¬è®¤ä¸ºæ˜¯ä¸€ç§é”™è¯¯çš„æƒ…å†µåšå¤„ç†ã€‚

åœ¨ `src/xhr.ts` å‡½æ•°ä¸­æ·»åŠ  çŠ¶æ€ç çš„å¤„ç†ï¼š

```typescript
request.onreadystatechange = function handleLoad() {
  if(request.readyState !== 4) {
    return
  }

  const responseHeaders = parseHeaders(request.getAllResponseHeaders())
  const responseData = responseType && responseType !== 'text' ? request.response : request.responseText
  const response: AxiosResponse = {
    data: responseData,
    status: request.status,
    statusText: request.statusText,
    headers: responseHeaders,
    config,
    request
  }
  
  handleResponse(response)
}

function handleResponse(response: AxiosResponse) {
  if(response.status >= 200 && response.status < 300) {
    resolve(response)
  } else {
    reject(new Error(`Request failed with status code ${response.status}`))
  }
}
```

> + åœ¨ `onreadystatechange` çš„å›è°ƒå‡½æ•°ä¸­ï¼Œæ·»åŠ äº†å¯¹ `request.status` çš„åˆ¤æ–­ï¼Œå› ä¸ºå½“å‡ºç°ç½‘ç»œé”™è¯¯æˆ–è€…è¶…æ—¶é”™è¯¯çš„æ—¶å€™ï¼Œè¯¥å€¼éƒ½ä¸º 0ã€‚
>
> + åœ¨ `handleResponse` å‡½æ•°ä¸­å¯¹ `request.status` çš„å€¼å†æ¬¡åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ `2xx` çš„çŠ¶æ€ç ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªæ­£å¸¸çš„è¯·æ±‚ï¼Œå¦åˆ™æŠ›é”™ï¼›



## ç¼–å†™æµ‹è¯• DEMO

åœ¨ `examples` ç›®å½•ä¸‹åˆ›å»º `error` ç›®å½•ï¼š

`example/error/index.html`ï¼š

```html
<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <title>base example</title>
</head>
<body>
<script src='/__build__/base.js'></script>
</body>
</html>
```



`examples/erorr/app.ts`

```typescript
import axios from '../../src/index'

axios({
  method: 'get',
  url: '/error/get1'
})
  .then(res => {
    console.log(res)
  })
  .catch(e => {
    console.log(e)
  })

axios({
  method: 'get',
  url: '/error/get'
})
  .then(res => {
    console.log(res)
  })
  .catch(e => {
    console.log(e)
  })

setTimeout(() => {
  axios({
    method: 'get',
    url: '/error/get'
  })
    .then(res => {
      console.log(res)
    })
    .catch(e => {
      console.log(e)
    })
}, 5000)

axios({
  method: 'get',
  url: '/error/timeout',
  timeout: 2000
})
  .then(res => {
    console.log(res)
  })
  .catch(e => {
    console.log(e.message)
  })
```

 

åœ¨ `examples/server.js` ä¸­æ·»åŠ  `router`ï¼š

```js
router.get('/error/get', function(req,res) {
  if(Math.random() > 0.5) {
    res.json( {
      msg: 'hello world'
    })
  } else {
    res.status(500)
    res.end()
  }
})

router.get('/error/timeout', function(req, res) {
  setTimeout(()=>{
    res.json({
      msg: 'hello world'
    })
  }, 3000)
})
```

> é€šè¿‡å¼€å‘è€…å·¥å…·çš„ network éƒ¨åˆ†æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸åŒçš„é”™è¯¯æƒ…å†µã€‚
>
> è‡³æ­¤å¯¹å„ç§é”™è¯¯éƒ½åšäº†å¤„ç†ï¼Œå¹¶æŠŠå®ƒä»¬æŠ›ç»™äº†ç¨‹åºåº”ç”¨æ–¹ï¼Œè®©ä»–ä»¬å¯¹é”™è¯¯å¯ä»¥åšè¿›ä¸€æ­¥çš„å¤„ç†ã€‚
>
> ä½†æ˜¯è¿™é‡Œçš„é”™è¯¯éƒ½ä»…ä»…æ˜¯ç®€å•çš„ Error å®ä¾‹ï¼Œåªæœ‰é”™è¯¯æ–‡æœ¬ä¿¡æ¯ï¼Œå¹¶ä¸åŒ…å«æ˜¯å“ªä¸ªè¯·æ±‚ã€è¯·æ±‚çš„é…ç½®ã€å“åº”å¯¹è±¡ç­‰å…¶å®ƒä¿¡æ¯ã€‚éœ€è¦å¯¹é”™è¯¯ä¿¡æ¯å¢å¼ºï¼›



## éœ€æ±‚åˆ†æ

æŠ›å‡ºçš„é”™è¯¯ä¸èƒ½åªæ˜¯ä¸€ä¸ªç®€å•çš„æ–‡æœ¬ä¿¡æ¯ï¼Œåº”è¯¥åŒ…æ‹¬è¯·æ±‚çš„å¯¹è±¡é…ç½® `config`ã€é”™è¯¯ä»£ç  `code`ã€`XMLHttpRequest` å¯¹è±¡å®ä¾‹ `request` ä»¥åŠè‡ªå®šä¹‰å¯¹è±¡ `response`ã€‚å¦‚ä¸‹ï¼š

```typescript
axios({
  method: 'get',
  url: '/error/timeout',
  timeout: 2000
}).then((res) => {
  console.log(res)
}).catch((e: AxiosError) => {
  console.log(e.message)
  console.log(e.request)
  console.log(e.code)
})
```

> è¿™æ ·å¯¹äºåº”ç”¨æ–¹æ¥è¯´ï¼Œä»–ä»¬å°±å¯ä»¥æ•è·åˆ°è¿™äº›é”™è¯¯çš„è¯¦ç»†ä¿¡æ¯ï¼Œåšè¿›ä¸€æ­¥çš„å¤„ç†ã€‚



## åˆ›å»º `AxiosError` ç±»å‹æ¥å£

åœ¨ `src/type/index.ts` ä¸­æ·»åŠ  `AxiosError` ç±»å‹æ¥å£ï¼š

```typescript
export interface AxiosError extends Error {
  config: AxiosRequestConfig
  code?: number
  request?: any
  response?: AxiosResponse
  isAxiosError: Boolean
}
```



ç„¶ååˆ›å»º `src/helpers/erorr.ts` æ–‡ä»¶ï¼Œåˆ›å»º `AxiosError` ç±»ï¼Œç»§æ‰¿äº `Error`ï¼š

```typescript
import { AxiosRequestConfig, AxiosResponse } from '../types'

export class AxiosError extends Error {
  isAxiosError: boolean
  config: AxiosRequestConfig
  code?: string | null
  request?: any
  response?: AxiosResponse

  constructor(
    message: string,
    config: AxiosRequestConfig,
    code: string | null,
    request: any,
    response: AxiosResponse
  ) {
    super(message)

    this.isAxiosError = true
    this.config = config
    this.code = code
    this.request = request
    this.response = response

    Object.setPrototypeOf(this, AxiosError.prototype)
  }
}

export function createError(
  message: string,
  config: AxiosRequestConfig,
  code?: string | null,
  request?: any,
  response?: AxiosResponse
): AxiosError {
  return new AxiosError(message, config, code, request, response)
}
```

> + ä½¿ç”¨ `Object.setPrototypeOf(this, AxiosError.prototype)` è§£å†³ TypeScript ç»§æ‰¿å†…ç½®å¯¹è±¡æ—¶å¯èƒ½é‡åˆ°çš„é—®é¢˜ã€‚[TypeScript-wiki/Breaking-Changes.md at main Â· microsoft/TypeScript-wiki (github.com)](https://github.com/Microsoft/TypeScript-wiki/blob/main/Breaking-Changes.md#extending-built-ins-like-error-array-and-map-may-no-longer-work)
> + `AxiosError` ç»§æ‰¿äº `Error` ç±»ï¼Œæ·»åŠ äº†ä¸€äº›è‡ªå·±çš„å±æ€§ï¼š`config`ã€`code`ã€`request`ã€`response`ã€`isAxiosError` ç­‰å±æ€§ã€‚
> + ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œå¯¹å¤–æš´éœ²ä¸€ä¸ª `createError` æ–¹æ³•åˆ›å»º `AxiosError` ç±»çš„å®ä¾‹ã€‚ 



## åº”ç”¨æ–¹æ³• `createError`

ä¿®æ”¹ `scr/xhr.ts` ä¸­ `xhr` å‡½æ•°ä¸­çš„å¤„ç†é”™è¯¯é€»è¾‘ï¼š

```typescript
function handleResponse(response: AxiosResponse) {
  if (response.status >= 200 && response.status < 300) {
    resolve(response)
  } else {
    reject(
      createError(
        `Request failed with status code ${response.status}`,
        config,
        null,
        request,
        response
      )
    )
  }
}

request.onerror = function handleError() {
  reject(createError('Network Error', config, null, request))
}

request.ontimeout = function handleTimeout() {
  reject(createError(`Timeout of ${timeout} ms exceeded`, config, 'ECONNABORTED', request))
}
```



## å¯¼å‡ºç±»å‹å®šä¹‰

ç”±äºåœ¨ DEMO ä¸­ï¼Œ TypeScript ä¸èƒ½æŠŠ `e` å‚æ•°æ¨æ–­ä¸º `AxiosError` ç±»å‹ï¼Œéœ€è¦æ‰‹åŠ¨çŸ¥åç±»å‹ï¼Œä¸ºäº†è®©å¤–éƒ¨åº”ç”¨èƒ½å¼•å…¥ `AxiosError` ç±»å‹ï¼Œéœ€è¦å°†å®ƒä»¬å¯¼å‡ºã€‚

åˆ›å»º `axios.ts` æ–‡ä»¶ï¼ŒæŠŠä¹‹å‰ `index.ts` çš„ä»£ç æ‹·è´è¿‡å»ï¼Œä½œä¸º `aixos` çš„ä¸»è¦é€»è¾‘ï¼›ä¿®æ”¹ `index.ts` ä¸ºå¯¼å‡ºæ–‡ä»¶ï¼š

`src/index.ts`ï¼š

```typescript
import axios from './axios'

export * from './types'

export default axios
```

è¿™æ ·åœ¨ DEMO ä¸­å°±å¯ä»¥å¼•ç”¨ `AxiosError` ç±»å‹äº†ã€‚



å¦‚ä¸‹ï¼Œ`examples/error/app.ts`ï¼š

```typescript
import axios, { AxiosError } from '../../src/index'

axios({
  method: 'get',
  url: '/error/get1'
}).then(res => {
  console.log(res)
}).catch((e: AxiosError) => {
  console.log(e)
})
```

