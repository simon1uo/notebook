---
title:  ğŸŒ’ å®ç°å¤„ç†è¯·æ±‚ URL å‚æ•°
date: 2022-06-10 22:25:28
permalink: /pages/2c5ed7/
categories:
  -  ğŸš¶ğŸ» å‰ç«¯å·©å›ºåŸºç¡€
  - ğŸšŸ axios
  -  ğŸ’½ ä½¿ç”¨ TypeScript é‡æ„ axios åº“
  -  ğŸŒ’ åŸºç¡€åŠŸèƒ½å®ç°
tags:
  - 
---
## éœ€æ±‚åˆ†æ

æ ¹æ®ä¸åŒçš„ URL params å‚æ•°æœ‰ä¸åŒçš„æƒ…å†µåˆ†æï¼š

+ æ™®é€šå‚æ•°ï¼š

  ```typescript
  axios({
    method: 'get',
    url: '/base/get',
    params: {
      a: 1,
      b: 2
    }
  })
  ```

  æœ€ç»ˆè¯·æ±‚ URL ä¸ºï¼š`/base/get?a=1&b=2`ï¼Œè¿™æ ·æœåŠ¡å™¨å°±å¯ä»¥é€šè¿‡è¯·æ±‚ URL è§£æåˆ°ä¼ é€çš„å‚æ•°æ•°æ®ã€‚å®é™…ä¸Šå°±æ˜¯æŠŠ `params` å¯¹è±¡ä¸­çš„ `key` å’Œ `value` æ‹¼æ¥åˆ° URL ä¸Šã€‚

+ å‚æ•°å€¼ä¸ºæ•°ç»„æ—¶ï¼š

  ```typescript
  axios({
    method: 'get',
    url: '/base/get',
    params: {
      foo: ['bar', 'baz']
    }
  })
  ```

  æœ€ç»ˆè¯·æ±‚ URL ä¸ºï¼š`/base/get?foo[]=bar&foo[]=baz`ï¼›

+ å‚æ•°å€¼ä¸ºå¯¹è±¡æ—¶ï¼š

  ```typescript
  const date = new Date()
  
  axios({
    method: 'get',
    url: '/base/get',
    params: {
      foo: {
        bar: 'baz'
      }
    }
  })
  ```

  æœ€ç»ˆè¯·æ±‚ URL ä¸ºï¼š`/base/get?foo=%7B%22bar%22:%22baz%22%7D`ï¼Œ`foo` åé¢æ‹¼æ¥çš„æ˜¯ `{"bar":"baz"}` encode åçš„ç»“æœã€‚

+ å‚æ•°å€¼ä¸º Date ç±»å‹ï¼š

  ```typescript
  const date = new Date()
  
  axios({
    method: 'get',
    url: '/base/get',
    params: {
      date
    }
  })
  ```

  æœ€ç»ˆè¯·æ±‚çš„ `url` æ˜¯ `/base/get?date=2019-04-01T05:55:39.030Z`ï¼Œ`date` åé¢æ‹¼æ¥çš„æ˜¯ `date.toISOString()` çš„ç»“æœã€‚

+ **æ”¯æŒç‰¹æ®Šå­—ç¬¦**ï¼šå…è®¸ç‰¹æ®Šå­—ç¬¦å‡ºç°åœ¨ URL ä¸­ï¼Œä¸å¸Œæœ›è¢« `encode`ã€‚

  ```typescript
  axios({
    method: 'get',
    url: '/base/get',
    params: {
      foo: '@:$, '
    }
  })
  ```

  æœ€ç»ˆè¯·æ±‚ URL ä¸º `/base/get?foo=@:$+`ï¼Œæ³¨æ„ï¼Œæˆ‘ä»¬ä¼šæŠŠç©ºæ ¼ è½¬æ¢æˆ `+`ã€‚

+ **æ”¯æŒç©ºå€¼çš„å¿½ç•¥**ï¼šå¯¹äºå€¼ä¸º `null` æˆ–è€… `undefined` çš„å±æ€§ï¼Œä¸ä¼šæ·»åŠ åˆ° url å‚æ•°ä¸­çš„ã€‚

  ```typescript
  axios({
    method: 'get',
    url: '/base/get',
    params: {
      foo: 'bar',
      baz: null
    }
  })
  ```

  æœ€ç»ˆè¯·æ±‚ URL ä¸ºï¼š`/base/get?foo=bar`ï¼›

+ ä¸¢å¼ƒ URL ä¸­çš„å“ˆå¸Œæ ‡è®°ï¼š

  ```js
  axios({
    method: 'get',
    url: '/base/get#hash',
    params: {
      foo: 'bar'
    }
  })
  ```

  æœ€ç»ˆè¯·æ±‚ URL ä¸ºï¼š`/base/get?foo=bar`ï¼›

+ ä¿ç•™ URL ä¸­å·²ç»å­˜åœ¨çš„å‚æ•°ï¼š

  ```typescript
  axios({
    method: 'get',
    url: '/base/get?foo=bar',
    params: {
      bar: 'baz'
    }
  })
  ```

  æœ€ç»ˆè¯·æ±‚ URL ä¸ºï¼š`/base/get?foo=bar&bar=baz`ï¼›

  

##  `buildURL` å‡½æ•°å®ç°

æ ¹æ®éœ€æ±‚åˆ†æï¼Œéœ€è¦å®ç°ä¸€ä¸ªå·¥å…·å‡½æ•°ï¼Œå°† `params` ä¸­çš„æ•°æ®æ‹¼æ¥åˆ° URL ä¸Šã€‚

+ åˆ›å»º `helpers` ç›®å½•ï¼Œåœ¨ç›®å½•ä¸‹åˆ›å»º `url.ts` ç¼–å†™å¤„ç† URL ç›¸å…³çš„å·¥å…·ã€‚
+ åœ¨åŒç›®å½•ä¸‹åˆ›å»º `util.ts` å­˜æ”¾ç›¸å…³çš„å·¥å…·ï¼›



`helpers/util.ts`ï¼šæ£€éªŒæ•°æ®çš„ç±»å‹ï¼Œæ˜¯å¦ä¸º `Date` å¯¹è±¡ï¼Œæˆ–è€…æ˜¯æ™®é€šå¯¹è±¡ `object`ã€‚

```typescript
const toString = Object.prototype.toString

export function isDate(val: any): val is Date {
  return toString.call(val) === '[object Date]'
}

export function isObject(val: any): val is Object {
  return val !== null && typeof val === 'object'
}
```



`helpers/url.ts` ï¼š

```typescript
import { isDate, isObject } from './util'

function encode(val: string): string {
  return encodeURIComponent(val)
    .replace(/%40/g, '@')
    .replace(/%3A/gi, ':')
    .replace(/%24/g, '$')
    .replace(/%2C/gi, ',')
    .replace(/%20/g, '+')
    .replace(/%5B/gi, '[')
    .replace(/%5D/gi, ']')
}

export function buildURL(url: string, params?: any) {
  if (!params) return url

  const parts: string[] = []

  Object.keys(params).forEach(key => {
    let val = params[key]
    if (val === null || typeof val === 'undefined') return

    let values: string[]
    if (Array.isArray(val)) {
      values = val
      key += '[]'
    } else {
      values = [val]
    }
    values.forEach(val => {
      if (isDate(val)) {
        val = val.toISOString()
      } else if(isObject(val)) {
        val = JSON.stringify(val)
      }
      parts.push(`${encode(key)}=${encode(val)}`)
    })
  })

  let serializedParams = parts.join('&')

  if(serializedParams) {
    const markIndex = url.indexOf('#')
    if(markIndex !== -1) {
      url = url.slice(0, markIndex)
    }

    url += (url.indexOf('?') === -1 ? '?' : '&') + serializedParams
  }

  return url
}
```

> + `encode()` å‡½æ•°å¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼›
> + `buildURL` æ‹¼æ¥å¸¦æœ‰å‚æ•°çš„ URLã€‚é¦–å…ˆ å…ˆéå† `params` å¯¹è±¡ä¸­çš„é”®å€¼ï¼Œåˆ¤æ–­å…¶ä¸­çš„ç±»å‹ï¼Œåˆ†åˆ«æŒ‰ç…§ä¸åŒçš„ç±»å‹ï¼ˆæ•°ç»„ã€ æ—¥æœŸã€æ™®é€šå¯¹è±¡ï¼‰ç¼–ç ï¼Œç„¶åå†æ·»åŠ åˆ°ä¸€ä¸ªå¤„ç†åçš„å‚æ•°å­—ç¬¦ä¸²æ•°ç»„ä¸­ï¼›ä½¿ç”¨ `&` æ‹¼æ¥è¿™ä¸ªå­—ç¬¦ä¸²æ•°ç»„ç”Ÿæˆåºåˆ—åŒ–çš„å‚æ•°å­—ç¬¦ä¸²ï¼›æ¥ç€å¤„ç†å“ˆå¸Œæ ‡è®°ï¼Œå¹¶ä¸”å¦‚æœ URL ä¸­å·²ç»å­˜åœ¨å‚æ•°ï¼Œè¦åœ¨å…¶åæ·»åŠ  `&` å†åŠ å…¥å­—ç¬¦ä¸²å¤„ç†åçš„å‚æ•°ã€‚



## åœ¨å…¥å£æ–‡ä»¶å¼•å…¥

```typescript
import { AxiosRequestConfig } from './types'
import xhr from './xhr'
import { buildURL } from './helpers/url'

function axios(config: AxiosRequestConfig) {
  processConfig(config)
  xhr(config)
}

function processConfig(config: AxiosRequestConfig) {
  config.url = transformURL(config)
}

function transformURL (config: AxiosRequestConfig) {
  const {url, params} = config
  return buildURL(url, params)
}

export default axios
```

åœ¨æ‰§è¡Œ `xhr` å‡½æ•°ä¹‹å‰ï¼Œæ·»åŠ å¤„ç† `config` çš„æ–¹æ³• `processConfig`ã€‚åœ¨ `processConfig` å†…éƒ¨ï¼Œæ‰§è¡Œ `transformURL` å¤„ç† URLã€‚



## ç¼–å†™ DEMO æµ‹è¯•

åœ¨ `exampls` ç›®å½•ä¸‹åˆ›å»º `base` ç›®å½•ï¼š

`base/index.html`ï¼š

```html
<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <title>simple example</title>
</head>
<body>

<script src="/__build__/simple.js"></script>
</body>
</html>
```

`base/app.ts`ï¼š

```typescript
import axios from '../../src/index'

axios({
  method: 'get',
  url: '/base/get',
  params: {
    foo: ['bar', 'baz']
  }
})

axios({
  method: 'get',
  url: '/base/get',
  params: {
    foo: {
      bar: 'baz'
    }
  }
})

const date = new Date()

axios({
  method: 'get',
  url: '/base/get',
  params: {
    date
  }
})

axios({
  method: 'get',
  url: '/base/get',
  params: {
    foo: '@:$, '
  }
})

axios({
  method: 'get',
  url: '/base/get',
  params: {
    foo: 'bar',
    baz: null
  }
})

axios({
  method: 'get',
  url: '/base/get#hash',
  params: {
    foo: 'bar'
  }
})

axios({
  method: 'get',
  url: '/base/get?foo=bar',
  params: {
    bar: 'baz'
  }
})
```



åœ¨ `server.js` ä¸­æ·»åŠ  `router`ï¼š

```typescript
router.get('/base/get', function(req, res) {
  res.json(req.query)
})
```



åœ¨ `examples/index.html` ä¸­æ·»åŠ æµ‹è¯•é“¾æ¥ï¼š

```html
<li><a href='base'>Base</a></li>
```



æœ€åè¿›å…¥é“¾æ¥ä¹‹åï¼Œå¯ä»¥çœ‹åˆ°å‘é€äº†å¤šä¸ªè¯·æ±‚ï¼ŒæŸ¥çœ‹è¯·æ±‚çš„ URL  å’Œå“åº”çš„ä¿¡æ¯ã€‚