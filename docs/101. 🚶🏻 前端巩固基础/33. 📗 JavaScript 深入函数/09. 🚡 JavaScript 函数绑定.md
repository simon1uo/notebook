---
title:  ğŸš¡ JavaScript å‡½æ•°ç»‘å®š
date: 2022-05-13 18:19:55
permalink: /pages/451f8c/
categories:
  -  ğŸ“— JavaScript æ·±å…¥å‡½æ•°
tags:
  -  JavaScript æ·±å…¥éƒ¨åˆ†
---
å½“å°† **å¯¹è±¡æ–¹æ³•** ä½œä¸ºå›è°ƒä¼ é€’ï¼Œä¾‹å¦‚ä¼ é€’ç»™ `setTimeout`ï¼Œä¼šå­˜åœ¨ä¸€ä¸ªå¸¸è§çš„é—®é¢˜ï¼Œä¸¢å¤± `this` å¯¹è±¡ã€‚

## å¼•å…¥ä¾‹å­ï¼šä¸¢å¤±çš„ `this`



ğŸŒ° ä¾‹å­ï¼š

```js
let user = {
  firstName: 'Simon',
  sayHi() {
    console.log(`Hello, ${this.firstName}ï¼`)
  }
}

setTimeout(user.sayhi, 1000) // Hello, undefined
```

> ä¼ é€’ å¯¹è±¡æ–¹æ³• ç»™ `setTimeout`ï¼Œä½†æ˜¯å®ƒä¸å¯¹è±¡åˆ†ç¦»å¼€äº†ï¼Œä¸¢å¤±äº† ä¸Šä¸‹æ–‡å¯¹è±¡ `user`ã€‚åœ¨ æµè§ˆå™¨ ä¸­çš„ `setTimeout` æ–¹æ³•ä¸­ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š `this` ä¸Šä¸‹æ–‡ï¼Œæ­¤æ—¶çš„ `this = window` ã€‚å¯¹äº Node.js `this` åˆ™ä¼šå˜ä¸º è®¡æ—¶å™¨å¯¹è±¡ã€‚



### è§£å†³æ–¹æ³•ï¼šåŒ…è£…å™¨

ä½¿ç”¨ä¸€ä¸ª **åŒ…è£…å‡½æ•°** è§£å†³ã€‚

ğŸŒ° ä¾‹å­ï¼š

```js
let user = {
  firstName: 'Simon',
  sayHi() {
    console.log(`Hello, ${this.firstName}ï¼`)
  }
}

setTimeout(function() {
  user.sayHi()
}, 1000)
```

æˆ–è€…ä½¿ç”¨ **ç®­å¤´å‡½æ•°** å½¢å¼ï¼š 

```js
setTimeout(() => user.sayHi(), 1000)
```

> æ­¤æ—¶ `user.sayHi()` ä»å¤–éƒ¨è¯æ³•ç¯å¢ƒä¸­è·å–åˆ°äº† `user` å¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥æ­£å¸¸çš„è°ƒç”¨ã€‚



ğŸŒ° ä¾‹å­ / å¦‚æœå¯¹è±¡åœ¨ `setTimeout` è§¦å‘ä¹‹å‰æ”¹å˜äº†ï¼Œæ­¤æ—¶è¿™ç§åŒ…è£…å™¨æ–¹æ³•å°±å­˜åœ¨æ¼æ´äº†ï¼š
```js
let user = {
  firstName: 'Simon',
  sayHi() {
    console.log(`Hello, ${this.firstName}ï¼`)
  }
}

setTimeout(() => user.sayHi(), 1000)

user = {
  sayHi() {
    console.log('changed user sayhi()')
  }
}
```



### è§£å†³æ–¹æ³•ï¼š `bind`

å‡½æ•°æä¾›äº†ä¸€ä¸ª **å†…å»ºæ–¹æ³•** `bind`ï¼Œå¯ä»¥ç»‘å®š `this` å¯¹è±¡ã€‚åŸºæœ¬è¯­æ³•ä¸ºï¼š
```js
let boundFunc = func.bind(context)
```

> `func.bind(context)` çš„ç»“æœæ˜¯ä¸€ä¸ª ç‰¹æ®Šçš„ ç±»ä¼¼äºå‡½æ•°ã€Œå¤–æ¥å¯¹è±¡ã€ï¼Œå¯ä»¥åƒå‡½æ•°ä¸€æ ·è¢«è°ƒç”¨ï¼Œå¹¶ä¸” é€æ˜åœ° å°†è°ƒç”¨ä¼ é€’ç»™ `func` å¹¶ä¸”è®¾å®š `this = context`ã€‚
>
> ç®€å•çš„è¯´ï¼Œå°±æ˜¯ `boundFunc` çš„è°ƒç”¨ æ˜¯ ç»‘å®šäº† `this` çš„ `func`ã€‚



ğŸŒ° ä¾‹å­ï¼š

```js
let user = {
  firstName = 'Simon'
}

function func() {
  console.log(this.firstName) 
}

let funcUser = func.bind(user)
funcUser() // 'Simon'
```

> `funcUser` å°†è°ƒç”¨ä¼ é€’ç»™äº† `func` åŒæ—¶ `this = user`ã€‚



ğŸŒ° ä¾‹å­ / `bind` è¿˜ä¼šä¼ é€’ æ‰€æœ‰çš„å‚æ•°ï¼š

```js
function func(phrase) {
  console.log(phrase + ', ' this.firstName);
}

let funcUser = func.bind(user)
funcUser("hello") // "hello, Simon"
```



ğŸŒ° ä¾‹å­ / `bind` åº”ç”¨äº **å¯¹è±¡æ–¹æ³•**ï¼š

```js
let user = {
  firstName: 'Simon',
  sayHi() {
    console.log(`Hello, ${this.firstName}ï¼`)
  }
}

let sayHi = user.sayHi.bind(user)

setTimeout(sayHi, 1000) 

user = {
  sayHi() {
    console.log('changed user sayhi()')
  }
}
```

> å³ä½¿åœ¨ ä¸åˆ°ä¸€ç§’æ—¶ æ”¹å˜äº†åŸæ¥çš„å¯¹è±¡ `user`ï¼Œè¿™é‡Œ `bind` å–äº†æ–¹æ³• `user.sayHi` å°†å…¶ç»‘å®šåˆ° `user`ï¼Œæ‰€ä»¥ `sayHi` æ˜¯ä¸€ä¸ª **ç»‘å®šåçš„** æ–¹æ³•ï¼Œå®ƒå¯ä»¥è¢«å•ç‹¬è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥è¢«ä¼ é€’ç»™ `setTimeout`ã€‚



ğŸŒ° ä¾‹å­ / `bind` åº”ç”¨äº å¯¹è±¡æ–¹æ³• åŒ…æ‹¬æ–¹æ³•çš„å‚æ•°ï¼š

```js
let user = {
  firstName: 'Simon',
  sayHi(phrase) {
    console.log(`${phrase}, ${this.firstName}ï¼`)
  }
}

let say = user.sayHi.bind(user)

say("Hello")
say("Bye")
```



::: tip

å¦‚æœå¯¹è±¡ä¸­æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œå¹¶ä¸”éƒ½æ‰“ç®—å°†å®ƒä»¬ä¼ é€’å‡ºå»ï¼Œé‚£ä¹ˆå¯ä»¥å­å•Šä¸€ä¸ªå¾ªç¯ä¸­å®Œæˆæ‰€æœ‰æ–¹æ³•çš„ç»‘å®šï¼š

```js
for (let key in user) {
  if (typeof user[key] === 'function') {
    user[key] = user[key].bind(user)
  }
}
```

> åœ¨ JavaScript åº“æœ‰æä¾›æ–¹ä¾¿æ‰¹é‡ç»‘å®šçš„å‡½æ•°ï¼Œä¾‹å¦‚ loadash ä¸­çš„ `_.bindAll(object, methodNames)`ã€‚

:::



### åå‡½æ•°

`bind` çš„ å®Œæ•´è¯­æ³•ï¼š

```js
let bound = func.bind(context, [arg1], [arg2], ... )
```

> å¯ä»¥çœ‹åˆ° `bind` å…è®¸å°† ä¸Šä¸‹æ–‡ ç»‘å®šä¸º `this`ï¼Œä»¥åŠç»‘å®šå‡½æ•°çš„ **åˆå§‹å‚æ•°**ã€‚



ğŸŒ° ä¾‹å­ï¼š
```js
function mul(a, b) {
  return a * b
}
```

ä½¿ç”¨ `bind` åœ¨è¯¥å‡½æ•°åŸºç¡€ä¸Šåˆ›å»ºä¸€ä¸ª `double` å‡½æ•°ï¼š

```js
let double = mul.bind(null, 2)

console.log(double(3)) // 6
```

> å¯¹ `mul.bind(null, 2)` çš„è°ƒç”¨åˆ›å»ºäº†ä¸€ä¸ªæ–°å‡½æ•° `double`ï¼Œå®ƒå°†è°ƒç”¨ä¼ é€’åˆ° `mul`ï¼Œå°† `null` ç»‘å®šä¸ºä¸Šä¸‹æ–‡ï¼Œå¹¶å°† `2`ç»‘å®šä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚å¹¶ä¸”ï¼Œå‚æ•°å‡è¢«åŸæ ·ä¼ é€’ã€‚ 



è¿™ç§ç”¨æ³•è¢«ç§°ä¸º **åå‡½æ•°åº”ç”¨ç¨‹åº**ï¼Œ é€šè¿‡ç»‘å®š **å…ˆæœ‰çš„å‡½æ•°** çš„ä¸€äº›å‚æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°ã€‚ä¸Šé¢çš„ä¾‹å­ï¼Œå› ä¸ºæ²¡æœ‰ç”¨åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡çš„åœ°æ–¹ï¼Œæ‰€ä»¥ä¼ å…¥çš„æ˜¯ `null` ï¼ˆæ²¡æœ‰ä¹Ÿè¦ä¼ å…¥å‚æ•°ï¼‰ã€‚

> ä½¿ç”¨åå‚æ•°çš„å¥½å¤„ï¼š
>
> + å¯ä»¥åœ¨åŸæ¥çš„å‡½æ•°çš„åŸºç¡€ä¸Šï¼Œåˆ›å»ºä¸€ä¸ªå…·æœ‰ **å¯è¯»æ€§é«˜** çš„åå­—çš„ç‹¬ç«‹å‡½æ•°ï¼ˆä¾‹å¦‚ `double`ï¼Œ`triple`ï¼‰ ã€‚å¯ä»¥åªä½¿ç”¨å®ƒä»¬è€Œä¸ç”¨æ¯æ¬¡éƒ½æä¾›ç›¸åŒçš„å‚æ•°ã€‚
> + å½“æœ‰ä¸€ä¸ª **éå¸¸é€šç”¨çš„** å‡½æ•°ï¼Œå¹¶ä¸”å¸Œæœ›æœ‰ä¸€ä¸ª é€šç”¨å‹ æ›´ä½çš„è¯¥å‡½æ•°çš„å˜ä½“ï¼Œä½¿ç”¨ åå‡½æ•° éå¸¸æœ‰ç”¨ã€‚



### ä»…ç»‘å®šå‚æ•° `partial`

å½“æƒ³ç»‘å®šä¸€äº›å‚æ•°åˆ°å‡½æ•°ï¼Œä½†ä¸éœ€è¦ç”¨åˆ° ä¸Šä¸‹æ–‡ `this` ï¼ŒåŸç”Ÿçš„ `bind` ä¸å…è®¸è¿™ç§æƒ…å†µï¼ˆä¸å¯ä»¥çœç•¥ `context` ç›´æ¥è·³åˆ°å‚æ•°ï¼‰ã€‚

`partial` å¯ä»¥å®ç°ä»…ç»‘å®šå‚æ•°çš„å‡½æ•°ï¼Œç”¨æ³•ï¼š

```js
function partial(func, argsBound) {
  return function(...args) {
    retrun func.call(this, ...argsBound, ...args)
  }
}
```



ğŸŒ° ä¾‹å­ï¼š
```js
let user = {
  firstName: "John",
  say(time, phrase) {
   console.log(`[${time}] ${this.firstName}: ${phrase}!`);
  }
};

user.sayNow = partial(user.say, new Date.getHours() + ':' + new Date().getMinutes())

user.sayNow("Hello") // 
```

> `partial(func[, arg1, arg2...])` è°ƒç”¨çš„ç»“æœæ˜¯ä¸€ä¸ªåŒ…è£…å™¨ ï¼Œå®ƒè°ƒç”¨ `func` å¹¶å…·æœ‰ä»¥ä¸‹å†…å®¹ï¼š
>
> - ä¸å®ƒè·å¾—çš„å‡½æ•°å…·æœ‰ç›¸åŒçš„ `this`ï¼ˆå¯¹äº `user.sayNow` è°ƒç”¨æ¥è¯´ï¼Œå®ƒæ˜¯ `user`ï¼‰
> - ç„¶åç»™å®ƒ `...argsBound` â€”â€” æ¥è‡ªäº `partial` è°ƒç”¨çš„å‚æ•°ï¼ˆ`"10:00"`ï¼‰
> - ç„¶åç»™å®ƒ `...args` â€”â€” ç»™åŒ…è£…å™¨çš„å‚æ•°ï¼ˆ`"Hello"`ï¼‰

åŒæ · lodash åº“ä¸­æœ‰ç°æˆçš„ `_.partial` å®ç°



## æ€»ç»“

+ æ–¹æ³• `func.bind(context, ...args) `è¿”å›å‡½æ•° `func` ç»‘å®šäº† `this` ï¼ˆä»¥åŠç»™å®šçš„ä¸€äº›å‚æ•°ï¼‰çš„ **å˜ä½“**ã€‚
  + é€šå¸¸ä½¿ç”¨ `bind` ç»‘å®š å¯¹è±¡æ–¹æ³• çš„ `this`ï¼Œä»¥ä¾¿æŠŠå®ƒä»¬ä¼ é€’åˆ°å…¶ä»–åœ°æ–¹ä½¿ç”¨ï¼Œè€Œä¸ä¸¢å¤±ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚
+ å½“ç»‘å®šå…ˆæœ‰å‡½æ•°çš„ä¸€äº›å‚æ•°ï¼Œç»‘å®šåçš„å‡½æ•°ä¸º **åå‡½æ•°**ã€‚å¯ä»¥ç”¨äºä¸æƒ³ä¸€éä¸€éé‡å¤ç›¸åŒåœ°ä¼ å…¥å‚æ•°æ—¶å¯ä»¥ç”¨ `partial`ã€‚



## å®ä¾‹

### äºŒæ¬¡ `bind`

> å½“å¯¹ä¸€ä¸ªå‡½æ•°åº”ç”¨ `bind` ç»‘å®šä¸Šä¸‹æ–‡å¯¹è±¡ä¸¤æ¬¡æ—¶ï¼š
>
> ```js
> function f() {
>   console.log(this.name);
> }
> 
> f = f.bind( {name: "John"} ).bind( {name: "Ann" } );
> 
> f();
> ```

::: details

æœ€åè¾“å‡ºçš„ç»“æœæ˜¯ `John`ã€‚é“¾å¼è°ƒç”¨æ˜¯åº”ç”¨äºä¸Šä¸€æ¬¡æ–¹æ³•è°ƒç”¨åçš„ç»“æœã€‚ `bind( ... )` è¿”å›çš„å¤–æ¥ç»‘å®šå‡½æ•°ä»…åœ¨åˆ›å»ºçš„æ—¶å€™è®°å¿†ä¸Šä¸‹æ–‡ã€‚æ‰€ä»¥ä¸€ä¸ªå‡½æ•°ä¸èƒ½é‡ç»‘å®šã€‚ 

:::



### `bind` åçš„å‡½æ•°å±æ€§

> å½“å‡½æ•°çš„å±æ€§ä¸­æœ‰ä¸€ä¸ªå€¼ï¼Œ`bind` ä¹‹åå€¼è¿˜å­˜åœ¨å—ï¼Ÿ
>
> ```js
> function sayHi() {
>   console.log( this.name );
> }
> sayHi.test = 5;
> 
> let bound = sayHi.bind({
>   name: "John"
> });
> 
> console.log(bound.test);
> ```

::: details

`bind` çš„ç»“æœæ˜¯å¦ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå¹¶æ²¡æœ‰ `test` å±æ€§ã€‚

:::

