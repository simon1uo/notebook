---
title:  ğŸ¥¢ JavaScript Fetch
date: 2022-05-29 23:54:06
permalink: /pages/ad7a87/
categories:
  -  ğŸ¯ JavaScript AJAX ç½‘ç»œè¯·æ±‚
tags:
  - JavaScript æ·±å…¥éƒ¨åˆ†
---
## `fetch` çš„ä½¿ç”¨

`fetch()` æ–¹æ³•æ˜¯ä¸€ç§ç°ä»£é€šç”¨ç½‘ç»œè¯·æ±‚çš„æ–¹æ³•ï¼š

```js
let promise = fetch(url, [options])
```

+ `url`ï¼šè¯·æ±‚ç½‘ç»œè·¯å¾„ï¼›
+ `options`ï¼šå¯é€‰å‚æ•°ï¼ˆæ–¹æ³•ã€è¯·æ±‚å¤´ç­‰ï¼‰ã€‚æ²¡æœ‰å¯é€‰å‚æ•°ï¼Œé»˜è®¤è¯·æ±‚æ–¹æ³• `get`ã€‚



ä½¿ç”¨ `fetch` å‘é€ç½‘ç»œè¯·æ±‚åï¼Œè·å–æ¥è‡ªæœåŠ¡å™¨çš„å“åº”éœ€è¦ç»è¿‡ä¸¤ä¸ªé˜¶æ®µï¼š

+ ç¬¬ä¸€é˜¶æ®µï¼šå½“æœåŠ¡å™¨å‘é€äº†å“åº”å¤´ï¼Œ`fetch` è¿”å›çš„ `promise` å°±ä½¿ç”¨å†…å»ºçš„ `Response` ç±»å¯¹è±¡æ¥ **å¯¹å“åº”å¤´è¿›è¡Œè§£æ**ã€‚

  >  å¯ä»¥åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæ£€æŸ¥å“åº”å¤´ï¼Œæ£€æŸ¥ HTTP çŠ¶æ€ç¡®å®šè¯·æ±‚æ˜¯å¦æˆåŠŸäº†ï¼Œè¿™ä¸ªé˜¶æ®µè¿˜æ²¡æœ‰å“åº”ä½“ã€‚
  >
  > + å¦‚æœ`fetch` æ— æ³•å»ºç«‹ä¸€ä¸ª HTTP è¯·æ±‚ã€‚ä¾‹å¦‚ï¼Œç½‘ç»œé—®é¢˜ï¼›è¯·æ±‚ç½‘ç»œåœ°å€ä¸å­˜åœ¨ï¼Œæ­¤æ—¶ `promise` å°±ä¼š `reject`ã€‚
  > + å¼‚å¸¸çš„ HTTP çŠ¶æ€ï¼Œä¾‹å¦‚ 404 æˆ– 500ï¼Œä¸ä¼šå¯¼è‡´å‡ºç° errorã€‚

  è¯·æ±‚ HTTP çŠ¶æ€å¯ä»¥é€šè¿‡ä¸¤ä¸ªå±æ€§æŸ¥çœ‹ï¼š

  + `status`ï¼šHTTP çŠ¶æ€ç ï¼›
  + `ok`ï¼šå¸ƒå°”å€¼ï¼Œå¦‚æœ HTTP çŠ¶æ€ç ä¸º 200-299ï¼Œåˆ™ä¸º `true`ã€‚

  ğŸŒ° ä¾‹å­ï¼š

  ```js
  let response = await fetch(url);
  
  if (response.ok) { // å¦‚æœ HTTP çŠ¶æ€ç ä¸º 200-299
    // è·å– response bodyï¼ˆæ­¤æ–¹æ³•ä¼šåœ¨ä¸‹é¢è§£é‡Šï¼‰
    let json = await response.json();
  } else {
    alert("HTTP-Error: " + response.status);
  }
  ```

  

+ ç¬¬äºŒé˜¶æ®µï¼šè·å– `response` å“åº”ä½“ï¼Œä½¿ç”¨ä¸€ä¸ªå…¶ä»–çš„æ–¹æ³•è°ƒç”¨ã€‚

  `Response` æä¾›äº†å¤šç§åŸºäº `promise` çš„æ–¹æ³•ï¼Œæ¥ä»¥ä¸åŒçš„æ ¼å¼è®¿é—® resposne bodyï¼š

  + **`response.text()`** ï¼šè¯»å– `response`ï¼Œå¹¶ä»¥æ–‡æœ¬å½¢å¼è¿”å› responseï¼›
  + **`response.json()`** ï¼šå°† `response` è§£æä¸º JSONï¼›
  + `response.formData()`ï¼šä»¥ `FormData` å¯¹è±¡çš„å½¢å¼è¿”å› responseï¼› 
  + `response.blob()`ï¼šä»¥ Blob çš„å½¢å¼è¿”å› responseï¼›
  + `response.arrayBuffer()`ï¼šä»¥ ArrayBuffer å½¢å¼è¿”å› responseï¼›
  + `response.body` ï¼šæ˜¯ `ReadableStream` å¯¹è±¡ï¼Œå…è®¸é€å—è¯»å– `body` ã€‚



ğŸŒ° ä¾‹å­ / è·å–å“åº”çš„ JSON å¯¹è±¡ï¼š

```js
let url = 'https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits';
let response = await fetch(url);

let commits = await response.json();
console.log(commits[0].author.login)
```

æˆ–è€…ä½¿ç”¨çº¯ `promise`ï¼š

```js
fetch('https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits')
  .then(response => response.json())
  .then(commits => alert(commits[0].author.login));
```



::: warning

ä¸€èˆ¬åªèƒ½é€‰æ‹©ä¸€ç§è¯»å– body çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå·²ç»ä½¿ç”¨äº† `response.text()` æ¥è·å– `response`ï¼Œ é‚£ä¹ˆå†ç”¨ `response.json()` ä¸ä¼šç”Ÿæ•ˆã€‚å› ä¸ºå“åº”ä½“å†…å®¹å·²ç»è¢«å¤„ç†è¿‡äº†ã€‚

:::



### å“åº”å¤´ Response header

Response header æ˜¯ä½äº `response.headers` ä¸­çš„**ä¸€ä¸ªç±»ä¼¼äº Map çš„ header å¯¹è±¡**ã€‚ï¼ˆä¸æ˜¯çœŸæ­£çš„ Map å¯¹è±¡ï¼‰ å¯ä»¥é€šè¿‡ **åå­—** è·å–å„ä¸ª `header`ï¼Œæˆ–è€…è¿­ä»£ã€‚

ğŸŒ° ä¾‹å­/ è·å–å“åº”å¤´ `Content-type`ï¼š
```js
let response = await fetch('https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits');

// è·å–ä¸€ä¸ª header
alert(response.headers.get('Content-Type')); // application/json; charset=utf-8

// è¿­ä»£æ‰€æœ‰ header
for (let [key, value] of response.headers) {
  alert(`${key} = ${value}`);
}
```



### è¯·æ±‚å¤´ Request header

å¯ä»¥é€šè¿‡åœ¨ä½¿ç”¨ `fetch` æ—¶ï¼Œåœ¨é€‰æ‹©å‚æ•°ä¸­é…ç½® `headers` é€‰é¡¹ã€‚

ğŸŒ° ä¾‹å­ï¼š

```js
let response = fetch(protectedUrl, {
  headers: {
    Authentication: 'secret'
  }
})
```



> ä¸ºäº†ä¿è¯ HTTP çš„æ­£ç¡®æ€§å’Œå®‰å…¨æ€§ï¼Œå­˜åœ¨ä¸èƒ½æ§åˆ¶çš„è¯·æ±‚å¤´ï¼šhttps://fetch.spec.whatwg.org/#forbidden-header-nameã€‚ä»…æœ‰æµè§ˆå™¨æ§åˆ¶ã€‚



### è¯·æ±‚æ–¹æ³• `method`

è¦ä½¿ç”¨ é»˜è®¤æ–¹æ³• `GET` ä»¥å¤–çš„è¯·æ±‚æ–¹æ³•ï¼Œé€šè¿‡ `method` é€‰é¡¹é…ç½® / æˆ–è€…é…ç½® `body`ï¼ˆrequest bodyï¼Œ å¸¸ç”¨ JSONï¼‰ã€‚



ğŸŒ° ä¾‹å­ / ä»¥ JSON å½¢å¼å‘é€å¯¹è±¡ç±»å‹çš„è¯·æ±‚ï¼š

```js
let user = {
  name: 'John',
  surname: 'Smith'
}

let response = await fetch('/article/fetch/post/user', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json;charset=utf-8'
  },
  body: JSON.stringify(user)
});

let result = await response.json()
console.log(result.message)
```



å¦‚æœè¯·æ±‚çš„ `body` æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™ `Content-Type` ä¼šé»˜è®¤è®¾ç½®ä¸º `text/plain;charset=UTF-8`ã€‚æ‰€ä»¥å¦‚æœè¦å‘é€ JSONï¼Œéœ€è¦è®¾ç½®è¯·æ±‚å¤´ `Content-type` æ§åˆ¶ç¼–ç ç±»å‹ã€‚



ğŸŒ° ä¾‹å­ / è·å– GitHub ç”¨æˆ·ä¿¡æ¯ã€‚

> + åˆ›å»ºä¸€ä¸ªå¼‚æ­¥å‡½æ•° `getUsers(names)`ï¼Œè¯¥å‡½æ•°æ¥å— GitHub ç™»å½•åæ•°ç»„ä½œä¸ºè¾“å…¥ï¼ŒæŸ¥è¯¢ GitHub ä»¥è·å–æœ‰å…³è¿™äº›ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¹¶è¿”å› GitHub ç”¨æˆ·æ•°ç»„ã€‚
> + GitHub æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯çš„ APIï¼šhttps://api.github.com/users/USERNAME

```js
async function getUsers(names) {
  let jobs = [];
  
  for (let name of names) {
    let job = fetch(`https://api.github.com/users/${name}`).then(
      response => {
        if (response.status != 200) return null;
        else return response.json();
      }, 
      error => {
        return null;
      }
    );
    jobs.push(job)
  }
  
  let results = await Promis.all(jobs)
  return results;
}
```

> + å¯¹äº æ¯ä¸€ä¸ªç”¨æˆ·åéƒ½æœ‰ä¸€ä¸ª `fetch` è¯·æ±‚ã€‚æ±‚ä¸åº”è¯¥ç›¸äº’ç­‰å¾…ã€‚ä»¥ä¾¿èƒ½å¤Ÿå°½å¿«è·å–åˆ°æ•°æ®ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªè¯·æ±‚å¤±è´¥äº†ï¼Œæˆ–è€…æ²¡æœ‰è¿™ä¸ªç”¨æˆ·ï¼Œåˆ™å‡½æ•°åº”è¯¥è¿”å› `null` åˆ°ç»“æœæ•°ç»„ä¸­ã€‚
> + `.then` è°ƒç”¨ç´§è·Ÿåœ¨ `fetch` åé¢ï¼Œè¿™æ ·å½“æ”¶åˆ°å“åº”æ—¶ï¼Œå®ƒä¸ä¼šç­‰å¾…å…¶ä»–çš„ `fetch`ï¼Œè€Œæ˜¯ç«‹å³å¼€å§‹è¯»å– `.json()`ã€‚é€šè¿‡å°† `.json()` ç›´æ¥æ·»åŠ åˆ°æ¯ä¸ª `fetch` ä¸­ï¼Œå°±èƒ½ç¡®ä¿æ¯ä¸ª fetch åœ¨æ”¶åˆ°å“åº”æ—¶éƒ½ä¼šç«‹å³å¼€å§‹ä»¥ JSON æ ¼å¼è¯»å–æ•°æ®ï¼Œè€Œä¸ä¼šå½¼æ­¤ç­‰å¾…ã€‚
> + ä½¿ç”¨ `await Promise.all` å°†ä¼šç­‰åˆ°æ‰€æœ‰çš„ `fetch` éƒ½è·å–åˆ°å“åº”æ•°æ®æ‰å¼€å§‹è§£æã€‚



## `Fetch` çš„åº”ç”¨



### `FormData`

ç”¨äºå‘é€ HTML è¡¨å•æ•°æ®çš„ç±»å‹å¯¹è±¡ã€‚æ„é€ å™¨ä½¿ç”¨å¦‚ä¸‹ï¼š
```js
let formData = new FormData([form])
```

> `[form]` æ˜¯é€‰æ‹©æ€§æä¾›çš„ã€‚å¦‚æœæä¾›äº† HTML `form` å…ƒç´ ï¼Œå°±ä¼šè‡ªåŠ¨æ•è·è¯¥ `from` å…ƒç´ å­—æ®µã€‚

`FormData` **çš„ç‰¹æ®Šä¹‹å¤„åœ¨äºç½‘ç»œæ–¹æ³•**ã€‚ä¾‹å¦‚ `fetch` å¯ä»¥æ¥å—ä¸€ä¸ª `FormData` å¯¹è±¡ä½œä¸º bodyã€‚å®ƒä¼šè¢«ç¼–ç å¹¶å‘é€å‡ºå»ï¼Œå¸¦æœ‰ `Content-Type: multipart/form-data`ã€‚

å¯¹äºæœåŠ¡å™¨ï¼Œåªæ˜¯æ™®é€šçš„è¡¨è¾¾æ•°æ®æäº¤ã€‚



ğŸŒ° ä¾‹å­ / æäº¤ç®€å•çš„è¡¨å•æ•°æ®ï¼š
```html
<form id="formElem">
  <input type="text" name="name" value="John">
  <input type="text" name="surname" value="Smith">
  <input type="submit">
</form>
```

::: demo [vanilla]

```html
<html>
  <form id="formElem">
    <input type="text" name="name" value="John">
    <input type="text" name="surname" value="Smith">
    <input type="submit">
	</form>
</html>
```

:::

```js
let formElem = document.querySelector("#formElem");
formElem.onsubmit = async (e) => {
  e.preventDefault
  
  let response = await fetch('/article/formdata/post/user', {
      method: 'POST',
      body: new FormData(formElem)
  });
  
  let result = await response.json()
  console.log(result.message)
}
```



`FormData` æä¾›çš„æ–¹æ³•ä¿®æ”¹å…¶ä¸­çš„å­—æ®µï¼š

+ `formData.append(name, value)`ï¼šæ·»åŠ å…·æœ‰ç»™å®š `name` å’Œ `value` çš„è¡¨å•å­—æ®µï¼›
+ `formData.append(name, blob, fileName)`ï¼šæ·»åŠ ä¸€ä¸ªç›¸å½“äº `<input type="file">` è¾“å…¥ç±»å‹çš„å­—æ®µã€‚ç¬¬ä¸‰ä¸ªå‚æ•° `fileName` è®¾ç½®æ–‡ä»¶åï¼ˆè€Œä¸æ˜¯è¡¨å•å­—æ®µåï¼‰ï¼Œå› ä¸ºå®ƒæ˜¯ç”¨æˆ·æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„åç§°ï¼›
+ `formData.delete(name)` ï¼šç§»é™¤å¸¦æœ‰ç»™å®š `name` çš„å­—æ®µï¼›
+ `formData.get(name)`ï¼šè·å–å¸¦æœ‰ç»™å®š `name` çš„å­—æ®µå€¼ï¼›
+ `formData.has(name)`ï¼šå¦‚æœå­˜åœ¨å¸¦æœ‰ç»™å®š `name` çš„å­—æ®µï¼Œåˆ™è¿”å› `true`ï¼Œå¦åˆ™è¿”å› `false`ã€‚

> æŠ€æœ¯ä¸Šï¼Œå¯ä»¥æ‹¥æœ‰å¤šä¸ª **ç›¸åŒåç§°** `name` çš„å­—æ®µã€‚å› æ­¤ï¼Œå¤šæ¬¡è°ƒç”¨ `append` å°†ä¼šæ·»åŠ å¤šä¸ªå…·æœ‰ç›¸åŒåç§°çš„å­—æ®µã€‚ä½¿ç”¨ `set` æ–¹æ³•ï¼Œç¡®ä¿è¯¥å­—æ®µåªæœ‰ä¸€ä¸ªå”¯ä¸€çš„å€¼ï¼ˆç§»é™¤ä¹‹å‰å­˜åœ¨çš„ `name` å­—æ®µï¼‰ã€‚

+ `formData.set(name, value)`

+ `formData.set(name, blob, fileName)`

  **ä¸ä½¿ç”¨ `append` çš„æ–¹æ³•ç›¸åŒ**ã€‚



å¯ä»¥ä½¿ç”¨ `for ... of` å¾ªç¯è¿­ä»£ `formData` ä¸­çš„å­—æ®µä¸å€¼ï¼š
```js
for (let [name, value] of formData) {
  console.log(`${name} = ${value}`)
}
```

 

####  `FormData` è¡¨å•ä¸Šä¼ æ–‡ä»¶

`FormData` è¡¨å•ç±»å‹å§‹ç»ˆå¸¦æœ‰è¯·æ±‚å¤´ `Content-type: multipart/form-data` å‘é€æ•°æ®ï¼Œè¿™ä¸ªç¼–ç å…è®¸å‘é€æ–‡ä»¶ ï¼ˆ`<input type="file">` ç±»å‹çš„è¾“å…¥æ¡†ï¼‰ã€‚

ğŸŒ° ä¾‹å­ / **ä¸Šä¼ å›¾ç‰‡**ï¼š
```html
<form id="formElem">
  <input type="text" name="firstName" value="John">
  Picture: <input type="file" name="picture" accept="image/*">
  <input type="submit">
</form>
```

```js
formElem.onsubmit = async (e) => {
    e.preventDefault();

    let response = await fetch('/article/formdata/post/user-avatar', {
      method: 'POST',
      body: new FormData(formElem)
    });

    let result = await response.json();

    alert(result.message);
};
```





### `Fetch` è·¨æºè¯·æ±‚

> è·¨æºè¯·æ±‚ï¼ˆè·¨åŸŸï¼‰ ï¼ˆè·¨æºèµ„æºè¯·æ±‚ Cross-Origin Resource Sharing / CORS ï¼‰ï¼šå‘é€åˆ°å…¶ä»–åŸŸã€åè®®æˆ–è€…ç«¯å£çš„è¯·æ±‚ã€‚

å…è®¸è·¨æºè¯·æ±‚çš„ä¸¤ç§è¯·æ±‚ç±»å‹ï¼š

+ å®‰å…¨è¯·æ±‚ï¼›
+ æ‰€æœ‰çš„å…¶ä»–è¯·æ±‚ã€‚



å®‰å…¨çš„è¯·æ±‚éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š

+ å®‰å…¨çš„è¯·æ±‚æ–¹æ³•ï¼š`GET`ã€ `POST`ã€`HEAD`ï¼›
+ å®‰å…¨çš„è¯·æ±‚å¤´ header ä»…å…è®¸è‡ªå®šä¹‰ä¸‹åˆ—çš„ headerï¼š
  + `Accept`ï¼Œ
  + `Accept-Language`ï¼Œ
  + `Content-Language`ï¼Œ
  + `Content-Type` çš„å€¼ä¸º `application/x-www-form-urlencoded`ï¼Œ`multipart/form-data` æˆ– `text/plain`ã€‚

> é™¤äº†å®‰å…¨çš„è¯·æ±‚ï¼Œæ²¡æœ‰ç¬¦åˆä¸Šè¿°æ¡ä»¶çš„è¯·æ±‚éƒ½ä¸ºéå®‰å…¨çš„è¯·æ±‚ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ `PUT` è¯·æ±‚æ–¹æ³•ï¼Œæˆ–è€…å…·æœ‰é™¤äº†ä¸Šè¿°çš„è‡ªå®šä¹‰çš„è¯·æ±‚å¤´éƒ¨ã€‚
>
> å®‰å…¨çš„è¯·æ±‚ä¸éå®‰å…¨çš„è¯·æ±‚çš„æœ¬è´¨åŒºåˆ«ï¼š
>
> + å¯ä»¥ä½¿ç”¨ `<form>` / `script` è¿›è¡Œå®‰å…¨è¯·æ±‚ï¼Œæ— éœ€ç‰¹æ®Šçš„æ–¹æ³•ã€‚
>
>   > ä½¿ç”¨å®‰å…¨çš„è¯·æ±‚èƒ½å…¼å®¹è¾ƒæ—§çš„æœåŠ¡å™¨ï¼Œä¸ç”¨è¿›è¡Œç‰¹æ®Šçš„å¤„ç†ã€‚
>
> + è€Œå‘é€éå®‰å…¨çš„è¯·æ±‚ï¼Œæ— æ³•è¿›è¡ŒåŒæ ·çš„å·¥ä½œã€‚
>
>   > æ—§çš„æœåŠ¡å™¨å¯èƒ½ä¼šè®¤ä¸ºæ­¤ç±»è¯·æ±‚æ¥è‡ªå…·æœ‰ç‰¹æƒçš„æ¥æºã€‚å½“å°è¯•å‘é€ä¸€ä¸ªéå®‰å…¨è¯·æ±‚æ—¶ï¼Œæµè§ˆå™¨ä¼šå‘é€ä¸€ä¸ªç‰¹æ®Šçš„é¢„æ£€è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œè¯¢é—®æœåŠ¡æ˜¯å¦æ¥å—æ­¤ç±»è·¨æºè¯·æ±‚å—ã€‚
>   >
>   > æœåŠ¡å™¨éœ€è¦æ˜ç¡®é€šè¿‡ header ç¡®è®¤ï¼Œå¦åˆ™éå®‰å…¨çš„è¯·æ±‚æ— æ³•å‘é€ã€‚



**å¯¹äºå®‰å…¨çš„è¯·æ±‚ CORS**ï¼š

ğŸŒ° ä¾‹å­ï¼š

ä» `https://somewhere.page` è¯·æ±‚ `https://anywhere.com/request`ï¼Œå‘é€çš„è¯·æ±‚å¤´ä¸ºï¼š

```
GET /request
Host: anywhere.com
Origin: https://somewhere.page
```

> è¯·æ±‚å¤´çš„ Origin ä¼šåŒ…å«ç¡®åˆ‡çš„è¯·æ±‚æ¥æºï¼ˆåŸŸåã€åè®®ã€ç«¯å£ï¼‰ï¼Œæ²¡æœ‰è·¯å¾„ã€‚æœåŠ¡å™¨æ£€æŸ¥ Origin ï¼Œå¦‚æœåŒæ„æ¥å—è¯·æ±‚ï¼Œå°±ä¼šåœ¨å“åº”ä¸­æ·»åŠ ä¸€ä¸ªç‰¹æ®Šçš„ header `Access-Control-Allow-Origin`ã€‚è¯¥ header åŒ…å«äº†å…è®¸çš„æºï¼Œæˆ–è€…ä¸€ä¸ªæ˜Ÿå· `*`ã€‚ç„¶åå“åº”æˆåŠŸï¼Œå¦åˆ™æŠ¥é”™ã€‚
>
> æµè§ˆå™¨ä½œä¸ºä¸­é—´äººï¼šç¡®ä¿äº†å‘é€çš„è·¨æºè¯·æ±‚å¸¦æœ‰æ­£ç¡®çš„ Originï¼›æ£€æŸ¥å“åº”å¤´ä¸­æ˜¯å¦å¸¦æœ‰è®¸å¯ `Access-Control-Allow-Origin`ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å…è®¸ JavaScript è®¿é—®å“åº”ï¼Œå¦åˆ™å°†å¤±è´¥å¹¶æŠ¥é”™ã€‚

å“åº”çš„è¯·æ±‚å¤´ï¼š

```
200 OK
Content-Type:text/html; charset=UTF-8
Access-Control-Allow-Origin: *
```



> å¯¹äºå“åº”å¤´ ï¼ˆResponse Headerï¼‰å¤„ç†è·¨æºè¯·æ±‚æ—¶ï¼ŒJavaScript åªèƒ½è®¿é—® å®‰å…¨çš„å“åº”å¤´ï¼š
>
> - `Cache-Control`
> - `Content-Language`
> - `Content-Type`
> - `Expires`
> - `Last-Modified`
> - `Pragma`
>
> å¯¹äºå…¶ä»–çš„å“åº”å¤´éƒ½ä¼šå¯¼è‡´å‡ºé”™ã€‚
>
> è¦æˆäºˆ JavaScript å¯¹ä»»ä½•å…¶ä»–è¯·æ±‚çš„è®¿é—®æƒé™ï¼ŒæœåŠ¡å™¨å¿…é¡»å‘é€ `Access-Control-Expose-Headers` headerã€‚å®ƒåŒ…å«ä¸€ä¸ªä»¥é€—å·åˆ†éš”çš„åº”è¯¥è¢«è®¾ç½®ä¸ºå¯è®¿é—®çš„éå®‰å…¨ header åç§°åˆ—è¡¨ã€‚



**å¯¹äºéå®‰å…¨çš„è¯·æ±‚**ï¼š

ä¸ºäº†ä½¿ç”¨ä»»ä½•çš„ HTTP è¯·æ±‚æ–¹æ³•ï¼ˆä¸ä»… GET / POSTï¼Œè¿˜æœ‰å¯èƒ½æ˜¯ PATCHã€DELETE æˆ–è€…å…¶ä»–ï¼‰ã€‚

+ æµè§ˆå™¨å‘é€é¢„æ£€è¯·æ±‚ï¼Œæ¥è¯·æ±‚è®¸å¯ï¼š

  é¢„æ£€è¯·æ±‚ä½¿ç”¨ `OPTIONS` æ–¹æ³•ï¼Œå®ƒæ²¡æœ‰ bodyï¼Œä½†æ˜¯æœ‰ä¸‰ä¸ª headerï¼š

  + `Access-Control-Request-Method` header å¸¦æœ‰éå®‰å…¨è¯·æ±‚çš„æ–¹æ³•ã€‚
  + `Access-Control-Request-Headers` header æä¾›ä¸€ä¸ªä»¥é€—å·åˆ†éš”çš„éå®‰å…¨ HTTP-header åˆ—è¡¨ã€‚

   

+ å¦‚æœæœåŠ¡å™¨åŒæ„å¤„ç†è¯·æ±‚ï¼Œé‚£ä¹ˆä¼šè¿›è¡Œå“åº”ä»¥ä¸‹å“åº”å¤´ä¿¡æ¯ï¼š
  + `Access-Control-Allow-Origin` å¿…é¡»ä¸º `*` æˆ–è¿›è¡Œè¯·æ±‚çš„æºæ‰èƒ½å…è®¸æ­¤è¯·æ±‚ã€‚
  + `Access-Control-Allow-Methods` å¿…é¡»å…·æœ‰å…è®¸çš„æ–¹æ³•ã€‚
  + `Access-Control-Allow-Headers` å¿…é¡»å…·æœ‰ä¸€ä¸ªå…è®¸çš„ header åˆ—è¡¨ã€‚
  + `Access-Control-Max-Age` å¯ä»¥æŒ‡å®šç¼“å­˜æ­¤æƒé™çš„ç§’æ•°ã€‚å› æ­¤ï¼Œæµè§ˆå™¨ä¸æ˜¯å¿…é¡»ä¸ºæ»¡è¶³ç»™å®šæƒé™çš„åç»­è¯·æ±‚å‘é€é¢„æ£€ã€‚



ğŸŒ° ä¾‹å­ï¼š

+ å‘é€é¢„æ£€è¯·æ±‚ / preflight requestï¼š

  ```
  OPTIONS /service.json
  Host: site.com
  Origin: https://somewhere.info
  Access-Control-Request-Method: PATCH
  Access-Control-Request-Headers: Content-Type,API-Key
  ```

  > + `Origin`ï¼š æ¥æºã€‚
  >
  > - `Access-Control-Request-Method` ï¼š è¯·æ±‚æ–¹æ³•ã€‚
  > - `Access-Control-Request-Headers` ï¼š ä»¥é€—å·åˆ†éš”çš„éå®‰å…¨ header åˆ—è¡¨ã€‚

  

+ æœåŠ¡å™¨å“åº”é¢„æ£€å“åº” / preflight responseï¼š

  ```
  Access-Control-Allow-Origin: https://somewhere.page
  Access-Control-Allow-Methods: PUT,PATCH,DELETE
  Access-Control-Allow-Headers: Content-Type,API-Key
  Access-Control-Max-Age: 86400
  ```

  > è¿™å°†å…è®¸åç»­é€šä¿¡ï¼Œå¦åˆ™ä¼šè§¦å‘é”™è¯¯ã€‚å¦‚æœæœåŠ¡å™¨å°†æ¥éœ€è¦å…¶ä»–æ–¹æ³•å’Œ headerï¼Œåˆ™å¯ä»¥é€šè¿‡å°†è¿™äº›æ–¹æ³•å’Œ header æ·»åŠ åˆ°åˆ—è¡¨ä¸­æ¥é¢„å…ˆå…è®¸å®ƒä»¬ã€‚
  >
  > å¯ä»¥çœ‹åˆ° `PATCH` åœ¨ `Access-Control-Allow-Methods` ä¸­ï¼Œ`Content-Type,API-Key` åœ¨åˆ—è¡¨ `Access-Control-Allow-Headers` ä¸­ï¼Œå› æ­¤å®ƒå°†å‘é€ä¸»è¯·æ±‚ã€‚
  >
  > `Access-Control-Max-Age` å¸¦æœ‰ä¸€ä¸ªè¡¨ç¤ºç§’çš„æ•°å­—ï¼Œåˆ™åœ¨ç»™å®šçš„æ—¶é—´å†…ï¼Œé¢„æ£€æƒé™ä¼šè¢«ç¼“å­˜ã€‚ä¸Šé¢çš„å“åº”å°†è¢«ç¼“å­˜ 86400 ç§’ï¼Œä¹Ÿå°±æ˜¯ä¸€å¤©ã€‚åœ¨æ­¤æ—¶é—´èŒƒå›´å†…ï¼Œåç»­è¯·æ±‚å°†ä¸ä¼šè§¦å‘é¢„æ£€ã€‚å‡è®¾å®ƒä»¬ç¬¦åˆç¼“å­˜çš„é…é¢ï¼Œåˆ™å°†ç›´æ¥å‘é€å®ƒä»¬ã€‚



+ å‘é€å®é™…è¯·æ±‚ï¼š

  æœ€åçš„è¯·æ±‚å¤´ï¼š

  ```
  PATCH /service.json
  Host: site.com
  Content-Type: application/json
  API-Key: secret
  Origin: https://javascript.info
  ```

  å“åº”å¤´åº”è¯¥æ·»åŠ  `Access-Control-Allow-Origin`ã€‚

  ä¾‹å¦‚ï¼š

  ```
  Access-Control-Allow-Origin: https://somewhere.pages
  ```

  



### Fetch  è¯·æ±‚å‡­è¯

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”± JavaScript ä»£ç å‘èµ·çš„è·¨æºè¯·æ±‚ï¼Œä¸ä¼šå¸¦ä»»ä½•å‡­æ®ï¼ˆcookies æˆ–è€… HTTP ç½‘ç»œè®¤è¯ï¼‰ã€‚

> å› ä¸ºå…·æœ‰å‡­æ®çš„è¯·æ±‚æ¯”æ²¡æœ‰å‡­æ®çš„è¯·æ±‚è¦å¼ºå¤§å¾—å¤šã€‚å¦‚æœè¢«å…è®¸ï¼Œå®ƒä¼šä½¿ç”¨å®ƒä»¬çš„å‡­æ®æˆäºˆ JavaScript ä»£è¡¨ç”¨æˆ·è¡Œä¸ºå’Œè®¿é—®æ•æ„Ÿä¿¡æ¯çš„å…¨éƒ¨æƒåŠ›ã€‚

æ‰€ä»¥è¦åœ¨ è·¨æºè¯·æ±‚ å¿…é¡»æ˜¾å¼åœ°å¸¦æœ‰å…è®¸è¯·æ±‚çš„å‡­æ®å’Œé™„åŠ  headerã€‚

ä¾‹å­ï¼šè¦åœ¨ `fetch` ä¸­å‘é€å‡­æ®ï¼Œéœ€è¦æ·»åŠ  `credentials: "include"` é€‰é¡¹ï¼š

```js
fetch('http://another.com', {
  credentials: "include"
});
```

> ç°åœ¨ï¼Œ`fetch` å°†æŠŠæºè‡ª `another.com` çš„ cookie å’Œæˆ‘ä»¬çš„è¯·æ±‚å‘é€åˆ°è¯¥ç½‘ç«™ã€‚

å¦‚æœæœåŠ¡å™¨åŒæ„æ¥å— **å¸¦æœ‰å‡­æ®** çš„è¯·æ±‚ï¼Œåˆ™é™¤äº† `Access-Control-Allow-Origin` å¤–ï¼ŒæœåŠ¡å™¨è¿˜åº”è¯¥åœ¨å“åº”ä¸­æ·»åŠ  header `Access-Control-Allow-Credentials: true`ã€‚

å“åº”å¤´å¦‚ä¸‹ï¼š
```
200 OK
Access-Control-Allow-Origin: https://somewhere.pages
Access-Control-Allow-Credentials: true
```



æ³¨æ„ï¼šå¯¹äºå…·æœ‰å‡­æ®çš„è¯·æ±‚ï¼Œç¦æ­¢ `Access-Control-Allow-Origin` ä½¿ç”¨æ˜Ÿå· `*`ã€‚å¦‚ä¸Šæ‰€ç¤ºï¼Œå®ƒå¿…é¡»æœ‰ä¸€ä¸ªç¡®åˆ‡çš„æºã€‚è¿™æ˜¯å¦ä¸€é¡¹å®‰å…¨æªæ–½ï¼Œä»¥ç¡®ä¿æœåŠ¡å™¨çœŸçš„çŸ¥é“å®ƒä¿¡ä»»çš„å‘å‡ºæ­¤è¯·æ±‚çš„æ˜¯è°ã€‚
