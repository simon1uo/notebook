---
title: 🖇 MyBatis 拓展应用
date: 2022-03-09 14:40:56
permalink: /pages/3b8955/
categories: 
  - _pages
  - 🧋 JavaEE
  - 🗺 MyBatis
tags: 
  - MyBatis
author: 
  name: Simon
  link: https://github.com/simon1uo
---



## MyBatis 缓存拓展

### 第三方缓存 EHCache



::: tip

配置 EHCache 步骤：

+ 引入 EHCache 到 maven `pom.xml` ：

```xml
<!-- Mybatis EHCache整合包 -->
<dependency>
    <groupId>org.mybatis.caches</groupId>
    <artifactId>mybatis-ehcache</artifactId>
    <version>1.2.1</version>
</dependency>
<!-- slf4j日志门面的一个具体实现 -->
<dependency>
    <groupId>ch.qos.logback</groupId>
    <artifactId>logback-classic</artifactId>
    <version>1.2.3</version>
</dependency>
```

+ 创建配置文件`ehcache.xml`：

```xml
<?xml version="1.0" encoding="utf-8" ?>
<ehcache xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="../config/ehcache.xsd">
    <!-- 磁盘保存路径 -->
    <diskStore path="D:\atguigu\ehcache"/>
    <defaultCache
            maxElementsInMemory="1000"
            maxElementsOnDisk="10000000"
            eternal="false"
            overflowToDisk="true"
            timeToIdleSeconds="120"
            timeToLiveSeconds="120"
            diskExpiryThreadIntervalSeconds="120"
            memoryStoreEvictionPolicy="LRU">
    </defaultCache>
</ehcache>
```

+ 在 `Cache` 标签中设置二级缓存的类型：

```xml
<cache type="org.mybatis.caches.ehcache.EhcacheCache"/>
```

+ 加入 **logback** 日志配置：由于存在 slf4j，简易日志的 log4j 将会失效，需要借助 slf4j的具体实现 logback 打印日志。创建配置文件 `logback.xml` ：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration debug="true">
    <!-- 指定日志输出的位置 -->
    <appender name="STDOUT"
              class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <!-- 日志输出的格式 -->
            <!-- 按照顺序分别是：时间、日志级别、线程名称、打印日志的类、日志主体内容、换行 -->
            <pattern>[%d{HH:mm:ss.SSS}] [%-5level] [%thread] [%logger]
                [%msg]%n
            </pattern>
        </encoder>
    </appender>
    
    <!--设置全局日志级别。日志级别按顺序分别是：DEBUG、INFO、WARN、ERROR-->
    <!-- 指定任何一个日志级别都只打印当前级别和后面级别的日志。 -->
    <root level="DEBUG">
        <!-- 指定打印日志的appender，这里通过“STDOUT”引用了前面配置的appender -->
        <appender-ref ref="STDOUT"/>
    </root>
    <!-- 根据特殊需求指定局部日志级别 -->
    <logger name="com.mybatis.mapper" level="DEBUG"/>
</configuration>
```

::: 



## MyBatis 的逆向工程

> 正向工程：先创建 Java 实体类，由框架负责根据实体类生成数据库表。 Hibernate 是支持正向工程的。
>
> 逆向工程：先创建数据库表，由框架负责根据数据库表，反向生成如下资源：
>
> +  Java实体类
> + Mapper接口
> + Mapper映射文件



::: tip

创建逆向工程的步骤：

+ 引入相关的 maven 依赖：`pom.xml` ：包含 MyBatis 核心以及插件 **mybatis generator**：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>org.example</groupId>
    <artifactId>demo3</artifactId>
    <version>1.0-SNAPSHOT</version>

    <packaging>jar</packaging>

    <properties>
        <maven.compiler.source>15</maven.compiler.source>
        <maven.compiler.target>15</maven.compiler.target>
    </properties>

    <!-- 依赖MyBatis核心包 -->
    <dependencies>
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.5.7</version>
        </dependency>
        <!-- junit测试 -->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.12</version>
            <scope>test</scope>
        </dependency>
        <!-- log4j -->
        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
            <version>1.2.17</version>
        </dependency>
    </dependencies>

    <!-- 控制Maven在构建过程中相关配置 -->
    <build>
        <!-- 构建过程中用到的插件 -->
        <plugins>
            <!-- 具体插件，逆向工程的操作是以构建过程中插件形式出现的 -->
            <plugin>
                <groupId>org.mybatis.generator</groupId>
                <artifactId>mybatis-generator-maven-plugin</artifactId>
                <version>1.3.0</version>
                <!-- 插件的依赖 -->
                <dependencies>
                    <!-- 逆向工程的核心依赖 -->
                    <dependency>
                        <groupId>org.mybatis.generator</groupId>
                        <artifactId>mybatis-generator-core</artifactId>
                        <version>1.3.2</version>
                    </dependency>
                    <!-- 数据库连接池 -->
                    <dependency>
                        <groupId>com.mchange</groupId>
                        <artifactId>c3p0</artifactId>
                        <version>0.9.2</version>
                    </dependency>
                    <!-- MySQL驱动 -->
                    <dependency>
                        <groupId>mysql</groupId>
                        <artifactId>mysql-connector-java</artifactId>
                        <version>5.1.8</version>
                    </dependency>
                </dependencies>
            </plugin>
        </plugins>
    </build>
</project>
```

+ 创建配置文件 `generatorConfig.xml` ：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE generatorConfiguration
        PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
        "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">
<generatorConfiguration>
    <!--
    targetRuntime: 执行生成的逆向工程的版本
    MyBatis3Simple: 生成基本的CRUD（清新简洁版）
    MyBatis3: 生成带条件的CRUD（奢华尊享版）
    -->
    <context id="DB2Tables" targetRuntime="MyBatis3Simple">
        <!-- 数据库的连接信息 -->
        <jdbcConnection driverClass="com.mysql.jdbc.Driver"
                        connectionURL="jdbc:mysql://localhost:3306/mybatis_demo?useUnicode=true&amp;characterEncoding=utf8"
                        userId="root"
                        password="00000000">
        </jdbcConnection>
        <!-- javaBean的生成策略-->
        <javaModelGenerator targetPackage="com.mybatis.pojo"
                            targetProject="./src/main/java">
            <property name="enableSubPackages" value="true"/>
            <property name="trimStrings" value="true"/>
        </javaModelGenerator>
        <!-- SQL映射文件的生成策略 -->
        <sqlMapGenerator targetPackage="com.mybatis.mapper"
                         targetProject="./src/main/resources">
            <property name="enableSubPackages" value="true"/>
        </sqlMapGenerator>
        <!-- Mapper接口的生成策略 -->
        <javaClientGenerator type="XMLMAPPER"
                             targetPackage="com.mybatis.mapper" targetProject="./src/main/java">
            <property name="enableSubPackages" value="true"/>
        </javaClientGenerator>
        <!-- 逆向分析的表 -->
        <!-- tableName设置为*号，可以对应所有表，此时不写domainObjectName -->
        <!-- domainObjectName属性指定生成出来的实体类的类名 -->
        <table tableName="emp" domainObjectName="Emp"/>
        <table tableName="dept" domainObjectName="Dept"/>
    </context>
</generatorConfiguration>
```

::: warning 

`target` 路径位置可能需要根据实际修改 `/` 或者 `\`。我这里在 macOS 下使用的是 `/` 。

:::

+ 通过运行插件 **mybatis-generator:generate** 即可生成相关的文件。

  <img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/UkXBxh.png" alt="image-20220309152203802" style="zoom:33%;" />





🌰 例子：用生成后的映射进行查询（条件查询）：

:::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }" 

::: tab code

```java
@Test
public void testMBG(){
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    EmpMapper mapper = sqlSession.getMapper(EmpMapper.class);

    /*// 查询所有数据
    List<Emp> emps = mapper.selectByExample(null);
    emps.forEach(emp -> System.out.println(emp));*/

    // 根据条件查询
    EmpExample empExample = new EmpExample();
    empExample.createCriteria().andEmpNameEqualTo("张三").andAgeBetween(10,20);
    empExample.or().andDidIsNotNull();
    List<Emp> emps = mapper.selectByExample(empExample);
    emps.forEach(emp -> System.out.println(emp));
}
```

::: 

::: tab result

```sql
DEBUG 03-09 16:14:20,060 ==>  Preparing: select eid, emp_name, age, sex, email, did from emp WHERE ( emp_name = ? and age between ? and ? ) or( did is not null ) (BaseJdbcLogger.java:137) 
DEBUG 03-09 16:14:20,094 ==> Parameters: 张三(String), 10(Integer), 20(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-09 16:14:20,127 <==      Total: 5 (BaseJdbcLogger.java:137) 
Emp{eid=1, empName='张三', age=20, sex='男', email='123@qq.com', did=1}
Emp{eid=2, empName='李四', age=18, sex='女', email='455@163.com', did=2}
Emp{eid=3, empName='王五', age=18, sex='女', email='455@163.com', did=3}
Emp{eid=4, empName='赵六', age=18, sex='男', email='455@163.com', did=1}
Emp{eid=5, empName='田七', age=20, sex='女', email='455@163.com', did=2}
```

:::

::::



🌰 例子：修改信息

:::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }" 

::: tab code

1. `UpdateByPrimaryKey` ：

```java
@Test
public void testMBG(){
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    EmpMapper mapper = sqlSession.getMapper(EmpMapper.class);
  	mapper.updateByPrimaryKey(new Emp(1, "admin", 22, "女", "456@qq.com", 3));
}
```

:::

::: tab result

```sql
DEBUG 03-09 16:23:28,335 ==>  Preparing: update emp set emp_name = ?, age = ?, sex = ?, email = ?, did = ? where eid = ? (BaseJdbcLogger.java:137) 
DEBUG 03-09 16:23:28,365 ==> Parameters: admin(String), 22(Integer), 女(String), 456@qq.com(String), 3(Integer), 1(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-09 16:23:28,403 <==    Updates: 1 (BaseJdbcLogger.java:137) 
```

:::

::::

:::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }" 

::: tab code

2. `UpdateByPrimaryKeySelective` ：

```java
@Test
public void testMBG(){
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    EmpMapper mapper = sqlSession.getMapper(EmpMapper.class);
    mapper.updateByPrimaryKeySelective(new Emp(1, "admin", null, "女", "456@qq.com", 3));
}
```

:::

::: tab result

此时，修改的对象中，修改值有 `null` 时，不会出现在 SQL 更新语句当中。

```sql
DEBUG 03-09 16:25:38,120 ==>  Preparing: update emp SET emp_name = ?, sex = ?, email = ?, did = ? where eid = ? (BaseJdbcLogger.java:137) 
DEBUG 03-09 16:25:38,151 ==> Parameters: admin(String), 女(String), 456@qq.com(String), 3(Integer), 1(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-09 16:25:38,155 <==    Updates: 1 (BaseJdbcLogger.java:137) 
```

:::

::::

添加信息的实现原理与修改信息原理类似。



## 分页插件



::: tip

配置分页插件步骤：

+ 在 maven 中添加依赖：`pom.xml`：

```xml
<!-- https://mvnrepository.com/artifact/com.github.pagehelper/pagehelper -->
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper</artifactId>
    <version>5.2.0</version>
</dependency>
```

+ 在 MyBatis 核心配置中配置插件：

```xml
<plugins>
    <!--设置分页插件-->
    <plugin interceptor="com.github.pagehelper.PageInterceptor"></plugin>
</plugins>
```

:::



分页插件的使用：

+ 需要在查询功能之前使用 `PageHelper.startPage(int pageNum, int pageSize)` 开启分页功能。
+ 在查询获取数据后，使用 `PageInfo<T> pageInfo = new PageInfo<>(List<T> list, int navigatePages)` 获取分页的相关数据，`list` 为要分页的P数据。

🌰 例子：查询所有的员工信息后，使用分页插件进行内容的分页：`Page<Object> page = PageHelper.startPage(2, 4);` 获取分页的相关数据

::: tab code

```java
@Test
    public void testPageHelper() {
        SqlSession sqlSession = SqlSessionUtils.getSqlSession();
        EmpMapper mapper = sqlSession.getMapper(EmpMapper.class);
//        Page<Object> page = PageHelper.startPage(2, 4);
        PageHelper.startPage(2, 4);
        List<Emp> emps = mapper.selectByExample(null);
        PageInfo<Emp> empPageInfo = new PageInfo<>(emps, 5);// navigatePages 一般为基数
//        emps.forEach(emp -> System.out.println(emp));
        System.out.println(empPageInfo);
    }
```

::: 

::: tab result

```sql
DEBUG 03-09 16:58:47,635 Cache Hit Ratio [SQL_CACHE]: 0.0 (LoggingCache.java:60) 
DEBUG 03-09 16:58:47,677 ==>  Preparing: SELECT count(0) FROM emp (BaseJdbcLogger.java:137) 
DEBUG 03-09 16:58:47,710 ==> Parameters:  (BaseJdbcLogger.java:137) 
DEBUG 03-09 16:58:47,738 <==      Total: 1 (BaseJdbcLogger.java:137) 
DEBUG 03-09 16:58:47,740 ==>  Preparing: select eid, emp_name, age, sex, email, did from emp LIMIT ?, ? (BaseJdbcLogger.java:137) 
DEBUG 03-09 16:58:47,741 ==> Parameters: 4(Long), 4(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-09 16:58:47,744 <==      Total: 4 (BaseJdbcLogger.java:137) 
PageInfo{pageNum=2, pageSize=4, size=4, startRow=5, endRow=8, total=14, pages=4, list=Page{count=true, pageNum=2, pageSize=4, startRow=4, endRow=8, total=14, pages=4, reasonable=false, pageSizeZero=false}[Emp{eid=5, empName='田七', age=20, sex='女', email='455@163.com', did=2}, Emp{eid=9, empName='4', age=null, sex='null', email='null', did=null}, Emp{eid=10, empName='5', age=null, sex='null', email='null', did=null}, Emp{eid=11, empName='6', age=null, sex='null', email='null', did=null}], prePage=1, nextPage=3, isFirstPage=false, isLastPage=false, hasPreviousPage=true, hasNextPage=true, navigatePages=5, navigateFirstPage=1, navigateLastPage=4, navigatepageNums=[1, 2, 3, 4]}
```

:::

> 🔢 常用数据： 
>
> + `pageNum` ：当前页的页码；
> + `pageSize` ：每页显示的条数；
> + `size`：当前页显示的真实条数；
> + `total`：总记录数；
> + `pages` ：总页数；
> + `prePage` ：上一页的页码；
> + `nextPage`：下一页的页码；
> + `isFirstPage/isLastPage`：是否为第一页/最后一页；
> + `hasPreviousPage/hasNextPage`：是否存在上一页/下一页；
> + `navigatePage`：导航分页的页码数；
> + `navigatepageNums`：导航分页的页码，例如：`[1,2,3,4,5]`
