---
title: 🪜 JavaScript 执行上下文与执行上下文栈
date: 2022-03-17 15:04:29
permalink: /pages/a54eb0/
categories: 
  - 📚 前端笔记
  - 🚶 基础部分
  - 🏃 JavaScript 进阶高级
tags: 
  - null
author: 
  name: Simon
  link: https://github.com/simon1uo
---
## 变量提升与函数提升

+ **变量声明提升**：
  + 通过 `var ` 定义（声明）的变量，在定义语句之前就可以访问。值为 `undefined` 。
+ **函数声明提升**：
  + 通过 `function` 声明的函数，在之前就可以直接调用，值为函数定义（对象）。但是通过 `var` 定义的函数不适用函数提升（为变量提升）。



🌰 例子：

```js
var a = 3
function fn(){
  // var a
  console.log(a) // undefined
  var a = 4
}
fn()
```

```js
fn2() // undefined 可调用

function fn2(){
  console.log('fn2()')
}
```

```js
fn3() // error

var fn3() = function (){
  console.log('fn3()')
}
```



:question: 变量提升和函数提升是如何产生的？

## 执行上下文

> + 按照**位置**给代码进行分类：
>   + **全局代码**
>   + 函数代码

+ **全局执行上下文**：
  + 在执行全局代码前**将 `window` 确定为全局执行上下文**。
  + 对全局数据进行**预处理**：
    + 使用 `var` 定义的**全局变量**值为 `undefined`，添加为 `window` 的**属性**；
    + 使用 `function` 声明的**全局函数**赋值，添加为 `window ` 的**方法**；
    + `this` 赋值为 `window`。
  + 开始执行全局代码。
+ **函数执行上下文** ：
  + 在**调用函数时**，准备**执行函数体之前**，**创建对应的函数执行上下文对象**（虚拟的，存在于栈中）；
  + 对局部数据进行**预处理**：
    + 形参变量赋值**`实参`的数据**，添加为执行上下文的属性；
    + `arguments` 赋值**`实参`的数据列表（伪数组）**，添加为执行上下文的属性；
    + 使用 `var` 定义的**局部变量**赋值 `undefined`，添加为执行上下文的属性；
    + 使用 `function` 声明的函数，赋值 `fun` ，添加为执行上下文的方法；
    + `this` 赋值 `调用函数的对象`。
  + 开始执行函数体代码。



🌰 例子：**全局执行上下文**：

```js
console.log(a1) // window.a1
a2() // window.a2()
console.log(this) // window

var a1 = 1
function a2() {
  console.log('a2()')
}
```



🌰 例子：**函数执行上下文**：

```js
function fn(a1) {
	console.log(a1) // 2
  console.log(a2) // undefined
  a3() // a3()
  console.log(this) // window 调用fn()的对象 
  console.log(arguments) // 伪数组(2,3)
  
  var a2 = 3
  function a3() {
    console.log('a3()')
  }
}

fn(2, 3)
```

## 执行上下文栈

+ 在**全局代码执行之前**，JavaScript 引擎就会创建一个栈来**存储管理所有的执行上下文对象**。
+ 在全局执行上下文 `window` 确定后，将其添加到栈中（压栈）。
+ （调用函数时）在函数执行上下文创建后，将其添加到栈中（压栈）。
+ 在当前函数执行完后，将**栈顶的对象移除**（出栈）。
+ 当所有的代码执行完后，栈中只剩下 `window`。



🌰 例子：

```js
// 1.进入全局执行上下文
var a =10

var bar = function(x) {
  var b = 5
  foo(x + b) // 3. 进入foo执行上下文
}

var foo = function(y) {
  var c = 5
  console.log(a + c + y)
}

bar(10) // 2. 进入bar函数执行上下文
```



<img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/7lxBJT.png" alt="image-20220319112348783" style="zoom: 50%;" />



## 面试题



:one: ：

+ 依次输出的内容。
+ 整个过程产生了几个执行上下文？

```js
console.log('global begin:' + i)
var i = 1
foo(1)
function foo(i){
  if(i == 4) {
    return;
  }
  console.log('foo() begin:' + i)
  foo(i + 1) 
  console.log('foo() end:' + i)
}
console.log('global end:' + i)
```



+ <img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/Z73UoI.png" alt="image-20220319131349041" style="zoom:33%;" />
+ `5`。



:two:：

```js
function a() { }
var a
console.log(typeof a) // function
```

**先执行变量提升再执行函数提升**。



```js
if(!(b in window)) {
  var b = 1
}
console.log(b)
```



```js
var c = 1
function c(c){
  console.log(c)
}
c(2) // TypeError: c is not a function. (In 'c(2)', 'c' is 1) 
```

