---
title: ğŸ›© Promise çš„ async å’Œ await
date: 2022-04-21 13:06:43
permalink: /pages/b7c06f/
categories: 
  - ğŸ“š å‰ç«¯ç¬”è®°
  - ğŸš¶ åŸºç¡€éƒ¨åˆ†
  - ğŸš‡ Promise
tags: 
  - null
author: 
  name: Simon
  link: https://github.com/simon1uo
---
ğŸ”— ç›¸å…³é“¾æ¥ ï¼š

+ [asyncå‡½æ•° - JavaScript | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function)
+ [await - JavaScript | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/await)



### `async` å‡½æ•°

+ è¿”å›å€¼ä¸º Promise å¯¹è±¡
+ Promise å¯¹è±¡çš„ç»“æœ**ç”± `async` å‡½æ•°æ‰§è¡Œçš„è¿”å›å€¼**å†³å®šã€‚

ï¼ˆæ³¨ï¼šä¸ `then` ç›¸ä¼¼ï¼‰



ğŸŒ° ä¾‹å­ï¼š

```js
async function main(){
    // è¿”å›å€¼ä¸ºépromise
    // return 123 // æˆåŠŸçš„promise
    // è¿”å›çš„æ˜¯promiseå¯¹è±¡
    /*return new Promise((resolve, reject)=>{
        resolve('ok') // ç»“æœç”±è¿™ä¸ªç»“æœå†³å®š
    })*/
    throw "error" 
}

let result = main()
console.log(result)
```



### `await` è¡¨è¾¾å¼

+ `await` å³ä¾§çš„è¡¨è¾¾å¼ä¸€èˆ¬ä¸º Promise å¯¹è±¡ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒçš„å€¼ã€‚
+ å¦‚æœè¡¨è¾¾å¼ä¸º Promise å¯¹è±¡ï¼Œawait è¿”å›çš„æ˜¯ **Promise æˆåŠŸçš„å€¼**ã€‚
+ å¦‚æœè¡¨è¾¾å¼æ˜¯**å…¶ä»–å€¼**ï¼Œ**ç›´æ¥å°†æ­¤å€¼ä½œä¸º `await` çš„è¿”å›å€¼**ã€‚



æ³¨æ„ï¼š

+ `await` å¿…é¡»å†™åœ¨ `async` å‡½æ•°ä¸­ï¼Œä½† `async` å‡½æ•°ä¸­å¯ä»¥æ²¡æœ‰ `await` ã€‚
+ å¦‚æœ `await`  çš„ Promise å¤±è´¥äº†ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è¦é€šè¿‡ `try â€¦ catch â€¦ ` æ•è·å¤„ç†ã€‚

ğŸŒ° ä¾‹å­ï¼š

```js
async function main(){
  let p = new Promise((resolve, reject)=>{
    // resolve('ok')
    reject('error')
  })

  // let result = await p; // å³ä¾§ä¸ºpromiseçš„æƒ…å†µ
  // console.log(result);
  // let result2 = await 123; // å³ä¾§ä¸ºå…¶ä»–ç±»å‹
  // console.log(result2);

  try {
    let result3 = await p; // å³ä¾§ä¸ºpromiseå¤±è´¥
  } catch (e) {
    console.warn(e) // è·å–åˆ°å¤±è´¥çš„ç»“æœ
  }
}

main()
```



### `async` ä¸ `await` ç»“åˆ



ğŸŒ° ä¾‹å­ï¼ˆè¯»å–æ–‡ä»¶ï¼‰ï¼š

```js
const fs = require('fs')
const util = require('util')
const mineReadFile = util.promisify(fs.readFile)

// ä½¿ç”¨asyncä¸await
async function main() {
    try {
        let data1 = await mineReadFile('./resource/1.html')
        let data2 = await mineReadFile('./resource/2.html')
        let data3 = await mineReadFile('./resource/3.html')
        console.log(data1 + data2 + data3)
    } catch (err) {
        console.warn(err)
    }

}

main()
```



+ ç›¸æ¯”äºä½¿ç”¨å›è°ƒå‡½æ•°å®ç°ï¼Œå‡å°‘å†™æŠ›å‡ºå¼‚å¸¸ `try-catch` ç»“æ„ã€‚
+ åœ¨ `async` ä¸ `await` ç»“åˆåï¼Œå°‘ç”¨å›è°ƒå‡½æ•°ã€‚



ğŸŒ° ä¾‹å­ï¼ˆå‘é€ AJAX è¯·æ±‚ï¼‰ï¼š

```html
<button id="btn">è·å–</button>

<script>
    function sendAJAX(url) {
        return new Promise((resolve, reject)=>{
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url)
            xhr.send();
            xhr.onreadystatechange = function () {
                if(xhr.readyState === 4) {
                    if(xhr.status >= 200 && xhr.status < 300) {
                        // æˆåŠŸè¯·æ±‚
                        resolve(xhr.response)
                    } else {
                        // å¤±è´¥è¯·æ±‚
                        reject(xhr.status)
                    }
                }
            }
        })
    }

    let btn = document.querySelector("#btn")
    btn.addEventListener('click', async function(){
        let text = await sendAJAX('https://api.apiopen.top/getJoke')
        console.log(text)
    })

</script>
```