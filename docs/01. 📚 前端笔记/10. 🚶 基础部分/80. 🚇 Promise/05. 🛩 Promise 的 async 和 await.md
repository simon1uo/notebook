---
title: 🛩 Promise 的 async 和 await
date: 2022-04-21 13:06:43
permalink: /pages/b7c06f/
categories: 
  - 📚 前端笔记
  - 🚶 基础部分
  - 🚇 Promise
tags: 
  - null
author: 
  name: Simon
  link: https://github.com/simon1uo
---
🔗 相关链接 ：

+ [async函数 - JavaScript | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function)
+ [await - JavaScript | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/await)



### `async` 函数

+ 返回值为 Promise 对象
+ Promise 对象的结果**由 `async` 函数执行的返回值**决定。

（注：与 `then` 相似）



🌰 例子：

```js
async function main(){
    // 返回值为非promise
    // return 123 // 成功的promise
    // 返回的是promise对象
    /*return new Promise((resolve, reject)=>{
        resolve('ok') // 结果由这个结果决定
    })*/
    throw "error" 
}

let result = main()
console.log(result)
```



### `await` 表达式

+ `await` 右侧的表达式一般为 Promise 对象，但也可以是其它的值。
+ 如果表达式为 Promise 对象，await 返回的是 **Promise 成功的值**。
+ 如果表达式是**其他值**，**直接将此值作为 `await` 的返回值**。



注意：

+ `await` 必须写在 `async` 函数中，但 `async` 函数中可以没有 `await` 。
+ 如果 `await`  的 Promise 失败了，就会抛出异常，需要通过 `try … catch … ` 捕获处理。

🌰 例子：

```js
async function main(){
  let p = new Promise((resolve, reject)=>{
    // resolve('ok')
    reject('error')
  })

  // let result = await p; // 右侧为promise的情况
  // console.log(result);
  // let result2 = await 123; // 右侧为其他类型
  // console.log(result2);

  try {
    let result3 = await p; // 右侧为promise失败
  } catch (e) {
    console.warn(e) // 获取到失败的结果
  }
}

main()
```



### `async` 与 `await` 结合



🌰 例子（读取文件）：

```js
const fs = require('fs')
const util = require('util')
const mineReadFile = util.promisify(fs.readFile)

// 使用async与await
async function main() {
    try {
        let data1 = await mineReadFile('./resource/1.html')
        let data2 = await mineReadFile('./resource/2.html')
        let data3 = await mineReadFile('./resource/3.html')
        console.log(data1 + data2 + data3)
    } catch (err) {
        console.warn(err)
    }

}

main()
```



+ 相比于使用回调函数实现，减少写抛出异常 `try-catch` 结构。
+ 在 `async` 与 `await` 结合后，少用回调函数。



🌰 例子（发送 AJAX 请求）：

```html
<button id="btn">获取</button>

<script>
    function sendAJAX(url) {
        return new Promise((resolve, reject)=>{
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url)
            xhr.send();
            xhr.onreadystatechange = function () {
                if(xhr.readyState === 4) {
                    if(xhr.status >= 200 && xhr.status < 300) {
                        // 成功请求
                        resolve(xhr.response)
                    } else {
                        // 失败请求
                        reject(xhr.status)
                    }
                }
            }
        })
    }

    let btn = document.querySelector("#btn")
    btn.addEventListener('click', async function(){
        let text = await sendAJAX('https://api.apiopen.top/getJoke')
        console.log(text)
    })

</script>
```