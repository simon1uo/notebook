---
title:  ğŸšƒ JavaScript è£…é¥°å™¨æ¨¡å¼å’Œè½¬å‘
date: 2022-05-11 14:01:03
permalink: /pages/bf45a3/
categories:
  -  ğŸ“š å‰ç«¯ç¬”è®°
  -  ğŸš¶ åŸºç¡€éƒ¨åˆ†
  -  ğŸ“— JavaScript æ·±å…¥å‡½æ•°
tags:
  - 
---
JavaScript åœ¨å¤„ç†å‡½æ•°æ—¶æä¾›äº†éå‡¡çš„çµæ´»æ€§ã€‚é™¤äº†å‰é¢æåˆ°çš„ è¢«ä¼ é€’ï¼Œç”¨ä½œå¯¹è±¡ï¼Œè¿˜å¯ä»¥ **è½¬å‘è°ƒç”¨** å’Œ **è£…é¥°** å‡½æ•°ã€‚



## å¼•å­ï¼šé€æ˜ç¼“å­˜

ğŸŒ° ä¾‹å­ / æœ‰ä¸€ä¸ª CPU é‡è´Ÿè½½çš„å‡½æ•° `slow(x)`ï¼Œä½†å®ƒçš„ç»“æœæ˜¯ç¨³å®šçš„ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹äºç›¸åŒçš„ `x`ï¼Œå®ƒæ€»æ˜¯è¿”å›ç›¸åŒçš„ç»“æœã€‚å¦‚æœç»å¸¸è°ƒç”¨è¯¥å‡½æ•°ï¼Œå¯èƒ½å¸Œæœ›å°† **ç»“æœç¼“å­˜** ä¸‹æ¥ï¼Œä»¥é¿å…åœ¨é‡æ–°è®¡ç®—ä¸ŠèŠ±è´¹é¢å¤–çš„æ—¶é—´ã€‚

ä½†æ˜¯ä¸æ˜¯å°†è¿™ä¸ªåŠŸèƒ½æ·»åŠ åˆ° `slow()` ä¸­ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª **åŒ…è£…å™¨å‡½æ•°**ï¼ˆWrapperï¼‰ï¼Œè¯¥å‡½æ•°å¢åŠ äº†ç¼“å­˜åŠŸèƒ½ã€‚

```js
function slow(x) {
  // ... 
  // ... å¯èƒ½ä¼šæœ‰é‡è´Ÿè½½çš„ CPU å¯†é›†å‹å·¥ä½œ
  // ,,, 
  console.log(`called with ${x}`)
	return x
}

// è£…é¥°å™¨å‡½æ•°
function cachingDecorator(func) {
  let cache = new Map()
  
  return function(x) {
    if(cache.has(x)) { // å¦‚æœç¼“å­˜èµ·æœ‰å¯¹åº”çš„ç»“æœ
      return cache.get(x) // åˆ™ä»ç¼“å­˜ä¸­è¯»å–ç»“æœ
    }
    
    let result = func(x) // å¦åˆ™å°±è°ƒç”¨ func(x)
    
    cache.set(x, result) // ç„¶åå°† x æ·»åŠ åˆ°ç¼“å­˜
    return result
  }
}

slow = cachingDecorator(slow)
console.log(slow(1)) // slow(1) è¢«ç¼“å­˜ä¸‹æ¥å¹¶è¿”å›ç»“æœ
console.log('again' + slow(1)) // è¿”å›ç¼“å­˜ä¸­çš„ç»“æœ


console.log(slow(2)) // slow(2) è¢«ç¼“å­˜ä¸‹æ¥å¹¶è¿”å›ç»“æœ
console.log('again' + slow(2)) // è¿”å›ç¼“å­˜ä¸­çš„ç»“æœ
```

> `cachingDecorator` æ˜¯ä¸€ä¸ª **è£…é¥°å™¨ï¼ˆdecoratorï¼‰**ï¼šä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°ï¼Œå®ƒæ¥å—å¦ä¸€ä¸ªå‡½æ•°å¹¶æ”¹å˜å®ƒçš„è¡Œä¸ºã€‚
>
> æ€æƒ³ï¼šå¯ä»¥ä¸ºä»»ä½•ä¸€ä¸ªå‡½æ•°è°ƒç”¨ `cachingDecorator`ï¼Œå®ƒå°†è¿”å›ç¼“å­˜åŒ…è£…å™¨ã€‚é€šè¿‡å°†ç¼“å­˜ä¸ä¸»å‡½æ•°ä»£ç åˆ†å¼€ï¼Œä½¿ä¸»å‡½æ•°ä»£ç å˜å¾—æ›´ç®€å•ã€‚
>
> `cachingDecorator(func)` çš„ç»“æœæ˜¯ä¸€ä¸ªâ€œåŒ…è£…å™¨â€ï¼š`function(x)` å°† `func(x)` çš„è°ƒç”¨â€œåŒ…è£…â€åˆ°ç¼“å­˜é€»è¾‘ä¸­ï¼š
>
> ![image-20220511140925295](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/DC1V4M.png)
>
> ä»å¤–éƒ¨ä»£ç æ¥çœ‹ï¼ŒåŒ…è£…çš„ `slow` å‡½æ•°æ‰§è¡Œçš„ä»ç„¶æ˜¯ä¸ä¹‹å‰ç›¸åŒçš„æ“ä½œã€‚å®ƒåªæ˜¯åœ¨å…¶è¡Œä¸ºä¸Šæ·»åŠ äº†ç¼“å­˜åŠŸèƒ½ã€‚

ä½¿ç”¨ `cachingDecorator` å¹¶ä¸æ”¹å˜åŸæ¥å‡½æ•°çš„ä»£ç çš„å¥½å¤„ï¼š

+ `cachingDecorator` æ˜¯å¯é‡ç”¨çš„ã€‚
+ ç¼“å­˜é€»è¾‘æ˜¯ç‹¬ç«‹çš„ï¼Œå®ƒæ²¡æœ‰å¢åŠ  `slow` æœ¬èº«çš„å¤æ‚æ€§ã€‚
+ å¦‚æœéœ€è¦ï¼Œå¯ä»¥ç»„åˆå¤šä¸ªè£…é¥°å™¨ï¼ˆå…¶ä»–è£…é¥°å™¨å°†éµå¾ªåŒæ ·çš„é€»è¾‘ï¼‰ã€‚



ğŸŒ° ä¾‹å­ / ä¸Šé¢çš„ **ç¼“å­˜è£…é¥°å™¨** ä¸é€‚ç”¨äº **å¯¹è±¡çš„æ–¹æ³•**ï¼š

```js
let worker = {
  someMethod() {
    return 1;
  },

  slow(x) {
    // ...
    // ... CPU è¿‡è½½ä»»åŠ¡
    // ...
    console.log("Called with " + x);
    return x * this.someMethod(); // (*)
  }
};

// function cachingDecorator(func) ... 

console.log(work.slow(1)) // å¯ç”¨

work.slow = cachingDecorator(worker.slow)
console.log(work.slow(2)) // ä¸å¯ç”¨
```

> å› ä¸ºè£…é¥°å™¨è¯•å›¾è®¿é—® `this.someMethod` æ—¶ ï¼Œè¿™é‡Œçš„ `this` ä¸º `undefined`ã€‚åŒ…è£…å™¨å°†è°ƒç”¨ä¼ é€’ç»™åŸå§‹æ–¹æ³•ï¼Œä½†æ²¡æœ‰ä¸Šä¸‹æ–‡ `this`ã€‚å› æ­¤ï¼Œå‘ç”Ÿäº†é”™è¯¯ã€‚



## `func.call()`

**å¯ä»¥ä½¿ç”¨å†…å»ºå‡½æ•°æ–¹æ³• `func.call(content, ...args)`** è§£å†³è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒå…è®¸è°ƒç”¨ä¸€ä¸ª **æ˜¾å¼è®¾ç½® `this`** çš„å‡½æ•°ã€‚

è¯­æ³•ä¸ºï¼š`func.call(context, arg1, arg2, ...)`ã€‚



ğŸŒ° ä¾‹å­ / `call` çš„ç®€å•åº”ç”¨ï¼š
```js
func(1, 2, 3);
func.call(obj, 1, 2, 3)
```

> è¿™ä¸¤ç§æ–¹æ³•éƒ½æ˜¯è°ƒç”¨ `func` å‡½æ•°ï¼Œå¹¶ä¸”ä¼ å…¥å‚æ•°ä¸º `1, 2, 3`ã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ `func.call` è¿˜ä¼šå°† `this` è®¾ç½®ä¸º `obj`ã€‚



ğŸŒ° ä¾‹å­ï¼š

```js
function sayHi() {
  console.log(this.name);
}

let user = { name: "John" };
let admin = { name: "Admin" };

// ä½¿ç”¨ call å°†ä¸åŒçš„å¯¹è±¡ä¼ é€’ä¸º "this"
sayHi.call(user); // John
sayHi.call(admin); // Admin
```

> æœ‰å‚æ•°çš„æŒ‡å®šä¸Šä¸‹æ–‡è°ƒç”¨ï¼š
> ```js
> function say(phrase) {
>   console.log(this.name + ': ' + phrase)
> }
> 
> let user = {name: 'Simon'}
> say.call(user, 'hello')
> ```



ğŸŒ° ä¾‹å­ / ä¿®æ”¹å…ˆå‰çš„ **ç¼“å­˜è£…é¥°å™¨** ä¾‹å­ï¼š
```js
 let worker = {
  someMethod() {
    return 1;
  },

  slow(x) {
    // ...
    // ... CPU è¿‡è½½ä»»åŠ¡
    // ...
    console.log("Called with " + x);
    return x * this.someMethod(); // (*)
  }
};

function cachingDecorator(func) {
  let cache = new Map()
  return function(x) {
    if(cache.has(x)) {
      if(cache.has(x)) return cache.get(x)
    }
   	let result = func.call(this, x)
    cache.set(x, result)
  	return result
  }
}

worker.slow = cachingDecorator(worker.slow)
console.log(worker.slow(2))
console.log(worker.slow(2)) // è°ƒç”¨ç¼“å­˜
```

> åœ¨æ­¤ä¹‹ä¸­ `this ` çš„ä¼ é€’è¿‡ç¨‹ï¼š
>
> + åœ¨ç»è¿‡è£…é¥°ä¹‹åï¼Œ`worker.slow` ç°åœ¨æ˜¯åŒ…è£…å™¨ `function (x) { ... }`ã€‚
> + å› æ­¤ï¼Œå½“ `worker.slow(2)` æ‰§è¡Œæ—¶ï¼ŒåŒ…è£…å™¨å°† `2` ä½œä¸ºå‚æ•°ï¼Œå¹¶ä¸” `this=worker`ï¼ˆå®ƒæ˜¯ç‚¹ç¬¦å· `.` ä¹‹å‰çš„å¯¹è±¡ï¼‰ã€‚
> + åœ¨åŒ…è£…å™¨å†…éƒ¨ï¼Œå‡è®¾ç»“æœå°šæœªç¼“å­˜ï¼Œ`func.call(this, x)` å°†å½“å‰çš„ `this`ï¼ˆ`=worker`ï¼‰å’Œå½“å‰çš„å‚æ•°ï¼ˆ`=2`ï¼‰ä¼ é€’ç»™åŸå§‹æ–¹æ³•ã€‚





## ä¼ é€’å¤šä¸ªå‚æ•°

å¦‚æœè¦å°† **ç¼“å­˜è£…é¥°å™¨** å†™å¾—æ›´åŠ é€šç”¨ï¼Œå°±è¦ä½¿å®ƒå¯ä»¥æ¥æ”¶å¤šä¸ªå‚æ•°çš„å‡½æ•°ã€‚

ä¾‹å¦‚ï¼Œç°åœ¨çš„ `woker.slow` å˜æˆäº†å¤šä¸ªå‚æ•°çš„å‡½æ•°ï¼š
```js
let worker = {
  slow(min, max) {
    // ... 
    return min + max 
  }
}

worker.slow = cachingDecorator(woker.slow) 
```

> æ­¤å¤„ `cachingDecorator` åº”è¯¥è¦è®°ä½ç›¸åŒå‚æ•°çš„è°ƒç”¨ã€‚
>
> åœ¨ä¹‹å‰ï¼Œå¯¹äºå•ä¸ªå‚æ•° `x`ï¼Œå¯ä»¥åªä½¿ç”¨ `cache.set(x, result)` æ¥ä¿å­˜ç»“æœï¼Œå¹¶ä½¿ç”¨ `cache.get(x)` æ¥æ£€ç´¢å¹¶è·å–ç»“æœã€‚
>
> ä½†æ˜¯ç°åœ¨ï¼Œéœ€è¦è®°ä½ **å‚æ•°ç»„åˆ** `(min,max)` çš„ç»“æœã€‚åŸç”Ÿçš„ `Map` ä»…å°†å•ä¸ªå€¼ä½œä¸ºé”®ï¼ˆkeyï¼‰ã€‚

> è§£å†³æ–¹æ¡ˆçš„æ–¹å‘ï¼š
>
> + å®ç°ä¸€ä¸ªæ–°çš„ï¼ˆæˆ–ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ï¼‰ç±»ä¼¼ map çš„æ›´é€šç”¨å¹¶ä¸”å…è®¸å¤šä¸ªé”®çš„æ•°æ®ç»“æ„ã€‚
> + åµŒå¥— Mapï¼š`cache.set(min)` å°†æ˜¯ä¸€ä¸ªå­˜å‚¨ï¼ˆé”®å€¼ï¼‰å¯¹ `(max, result)` çš„ `Map`ã€‚æ‰€ä»¥å¯ä»¥ä½¿ç”¨ `cache.get(min).get(max)` æ¥è·å– `result`ã€‚
> + å°†ä¸¤ä¸ªå€¼åˆå¹¶ä¸ºä¸€ä¸ªã€‚ä¸ºäº†çµæ´»æ€§ï¼Œå¯ä»¥å…è®¸ä¸ºè£…é¥°å™¨æä¾›ä¸€ä¸ªã€Œå“ˆå¸Œå‡½æ•°ã€ï¼Œè¯¥å‡½æ•°çŸ¥é“å¦‚ä½•å°†å¤šä¸ªå€¼åˆå¹¶ä¸ºä¸€ä¸ªå€¼ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ä¸€èˆ¬ä½¿ç”¨ ã€Œå“ˆå¸Œå‡½æ•°ã€å°†å¤šä¸ªå€¼åˆå¹¶ä¸ºä¸€ä¸ªå€¼ã€‚

åœ¨ `func.call` æ—¶ï¼Œä¼ å…¥çš„ä¸å†æ˜¯ä¸€ä¸ª `x`ï¼Œå¦‚æœæ˜¯å¤šä¸ªå‚æ•°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Rest è¯­æ³•çš„ `...` æ”¶é›†å¤šä¸ªå‚æ•°ã€‚æ‰€ä»¥å†™ä¸º `func.call(this, ...arguments)`ï¼Œ `arguments`  æ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰å‚æ•°çš„ä¸ºæ•°ç»„ã€‚

æœ€åï¼Œæ”¹è‰¯è¿‡åçš„ `cachingDecorator`ä¸ºï¼š

```js
let worker = {
  slow(min, max) {
    alert(`Called with ${min},${max}`);
    return min + max;
  }
};

function cachingDecorator(func, hash) {
  let cache = new Map();
  return function() {
    let key = hash(arguments); // (*)
    if (cache.has(key)) {
      return cache.get(key);
    }

    let result = func.call(this, ...arguments); // (**)

    cache.set(key, result);
    return result;
  };
}

function hash(args) {
  return args[0] + ',' + args[1];
}

worker.slow = cachingDecorator(worker.slow, hash);

alert( worker.slow(3, 5) ); // works
alert( "Again " + worker.slow(3, 5) ); // same (cached)
```

> ç°åœ¨è¿™ä¸ªåŒ…è£…å™¨å¯ä»¥å¤„ç†ä»»æ„æ•°é‡çš„å‚æ•°äº†ï¼ˆå°½ç®¡å“ˆå¸Œå‡½æ•°è¿˜éœ€è¦è¢«è¿›è¡Œè°ƒæ•´ä»¥å…è®¸ä»»æ„æ•°é‡çš„å‚æ•°ï¼‰ã€‚
>
> ä¸¤ä¸ªå…³é”®ç‚¹ï¼š
>
> + `(*)` å¤„ï¼šè°ƒç”¨ `hash` æ¥ä» `arguments` åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„é”®ã€‚è¿™é‡Œçš„ å“ˆå¸Œå‡½æ•° ä½¿ç”¨ä¸€ä¸ª è¿æ¥ç¬¦å°†ä¸¤ä¸ªå‚æ•°è¿æ¥åœ¨ä¸€èµ·ä½œä¸º Mapo çš„é”®ã€‚
> + `(**)` ï¼š ä½¿ç”¨ `func.call(this, ...arguments)` å°†åŒ…è£…å™¨è·å–çš„ä¸Šä¸‹æ–‡å’Œæ‰€æœ‰å‚æ•°ä¼ é€’ç»™åŸå§‹å‡½æ•°ã€‚



## `func.apply()`

å¯ä»¥ä½¿ç”¨ `func.apply(this, arguments)` ä»£æ›¿ `func.call(this, ...arguments)`ã€‚

ä½¿ç”¨è¯­æ³•ï¼š`func.apply(context, args)`ã€‚

+ `context`ï¼š å¯ä»¥è®¾ç½®ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚
+ `args` ï¼š ç±»æ•°ç»„å¯¹è±¡ä½œä¸ºå‚æ•°åˆ—è¡¨ã€‚

**`call` å’Œ `apply` å”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼š`call` æœŸæœ›ä¸€ä¸ªå‚æ•°åˆ—è¡¨ï¼Œè€Œ `apply` æœŸæœ›ä¸€ä¸ªåŒ…å«è¿™äº›å‚æ•°çš„ç±»æ•°ç»„å¯¹è±¡ã€‚** å…¶ä»–æ–¹é¢ï¼Œä¸¤ä¸ªæ–¹æ³•çš„è°ƒç”¨éƒ½å‡ ä¹æ˜¯ç­‰æ•ˆçš„ã€‚

```js
func.call(context, ...args);
func.apply(context, args);
```

> å…³äº `args` çš„å¾®å°åŒºåˆ«ï¼š
>
> + Spread è¯­æ³• `...` å…è®¸å°† **å¯è¿­ä»£å¯¹è±¡** `args` ä½œä¸ºåˆ—è¡¨ä¼ é€’ç»™ `call`ã€‚
> + `apply` åªæ¥å— **ç±»æ•°ç»„** `args`ã€‚

å¯¹äºå³å¯è¿­ä»£åˆæ˜¯ç±»æ•°ç»„çš„å¯¹è±¡ï¼Œä¾‹å¦‚ä¸€ä¸ªçœŸæ­£çš„æ•°ç»„ï¼Œä½¿ç”¨ `call` æˆ– `apply` å‡å¯ï¼Œä½†æ˜¯ `apply` å¯èƒ½ä¼šæ›´å¿«ï¼Œå› ä¸ºå¤§å¤šæ•° JavaScript å¼•æ“åœ¨å†…éƒ¨å¯¹å…¶è¿›è¡Œäº†ä¼˜åŒ–ã€‚

è¿™ç§ **å°†æ‰€æœ‰å‚æ•°è¿åŒä¸Šä¸‹æ–‡** ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°è¢«ç§°ä¸º ã€Œå‘¼å«è½¬ç§»ã€ï¼š

```js
let wrapper = function() {
  return func.apply(this, arguments);
};
```



### æ–¹æ³•å€Ÿç”¨

 ä½¿ç”¨ `func.apply` è§£å†³ä¸Šé¢ å“ˆå¸Œå‡½æ•° å¯ä»¥æ¥æ”¶ä»»æ„æ•°é‡çš„ `args`ï¼š

> ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨ `arguments.join()` ï¼Œå› ä¸º `arguments` åªæ˜¯ç±»æ•°ç»„å¯¹è±¡è€Œä¸æ˜¯çœŸæ­£çš„æ•°ç»„ï¼Œä¸èƒ½ä½¿ç”¨æ•°ç»„çš„æ–¹æ³•ã€‚

```js
function hash() {
  [].join.call(arguments)
}
```

è¿™ç§ç”¨æ³•ä¸º **æ–¹æ³•å€Ÿç”¨**ã€‚ä»å¸¸è§„æ•°ç»„ `[]` ä¸­å€Ÿç”¨ `join` æ–¹æ³•ï¼Œä½¿ç”¨ `[].join.call(arguments)` åœ¨ `arguments` çš„ä¸Šä¸‹æ–‡è¿è¡Œå®ƒã€‚



## è£…é¥°å™¨å’Œå‡½æ•°å±æ€§

é€šå¸¸ï¼Œç”¨è£…é¥°çš„å‡½æ•°æ›¿æ¢ä¸€ä¸ªå‡½æ•°æˆ–ä¸€ä¸ªæ–¹æ³•æ˜¯å®‰å…¨çš„ã€‚

ä½†æ˜¯å¦‚æœåŸå§‹å‡½æ•°æœ‰å±æ€§ï¼Œä¾‹å¦‚ `func.calledCount` æˆ–å…¶ä»–ï¼Œåˆ™è£…é¥°åçš„å‡½æ•°å°†ä¸å†æä¾›è¿™äº›å±æ€§ã€‚å› ä¸ºè¿™æ˜¯è£…é¥°å™¨ã€‚

ä¸€äº›åŒ…è£…å™¨å¯èƒ½ä¼šæä¾›è‡ªå·±çš„å±æ€§ã€‚ä¾‹å¦‚ï¼Œè£…é¥°å™¨ä¼šè®¡ç®—ä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨äº†å¤šå°‘æ¬¡ä»¥åŠèŠ±è´¹äº†å¤šå°‘æ—¶é—´ï¼Œå¹¶é€šè¿‡åŒ…è£…å™¨å±æ€§æš´éœ²è¿™äº›ä¿¡æ¯ã€‚

å­˜åœ¨ä¸€ç§åˆ›å»ºè£…é¥°å™¨çš„æ–¹æ³•ï¼Œè¯¥è£…é¥°å™¨å¯ä¿ç•™å¯¹å‡½æ•°å±æ€§çš„è®¿é—®æƒé™ï¼Œä½†è¿™éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„ `Proxy` å¯¹è±¡æ¥åŒ…è£…å‡½æ•°ã€‚





## æ€»ç»“

+ **è£…é¥°å™¨** æ˜¯ä¸€ä¸ªå›´ç»•æ”¹å˜å‡½æ•°è¡Œä¸ºçš„åŒ…è£…å™¨ã€‚ä¸»è¦å·¥ä½œä»ç”±è¯¥å‡½æ•°æ¥å®Œæˆã€‚ï¼ˆå¯ä»¥çœ‹ä½œæ˜¯æ·»åŠ å‡½æ•°é¢å¤–åŠŸèƒ½çš„ åˆ‡é¢ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ªè€Œä¸éœ€è¦æ›´æ”¹å‡½æ•°ä»£ç ï¼‰

+ å®ç°å‡½æ•° **è£…é¥°å™¨** ä½¿ç”¨ä¸¤ç§æ–¹æ³•ï¼š
  + `func.call(context, arg1, arg2 ...)` ï¼šä½¿ç”¨ç»™å®šçš„ä¸Šä¸‹æ–‡ **å¯¹è±¡** å’Œ **å‚æ•°** è°ƒç”¨ `func`.
  + `func.apply(context, args)`ï¼šè°ƒç”¨ `func` å°† `context` ä¸Šä¸‹æ–‡å¯¹è±¡ä½œä¸º `this` å’Œ **ç±»æ•°ç»„** çš„ `args` ä¼ é€’ç»™å‚æ•°åˆ—è¡¨ã€‚



+ é€šå¸¸ **å‘¼å«è½¬ç§»** ä½¿ç”¨ `apply` å®Œæˆï¼š

  ```js
  let wrapper = function() {
    return originalFunc.apply(this, arguments)
  }
  ```



+ **æ–¹æ³•å€Ÿç”¨**ï¼š ä»ä¸€ä¸ªå¯¹è±¡ä¸­è·å–ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨å¦ä¸€ä¸ªå¯¹è±¡çš„ä¸Šä¸‹æ–‡ä¸­ã€Œè°ƒç”¨ã€å®ƒã€‚é‡‡ç”¨æ•°ç»„æ–¹æ³•å¹¶å°†å®ƒä»¬åº”ç”¨äº `arguments` æˆ–è€…ä½¿ç”¨ Rest å‚æ•°å¯¹è±¡ã€‚



## å®ä¾‹

### é—´è°

> åˆ›å»ºä¸€ä¸ªè£…é¥°å™¨ `spy(func)`ï¼Œå®ƒåº”è¯¥è¿”å›ä¸€ä¸ªåŒ…è£…å™¨ï¼Œè¯¥åŒ…è£…å™¨å°† **æ‰€æœ‰å¯¹å‡½æ•°çš„è°ƒç”¨** ä¿å­˜åœ¨å…¶ `calls` å±æ€§ä¸­ã€‚æ¯ä¸ªè°ƒç”¨éƒ½ä¿å­˜åœ¨ä¸€ä¸ª **å‚æ•°æ•°ç»„**ã€‚

```js
function work(a, b) {
  console.log( a + b ); // work æ˜¯ä¸€ä¸ªä»»æ„çš„å‡½æ•°æˆ–æ–¹æ³•
}

work = spy(work);

work(1, 2); // 3
work(4, 5); // 9

for (let args of work.calls) {
  console.log( 'call:' + args.join() ); // "call:1,2", "call:4,5"
}
```

::: details

```js
function spy(func) {
  function wrapper(...args) {
    wrapper.calls.push(args)
    return func.apply(this, args)
  }
  
  wrapper.calls = []
	return wrapper
}
```

:::

### å»¶æ—¶

> åˆ›å»ºä¸€ä¸ªè£…é¥°å™¨ `delay(f, ms)`ï¼Œè¯¥è£…é¥°å™¨å°† `f` çš„æ¯æ¬¡è°ƒç”¨å»¶æ—¶ `ms` æ¯«ç§’ã€‚

```js
function f(x) {
  conosle.log(x);
}

// create wrappers
let f1000 = delay(f, 1000);
let f1500 = delay(f, 1500);

f1000("test"); // åœ¨ 1000ms åæ˜¾ç¤º "test"
f1500("test"); // åœ¨ 1500ms åæ˜¾ç¤º "test"
```

::: details

```js
function delay(f, ms) {
  return function() {
    setTimeout(()=> func.apply(this, arguments), ms)
  }
}
```

> ç”±äº **ç®­å¤´å‡½æ•°** æ²¡æœ‰è‡ªå·±çš„ `this` å’Œ `arguments`ï¼Œæ‰€ä»¥ `f.apply(this, arguments)` ä» **å½“å‰åŒ…è£…å™¨** ä¸­è·å– `this` å’Œ `arguments`ã€‚

å¦‚æœä¸ä½¿ç”¨ç®­å¤´å‡½æ•°ï¼Œéœ€è¦é€šè¿‡ä¸­é—´å˜é‡ä¼ é€’æ­£ç¡®çš„ `this`ã€‚

```js
function delay(f, ms) {
  return function(...args) {
    let savedThis = this
    setTimeout(function(){
      f.apply(savedThis, args)
    }, ms)
  }
}
```

:::



### é˜²æŠ–

> é˜²æŠ–å¤„ç†å¯ä»¥çœ‹ä½œè£…é¥°å™¨ `debounce(f, ms)` çš„ç»“æœæ˜¯ä¸€ä¸ª **åŒ…è£…èµ·**ï¼Œè¯¥åŒ…è£…å™¨æš‚åœå¯¹ `f` çš„è°ƒç”¨ï¼Œç›´åˆ°ç»è¿‡ `ms` æ¯«ç§’çš„ã€Œå†·å´æœŸã€ï¼Œç„¶åä½¿ç”¨æœ€æ–°çš„å‚æ•°è°ƒç”¨ `f` ä¸€æ¬¡ã€‚
>
> ä¾‹å¦‚ï¼Œä¸€ä¸ªå‡½æ•° `f` æ›¿æ¢ä¸º `f = debounce(f, 1000)`ã€‚å¦‚æœåŒ…è£…å™¨å‡½æ•° åˆ†åˆ«åœ¨ 0 msï¼Œ 200 msï¼Œ 500 ms æ—¶è¢«è°ƒç”¨äº†ï¼Œä¹‹åæ²¡æœ‰å…¶ä»–è°ƒç”¨ï¼Œé‚£ä¹ˆå®é™…çš„ `f` åªä¼šåœ¨ 1500 ms æ—¶è¢«è°ƒç”¨ä¸€æ¬¡ã€‚ç®€å•çš„è¯´ï¼Œå°±æ˜¯éœ€è¦ç­‰å¾… æœ€åä¸€æ¬¡è°ƒç”¨æ—¶ ç»è¿‡ 1000 ms å çš„å†·å´æœŸã€‚ 
>
> å®é™…åº”ç”¨ï¼šå¦‚æœç”¨æˆ·è¾“å…¥ä¸€äº›å†…å®¹ï¼Œåœ¨ç”¨æˆ·è¾“å…¥å®Œæˆåæ‰å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè€Œæ²¡æœ‰å¿…è¦ä¸ºæ¯ä¸€ä¸ªå­—ç¬¦çš„è¾“å…¥éƒ½å‘é€è¯·æ±‚ã€‚è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œæ‰å¤„ç†æ•´ä¸ªè¾“å…¥ç»“æœã€‚ä¸€èˆ¬ è¾“å…¥æ¡† çš„å‘ç”Ÿè¾“å…¥å˜åŒ–æ—¶ä¼šè°ƒç”¨ä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå¦‚æœç›‘å¬æ¯ä¸€æ¬¡å˜åŒ–åˆ™æ•´ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ä¼šè¢«é¢‘ç¹è°ƒç”¨ï¼Œä½¿ç”¨ é˜²æŠ– `debounce` å»¶æ—¶ 1000 ms å¤„ç†ï¼Œåªä¼šåœ¨æœ€åä¸€æ¬¡è¾“å…¥åçš„ 1000 ms åè¢«è°ƒç”¨ä¸€æ¬¡äº‹ä»¶å¤„ç†å‡½æ•°ã€‚

æ‰‹å†™ä¸€ä¸ª `debounce` é˜²æŠ–è£…é¥°å™¨ï¼š
::: details

```js
function debounce(func, delay) {
  let timeout;
  return function() {
    clearTimeout(timeout)
    setTimeout(()=> func.apply(this, arguments), delay)
  }
}
```

:::



### èŠ‚æµ

> èŠ‚æµè£…é¥°å™¨ `throttle(f, ms)` è¿”å›ä¸€ä¸ªåŒ…è£…å™¨ï¼Œå½“è¢«å¤šæ¬¡è°ƒç”¨æ—¶ï¼Œåœ¨æ¯ ms æœ€å¤šå°†è°ƒç”¨ä¼ é€’ç»™ `f` ä¸€æ¬¡ã€‚
>
> ä¸é˜²æŠ–è£…é¥°å™¨åŒºåˆ†ï¼š
>
> + `debouce` ä¼šåœ¨ ã€Œå†·å´æœŸã€ä¹‹åè¿è¡Œå‡½æ•°ä¸€æ¬¡ã€‚é€‚åˆå¤„ç†æœ€ç»ˆç»“æœã€‚
> + `throttle` è¿è¡Œå‡½æ•°çš„é¢‘ç‡ ä¸ä¼šå¤§äº æ‰€ç»™å®šçš„æ—¶é—´ `ms`ã€‚é€‚ç”¨äº **ä¸åº”è¯¥ç»å¸¸è¿›è¡Œçš„å®šæ—¶æ›´æ–°**ã€‚
> + é˜²æŠ–æ˜¯æ¥å¬ç”µè¯çš„ç§˜ä¹¦ï¼Œä¸€ç›´ç­‰åˆ° ms æ¯«ç§’ä¹‹åæ‰ä¼šæŠŠä¿¡æ¯ä¼ è¾¾ç»™è€æ¿ã€‚è€ŒèŠ‚æµæ˜¯æ¥å¬ç”µè¯çš„ç§˜ä¹¦ï¼Œæ‰“æ‰°è€æ¿çš„é¢‘ç‡ä¸èƒ½è¶…è¿‡æ¯ ms ä¸€æ¬¡ã€‚
>
> å®é™…åº”ç”¨ï¼šè¿½è¸ªé¼ æ ‡æŒ‡é’ˆçš„ç§»åŠ¨ï¼Œä»¥æ›´æ–°ç½‘é¡µä¸Šçš„æŸäº›ä¿¡æ¯ã€‚ä½†æ˜¯æ²¡æœ‰å¿…è¦å°†æ¯ä¸€ä¸ªå¾®å°çš„ç§»åŠ¨éƒ½ç»‘å®šäº‹ä»¶æ›´æ–°ï¼Œé«˜äºæ¯ 100 ms çš„æ›´æ–°é¢‘æ¬¡æ²¡æœ‰æ„ä¹‰ã€‚æ‰€ä»¥å°†å…¶åŒ…è£…åˆ° èŠ‚æµè£…é¥°å™¨ï¼Œä½¿ç”¨ `throttle(update, 1000)` ä½œä¸ºæ¯æ¬¡é¼ æ ‡ç§»åŠ¨æ—¶è¿è¡Œçš„å‡½æ•°ï¼Œè€Œä¸æ˜¯åŸå§‹çš„ `update()`ã€‚è£…é¥°å™¨ä¼šè¢«é¢‘ç¹è°ƒç”¨ï¼Œä½†æ˜¯æœ€å¤šæ¯ 100 ms å°†è°ƒç”¨è£…å‘ç»™ `update()` ä¸€æ¬¡ã€‚



::: details 

```js
function throttle(func, ms) {
  let isThrottled = false,
      savedArgs,
      savedThis;
  
 	function wrapper() {
    if(isThrottled) {
      savedArgs = arguments
      savedThis = this
      return
    }
    isThrottled = true
    
    func.apply(this, arguments)
    
    setTimeout(function(){
      isThrottled = false
      if(savedArgs) {
        wrapper.apply(savedThis, savedArgs)
        savedArgs = savedThis = null
      }
    }, ms)
  }
  
  return wrapper
}


function f(a){
  console.log(a)
}

let f1000 = throttle(f, 1000)
f1000(1)
f1000(2) 
f1000(3)
```

è°ƒç”¨ `throttle(func, ms)` è¿”å› `wrapper`ã€‚

+ ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œ `wrapper` å€¼è¿è¡Œ `func` å¹¶è®¾ç½®å†·å´çŠ¶æ€ï¼ˆ`isThrottled = true`ï¼‰ã€‚
+ åœ¨è¿™ç§çŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰è°ƒç”¨éƒ½è®°å¿†åœ¨ `savedArgs/savedThis` ä¸­ã€‚è¯·æ³¨æ„ï¼Œä¸Šä¸‹æ–‡å’Œå‚æ•°ï¼ˆargumentsï¼‰åŒç­‰é‡è¦ï¼Œåº”è¯¥è¢«è®°ä¸‹æ¥ã€‚
+ ç»è¿‡ `ms` æ¯«ç§’åï¼Œè§¦å‘ `setTimeout` ä¸­çš„å›è°ƒå‡½æ•°ã€‚å†·å´çŠ¶æ€ç§»é™¤ï¼ˆ`isThrottled = false`ï¼‰ï¼Œå¦‚æœå¿½ç•¥äº†è°ƒç”¨ï¼Œå³å°†ä½¿ç”¨æœ€åè®°å¿†çš„å‚æ•°å’Œä¸Šä¸‹æ–‡æ‰§è¡Œ `wrapper`ï¼ˆå› ä¸ºä¸ä»…ä»…éœ€è¦æ‰§è¡Œ `func`ï¼Œè¿˜è¦è¿›å…¥ å†·å´çŠ¶æ€å¹¶ä¸”è®¾ç½® timeout é‡åˆ¶å®ƒï¼‰ã€‚

æ‰€ä»¥åœ¨ä¾‹å­ä¸­ï¼Œ åªæ‰§è¡Œäº† ç¬¬ä¸€æ¬¡ å’Œ æœ€åä¸€æ¬¡ã€‚ 

:::