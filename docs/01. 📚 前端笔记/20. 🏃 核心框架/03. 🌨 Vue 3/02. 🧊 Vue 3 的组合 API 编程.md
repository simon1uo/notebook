---
title: ğŸ§Š Vue 3 çš„ç»„åˆ API ç¼–ç¨‹
date: 2022-04-10 12:42:10
permalink: /pages/0768ce/
categories: 
  - ğŸ“š å‰ç«¯ç¬”è®°
  - ğŸƒ æ ¸å¿ƒæ¡†æ¶
  - ğŸŒ¨ Vue 3
tags: 
  - null
author: 
  name: Simon
  link: https://github.com/simon1uo
---
## å¸¸ç”¨ API

### `setup`

+ `setup` æ˜¯ Vue 3 ä¸­çš„æ–°çš„ä¸€ä¸ªé…ç½®é¡¹ï¼Œ**å€¼ä¸ºä¸€ä¸ªå‡½æ•°**ã€‚

  æ˜¯æ‰€æœ‰ Composition ç»„åˆ API ã€Œè¡¨æ¼”çš„èˆå°ã€ã€‚

+ ç»„ä»¶ä¸­æ‰€æœ‰åˆ°çš„ï¼š**æ•°æ®ã€æ–¹æ³•**ï¼Œéƒ½è¦é…ç½®åœ¨ `setup` ä¸­ã€‚

+ `setup` å‡½æ•°ä¸­çš„ä¸¤ç§è¿”å›å€¼ï¼š
  + :star: è‹¥æœ€åè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™å¯¹è±¡ä¸­çš„å±æ€§ã€æ–¹æ³•ï¼Œ**åœ¨æ¨¡ç‰ˆä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨**ã€‚
  + è‹¥è¿”å›ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ï¼Œåˆ™å¯ä»¥è¿”å›è‡ªå®šä¹‰çš„æ¸²æŸ“å†…å®¹ï¼ˆäº†è§£ï¼‰ã€‚



ğŸŒ° ä¾‹å­ï¼šåœ¨ `setup` ä¸­è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼š

```js
setup() {
  // æ•°æ®
  let name = 'Simon'
  let age = '3'

  // æ–¹æ³•
  function sayHello() {
    alert(`hello, this is ${name}, age:${age}`)
  }

  return {
    name,
    age,
    sayHello
  }
}
```



+ :warning: æ³¨æ„ï¼š
  1. å°½é‡ä¸è¦ä¸ Vue 2.x ä¸­çš„é…ç½®æ··ç”¨ï¼š
     + Vue 2.x çš„é…ç½®ï¼ˆ`data` ã€`methods`ã€`computed`  â€¦ ï¼‰ä¸­å¯ä»¥è®¿é—®åˆ° `setup` ä¸­çš„å±æ€§ã€æ–¹æ³•ã€‚
     + ä½†æ˜¯åœ¨ `setup` é…ç½®ä¸­ä¸èƒ½è®¿é—® Vue 2.x çš„é…ç½®ï¼ˆ`data` ã€`methods`ã€`computed`  â€¦ ï¼‰ã€‚
     + å½“ `setup` ä¸­çš„å±æ€§ã€æ–¹æ³•ä¸ Vue 2.x çš„é…ç½®æœ‰é‡åæ—¶ï¼Œ**ä»¥ `setup` ä¼˜å…ˆã€‚**
  2. `setup` ä¸èƒ½æ˜¯ä¸€ä¸ª `async` å‡½æ•°ï¼Œå› ä¸ºè¿”å›å€¼ä¸å†æ˜¯ `return` å¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªè¢« `async` åŒ…è£¹çš„å¯¹è±¡ï¼Œè€Œæ˜¯ `promise ` ï¼Œæ­¤æ—¶æ¨¡ç‰ˆæ— æ³•ä½¿ç”¨ `return` ä¸­çš„å±æ€§ï¼ˆ**åæœŸå¯ä»¥è¿”å›ä¸€ä¸ª `Promise` çš„å®ä¾‹ï¼Œä½†æ˜¯éœ€è¦ `Suspense` å’Œå¼‚æ­¥ç»„ä»¶çš„é…åˆ** ğŸ”— [Suspense ç»„ä»¶]()ï¼‰



### `ref` å‡½æ•°

> + åœ¨ä¹‹å‰ä½¿ç”¨çš„ `ref` ï¼Œä½œç”¨æ˜¯ç»™åŸç”Ÿçš„ DOM æ ‡ç­¾æ·»åŠ æ ‡è¯†ï¼Œæ›¿ä»£ `id` çš„ä½œç”¨ã€‚
> + åœ¨ä¸Šè¿° `setup` çš„ä¾‹å­ä¸­å®šä¹‰çš„æ•°æ®ä¸æ˜¯ä¸€ä¸ªå“åº”å¼çš„æ•°æ®ï¼Œå‘ç”Ÿå˜åŒ– Vue æ— æ³•ç›‘æµ‹ã€‚

+ `ref` å‡½æ•°ä½œç”¨ï¼š**å®šä¹‰ä¸€ä¸ªå“åº”å¼çš„æ•°æ®**ã€‚

+ è¯­æ³•ï¼š `const xxx = ref(initValue)`
  + åˆ›å»ºä¸€ä¸ª `ReflImpl` ï¼š`reference` + `implement` åŒ…å«å“åº”å¼æ•°æ®çš„**å¼•ç”¨ `ref` å¯¹è±¡**ï¼ˆå¼•ç”¨å®ç°å¯¹è±¡ï¼‰ã€‚
  + åœ¨ JS ä¸­æ“ä½œæ•°æ®ï¼š `xxx.value` 
  + **åœ¨æ¨¡ç‰ˆä¸­è¯»å–æ•°æ®**ï¼šç›´æ¥ `{{ xxx }}`ï¼ˆè‡ªåŠ¨è§£æ `ReflImpl` çš„ `value` å€¼ï¼‰



+ æ³¨æ„ï¼š
  + å‚æ•°å¯ä»¥æ¥æ”¶çš„æ•°æ®æœ‰ï¼šåŸºæœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡ç±»å‹ã€‚
  + **åŸºæœ¬ç±»å‹çš„æ•°æ®**ï¼šå“åº”å¼ä¾ç„¶æ˜¯ç›´æ¥é  `Object.defineProperty()` çš„ **`get` ä¸ `set`** ï¼ˆæ•°æ®åŠ«æŒï¼‰å®Œæˆçš„ã€‚
  + **å¯¹è±¡ç±»å‹çš„æ•°æ®**ï¼šå€ŸåŠ© Vue 3 ä¸­çš„ `reactive` å‡½æ•°ã€‚



### `reactive` å‡½æ•°

+ `reactive` å‡½æ•°çš„ä½œç”¨ï¼šå®šä¹‰ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„å“åº”å¼æ•°æ®ã€‚ï¼ˆå¯¹äºåŸºæœ¬æ•°æ®ç±»å‹åªèƒ½ä½¿ç”¨ `ref`ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹æ”¾åœ¨å¯¹è±¡ä¸­å†ä½¿ç”¨ `reactive` å‡½æ•°å³å¯ ï¼‰
+ è¯­æ³•ï¼š`const ä»£ç†å¯¹è±¡ = reactive(æºå¯¹è±¡) `ï¼Œå‚æ•°æ¥æ”¶ä¸€ä¸ªå¯¹è±¡ï¼ˆæˆ–æ•°ç»„ï¼‰ï¼Œè¿”å›ä¸€ä¸ª**ä»£ç†å¯¹è±¡**ï¼ˆ`Proxy` çš„å®ä¾‹å¯¹è±¡ï¼Œä»£ç† Proxy å¯¹è±¡ï¼‰

+ ä½¿ç”¨ `reactive` å‡½æ•°å®šä¹‰çš„**å“åº”å¼æ•°æ®**æ˜¯ã€Œ**æ·±å±‚æ¬¡çš„**ã€ã€‚
+ `reactive` å‡½æ•°å†…éƒ¨åŸºäº ES6 çš„ `Proxy` å‡½æ•°å®ç°ï¼Œ**é€šè¿‡ä»£ç†å¯¹è±¡æ“ä½œæºå¯¹è±¡çš„å†…éƒ¨æ•°æ®**ã€‚



### å¯¹æ¯” `ref` ä¸ `reactive` å‡½æ•°

+ **ä»å®šä¹‰æ•°æ®ç±»å‹è§’åº¦å¯¹æ¯”**ï¼š

  + `ref` ç”¨æ¥å®šä¹‰åŸºæœ¬æ•°æ®ç±»å‹ã€‚
  + `reactive` ç”¨æ¥å®šä¹‰å¯¹è±¡ï¼ˆåŒ…æ‹¬æ•°ç»„ï¼‰ç±»å‹ã€‚

  `reactive` å¯ä»¥ç”¨æ¥å®šä¹‰åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå°è£…åœ¨ä¸€ä¸ª `data` å¯¹è±¡ä¸­å³å¯ã€‚

+ **ä»åŸç†è§’åº¦å¯¹æ¯”**ï¼š

  + `ref` é€šè¿‡  `Object.defineProperty()` çš„ `get` ä¸ `set` æ¥å®ç°å“åº”å¼ï¼ˆæ•°æ®åŠ«æŒï¼‰ã€‚
  + `reactive` é€šè¿‡ä½¿ç”¨ `Proxy` ï¼ˆæ•°æ®åŠ«æŒï¼‰ä¸ `Reflect` ï¼ˆæ“ä½œæºå¯¹è±¡å†…éƒ¨çš„æ•°æ®ï¼‰ç»“åˆå®ç°å“åº”å¼ã€‚

+ **ä»å®ç”¨è§’åº¦å¯¹æ¯”**ï¼š
  + `ref` å®šä¹‰çš„æ•°æ®ï¼Œæ“ä½œæ•°æ®éœ€è¦ä½¿ç”¨ `.value` è¯»å–ï¼Œåœ¨æ¨¡ç‰ˆä¸­å¯ä»¥ç›´æ¥è¯»å–ã€‚
  + `reactive` å®šä¹‰çš„æ•°æ®ï¼Œæ“ä½œå’Œè¯»å–æ•°æ®å¯ä»¥ç›´æ¥è¯»å–ã€‚ 



### `setup` çš„æ³¨æ„ç‚¹

- `setup` **æ‰§è¡Œçš„æ—¶æœº**ï¼š
  - åœ¨ `beforeCreate` ä¹‹å‰æ‰§è¡Œä¸€æ¬¡ï¼Œ`this` æ˜¯ `undefined`ã€‚

- `setup` **çš„å‚æ•°**ï¼š
  - `props`ï¼šå€¼ä¸ºå¯¹è±¡ï¼ŒåŒ…å«ï¼šç»„ä»¶å¤–éƒ¨ä¼ é€’è¿‡æ¥ï¼Œ**ä¸”ç»„ä»¶å†…éƒ¨å£°æ˜æ¥æ”¶äº†çš„å±æ€§**ã€‚
  - `context`ï¼š**ä¸Šä¸‹æ–‡å¯¹è±¡**ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
    - `attrs`ï¼š å€¼ä¸ºå¯¹è±¡ï¼ŒåŒ…å«ï¼šç»„ä»¶å¤–éƒ¨ä¼ é€’è¿‡æ¥ï¼Œ**ä½†æ²¡æœ‰åœ¨ `props` é…ç½®ä¸­å£°æ˜çš„å±æ€§ï¼Œç›¸å½“äº ```this.$attrs```ã€‚**
    - `slots`ï¼š**æ”¶åˆ°çš„æ’æ§½å†…å®¹**ï¼Œç›¸å½“äº ```this.$slots```ã€‚
    - `emit`ï¼š**åˆ†å‘è‡ªå®šä¹‰äº‹ä»¶çš„å‡½æ•°**ï¼Œç›¸å½“äº ```this.$emit```ã€‚æ³¨æ„ï¼Œè‡ªå®šä¹‰äº‹ä»¶åœ¨è¦è§¦å‘çš„ç»„ä»¶ä¸­ï¼Œä¸ `props` ç›¸åŒï¼Œä½¿ç”¨ `emits` å…ˆå£°æ˜ï¼Œå¦åˆ™ä¼šè­¦å‘Šã€‚

### å“åº”å¼åŸç†



#### Vue 2 ä¸­çš„å“åº”å¼

- å®ç°åŸç†ï¼ˆå¯¹äºå¯¹è±¡ç±»å‹å’Œæ•°ç»„ç±»å‹çš„æ•°æ®ï¼‰ï¼š

  - **å¯¹è±¡ç±»å‹**ï¼šé€šè¿‡ `Object.defineProperty()` å¯¹å±æ€§çš„è¯»å–ã€ä¿®æ”¹è¿›è¡Œæ‹¦æˆªï¼ˆæ•°æ®åŠ«æŒï¼‰ã€‚

  - **æ•°ç»„ç±»å‹**ï¼š**é€šè¿‡é‡å†™æ›´æ–°æ•°ç»„çš„ä¸€ç³»åˆ—æ–¹æ³•æ¥å®ç°æ‹¦æˆª**ã€‚ï¼ˆå¯¹æ•°ç»„çš„å˜æ›´æ–¹æ³•è¿›è¡Œäº†åŒ…è£¹ï¼‰ã€‚

    ```js
    Object.defineProperty(data, 'count', {
        get () {}, 
        set () {}
    })
    ```

- **å­˜åœ¨é—®é¢˜**ï¼š~~ï¼ˆå¯ä»¥é€šè¿‡ `Vue.set`ï¼ˆ`this.$set` ï¼‰ è§£å†³ï¼‰~~

  - æ–°å¢å±æ€§ã€åˆ é™¤å±æ€§ï¼Œ**ç•Œé¢ä¸ä¼šæ›´æ–°**ã€‚
  - ç›´æ¥é€šè¿‡ä¸‹æ ‡ä¿®æ”¹æ•°ç»„ï¼Œ**ç•Œé¢ä¸ä¼šè‡ªåŠ¨æ›´æ–°**ã€‚



#### Vue3 çš„å“åº”å¼

- å®ç°åŸç†: 
  - é€šè¿‡ **Proxy**ï¼ˆä»£ç†ï¼‰ï¼š**æ‹¦æˆªå¯¹è±¡ä¸­ä»»æ„å±æ€§çš„å˜åŒ–**ï¼ŒåŒ…æ‹¬ï¼šå±æ€§å€¼çš„è¯»å†™ã€å±æ€§çš„æ·»åŠ ã€å±æ€§çš„åˆ é™¤ç­‰ã€‚
  - é€šè¿‡ **Reflect**ï¼ˆåå°„ï¼‰ï¼š**æ˜ å°„å¯¹æºå¯¹è±¡çš„å±æ€§è¿›è¡Œæ“ä½œ**ã€‚

```js
new Proxy(data, {
	// æ‹¦æˆªè¯»å–å±æ€§å€¼
    get (target, prop) {
    	return Reflect.get(target, prop)
    },
    // æ‹¦æˆªè®¾ç½®å±æ€§å€¼æˆ–æ·»åŠ æ–°å±æ€§
    set (target, prop, value) {
    	return Reflect.set(target, prop, value)
    },
    // æ‹¦æˆªåˆ é™¤å±æ€§
    deleteProperty (target, prop) {
    	return Reflect.deleteProperty(target, prop)
    }
})
```

> ğŸ”— ç›¸å…³é“¾æ¥ MDNï¼š
>
> - **Proxy**ï¼šhttps://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy
>
> - **Reflect**ï¼šhttps://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect





### è®¡ç®—å±æ€§ `computed` å‡½æ•°

Vue 3 ä¸­çš„è®¡ç®—å±æ€§ `computed` å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ä¸ Vue 2 ä¸­çš„ `computed` ä¸€è‡´ï¼Œåœ¨ Vue 3 ä¸­è®¡ç®—å±æ€§æ”¾å…¥äº† `setup` ä¸­ã€‚å¯ä»¥å°†å®šä¹‰åœ¨ `setup` ä¸­çš„æ•°æ®è®¾ç½®ä¸ºè®¡ç®—å±æ€§ã€‚



ğŸŒ° è®¡ç®—å±æ€§çš„ç®€å†™å½¢å¼ï¼š

```js
setup() {
  // æ•°æ®å±æ€§
  let person = reactive({
    firstName: 'Simon',
    lastName: 'Luo',
  })

  // è®¡ç®—å±æ€§
  person.fullName = computed(() => {
    return person.firstName + '-' + person.lastName
  })

  return {
    person,
  }
```

> + ä¸Šè¿°ç®€å†™çš„å½¢å¼è‹¥å°†è®¡ç®—åçš„å±æ€§ä¿®æ”¹ä¼šæç¤ºè­¦å‘Šï¼Œå› ä¸ºç®€å†™çš„è®¡ç®—å±æ€§æ˜¯åªè¯»çš„ã€‚



ğŸŒ° è®¡ç®—å±æ€§çš„å®Œæ•´å½¢å¼ï¼ˆåŒ…æ‹¬ `get()` å’Œ `set()` ï¼‰ï¼š

```js
person.fullName = computed({
  get() {
    return person.firstName + '-' + person.lastName
  },
  set(value) {
    const nameArr = value.split('-')
    person.firstName = nameArr[0]
    person.lastName = nameArr[1]
  }
})
```



### æ•°æ®ç›‘è§† `watch` å‡½æ•°

ä¸ `computed` å‡½æ•°ç±»ä¼¼ï¼Œ`watch` å‡½æ•°æ”¾åœ¨ `setup` ä¸­ä½¿ç”¨ï¼Œå¹¶ä¸”ä¸ Vue 2 æ—¶çš„æ•°æ®ç›‘è§† `watch` é…ç½®ç”¨æ³•ç›¸åŒã€‚

ä½†æ˜¯ Vue 3 ä¸­çš„æ•°æ®ç›‘è§†ï¼Œ**å¯¹äºä¸åŒçš„ä½¿ç”¨æƒ…å†µæœ‰ä¸åŒçš„ç»“æœ**ï¼š

+ ç›‘è§†æ™®é€šçš„ `ref` å®šä¹‰çš„ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼š

```js
watch(sum, (newValue, oldValue)=>{
  console.log('newValue', newValue)
  console.log('oldValue', oldValue)
}, {immediate: true})
```

+ ç›‘è§†æ™®é€šçš„ `ref` å®šä¹‰çš„å¤šä¸ªå“åº”å¼æ•°æ®ï¼š

```js
watch([sum, msg], (newValue, oldValue)=>{
  console.log('newValue', newValue)
  console.log('oldValue', oldValue)
})
```

> ç›‘è§†ä½¿ç”¨ `ref` å®šä¹‰çš„æ•°æ®å¯ä»¥å®Œæ•´è·å– `newValue` ã€`oldValue` ã€‚ 

::: warning 

å¯¹äº `ref` å®šä¹‰çš„å“åº”å¼æ•°æ®çš„ä¸€ä¸ªæ³¨æ„ç‚¹ï¼š`ref` å®šä¹‰çš„æ™®é€šæ•°æ®çš„ç›‘è§†ä¸èƒ½ä½¿ç”¨ `.value` ï¼Œä¸ç”¨ä½¿ç”¨ `.value` æ˜¯å› ä¸º `ref` å®šä¹‰çš„æ•°æ®ç”Ÿæˆå¼•ç”¨å¯¹è±¡ï¼Œ`.value` ç›´æ¥è·å–çš„æ˜¯æ•°æ®ã€‚

è€Œå¯¹äºä½¿ç”¨ `ref` å®šä¹‰çš„å“åº”å¼æ•°æ®ä¸ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œæ­¤æ—¶ `.value` çš„å€¼ä¸ºå€Ÿç”¨ `reative` ç”Ÿæˆçš„ `Proxy` å¯¹è±¡ï¼Œè¿™æ—¶å¹¶ä¸èƒ½ç›‘è§†åˆ°è¯¥å±‚æ¬¡çš„å˜åŒ–ã€‚å¯ä»¥ä½¿ç”¨åŠ ä¸Š `.value` æˆ–è€…å¼€å¯æ·±åº¦ç›‘è§†è§£å†³ã€‚ 

:::

+ ç›‘è§† `reactive` å®šä¹‰çš„å“åº”å¼æ•°æ®ï¼ˆä»¥å¯¹è±¡ä¸ºä¾‹ï¼‰ï¼š

```js
watch(person, (newValue, oldValue) => {
  console.log('oldValue', oldValue) // ä¾æ—§æ˜¯newValue
  console.log('newValue', newValue)
}, {deep: false})
```

::: warning 

+ ç›‘è§†ä½¿ç”¨ `reactive` å®šä¹‰çš„å“åº”å¼æ•°æ®ä¸èƒ½è·å– `oldValue` ï¼›

+ ç›‘è§†ä½¿ç”¨ `reactive` å®šä¹‰çš„å“åº”å¼æ•°æ®ï¼Œä¼šå¼ºåˆ¶å¼€å¯æ·±åº¦ç›‘è§†ï¼ˆå¯¹äºæ­¤äº‹ç›‘è§†å®Œæ•´çš„ä¸€ä¸ªå¯¹è±¡è€Œè¨€ï¼‰ã€‚

::: 

+ ç›‘è§† `reactive` å®šä¹‰çš„å“åº”å¼æ•°æ®çš„æŸä¸€ä¸ªå±æ€§æˆ–è€…æŸäº›å±æ€§ï¼Œç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¸ºä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼æˆ–è€…å¯¹è±¡ï¼Œç›‘æµ‹å¤šä¸ªå±æ€§éœ€è¦ä½¿ç”¨æ•°ç»„åŒ…è£¹ã€‚

```js
watch(() => person.age, (newValue, oldValue) => {
  console.log('newValue', newValue)
}, {immediate: true, deep: false})
```

```js
watch([() => person.age, () => person.name], (newValue, oldValue) => {
  console.log('newValue', newValue)
}, {deep: false})
```

::: warning 

+ å½“ç›‘è§†çš„ä¸º `reactive` å®šä¹‰çš„å“åº”å¼æ•°æ®çš„æŸä¸€ä¸ªå±æ€§ä¸ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¹¶ä¸”å…¶ä¸­æœ‰éœ€è¦æ·±åº¦ç›‘è§†çš„å±æ€§ï¼Œæ­¤æ—¶éœ€è¦å¼€å¯æ·±åº¦ç›‘è§†ã€‚

```js
watch(() => person.job, (newValue, oldValue) => {
  console.log('oldValue', oldValue)
  console.log('newValue', newValue)
}, {deep: true})
```

> ç”±äºç›‘è§†çš„æ˜¯reactiveå®šä¹‰çš„å¯¹è±¡ä¸­çš„æŸä¸ªå±æ€§ï¼Œæ‰€ä»¥deepé…ç½®æœ‰æ•ˆ

::: 



### `watchEffect` å‡½æ•°

+ åœ¨ `watch` å‡½æ•°ä¸­ï¼šæ—¢è¦æŒ‡æ˜ç›‘è§†çš„å±æ€§ï¼Œä¹Ÿè¦æŒ‡æ˜ç›‘è§†çš„å›è°ƒã€‚
+ åœ¨ `watchEffect` å‡½æ•°ä¸­ï¼šä¸ç”¨æŒ‡æ˜ç›‘è§†å“ªä¸ªå±æ€§ï¼Œ**ç›‘è§†çš„å›è°ƒä¸­ç”¨åˆ°å“ªä¸ªå±æ€§ï¼Œé‚£å°±ç›‘è§†å“ªä¸ªå±æ€§ã€‚**
+ ä¸ `computed` å‡½æ•°ç›¸ä¼¼ï¼Œåœ¨ `computed` å‡½æ•°ä¸­æ³¨é‡è®¡ç®—å‡ºæ¥çš„å€¼ï¼ˆå›è°ƒå‡½æ•°çš„è¿”å›å€¼ï¼‰ï¼Œæ‰€ä»¥å¿…é¡»è¦è¿”å›ä¸€ä¸ªå€¼ï¼›ä½†æ˜¯ `watchEffect` æ³¨é‡çš„æ˜¯è¿‡ç¨‹ï¼ˆ**å›è°ƒå‡½æ•°çš„å‡½æ•°ä½“**ï¼‰ï¼Œæ‰€ä»¥ä¸ç”¨å†™è¿”å›å€¼ã€‚



ğŸŒ° `watchEffect` å‡½æ•°çš„ä½¿ç”¨ä¾‹å­ï¼š

```js
watchEffect(()=>{
  const x1 = sum.value
  const x2 = person.age
  console.log('watchEffectå›è°ƒæ‰§è¡Œ')
})
```

> åªè¦ `watchEffect` æŒ‡å®šçš„å›è°ƒå‡½æ•°ä¸­**ç”¨åˆ°çš„æ•°æ®å‘ç”Ÿå˜åŒ–**ï¼Œåˆ™ç›´æ¥é‡æ–°æ‰§è¡Œå›è°ƒã€‚





### ç”Ÿå‘½å‘¨æœŸ

![Vue 3ç”Ÿå‘½å‘¨æœŸ](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/rPkbaj.svg) 

- Vue 3ä¸­å¯ä»¥ç»§ç»­ä½¿ç”¨ Vue 2 ä¸­çš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä½†æœ‰æœ‰ä¸¤ä¸ªè¢«æ›´åï¼š
  - ```beforeDestroy``` æ”¹åä¸º ```beforeUnmount```
  - ```destroyed``` æ”¹åä¸º ```unmounted```
- Vue 3ä¹Ÿæä¾›äº† Composition API å½¢å¼çš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä¸ Vue 2ä¸­é’©å­å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š
  - `beforeCreate`===>`setup()`
  - `created`=======>`setup()`
  - `beforeMount` ===>`onBeforeMount`
  - `mounted`=======>`onMounted`
  - `beforeUpdate`===>`onBeforeUpdate`
  - `updated` =======>`onUpdated`
  - `beforeUnmount` ==>`onBeforeUnmount`
  - `unmounted` =====>`onUnmounted`



### è‡ªå®šä¹‰ hook å‡½æ•°

è‡ªå®šä¹‰ hook å‡½æ•°æœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ**æŠŠ `setup` å‡½æ•°ä¸­ä½¿ç”¨çš„ Composition API è¿›è¡Œäº†å°è£…ã€‚**

- ç±»ä¼¼äº Vue2 ä¸­çš„mixinã€‚

- è‡ªå®šä¹‰ hook çš„ä¼˜åŠ¿ï¼š**å¤ç”¨ä»£ç ï¼Œè®© `setup` ä¸­çš„é€»è¾‘æ›´æ¸…æ¥šæ˜“æ‡‚**ã€‚



ğŸŒ° ä¾‹å­ï¼š

+ åœ¨ `src` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„ç›®å½• `hook` å­˜å‚¨ `hook` å‡½æ•°ï¼Œåˆ›å»ºæ–‡ä»¶ `usePoint` ä¸ºä¾‹ï¼ˆä¸€èˆ¬å‘½åå¼€å¤´ä¸º `use` ï¼‰ï¼š

```js
// å®ç°è·å–é¼ æ ‡åæ ‡
import {onBeforeUnmount, onMounted, reactive} from "vue";

export default function () {
    // å®ç°çš„æ•°æ®
    let point = reactive({
        x: 0,
        y: 0
    })

    // å®ç°çš„æ–¹æ³•
    function savePoint(event) {
        point.x = event.pageX
        point.y = event.pageY
        console.log(event.pageX, event.pageY)
    }

    // å®ç°çš„ç›¸å…³é’©å­
    onMounted(() => {
        window.addEventListener('click', savePoint)
    })

    onBeforeUnmount(() => {
        window.removeEventListener('click', savePoint)
    })

    return point
}
```

+ åœ¨è¦ä½¿ç”¨è¿™ä¸ª `hook` å‡½æ•°çš„ç»„ä»¶ï¼Œå¼•å…¥å½“ä½œå‡½æ•°å¹¶ä½¿ç”¨ï¼š

```js
import usePoint from "../hooks/usePoint";
```

```js
setup() {
  let point = usePoint()

  return {
    point
  }
}
```

### `toRef` å‡½æ•°

+ `toRef` å‡½æ•°åˆ›å»ºä¸€ä¸ª `ref` å¯¹è±¡ï¼Œå…¶ `value` å€¼æŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡ä¸­çš„æŸä¸ªå±æ€§ã€‚
+ è¯­æ³•ï¼š`const name = toRef(person,'name')` / `toRefs(person)`
+ åº”ç”¨ï¼š**è¦å°†å“åº”å¼å¯¹è±¡ä¸­çš„æŸä¸ªå±æ€§å•ç‹¬æä¾›ç»™å¤–éƒ¨ä½¿ç”¨æ—¶**ã€‚

> ä¸ `ref` å‡½æ•°ä¸åŒï¼Œ`ref` å‡½æ•°ä¼šé‡æ–°åˆ›å»ºæ–°çš„å¼•ç”¨ `RefImpl` å¯¹è±¡ï¼›`toRef` åˆ›å»ºçš„æ˜¯å¼•ç”¨åŸæ¥çš„ `RefImpl` å¯¹è±¡ã€‚



ğŸŒ°ï¼šä½¿ç”¨ `toRefs()` æ‰¹é‡å¤„ç† `setup` ä¸­çš„æŸä¸ªå¯¹è±¡ï¼š

```js
setup(){
	let person = reactive({
		name: 'Simon',
    age: 3
	})
  
  return {
 	 	...toRefs(person)
	}
}
```



## å…¶ä»– API

### `shallowReactive` åŸå§‹ `shallowRef` å‡½æ•°

+ **æµ…å±‚å“åº”å¼æ•°æ®çš„å®šä¹‰**ï¼š

  + `shallowReactive`ï¼šåªå¤„ç†å¯¹è±¡æœ€å¤–å±‚å±æ€§çš„å“åº”å¼ï¼ˆ**æµ…å“åº”å¼**ï¼‰ã€‚

  + `shallowRef`ï¼šåªå¤„ç†åŸºæœ¬æ•°æ®ç±»å‹çš„å“åº”å¼, ä¸è¿›è¡Œå¯¹è±¡çš„å“åº”å¼å¤„ç†ï¼ˆå¯¹äºä½¿ç”¨è¿™ä¸ªå‡½æ•°å®šä¹‰çš„å¯¹è±¡ï¼Œä¸ä¼šå€Ÿç”¨ `reactive` å¤„ç†å¯¹è±¡ä¸º `Proxy` å¯¹è±¡ï¼‰ã€‚

+ **åº”ç”¨åœºæ™¯**ï¼š
  + å¦‚æœåªæœ‰ä¸€ä¸ª**å¯¹è±¡æ•°æ®**ï¼Œç”±å¤šå±‚å¯¹è±¡ç»“æ„ï¼ˆç»“æ„è¾ƒæ·±å±‚ï¼‰ï¼Œä½†åªéœ€è¦å®ç°å¤–å±‚å±æ€§çš„å˜åŒ–ï¼Œä½¿ç”¨ `shallowReactive` å‡½æ•°å®šä¹‰ã€‚
  + å¦‚æœåªæœ‰ä¸€ä¸ª**å¯¹è±¡æ•°æ®**ï¼Œ**åç»­åŠŸèƒ½ä¸ä¼šä¿®æ”¹è¯¥å¯¹è±¡ä¸­çš„å±æ€§**ï¼Œè€Œæ˜¯ç”Ÿæˆæ–°çš„å¯¹è±¡æ¥æ›¿æ¢ï¼Œä½¿ç”¨ `shallowRef` å‡½æ•°å®šä¹‰ã€‚

### `readonly` ä¸ `shallowReadonly` å‡½æ•°

+ åªè¯»å±æ€§ç›¸å…³çš„ API ï¼šï¼ˆ*å¯¹äºå®šä¹‰çš„å“åº”å¼æ•°æ®æœ‰æ•ˆï¼‰
  + `readonly` ï¼šè®©ä¸€ä¸ªå“åº”å¼æ•°æ®å˜ä¸ºåªè¯»çš„ï¼ˆ**æ·±åªè¯»**ï¼‰ï¼›
  + `shallowReadonly` ï¼šè®©ä¸€ä¸ªå“åº”å¼æ•°æ®å˜ä¸ºåªè¯»ï¼ˆ**æµ…åªè¯»**ï¼‰ï¼›
+ **åº”ç”¨åœºæ™¯**ï¼š**ä¸å¸Œæœ›å“åº”å¼æ•°æ®è¢«ä¿®æ”¹æ—¶**ã€‚ï¼ˆå½“æ”¶åˆ°æ¥è‡ªå¦ä¸€ä¸ªç»„ä»¶å®šä¹‰çš„å“åº”å¼æ•°æ®ï¼Œåœ¨ç°ç»„ä»¶ä¸å¸Œæœ›å¼•å…¥çš„æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼‰

### `toRaw` ä¸ `markRaw` å‡½æ•°

ç”Ÿæˆä¸æ ‡è®°ä¸ºåŸå§‹æ™®é€šæ•°æ®ï¼š

+ `toRaw`ï¼š
  + ä½œç”¨ï¼šå°†ä¸€ä¸ªç”± `reactive` ï¼ˆåªèƒ½æ˜¯ï¼‰å®šä¹‰çš„å“åº”å¼å¯¹è±¡è½¬ä¸ºæ™®é€šå¯¹è±¡ï¼ˆåŸå§‹ï¼‰ã€‚
  + ä½¿ç”¨åœºæ™¯ï¼šç”¨äºè¯»å–å“åº”å¼å¯¹è±¡å¯¹åº”çš„æ™®é€šå¯¹è±¡ï¼Œ**å¯¹è¿™ä¸ªæ™®é€šå¯¹è±¡çš„æ‰€æœ‰æ“ä½œä¸ä¼šå¼•èµ·é¡µé¢çš„å˜åŒ–**ã€‚
+ `markRaw` ï¼š
  + ç”¨äºæŸäº›æ•°æ®**ä¸åº”è¯¥è¢«èµ‹å€¼æ—¶è‡ªåŠ¨è®¾ç½®ä¸ºå“åº”å¼æ•°æ®çš„ï¼Œ**ä¾‹å¦‚å¤æ‚çš„ç¬¬ä¸‰æ–¹åº“æ•°æ®ã€‚
  + å½“æ¸²æŸ“å…·æœ‰ä¸å¯å˜æ•°æ®æºçš„å¤§åˆ—è¡¨æ—¶ï¼Œ**è·³è¿‡å“åº”å¼è½¬æ¢ä¼šæé«˜æ¸²æŸ“æ€§èƒ½**ã€‚

### `customRef`

+ ä½œç”¨ï¼šåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ `ref` ï¼Œ**å¹¶ä¸”å¯¹å…¶ä¾èµ–é¡¹è·Ÿè¸ªå’Œæ›´æ–°è§¦å‘è¿›è¡Œæ˜¾ç¤ºæ§åˆ¶**ã€‚



ğŸŒ° å®ç°é˜²æŠ–æ•ˆæœï¼ˆå»¶è¿Ÿæ˜¾ç¤ºï¼‰ï¼š

::: details

```js
// è‡ªå®šä¹‰ä¸€ä¸ªref
function myRef(value, delay) {
  let timer
  // console.log('myRef', value)
  return customRef((track, trigger) => {
    return {
      // ç±»ä¼¼è®¡ç®—å±æ€§get/set
      get() {
        console.log(`read from myRef, value: ${value}`)
        track() // é€šçŸ¥Vueè¿½è¸ªvalueçš„å˜åŒ–ï¼ˆå‘Šè¯‰Vueï¼‰
        return value
      },
      set(newValue) {
        console.log(`modify in myRef, after Modified Value: ${newValue}`)
        clearTimeout(timer)
        timer = setTimeout(() => {
          value = newValue
          trigger() // é€šçŸ¥Vueé‡æ–°è§£ææ¨¡ç‰ˆ
        }, delay)
      },
    }
  })
}

let keyword = myRef('hello', 500) // ä½¿ç”¨è‡ªå®šä¹‰ref
```

:::



### `provide` ä¸ `inject`

<img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/D1Uy5Y.png" style="width:300px" />

+ ä½œç”¨ï¼š å®ç°**ï¼ˆç¥–ä¸åä»£ï¼‰è·¨çº§ç»„ä»¶ä¹‹é—´**çš„é€šä¿¡ã€‚
+ å¥—è·¯ï¼šçˆ¶ç»„ä»¶æœ‰ä¸€ä¸ª `provide` é€‰é¡¹æ¥æä¾›æ•°æ®ï¼Œåä»£ç»„ä»¶æœ‰ä¸€ä¸ª `inject` é€‰é¡¹æ¥å¼€å§‹ä½¿ç”¨è¿™äº›æ•°æ®ã€‚



ğŸŒ° ä¾‹å­ï¼š

+ åœ¨ç¥–ç»„ä»¶ä¸­çš„ `setup` ä¸­ `provide` ï¼š

```js
setup(){
	......
    let car = reactive({name:'å¥”é©°',price:'40ä¸‡'})
    provide('car',car)
    ......
}
```

+ åœ¨åä»£ç»„ä»¶ä¸­ä½¿ç”¨ `inject` è·å–ï¼š

```js
setup(props,context){
	......
    const car = inject('car')
    return {car}
	......
}
```



### å“åº”å¼æ•°æ®åˆ¤æ–­

å½“æ•°æ®é€æ¸å¢å¤šæˆ–è€…è·å–ä»å®ƒå¤„æ¥çš„æ•°æ®ï¼ŒæœªçŸ¥è¯¥æ•°æ®çš„å“åº”å¼ç±»å‹ï¼ˆæ˜¯å¦ä¸ºå“åº”å¼ï¼‰ï¼Œéœ€è¦è¿›è¡Œè¯¥æ•°æ®çš„åˆ¤æ–­ï¼Œä½¿ç”¨ä¸‹åˆ—å‡½æ•°åˆ¤æ–­ï¼š

+ `isRef` ï¼šæ£€æŸ¥ç›®æ ‡æ•°æ®æ˜¯å¦ä¸º `ref` åˆ›å»ºçš„å¼•ç”¨å¯¹è±¡ï¼›
+ `isReactive` ï¼šæ£€æŸ¥ç›®æ ‡æ•°æ®æ˜¯å¦ç”± `reactive` åˆ›å»ºçš„å“åº”å¼ä»£ç†ï¼›
+ `isReadonly` ï¼šæ£€æŸ¥ç›®æ ‡æ•°æ®æ˜¯å¦ä¸ºç”± `readonly` åˆ›å»ºçš„åªè¯»ä»£ç†ï¼›
+ `isProxy` ï¼šæ£€æŸ¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¦ç”± `reactive` æˆ–è€… `readonly` æ–¹æ³•åˆ›å»ºçš„ä»£ç†ã€‚



## Composition API çš„ä¼˜åŠ¿

### Options API å­˜åœ¨çš„é—®é¢˜

![](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/EReLGK.gif)

::: tip

ä½¿ç”¨ä¼ ç»Ÿ Options API ï¼ˆé…ç½®å¼ APIï¼‰ä¸­ï¼Œ**æ–°å¢æˆ–è€…ä¿®æ”¹ä¸€ä¸ªéœ€æ±‚**ï¼Œå°±éœ€è¦åˆ†åˆ«åœ¨ `data`ã€`methods`ã€`computed` é‡Œä¿®æ”¹ ã€‚

:::



### Composition API çš„ä¼˜åŠ¿

![](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/256pe6.gif)

![](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/duDTPa.gif)

::: tip

:star: åœ¨ Composition API ï¼ˆ**åŸºäºå‡½æ•°ç»„åˆ** APIï¼‰ä¸­ï¼Œå¯ä»¥æ•´åˆåœ¨ä¸€å—ç»„ç»‡ä»£ç ã€å‡½æ•°ï¼ˆé…åˆè‡ªå®šä¹‰é’©å­å‡½æ•°ä½¿ç”¨ï¼‰ï¼Œ**è®©ç›¸å…³åŠŸèƒ½çš„ä»£ç æ›´åŠ æœ‰åºçš„ç»„ç»‡åœ¨ä¸€èµ·**ã€‚

:::
