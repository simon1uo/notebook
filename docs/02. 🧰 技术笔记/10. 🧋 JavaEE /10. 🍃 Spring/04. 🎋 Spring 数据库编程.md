---
title: 🎋 Spring 数据库编程
date: 2022-04-18 14:08:10
permalink: /pages/328e92/
categories: 
  - _pages
  - 🧋 JavaEE
  - 🍃 Spring
tags: 
  - null
author: 
  name: Simon
  link: https://github.com/simon1uo
---
在 Spring 中所有的实例看作 bean，包括数据库资源。（在 Spring 中的内置 [JdbcTemplate]() 现在很少使用，常用与 Mybatis 整合）



### Spring 与 MyBatis 整合

🌰 基于**配置文件**整合例子：

+ 创建 Maven 项目，导入下列依赖：

```xml
<packaging>jar</packaging>

<dependencies>
    <!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java -->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>8.0.28</version>
    </dependency>

    <!-- https://mvnrepository.com/artifact/org.springframework/spring-context -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-context</artifactId>
        <version>5.3.19</version>
    </dependency>

    <!-- https://mvnrepository.com/artifact/org.springframework/spring-jdbc -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-jdbc</artifactId>
        <version>5.3.19</version>
    </dependency>

    <!-- https://mvnrepository.com/artifact/org.mybatis/mybatis -->
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis</artifactId>
        <version>3.5.9</version>
    </dependency>

    <!-- https://mvnrepository.com/artifact/org.mybatis/mybatis-spring -->
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis-spring</artifactId>
        <version>2.0.7</version>
    </dependency>

    <!-- https://mvnrepository.com/artifact/junit/junit -->
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>4.13.2</version>
        <scope>test</scope>
    </dependency>

</dependencies>
```



+ 配置 Spring 配置文件（`applicationContext.xml`），进行数据库配置：

> + 注意要加入 `context` 命名空间。
> + 使用 `context:property-placeholder` 引入外部 `jdbc` 数据库配置文件。

```xml
<context:property-placeholder location="jdbc.properties"/>

<bean id="dataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
    <property name="driverClassName" value="${jdbc.driver}"/>
    <property name="url" value="${jdbc.url}"/>
    <property name="username" value="${jdbc.username}"/>
    <property name="password" value="${jdbc.password}"/>
</bean>
```

+ 创建 `sqlSessionFactory` 的 bean，对比 Mybatis 时期的配置简洁了不少：

```xml
<bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
    <property name="dataSource" ref="dataSource"/>
</bean>
```



+ 创建 `wallet` 持久化类：

```java
public class Wallet {
    private int id;
    private String name;
    private int money;
	
  // ... including getters and setters, toString()
}
```

+ 创建 `walletDAO` 类以及 Mybatis mapper 配置文件：

```java
public interface WalletDAO {
    List<Wallet> findAll();
}
```

```xml
<mapper namespace="com.simon.mapper.WalletDAO">
    <select id="findAll" resultType="com.simon.domain.Wallet">
        SELECT * FROM wallet
    </select>
</mapper>
```

+ 创建 `walletService` 以及其实现类 `walletServiceImpl` ：

```java
public interface WalletService {
    void printAll();
}
```

```java
public class WalletServiceImpl implements WalletService {
    private WalletDAO walletDAO;

    public WalletDAO getWalletDAO() {
        return walletDAO;
    }

    public void setWalletDAO(WalletDAO walletDAO) {
        this.walletDAO = walletDAO;
    }

    @Override
    public void printAll() {
        List<Wallet> wallets = walletDAO.findAll();
        System.out.println("当前账户信息");
        for (Wallet wallet : wallets) {
            System.out.println(wallet);
        }
    }
}
```



+ 返回 Spring 配置文件中创建 `WalletDAO` 和 `WalletService` 的 bean：

```xml
<bean id="walletDAO" class="org.mybatis.spring.mapper.MapperFactoryBean">
    <property name="mapperInterface" value="com.simon.mapper.WalletDAO"/>
    <property name="sqlSessionFactory" ref="sqlSessionFactory"/>
</bean>
<bean id="walletService" class="com.simon.service.impl.WalletServiceImpl">
    <property name="walletDAO" ref="walletDAO"/>
</bean>
```

> 至此已完成在 Spring 配置文件中所有的 Spring 与 MyBatis 的整合配置。



+ 创建测试类与测试方法：

```java
@Test
public void testPrintAll() {
    ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");
    WalletServiceImpl walletService = context.getBean("walletService", WalletServiceImpl.class);
    walletService.printAll();
}
```



🌰 **真·完全基于注解实现 Spring 与 Mybatis整合**：

> 在网上找了许多方法，最后还是得靠 xml 文件进行 mapper 扫描。最后摸索出了以下步骤。

延续上述例子的 `Wallet` 相关逻辑处理：

+ 创建 Spring 注解配置类 `SpringConfig` ：

```java
@Configuration // Spring 配置类
@ComponentScan(basePackages = "com.simon") // 扫描组件
@MapperScan(basePackages = "com.simon") // 扫描mapper
@PropertySource(value = {"classpath:jdbc.properties"}) // 引入数据库配置文件
public class SpringConfig {
    @Value("${jdbc.driver}")
    private String driverClassName;
    @Value("${jdbc.url}")
    private String url;
    @Value("${jdbc.username}")
    private String username;
    @Value("${jdbc.password}")
    private String password;

    // 配置dataSource
    @Bean
    public DriverManagerDataSource getDataSource() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource();
        dataSource.setDriverClassName(driverClassName);
        dataSource.setUrl(url);
        dataSource.setUsername(username);
        dataSource.setPassword(password);
        return dataSource;
    }

    // 配置 SqlSession
    @Bean
    public SqlSessionFactoryBean getSqlSessionFactory(DriverManagerDataSource dataSource) {
        SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean();
        sqlSessionFactoryBean.setDataSource(dataSource);
        return sqlSessionFactoryBean;
    }
}
```

> + 注意 `@MapperScan` 用于扫描 mapper 的注解。
> + `@Bean`：配置对象创建，等价于 `<bean>` 标签。可以在被修饰的方法参数列表中传入受 IoC 容器管理的类型，IoC 容器会自动根据类型找到对应对象并注入到此方法中。分别对应配置文件中创建 `dataSource` 和 `sqlSession` 的 bean 实例。



+ 在 `WalletDAO` 中按照 Mybatis 注解方法编写映射 ：

```java
@Repository
public interface WalletDAO {
    @Select("SELECT * FROM wallet")
    List<Wallet> findAll();
}
```



+ 在 `WalletServiceImpl` 中：

```java
@Service
@Transactional
public class WalletServiceImpl implements WalletService {
    @Autowired
    private WalletDAO walletDAO;

    public WalletDAO getWalletDAO() {
        return walletDAO;
    }

    public void setWalletDAO(WalletDAO walletDAO) {
        this.walletDAO = walletDAO;
    }

    @Override
    public void printAll() {
        List<Wallet> wallets = walletDAO.findAll();
        System.out.println("当前账户信息");
        for (Wallet wallet : wallets) {
            System.out.println(wallet);
        }
    }
}
```



+ 测试方法如下：

```java
public class WalletServiceTest {

    @Test
    public void testPrintAll() {
        ApplicationContext context = new AnnotationConfigApplicationContext(SpringConfig.class);
        WalletServiceImpl walletServiceImpl = context.getBean("walletServiceImpl", WalletServiceImpl.class);
        walletServiceImpl.printAll();
    }
}
```