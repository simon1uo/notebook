---
title: ğŸŒ¿ Spring AOP
date: 2022-03-28 20:44:14
permalink: /pages/dad650/
categories: 
  - _pages
  - ğŸ§‹ JavaEE
  - ğŸƒ Spring
tags: 
  - null
author: 
  name: Simon
  link: https://github.com/simon1uo
---
## Spring AOP æ¦‚è¿°

+ AOP å®šä¹‰ï¼šAspect Oriented Programmingï¼Œ**é¢å‘åˆ‡é¢ç¼–ç¨‹**ï¼ˆæ–¹é¢ï¼‰ï¼Œé€šè¿‡é¢„ç¼–è¯‘å’Œè¿è¡Œæ—¶åŠ¨æ€ä»£ç†æ‹“å±•ç¨‹åºåŠŸèƒ½ã€‚
+ AOP ä½œç”¨ï¼šåˆ©ç”¨ AOP å¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†éš”ç¦»ï¼Œé™ä½è€¦åˆæ€§ï¼Œæé«˜ç¨‹åºå¯é‡ç”¨è¡Œå’Œå¼€å‘æ•ˆç‡ã€‚
+ åœºæ™¯ï¼š æ—¥å¿—è®°å½•ï¼Œæ€§èƒ½ç»Ÿè®¡ï¼Œå®‰å…¨æ§åˆ¶ï¼Œäº‹åŠ¡å¤„ç†ï¼Œå¼‚å¸¸å¤„ç†
+ é€šä¿—æè¿°ï¼šä¸ä¿®æ”¹åŸåŠŸèƒ½æºä»£ç çš„æ–¹å¼ï¼Œ**åœ¨ä¸»å¹²åŠŸèƒ½ä¸­æ·»åŠ æ–°çš„åŠŸèƒ½**ã€‚



ğŸŒ° ä¾‹å­ï¼Œä½¿ç”¨ç™»å½•åŠŸèƒ½æ¡ˆä¾‹è¯´æ˜ AOPï¼š

+ æ·»åŠ æƒé™åˆ¤æ–­åŠŸèƒ½ï¼Œä¸é€šè¿‡ä¿®æ”¹ä¸»å¹²ç™»å½•åŠŸèƒ½æ·»åŠ æ–°çš„åˆ¤æ–­æƒé™æ¨¡å—ã€‚è¿™ä¸ªè¿‡ç¨‹å°±å«åš AOP ã€‚è¿™ä¸ªè¿‡ç¨‹çš„å¥½å¤„ï¼Œå°†åŠŸèƒ½åˆ†ç¦»å‡ºæ¥ï¼Œ æ­¤åä¸éœ€è¦æ­¤åŠŸèƒ½æ—¶å¯ä»¥ç®€æ˜“åˆ†ç¦»ï¼Œé™ä½åŠŸèƒ½è€¦åˆåº¦ã€‚





## AOP çš„åº•å±‚åŸç†

+ AOPåº•å±‚åŸç†ï¼š**åŠ¨æ€ä»£ç†**
  + **æœ‰æ¥å£æƒ…å†µ**ï¼šJDK åŠ¨æ€ä»£ç†ã€‚
  + **æ— æ¥å£æƒ…å†µ**ï¼šCGLib åŠ¨æ€ä»£ç†ã€‚

ï¼ˆå‚è€ƒè®¾è®¡æ¨¡å¼å¯ä»¥äº†è§£ä¸Šé¢ä¸¤ç§ä»£ç†æ–¹å¼ï¼‰

ç”±äº Spring5 ä¸­å¯¹ä¸Šè¿°ä»£ç†å·²ç»åšäº†å¾ˆå¥½çš„å°è£…ï¼Œåªéœ€è¦é€šè¿‡æœ€ç®€å•çš„æ–¹å¼è¿›è¡Œé…ç½®å³å¯ã€‚éœ€è¦å¯¹åŸç†æœ‰ä¸€å®šçš„è®¤è¯†ï¼Œæ‰èƒ½åšåˆ°ä»¥ä¸å˜åº”ä¸‡å˜ã€‚



### JDK åŠ¨æ€ä»£ç†



ğŸŒ° ä¾‹å­ï¼šæœ‰æ¥å£çš„æƒ…å†µ

+ å‡è®¾æœ‰æ¥å£ä¸å®ƒçš„å®ç°ç±»ï¼š

```java
public interface UserDAO {
    void login();
}
```

```java
public class UserDAOImpl implements UserDAO {
    @Override
    public void login(){
        //ç™»å½•å®ç°è¿‡ç¨‹
    }
}
```

+ è¿™ä¸ªæ—¶å€™è¦åœ¨åŸå§‹ä»£ç çš„åŸºç¡€ä¸Šæ·»åŠ æ–°çš„åŠŸèƒ½ï¼Œä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œ**åˆ›å»º `UserDAO` å®ç°ç±»çš„ä»£ç†å¯¹è±¡**ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡å¢å¼ºåŠŸèƒ½ã€‚



### CGlib åŠ¨æ€ä»£ç†



ğŸŒ° ä¾‹å­ï¼šæ²¡æœ‰æ¥å£çš„æƒ…å†µï¼š

+ å‡è®¾æœ‰ `User` å®ä½“ç±»ä¸å®ƒçš„æ–¹æ³•ï¼š

```java
public class User {
    public void add(){
        //...
    }
}
```

+ ä½¿ç”¨åŸå§‹æ–¹æ³•æ—¶ï¼š

```java
// åŸå§‹æ–¹æ³•ï¼šé€šè¿‡å­ç±»ç»§æ‰¿ï¼Œé‡å†™Userç±»æ–¹æ³•
public class Person extends User {
    @Override
    public void add(){
        super.add();
        //å¢å¼ºä»£ç é€»è¾‘
    }
}
```

+ å½“æ²¡æœ‰æ¥å£çš„æƒ…å†µï¼Œå¯ä»¥åˆ›å»º `User` ç±»çš„**å­ç±»ä»£ç†å¯¹è±¡**ã€‚





## JDK åŠ¨æ€ä»£ç†çš„å®ç°

+ å®ç°æ–¹å¼ï¼šä½¿ç”¨ `Proxy` ç±»ä¸­çš„æ–¹æ³•åˆ›å»ºä»£ç†å¯¹è±¡ã€‚

> `Proxy` ç±»ï¼š`java.lang.Object` / `java.lang.reflect.Proxy`

+ å…·ä½“æ–¹æ³•ï¼š`newProxyInstance(ClassLoader loader, Class<?>[] interfaces, InvocationHandler h)`

> + è¿”å›æŒ‡å®šæ¥å£çš„ä»£ç†ç±»çš„å®ä¾‹ï¼Œè¯¥æ¥å£æ–¹æ³•è°ƒç”¨åˆ†æ´¾ç»™æŒ‡å®šçš„è°ƒç”¨å¤„ç†ç¨‹åºã€‚
>
> + ä¸‰ä¸ªå‚æ•°ï¼š
>   + `ClassLoader loader` ï¼šç±»çš„åŠ è½½å™¨ã€‚
>   + `Class<?>[] interfaces`ï¼šå¢å¼ºæ–¹æ³•æ‰€åœ¨ç±»å®ç°çš„æ¥å£æ•°ç»„ï¼ˆè¡¨æ˜å¯ä»¥å¤šä¸ªæ¥å£ï¼‰
>   + `InvocationHandler h`ï¼šå®ç°`InvocationHandler`æ¥å£ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œç¼–å†™å¢å¼ºæ–¹æ³•ã€‚



ğŸŒ° ä¾‹å­ï¼ˆåŸå§‹å­¦ä¹ ä¾‹å­ï¼‰ï¼š

::: details

+ åˆ›å»º UserDAO æ¥å£ä¸å…¶å¯¹åº”çš„å®ç°ç±»ï¼š

```java
public interface UserDAO {
    public int add(int a, int b);

    public String update(String id);
}
```

```java
public class UserDAOImpl implements UserDAO{
    @Override
    public int add(int a, int b) {
        return a + b;
    }

    @Override
    public String update(String id) {
        return id;
    }
}
```

+ ä½¿ç”¨ `Proxy` åˆ›å»º `UserDAO` çš„ä»£ç†å¯¹è±¡ï¼š

```java
// åˆ›å»ºä»£ç†å¯¹è±¡ä»£ç 
class UserDAOProxy implements InvocationHandler {

    // æŠŠåˆ›å»ºçš„æ˜¯è°çš„ä»£ç†å¯¹è±¡ï¼ŒæŠŠè°ä¼ é€’è¿‡æ¥
    // é€šè¿‡æœ‰å‚æ„é€ æ–¹æ³•è¿›è¡Œä¼ é€’
    private Object object;

    public UserDAOProxy(Object object) {
        this.object = object;
    }

    // å¢å¼ºæ–¹æ³•çš„é€»è¾‘
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // å¢å¼ºæ–¹æ³•ä¹‹å‰
        System.out.println("åœ¨æ–¹æ³•ä¹‹å‰æ‰§è¡Œï¼Œæ‰§è¡Œçš„æ–¹æ³•å: " + method.getName() + ": ä¼ é€’çš„å‚æ•°" + Arrays.toString(args));

        // è¢«å¢å¼ºçš„æ–¹æ³•æ‰§è¡Œ
        Object res = method.invoke(object, args);

        // å¢å¼ºæ–¹æ³•ä¹‹åæ‰§è¡Œ
        System.out.println("æ–¹æ³•ä¹‹åæ‰§è¡Œ" + object);
        return res;
    }
}
```

> å¯ä»¥ä½¿ç”¨ `method.getName()` å¯¹è¦å¢å¼ºçš„ç‰¹å®šçš„æ–¹æ³•è¿›è¡Œåˆ¤æ–­ï¼Œæ‰§è¡Œç‰¹å®šçš„å¢å¼ºä»£ç ã€‚

```java
public class JDKProxy {
    public static void main(String[] args) {
        Class[] interfaces = {UserDAO.class};
        /*Proxy.newProxyInstance(JDKProxy.class.getClassLoader(), interfaces, new InvocationHandler() {
            @Override
            public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                return null;
            }
        });*/
        UserDAOImpl userDAO = new UserDAOImpl();

        UserDAO dao = (UserDAO) Proxy.newProxyInstance(JDKProxy.class.getClassLoader(), interfaces, new UserDAOProxy(userDAO));
        int result = dao.add(1, 2);
        System.out.println("result" + result);


    }
}
```

:::

ğŸŒ° ä¾‹å­ï¼ˆæ”¹è¿›å®Œæˆåº¦ä¾‹å­ï¼‰ï¼š

::: details

+ åˆ›å»º UserDAO æ¥å£ä¸å…¶å¯¹åº”çš„å®ç°ç±»ï¼š

```java
public interface UserDAO {
    public int add(int a, int b);

    public String update(String id);
}
```

```java
public class UserDAOImpl implements UserDAO{
    @Override
    public int add(int a, int b) {
        return a + b;
    }

    @Override
    public String update(String id) {
        return id;
    }
}
```

+ åˆ›å»º `UserDAO` ä»£ç†å¯¹è±¡ç±» `UserDAOProxy`ï¼š

```java
public class UserDAOProxy {
    private UserDAO target;

    public UserDAOProxy(UserDAO target) {
        this.target = target;
    }

    public UserDAO newProxyInstances() {
        Class<?> targetClass = target.getClass();
        ClassLoader classLoader = targetClass.getClassLoader();
        Class<?>[] interfaces = targetClass.getInterfaces();
        return (UserDAO) Proxy.newProxyInstance(classLoader, interfaces, new UserDAOInvocationHandler());
    }

    class UserDAOInvocationHandler implements InvocationHandler {

        @Override
        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
            // å¢å¼ºæ–¹æ³•ä¹‹å‰
            System.out.println("before method: " + method.getName() + ", args: " + Arrays.toString(args));

            // è¢«å¢å¼ºçš„æ–¹æ³•æ‰§è¡Œ
            Object res = method.invoke(target, args);

            // å¢å¼ºæ–¹æ³•ä¹‹åæ‰§è¡Œ
            System.out.println("after method:" + target);
            return res;
        }
    }

    public static void main(String[] args) {
        UserDAO target = new UserDAOImpl();
        UserDAOProxy userDAOProxy = new UserDAOProxy(target);
        UserDAO userDAO = userDAOProxy.newProxyInstances();
        int result = userDAO.add(1, 2);
        System.out.println(result);
        userDAO.update("04191707");
    }
}
```

::: 



## AOP æœ¯è¯­

+ è¿æ¥ç‚¹ï¼š **ç±»ä¸­å¯ä»¥è¢«å¢å¼ºçš„æ–¹æ³•**ã€‚
+ åˆ‡å…¥ç‚¹ï¼š**ç±»ä¸­å®é™…è¢«å¢å¼ºçš„æ–¹æ³•**ã€‚
+ é€šçŸ¥ï¼ˆå¢å¼ºï¼‰ï¼š**å®é™…å¢å¼ºçš„é€»è¾‘éƒ¨åˆ†**ã€‚é€šçŸ¥åˆ†ä¸ºäº”ç§ç±»å‹ï¼š
  + å‰ç½®é€šçŸ¥ï¼šæ–¹æ³•æ‰§è¡Œä¹‹å‰çš„å¤„ç†ã€‚
  + åç½®é€šçŸ¥ï¼šæ–¹æ³•æ‰§è¡Œä¹‹åçš„å¤„ç†ã€‚
  + ç¯ç»•é€šçŸ¥ï¼šæ–¹æ³•æ‰§è¡Œ**å‰å**çš„å¤„ç†ã€‚
  + å¼‚å¸¸é€šçŸ¥ï¼šæ–¹æ³•**æŠ›å‡ºå¼‚å¸¸**çš„å¤„ç†ã€‚
  + æœ€ç»ˆé€šçŸ¥ï¼šæ–¹æ³•æ‰§è¡Œæœ€ç»ˆçš„å¤„ç†ï¼ˆç›¸å½“äº `try-catch-finally` ä¸­çš„ `finally` éƒ¨åˆ†ï¼‰ã€‚
+ åˆ‡é¢ï¼š æ˜¯ä¸€ä¸ªåŠ¨ä½œï¼Œå³æŠŠ**é€šçŸ¥åº”ç”¨åˆ°åˆ‡å…¥ç‚¹çš„è¿‡ç¨‹**ã€‚



ğŸŒ° ç†è§£ä¾‹å­ï¼š

::: details

```java
class User {
  add();
  
  update();
  
  select();
  
  delete();
}
```

+ ç±»ä¸­å››ä¸ªæ–¹æ³•è¢«å¢å¼ºï¼Œæ‰€ä»¥è¿™å››ä¸ªæ–¹æ³•å¯ä»¥ç§°ä¸ºè¿æ¥ç‚¹ã€‚

+ å¦‚æœæ­¤æ—¶ `add()` æ–¹æ³•è¢«å¢å¼ºï¼Œè¿™æ˜¯çš„åˆ‡å…¥ç‚¹ä¸º `add()` æ–¹æ³•ã€‚

:::



## AOP æ“ä½œå‡†å¤‡



### AspectJ ä»‹ç»

Spring ä¸€èˆ¬éƒ½æ˜¯åŸºäº `AspectJ` å®ç° AOP æ“ä½œçš„ï¼š

- `AspectJ` ä¸æ˜¯ Spring çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯**ä¸€ä¸ªç‹¬ç«‹çš„ AOP æ¡†æ¶**ã€‚

- ä¸€èˆ¬ä¼šæŠŠ `AspectJ `å’Œ Spring **æ­é…ä½¿ç”¨ï¼Œè¿›è¡Œ AOP æ“ä½œ**ï¼Œå› ä¸ºè¿™æ ·æ›´åŠ æ–¹ä¾¿ã€‚



+ åŸºäº AspectJ è¿›è¡Œ AOP æ“ä½œçš„ä¸¤ç§æ–¹å¼ï¼š
  + åŸºäº XML é…ç½®æ–‡ä»¶æ–¹å¼å®ç°ã€‚
  + åŸºäºæ³¨è§£æ–¹å¼å®ç°ã€‚ï¼ˆæ¨èä½¿ç”¨ï¼‰



### å¼•å…¥ AOP ç›¸å…³ä¾èµ–

![image-20220328224550819](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/ebAArl.png)

+ ï¼ˆåœ¨é¡¹ç›®å·¥ç¨‹ä¸­ï¼‰åœ¨ `maven` ä¸­å¼•å…¥ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjrt</artifactId>
    <version>1.9.8</version>
</dependency>
<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjweaver</artifactId>
    <version>1.9.8</version>
</dependency>
```



### åˆ‡å…¥ç‚¹è¡¨è¾¾å¼

+ ä½œç”¨ï¼š**çŸ¥é“å¯¹å“ªä¸ªç±»çš„æ–¹å¼è¿›è¡Œå¢å¼º**ã€‚
+ è¯­æ³•ç»“æ„ï¼š`execution([æƒé™ä¿®é¥°ç¬¦][è¿”å›ç±»å‹][ç±»å…¨è·¯å¾„][æ–¹æ³•å]([å‚æ•°åˆ—è¡¨]))`



ğŸŒ° ä¾‹å­ï¼š

+ :one: å¯¹ `com.simon.dao.BookDAO` ä¸­çš„ `add()` æ–¹æ³•è¿›è¡Œå¢å¼ºï¼š

```java
execution(* com.simon.dao.bookDAO.add(..))
  // æ­¤å¤„*æ ‡è¯†æ‰€æœ‰æƒé™ä¿®é¥°ç¬¦
```

+ :two: å¯¹ `com.simon.dao.BookDAO` ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•è¿›è¡Œå¢å¼ºï¼š

```java
execution(* com.simon.dao.bookDAO.* (..))
  // æ­¤å¤„ç¬¬äºŒ*æ ‡è¯†æ‰€æœ‰æ–¹æ³•
```

+ :three: å¯¹ `com.simon.dao` åŒ…ä¸­çš„æ‰€æœ‰çš„ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•è¿›è¡Œå¢å¼ºï¼š

```java
execution(* com.simon.dao.*.*(..))
```



## åŸºäºæ³¨è§£çš„ AOP æ“ä½œ

### AspectJ æ³¨è§£å®ç°



+ åœ¨ Spring é…ç½®æ–‡ä»¶ä¸­ï¼Œå¼€å¯æ³¨è§£æ‰«æï¼š
  + å¼•å…¥ `context` å’Œ `aop` åç§°ç©ºé—´ã€‚
  + é…ç½®ç»„ä»¶æ‰«æåŸºç¡€åŒ…ï¼ˆ**å¼€å¯ç»„ä»¶æ³¨è§£æ‰«æ**ï¼‰ã€‚
  + å¼€å¯ AspectJ ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚

::: details

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
                           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd">


    <!--å¼€å¯æ³¨è§£æ‰«æ-->
    <context:component-scan base-package="com.simon.aopanno"/>

    <!--å¼€å¯Aspectç”Ÿæˆä»£ç†å¯¹è±¡-->
    <aop:aspectj-autoproxy/>
</beans>
```

:::



+ **åˆ›å»ºè¢«å¢å¼ºå¯¹è±¡å’Œå¢å¼ºå¯¹è±¡**ï¼š

ğŸŒ° ä½¿ç”¨æ³¨è§£åˆ›å»º `User` å’Œ `User` å¯¹è±¡ï¼š

```java
@Component
public class User {
    public void add(){
        System.out.println("add... ");
    }
}
```

```java
@Component
@Aspect // ç”Ÿæˆä»£ç†å¯¹è±¡
public class UserProxy {
    // å‰ç½®é€šçŸ¥
    public void before(){
        System.out.println("before");
    }
}
```

+ æ·»åŠ è¯¦ç»†çš„å¢å¼ºé€šçŸ¥ã€å¢å¼ºç±»æ³¨è§£å’Œåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼š

::: details

```java
@Component
@Aspect // ç”Ÿæˆä»£ç†å¯¹è±¡
public class UserProxy {
    // å‰ç½®é€šçŸ¥
    @Before(value = "execution(* com.simon.aopanno.User.add())")
    public void before(){
        System.out.println("before..");
    }

    // åç½®é€šçŸ¥
    @AfterReturning(value = "execution(* com.simon.aopanno.User.add())")
    public void afterReturning(){
        System.out.println("afterReturning ...");
    }

    // æœ€ç»ˆé€šçŸ¥
    @After(value = "execution(* com.simon.aopanno.User.add())")
    public void after(){
        System.out.println("after...");
    }

    // å¼‚å¸¸é€šçŸ¥
    @AfterThrowing(value = "execution(* com.simon.aopanno.User.add())")
    public void afterThrowing(){
        System.out.println("afterThrowing");
    }

    // ç¯ç»•é€šçŸ¥
    @Around(value = "execution(* com.simon.aopanno.User.add())")
    public void around(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {
        System.out.println("before around");
        proceedingJoinPoint.proceed(); // è¢«å¢å¼ºçš„æ–¹æ³•æ‰§è¡Œ
        System.out.println("after around");
    }
}
```



::: warning 

+ ` afterReturning` ä¹Ÿå«è¿”å›å€¼åé€šçŸ¥ã€‚ 
+ `after` æœ€ç»ˆé€šçŸ¥ä¸ç®¡æœ‰æ— å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œï¼Œè€Œ `afterReturning` ï¼ˆåç½®é€šçŸ¥æˆ–è€…è¿”å›é€šçŸ¥ï¼‰å½“æœ‰å¼‚å¸¸å°±ä¸ä¼šæ‰§è¡Œã€‚

::: 



+ ç¼–å†™æµ‹è¯•ç±»å’Œæµ‹è¯•æ–¹æ³•ï¼š

:::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }" 

::: tab testCode

```java
public class TestAop {

    @Test
    public void TestAop() {
        ApplicationContext context = new ClassPathXmlApplicationContext("UserProxyBean.xml");
        User user = context.getBean("user", User.class);
        user.add();
    }
}
```

:::

::: tab result

+ è¿è¡Œæµ‹è¯•ç»“æœï¼š

```
before around
before..
add... 
afterReturning ...
after...
after around

Process finished with exit code 0
```

:::

::::

+ ä¸ºäº†æµ‹è¯• `@AfterThrowing` ä½œä»¥ä¸‹ä¿®æ”¹ï¼š

:::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }" 

::: tab testCode

+ åœ¨ `User` ç±»ä¸­ï¼š

```java
@Component
public class User {
    public void add() {
        int i = 1 / 0; // æ¨¡æ‹Ÿå¼‚å¸¸æƒ…å†µ
        System.out.println("add... ");
    }
}
```

:::

::: tab result

+ è¿è¡Œæµ‹è¯•ç»“æœï¼š

```
before around
before..
afterThrowing
after...

java.lang.ArithmeticException: / by zero

	at com.simon.aopanno.User.add(User.java:8)
```

å¯¹æ¯”æ­£å¸¸çš„æƒ…å†µï¼Œå¼‚å¸¸æƒ…å†µä¸‹ï¼Œ`@AfterReturning` åç½®é€šçŸ¥å’Œ `@Around` ç¯ç»•åç½®é€šçŸ¥çš„éƒ¨åˆ†å¤„ç†æ²¡æœ‰è¿›è¡Œï¼Œè€Œ `@After` æœ€ç»ˆé€šçŸ¥æ— è®ºå¦‚ä½•éƒ½ä¼šè¿›è¡Œã€‚

:::

::::



### æŠ½å–å…¬å…±åˆ‡å…¥ç‚¹è¡¨è¾¾å¼

ï¼ˆé‡ç”¨ç›¸åŒçš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼‰

åŒæ—¶æˆ‘ä»¬å‘ç°åˆ‡å…¥ç‚¹è¡¨è¾¾å¼éƒ½æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œå¯ä»¥å¯¹è¿™äº›ç›¸åŒçš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼è¿›è¡ŒæŠ½å–ï¼Œä»¥è¾¾åˆ°é‡ç”¨åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å®šä¹‰çš„ç›®çš„ã€‚

+ å¯ä»¥å°†ç›¸åŒçš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å®šä¹‰ä¸ºæˆå‘˜å˜é‡ï¼š

```java
private final String execution = "execution(* com.simon.aopanno.User.add())";
```

+ **åœ¨å¢å¼ºä»£ç†å¯¹è±¡ç±»ä¸­ï¼Œä½¿ç”¨ AspectJ æä¾›çš„ `@Pointcut` æ³¨è§£ã€‚**

ğŸŒ° ä¾‹å­ï¼š

```java
@Pointcut(value = "execution(* com.simon.aopanno.User.add())")
public void pointDemo(){

}
```



ğŸŒ° å®Œæ•´ä¾‹å­ï¼ˆå»¶ç»­ä¸Šè¿°æ³¨è§£å®ç°çš„ä¾‹å­ï¼‰ï¼š

::: details 

+ å®Œæ•´çš„ `UserProxy` ç±»ä½¿ç”¨å…¬å…±çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼š

```java
@Component
@Aspect // ç”Ÿæˆä»£ç†å¯¹è±¡
public class UserProxy {
    @Pointcut(value = "execution(* com.simon.aopanno.User.add())")
    public void pointDemo(){

    }

    // å‰ç½®é€šçŸ¥
    @Before(value = "pointDemo()")
    public void before(){
        System.out.println("before..");
    }

    // åç½®é€šçŸ¥
    @AfterReturning(value = "pointDemo()")
    public void afterReturning(){
        System.out.println("afterReturning ...");
    }

    // æœ€ç»ˆé€šçŸ¥
    @After(value = "pointDemo()")
    public void after(){
        System.out.println("after...");
    }

    // å¼‚å¸¸é€šçŸ¥
    @AfterThrowing(value = "pointDemo()")
    public void afterThrowing(){
        System.out.println("afterThrowing");
    }

    // ç¯ç»•é€šçŸ¥
    @Around(value = "pointDemo()")
    public void around(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {
        System.out.println("before around");
        proceedingJoinPoint.proceed(); // è¢«å¢å¼ºçš„æ–¹æ³•æ‰§è¡Œ
        System.out.println("after around");
    }
}
```

:::



### è®¾ç½®å¢å¼ºç±»ä¼˜å…ˆçº§

å¦‚æœæœ‰å¤šä¸ªå¢å¼ºç±»å¯¹ç±»ä¸­çš„åŒä¸€ä¸ªæ–¹æ³•è¿›è¡Œå¢å¼ºï¼Œå¯ä»¥è®¾ç½®**å¢å¼ºç±»çš„ä¼˜å…ˆçº§**ï¼Œæ¥å†³å®šå“ªä¸€ä¸ªå¢å¼ºç±»ä¼˜å…ˆæ‰§è¡Œï¼Œå“ªä¸€ä¸ªå¢å¼ºç±»åæ‰§è¡Œã€‚

+ ä½¿ç”¨ AspectJ æä¾›çš„ `@Order` æ³¨è§£è®¾ç½®ä¼˜å…ˆçº§ï¼Œå…¶ä¸­æŒ‡å®šä¼˜å…ˆçº§çš„æ•°å­—ï¼Œæ ¼å¼ä¸º `@Order(æ•°å­—ç±»å‹å€¼)`ï¼Œæ•°å­—ç±»å‹å€¼éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

  - **æ•°å­—ç±»å‹å€¼æœ€å°ï¼Œä¼˜å…ˆçº§è¶Šé«˜**ã€‚

  - **æ•°å­—ç±»å‹å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šä½ã€‚**



ğŸŒ° å¢å¼ºç±»ä¼˜å…ˆçº§ä¾‹å­ï¼š

::: details

+ åˆ›å»ºæ–°çš„ä¸€ä¸ªå¢å¼ºç±» `PersonProxy` ç±»ï¼Œä½¿ç”¨ `@Order` ä¼˜å…ˆçº§æ³¨è§£è®¾ç½®ä¸¤ä¸ªç±»çš„ä¼˜å…ˆçº§ï¼Œå¦‚ä¸‹ï¼š

```java
@Component
@Aspect
@Order(1)
public class PersonProxy {
    //...
}
@Component
@Aspect
@Order(3)
public class UserProxy {
    //...
}
```

+ æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

```
Person before around
Person before..
before around
before..
add... 
afterReturning ...
after...
after around
Person afterReturning ...
Person after...
Person after around

Process finished with exit code 0
```

::: tip

å¯ä»¥çœ‹å‡ºï¼š

+ `PersonProxy` ä¸­çš„å‰ç½®é€šçŸ¥å…ˆäº `UserProxy` ä¸­çš„å‰ç½®é€šçŸ¥æ‰§è¡Œ
+ **`PersonProxy` ä¸­çš„åç½®é€šçŸ¥æ™šäº `UserProxy` ä¸­çš„åç½®é€šçŸ¥æ‰§è¡Œ**

::: 



### å®Œå…¨æ³¨è§£å¼€å‘

è¦ç”¨å®Œå…¨æ³¨è§£çš„æ–¹å¼è¿›è¡Œå¼€å‘ï¼Œå¯ä»¥ä½¿ç”¨æ³¨è§£é…ç½®ç±»æ›¿ä»£ Spring çš„é…ç½®æ–‡ä»¶ï¼š
ğŸŒ° ä¾‹å­ï¼š

+ åˆ›å»º `AopConfig` ç±»ï¼š

```java
@Configuration
@ComponentScan(value = "com.simon.aopanno")
@EnableAspectJAutoProxy(proxyTargetClass = true)
public class AopConfig {
}
```

> ä½¿ç”¨æ³¨è§£ä¸é…ç½®æ–‡ä»¶ä¸­çš„ç›¸å…³å¯¹è±¡ï¼š
>
> + `@ComponentScan` æ³¨è§£è¿›è¡Œäº†ç»„ä»¶æ‰«æï¼Œå¯¹åº”é…ç½®æ–‡ä»¶ä¸­çš„ `<context:component-scan>` ã€‚
> + `@EnableAspectJAutoProxy` å¼€å¯ AspectJ ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œå¯¹åº”é…ç½®æ–‡ä»¶ä¸­çš„ `<aop:aspectj-autoproxy>`ã€‚

## åŸºäºé…ç½®æ–‡ä»¶çš„ AOP æ“ä½œ 

ï¼ˆäº†è§£å³å¯ï¼Œå®é™…è¿ç”¨ä¸­ä¸€èˆ¬ä½¿ç”¨æ³¨è§£æ–¹å¼ï¼‰

ğŸŒ° ä¾‹å­ï¼š
::: details

+ åˆ›å»ºè¢«å¢å¼ºçš„å¯¹è±¡ï¼ˆ`Book` ç±»ï¼‰å’Œå¢å¼ºå¯¹è±¡ï¼ˆ`BookProxy` ç±»ï¼‰ï¼š

```java
public class Book {
    public void buy(){
        System.out.println("Book.buy() ... ");
    }
}
```

```java
public class BookProxy {
    public void before(){
        System.out.println("before ... ");
    }

    public void afterReturning(){
        System.out.println("afterReturning ... ");
    }

    public void after(){
        System.out.println("after ... ");
    }

    public void afterThrowing(){
        System.out.println("afterThrowing ... ");
    }

    public void around(ProceedingJoinPoint joinPoint) throws Throwable {
        System.out.println("around before ...");
        joinPoint.proceed();
        System.out.println("around after ...");
    }

}
```

+ åœ¨ Spring é…ç½®æ–‡ä»¶ä¸­å¼•å…¥ `aop` å‘½åç©ºé—´ï¼š

```xml
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
                           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd">
```

+ åœ¨ Spring é…ç½®æ–‡ä»¶ä¸­åˆ›å»ºä¸¤ä¸ªç±»çš„å¯¹è±¡ï¼š

```xml
<!--åˆ›å»ºä¸¤ä¸ªç±»çš„å¯¹è±¡-->
<bean id="book" class="com.simon.aopxml.Book"/>
<bean id="bookProxy" class="com.simon.aopxml.BookProxy"/>
```

+ åœ¨ Spring é…ç½®æ–‡ä»¶ä¸­é…ç½® `aop` å¢å¼ºï¼š

```xml
<!--é…ç½®aopå¢å¼º-->
<aop:config>
    <!--é…ç½®åˆ‡å…¥ç‚¹-->
    <aop:pointcut id="p" expression="execution(* com.simon.aopxml.Book.buy(..))"/>
    <!--é…ç½®åˆ‡é¢-->
    <aop:aspect ref="bookProxy">
        <!--é…ç½®å¢å¼ºä½œç”¨åœ¨å“ªä¸ªæ–¹æ³•ä¸Š-->
        <aop:before method="before" pointcut-ref="p"/>
        <!--åç½®é€šçŸ¥-->
        <aop:after-returning method="afterReturning" pointcut-ref="p"/>
        <!--æœ€ç»ˆé€šçŸ¥-->
        <aop:after method="after" pointcut-ref="p"/>
        <!--å¼‚å¸¸é€šçŸ¥-->
        <aop:after-throwing method="afterThrowing" pointcut-ref="p"/>
        <!--ç¯ç»•é€šçŸ¥-->
        <aop:around method="around" pointcut-ref="p"/>
    </aop:aspect>
</aop:config>
```

:::
