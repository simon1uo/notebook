---
title: â›“ MyBatis å…³è”æ˜ å°„
date: 2022-03-21 09:32:02
permalink: /pages/f27918/
categories: 
  - _pages
  - ğŸ§‹ JavaEE
  - ğŸ—º MyBatis
tags: 
  - null
author: 
  name: Simon
  link: https://github.com/simon1uo
---
> ğŸ”— ç›¸å…³æ¦‚å¿µï¼šåœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå¤šè¡¨ä¹‹é—´å­˜åœ¨ç€ä¸‰ç§å…³è”å…³ç³»ï¼š
>
> + **ä¸€å¯¹ä¸€**ï¼šåœ¨ä»»æ„ä¸€æ–¹**å¼•å…¥å¯¹æ–¹ä¸»é”®ä½œä¸ºå¤–é”®**ï¼›
> + **ä¸€å¯¹å¤š**ï¼šåœ¨ã€Œå¤šã€æ–¹æ·»åŠ ã€Œä¸€ã€æ–¹**ä¸»é”®**ä½œä¸º**å¤–é”®**ï¼›
> + **å¤šå¯¹å¤š**ï¼šäº§ç”Ÿä¸­é—´å…³ç³»è¡¨ï¼Œå¼•å…¥ä¸¤ç«¯çš„è¡¨çš„ä¸»é”®ä½œä¸ºå¤–é”®ï¼Œä¸¤ä¸ªå¼•å…¥è¿›æ¥çš„ä¸»é”®ç»„æˆä¸€ä¸ª**è”åˆä¸»é”®**æˆ–ä½¿ç”¨æ–°çš„å­—æ®µä½œä¸ºä¸»é”®ã€‚

> åœ¨Javaä¸­åŒæ ·ä¹Ÿå¯ä»¥é€šè¿‡å¯¹è±¡è¿›è¡Œå…³ç³»æè¿°ï¼š
>
> + ä¸€å¯¹ä¸€ï¼šåœ¨æœ¬ç±»ä¸­å®šä¹‰å¯¹æ–¹ç±»å‹çš„å¯¹è±¡ï¼Œå¦‚Aç±»ä¸­å®šä¹‰Bç±»ç±»å‹çš„å±æ€§bï¼ŒBç±»ä¸­å®šä¹‰Aç¾ç±»å‹çš„å±æ€§aï¼›
> + ä¸€å¯¹å¤šï¼šä¸€ä¸ªAç±»ç±»å‹å¯¹åº”å¤šä¸ªBç±»ç±»å‹çš„æƒ…å†µï¼Œéœ€è¦åœ¨Aç¾ä¸­**ä»¥é›†åˆçš„æ–¹å¼**å¼•å…¥Bç±»ç±»å‹çš„å¯¹è±¡ï¼Œåœ¨Bä¸­å®šä¹‰Aç±»ç±»å‹çš„å±æ€§aï¼›
> + å¤šå¯¹å¤šï¼šåœ¨Aç±»ä¸­å®šä¹‰Bç±»ç±»å‹çš„é›†åˆï¼Œåœ¨Bç±»ä¸­å®šä¹‰Aç±»ç±»å‹çš„é›†åˆã€‚

## XML å®ç°å…³è”æ˜ å°„

åœ¨ MyBatis çš„æ˜ å°„æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å…ƒç´  `<resultMap>` ä¸­çš„é…ç½®å®ç°å…³è”æ˜ å°„ï¼š

+ `association` ï¼šä»ä¸€åˆ°ä¸€è”æ˜ å°„ï¼Œæ¯”å¦‚ä»ç”¨æˆ·è§’åº¦çœ‹èº«ä»½è¯å·ï¼Œå°±æ˜¯ä¸€ç§ä»ä¸€åˆ°ä¸€çš„å…³è”æ˜ å°„ã€‚

- `collection`ï¼šä»ä¸€åˆ°å¤šå…³è”æ˜ å°„ï¼Œæ¯”å¦‚ä»ç”¨æˆ·è§’åº¦çœ‹æ‰‹æœºå·ï¼Œå°±æ˜¯ä¸€ç§ä»ä¸€åˆ°å¤šçš„å…³è”æ˜ å°„ã€‚
- ~~`discriminator`ï¼šé‰´åˆ«å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ ¹æ®æŸäº›æ¡ä»¶å†³å®šé‡‡ç”¨å…·ä½“å®ç°ç±»å…³è”æ˜ å°„çš„æ–¹æ¡ˆã€‚~~

ä¸‰ç§è¡¨é—´å…³è”å…³ç³»è§£å†³æ–¹æ¡ˆï¼š

+ æ•°æ®åº“ä¸­ä¸€å¯¹ä¸€ï¼šMyBatisç”¨ä¸¤ä¸ª `association`ã€‚
+ æ•°æ®åº ä¸­ä¸€å¯¹å¤šï¼šMyBatisç”¨ä¸€ä¸ª `association` ï¼Œä¸€ä¸ª `collection`ã€‚
+ æ•°æ®åº“ä¸­å¤šå¯¹å¤šï¼šæœ‰ä¸­é—´è¡¨ï¼ŒMyBatisç”¨ä¸¤æ¬¡ä¸€å¯¹å¤šå…³è”æ˜ å°„ï¼ˆå³ä¸¤æ¬¡ `association` å’Œ `collection` )ã€‚



### å¤„ç†å­—æ®µå’Œå±æ€§çš„æ˜ å°„å…³ç³»

å½“å­—æ®µåå’Œå®ä½“ç±»ä¸­çš„å±æ€§åä¸ä¸€è‡´ï¼Œä½†æ˜¯å­—æ®µå**ç¬¦åˆæ•°æ®åº“çš„å‘½åè§„åˆ™ï¼ˆä½¿ç”¨`_`ï¼‰**ï¼Œå®ä½“ç±»ä¸­çš„å±æ€§å**ç¬¦åˆ Java çš„è§„åˆ™**ï¼ˆä½¿ç”¨é©¼å³°ï¼‰ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹æ³•ï¼š

+ é€šè¿‡æŸ¥è¯¢æ—¶ä¸ºå­—æ®µ**èµ·åˆ«å**çš„æ–¹æ³•ï¼Œä¿è¯å­—æ®µåå’Œå±æ€§åä¿æŒä¸€è‡´ï¼š
  ğŸŒ° ä¾‹å­ï¼š

  ```sql
  <!-- List<Emp> getAllEmp();-->
  <select id="getAllEmp" resultType="Emp">
      select eid, emp_name empName, age, sex, email
      from emp
  </select>
  ```

+ é€šè¿‡åœ¨ MyBatis çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªå…¨å±€é…ç½®ä¿¡æ¯ï¼Œåœ¨`<settings>` æ ‡ç­¾ä¸­è®¾ç½®å±æ€§ `mapUnderscoreToCamelCase` ï¼Œå¯ä»¥åœ¨æŸ¥è¯¢è¡¨ä¸­æ•°æ®æ—¶ï¼Œè‡ªåŠ¨å°† `_` ç±»å‹çš„å­—æ®µåè½¬æ¢ä¸ºé©¼å³°å‘½åæ³•çš„å±æ€§åï¼š
  ğŸŒ° ä¾‹å­ï¼šå­—æ®µåä¸º `user_name` è½¬æ¢ä¸º `userName`;

  åœ¨æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­ï¼š

  ```xml
  <settings>
      <!--å°†_è‡ªåŠ¨æ˜ å°„ä¸ºé©¼å³°-->
      <setting name="mapUnderscoreToCamelCase" value="true"/>
  </settings>
  ```

  

+ é€šè¿‡ `ResultMap` è®¾ç½®è‡ªå®šä¹‰æ˜ å°„çš„æ–¹æ³•ï¼š

ğŸŒ° ä¾‹å­ï¼šæŸ¥è¯¢æ‰€æœ‰çš„å‘˜å·¥ä¿¡æ¯ï¼š

```xml
<mapper namespace="com.mybatis.mapper.EmpMapper">
    <resultMap id="empResultMap" type="Emp">
        <id property="eid" column="eid"></id>
        <id property="empName" column="emp_name"></id>
        <id property="age" column="age"></id>
        <id property="sex" column="sex"></id>
        <id property="email" column="email"></id>
    </resultMap>
    <!-- List<Emp> getAllEmp();-->
    <select id="getAllEmp" resultMap="empResultMap">
        select *
        from emp
    </select>
    <!--<select id="getAllEmp" resultType="Emp">
        select eid, emp_name, age, sex, email
        from emp
    </select>-->
</mapper>
```

> `resultMap` ä¸‹çš„å±æ€§ï¼š
>
> + `id` ï¼šè¡¨ç¤ºè‡ªå®šä¹‰æ˜ å°„çš„å”¯ä¸€æ ‡è¯†ï¼›
> + `type` ï¼šæŸ¥è¯¢çš„æ•°æ®**è¦æ˜ å°„çš„å®ä½“ç±»çš„ç±»å‹**ï¼›
>
> å­æ ‡ç­¾è¯´æ˜ï¼š
>
> +  `id` ï¼šè®¾ç½®ä¸»é”®çš„æ˜ å°„å…³ç³»ï¼›
>
> +  `result`ï¼šè®¾ç½®æ™®é€šå­—æ®µçš„æ˜ å°„å…³ç³»ï¼›
> +  `association` ï¼šè®¾ç½®å¤šå¯¹ä¸€çš„æ˜ å°„å…³ç³»ï¼›
> +  `collection` ï¼šè®¾ç½®ä¸€å¯¹å¤šçš„æ˜ å°„å…³ç³»ï¼›
>
> å±æ€§è¯´æ˜ï¼š
>
> + `property` ï¼šè®¾ç½®æ˜ å°„å…³ç³»ä¸­çš„**å±æ€§å**ï¼›
> + `column` ï¼šè®¾ç½®æ˜ å°„å…³ç³»ä¸­è¡¨ä¸­çš„**å­—æ®µå**ï¼›



### ä¸€å¯¹ä¸€æ˜ å°„å…³ç³»

ä½¿ç”¨ `association` å…ƒç´ è§£å†³ä¸€å¯¹ä¸€çš„æ˜ å°„å…³ç³»ï¼Œå…¶ä¸­å­å…ƒç´ çš„å±æ€§:

+ `property` ï¼šæŒ‡å®šæ˜ å°„åˆ°çš„Javaå®ä½“ç±»å¯¹è±¡å±æ€§ï¼Œä¸è¡¨å¤–é”®å­—æ®µå¯¹åº”ã€‚
+ `javaType` ï¼šæŒ‡å®šæ˜ å°„åˆ° Java å®ä½“ç±»å¯¹è±¡å±æ€§çš„æ•°æ®ç±»å‹ã€‚
+ `column`ï¼šæŒ‡å®šæ•°æ®åº“è¡¨ä¸­å¯¹åº”çš„å­—æ®µï¼Œä¸€èˆ¬å¤–é”®ã€‚
+ `select`ï¼šæŒ‡å®šå¼•å…¥åµŒå¥—æŸ¥è¯¢çš„å­ SQL è¯­å¥ï¼Œè¯¥å±æ€§ç”¨äºå…³è”æ˜ å°„ä¸­çš„åµŒå¥—æŸ¥è¯¢
+ `fetchType` ï¼šæŒ‡å®šåœ¨å…³è”æŸ¥è¯¢æ—¶æ˜¯å¦å¯ç”¨å»¶è¿ŸåŠ è½½ï¼Œè¯¥å±æ€§æœ‰ `lazy` å’Œ `eager` ä¸¤ä¸ªå±æ€§å€¼ã€‚



ğŸŒ° ä¾‹å­ï¼šæœ‰ä¸¤ä¸ªä¸€å¯¹ä¸€å…³è”çš„è¡¨ `user` è¡¨å’Œ `idcard` è¡¨ï¼š

::: details

+ æ ¹æ®æ•°æ®åº“è¡¨ï¼Œç¼–å†™æŒä¹…åŒ–ç±» `User` ç±»å’Œ `IdCard` ç±»ï¼ŒèŠ‚é€‰ï¼š

```java
public class User {
    private int id;
    private String name;
    private int age;
    private String sex;
    private String address;
    private IdCard idCard;
}	
```

```java
public class IdCard {
    private int cid;
    private int uid;
    private String code;
    User user;
}
```

+ `IdCardMapper` æ˜ å°„ï¼š

```java
public interface IdCardMapper {
    List<IdCard> findAll();
    IdCard findByUid();
    IdCard findByCode(String code);
}
```

```xml
<mapper namespace="com.simon.mapper.IdCardMapper">
    <resultMap id="idCardMap" type="IdCard">
        <id property="cid" column="cid"/>
        <result property="code" column="code"/>
        <association property="user" javaType="User"
                     column="uid" select="findById"/>
    </resultMap>

    <!--List<IdCard> findAll();-->
    <select id="findAll" resultType="IdCardMap">
        SELECT *
        FROM idcard
    </select>

    <!--IdCard findByUid();-->
    <select id="findByUid" resultMap="IdCardMap">
        SELECT *
        FROM idcard
        WHERE uid = #{uid}
    </select>

    <!--IdCard findByCode(String code)-->
    <select id="findByCode" resultMap="idCardMap">
        SELECT *
        FROM idcard
        WHERE code = #{code}
    </select>
</mapper>
```

+ `UserMapper` æ˜ å°„ï¼š

```java
public interface UserMapper {
    List<User> findAll();
    User findById(int id);
    List<User> findByAgeSex(int age, String sex);
}
```

```xml
<mapper namespace="com.simon.mapper.UserMapper">
    <resultMap id="UserMap" type="User">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="age" column="age"/>
        <result property="sex" column="sex"/>
        <result property="address" column="address"/>
        <association property="idcard" javaType="IdCard"
                     column="id" select="findByUid"/>
    </resultMap>
    <!--List<User> findAll();-->
    <select id="findAll" resultMap="UserMap">
        SELECT *
        FROM user
    </select>

    <!--User findById(int id);-->
    <select id="findById">
        SELECT *
        FROM user
        WHERE id = #{id}
    </select>

    <!--List<User> findByAgeSex(int age, String sex);-->
    <select id="findByAgeSex">
        SELECT *
        FROM user
        WHERE age > #{param1}
          AND sex = #{param2}
    </select>
</mapper>
```

+ `UserMapperTest` å’Œ `IdCardMapperTest` çš„æµ‹è¯•ï¼š

```java
@Test
public void testFindAll() {
    List<User> userList = userMapper.findAll();
    for (User user : userList) {
        if (user != null){
            System.out.println(user);
            System.out.println(user.getIdCard());
        }
    }
}
```

```java
@Test
public void testFindAll() {
    List<IdCard> idCards = idCardMapper.findAll();
    for (IdCard idCard : idCards) {
        if (idCard != null){
            System.out.println(idCard);
            System.out.println(idCard.getUser());
        }
    }
}
```

+ æµ‹è¯• `User` å¤æ‚æŸ¥è¯¢ï¼šå¹´é¾„å¤§äº 20ï¼Œæ€§åˆ«ä¸º M çš„ç”¨æˆ·çš„ IdCard æ•°æ®ã€‚

```java
@Test
public void testFindUserByAgeSex(){
    List<User> userList = userMapper.findByAgeSex(20, "M");
    for (User user : userList) {
        if(user!=null) {
            System.out.println(user);
            System.out.println(user.getIdCard());
        }
    }
}
```

::: 



**MyBatis åŠ è½½å…³è”å…³ç³»å¯¹è±¡ä¸»è¦é€šè¿‡ä¸¤ç§æ–¹å¼**ï¼š

+ é€šè¿‡**åµŒå¥—æŸ¥è¯¢æ–¹æ³•**ï¼šé€šè¿‡æ‰§è¡Œå¦ä¸€æ¡ SQL æ˜ å°„è¯­å¥æ¥è¿”å›é¢„æœŸçš„å¤æ‚ç±»å‹ã€‚
  + æŸ¥è¯¢ SQL ä¸­åµŒå…¥ä¸€ä¸ªå­æŸ¥è¯¢ SQL
  + ä¼šæ‰§è¡Œå¤šæ¡ SQL è¯­å¥
  + è¯­å¥ç¼–å†™è¾ƒä¸ºç®€å•
+ é€šè¿‡**åµŒå¥—ç»“æœæ–¹å¼**ï¼šæ˜¯ä½¿ç”¨åµŒå¥—ç»“æœæ˜ å°„æ¥å¤„ç†é‡å¤çš„è”åˆç»“æœçš„å­é›†ï¼š
  + ä¸€ä¸ªåµŒå¥—çš„å¤šè¡¨æŸ¥è¯¢ SQL 
  + åªä¼šæ‰§è¡Œä¸€æ¡å¤æ‚çš„ SQL è¯­å¥
  + è¯­å¥ç¼–å†™çš„æ¯”è¾ƒå¤æ‚



ğŸŒ° ä¸Šé¢ `User` å’Œ `IdCard` çš„ä¾‹å­ï¼Œä½¿ç”¨åµŒå¥—æŸ¥è¯¢æ–¹å¼ã€‚

ğŸŒ° ä»¥ä¸‹ä½¿ç”¨åµŒå¥—ç»“æœæ–¹å¼å®Œæˆ `User` å’Œ `IdCard` çš„å…³ç³»æŸ¥è¯¢ï¼š

::: details

+ `IdCardMapper` ï¼š

```java
<mapper namespace="com.simon.mapper.IdCardMapper">
    <resultMap id="IdCardMap" type="IdCard">
        <id property="cid" column="cid"/>
        <result property="uid" column="uid"/>
        <result property="code" column="code"/>
        <association property="user" javaType="User">
            <id property="id" column="uid"/>
            <result property="name" column="name"/>
            <result property="age" column="age"/>
            <result property="sex" column="sex"/>
            <result property="address" column="address"/>
        </association>
    </resultMap>

    <!--List<IdCard> findAll();-->
    <select id="findAll" resultMap="IdCardMap">
        SELECT *
        FROM idcard,
             user
        WHERE idcard.uid = user.id
    </select>

    <!--IdCard findByUid();-->
    <select id="findByUid" resultMap="IdCardMap">
        SELECT *
        FROM idcard,
             user
        WHERE uid = #{uid}
          AND idcard.uid = user.id
    </select>

    <!--IdCard findByCode(String code)-->
    <select id="findByCode" resultMap="IdCardMap">
        SELECT *
        FROM idcard,
             user
        WHERE code = #{code}
          AND idcard.uid = user.id
    </select>
</mapper>
```

+ `UserMapper` ï¼š

```java
<mapper namespace="com.simon.mapper.UserMapper">
    <resultMap id="UserMap" type="User">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="age" column="age"/>
        <result property="sex" column="sex"/>
        <result property="address" column="address"/>
        <association property="idCard" javaType="IdCard">
            <id property="uid" column="id"/>
            <result property="cid" column="cid"/>
            <result property="code" column="code"/>
        </association>
    </resultMap>
    <!--List<User> findAll();-->
    <select id="findAll" resultMap="UserMap">
        SELECT *
        FROM user,
             idcard
        where user.id = idcard.uid
    </select>

    <!--User findById(int id);-->
    <select id="findById" resultMap="UserMap">
        SELECT *
        FROM user,
             idcard
        WHERE id = #{id}
          AND user.id = idcard.uid
    </select>

    <!--List<User> findByAgeSex(int age, String sex);-->
    <select id="findByAgeSex" resultMap="UserMap">
        SELECT *
        FROM user,
             idcard
        WHERE age > #{param1}
          AND sex = #{param2}
          AND user.id = idcard.uid
    </select>
</mapper>
```

::: 



### å¤šå¯¹ä¸€æ˜ å°„å…³ç³»



ğŸŒ° ä¾‹å­ï¼šæŸ¥è¯¢å‘˜å·¥ä»¥åŠéƒ¨é—¨ä¿¡æ¯ï¼š

```xml
<!--Emp getEmpAndDept(@Param("eid") Integer eid);-->
<select id="getEmpAndDept" resultMap="EmpAndDeptResultMapTwo">
    select * from emp left join dept on emp.did = dept.did where emp.eid = #{eid}
</select>
```

:one: æ–¹æ³•ä¸€ï¼š**çº§è”æ–¹å¼èµ‹å€¼**ï¼š

```xml
<resultMap id="EmpAndDeptResultMapOne" type="Emp">
    <id property="eid" column="eid"></id>
    <result property="empName" column="emp_name"></result>
    <result property="age" column="age"></result>
    <result property="sex" column="sex"></result>
    <result property="email" column="email"></result>
    <result property="dept.did" column="did"></result>
    <result property="dept.deptName" column="dept_name"></result>
</resultMap>
```



:two: æ–¹æ³•äºŒï¼šé€šè¿‡ `association` æ ‡ç­¾å®ç°ï¼š

```xml
<resultMap id="EmpAndDeptResultMapTwo" type="Emp">
    <id property="eid" column="eid"></id>
    <result property="empName" column="emp_name"></result>
    <result property="age" column="age"></result>
    <result property="sex" column="sex"></result>
    <result property="email" column="email"></result>
    <association property="dept" javaType="Dept">
        <id property="did" column="did"></id>
        <result property="deptName" column="dept_name"></result>
    </association>
</resultMap>
```

> `property`ï¼šéœ€è¦å¤„ç†å¤šå¯¹çš„æ˜ å°„å…³ç³»çš„å±æ€§å
>
> `javaType`ï¼š è¯¥å±æ€§çš„ç±»å‹



:three: :star: åˆ†å¸ƒæŸ¥è¯¢ï¼š

ğŸŒ° ä¾‹å­ï¼šåˆ†å¸ƒæŸ¥è¯¢å‘˜å·¥ä¿¡æ¯å’Œéƒ¨é—¨ä¿¡æ¯

ç¬¬ä¸€æ­¥ï¼šå…ˆæŸ¥è¯¢å‘˜å·¥ä¿¡æ¯

```xml
<!--Emp getEmpAndDeptByStepOne(@Param("eid") Integer eid);-->
<select id="getEmpAndDeptByStepOne" resultMap="getEmpAndDeptByStepResultMapOne">
    select *
    from emp
    where eid = #{eid}
</select>
```

ç¬¬äºŒæ­¥ï¼šé€šè¿‡ `did` æŸ¥è¯¢å‘˜å·¥æ‰€å¯¹åº”çš„éƒ¨é—¨ï¼š

```xml
<!--Dept getEmpAndDeptByStepTwo(@Param("did") Integer did);-->
<select id="getEmpAndDeptByStepTwo" resultType="Dept">
    select * from dept where did = #{did}
</select>
```

ç¬¬ä¸€æ­¥ä¸­ç”¨åˆ°çš„ `resultMap` ï¼š

```xml
<resultMap id="getEmpAndDeptByStepResultMapOne" type="Emp">
    <id property="eid" column="eid"></id>
    <result property="empName" column="emp_name"></result>
    <result property="age" column="age"></result>
    <result property="sex" column="sex"></result>
    <result property="email" column="email"></result>
    <association property="dept" select="com.mybatis.mapper.DeptMapper.getEmpAndDeptByStepTwo"
                 column="did"></association>
</resultMap>
```

> :star: `select`ï¼š è®¾ç½®åˆ†å¸ƒæŸ¥è¯¢ï¼ŒæŸ¥è¯¢æŸä¸ªå±æ€§çš„å€¼çš„ SQL å”¯ä¸€æ ‡è¯†ï¼ˆ `namespace.sqlId` æˆ– mapper æ¥å£çš„**å…¨ç±»å**ï¼ˆå¯ä»¥é€šè¿‡ ã€Œ`copy reference`ã€è·å–ï¼‰ï¼‰
>
> `colomn`ï¼šå°† SQL ä»¥åŠæŸ¥**è¯¢ç»“æœçš„æŸä¸ªå­—æ®µ**è®¾ç½®ä¸ºåˆ†å¸ƒæŸ¥è¯¢çš„æ¡ä»¶ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œåˆ†å¸ƒæŸ¥è¯¢çš„å¥½å¤„æ˜¯å¯ä»¥å®ç°å»¶è¿ŸåŠ è½½ï¼Œä½†æ˜¯å¿…é¡»åœ¨æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­è®¾ç½®å…¨å±€é…ç½®ä¿¡æ¯ ï¼ˆ`settings` æ ‡ç­¾ï¼‰ï¼š

+ `lazyLoadingEnabled` ï¼šå»¶è¿ŸåŠ è½½çš„å…¨å±€å¼€å…³ï¼Œå½“å¼€å¯æ—¶ï¼Œæ‰€æœ‰å…³è”å¯¹è±¡éƒ½ä¼šå»¶è¿ŸåŠ è½½ã€‚

+ `aggressiveLazyLoading`ï¼šå¼€å¯æ—¶ä»»ä½•æ–¹æ³•éƒ½ä¼šåŠ è½½è¯¥å¯¹è±¡çš„**æ‰€æœ‰å±æ€§**ï¼Œå¦åˆ™ä¼šæŒ‰éœ€åŠ è½½ã€‚é»˜è®¤ä¸º `false`ã€‚

  ```xml
  <settings>
      <setting name="lazyLoadingEnabled" value="true"/>
  </settings>
  ```

+ è®¾ç½®å»¶è¿ŸåŠ è½½åï¼šå¯ä»¥æŒ‰éœ€åŠ è½½ï¼Œå°±åªä¼šæ‰§è¡Œç›¸åº”çš„ sqlã€‚

  ğŸŒ° ä¾‹å­ï¼š

:::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }" 

::: tab java 

å¼€å¯å»¶è¿ŸåŠ è½½åï¼Œå•ç‹¬è·å–å‘˜å·¥çš„ä¿¡æ¯å’Œéƒ¨é—¨ä¿¡æ¯ï¼š

```java
@Test
public void testgetEmpAndDeptByStep(){
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    EmpMapper mapper = sqlSession.getMapper(EmpMapper.class);
    Emp emp = mapper.getEmpAndDeptByStepOne(3);
    System.out.println(emp.getEmpName());
    System.out.println("-----------");
    System.out.println(emp.getDept());
}
```

:::

::: tab result

```sql
DEBUG 03-08 13:58:46,720 ==>  Preparing: select * from emp where eid = ? (BaseJdbcLogger.java:137) 
DEBUG 03-08 13:58:46,754 ==> Parameters: 3(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-08 13:58:46,807 <==      Total: 1 (BaseJdbcLogger.java:137) 
ç‹äº”
-----------
DEBUG 03-08 13:58:46,808 ==>  Preparing: select * from dept where did = ? (BaseJdbcLogger.java:137) 
DEBUG 03-08 13:58:46,809 ==> Parameters: 3(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-08 13:58:46,810 <==      Total: 1 (BaseJdbcLogger.java:137) 
Dept{did=3, deptName='C'}
```

å¯ä»¥çœ‹åˆ°ï¼Œéœ€è¦é‚£ä¸€éƒ¨åˆ†çš„ä¿¡æ¯å°±åªä¼šè¿è¡ŒæŸä¸€éƒ¨åˆ†çš„æŸ¥è¯¢è¯­å¥ï¼Œè€Œä¸ä¼šå…¨éƒ¨æŸ¥è¯¢å…¨éƒ¨è¿è¡Œã€‚

:::

::::

+ æŸä¸ªæŸ¥è¯¢ä¸éœ€è¦å»¶è¿ŸåŠ è½½æ—¶ï¼Œåœ¨å…¨å±€å¼€å¯å»¶è¿ŸåŠ è½½çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡åœ¨ `association` æ ‡ç­¾ä¸­è®¾ç½®å±æ€§ `fetchType="lazy|eager"`ï¼Œé»˜è®¤ `lazy` å€¼è¡¨ç¤ºéœ€è¦å»¶è¿ŸåŠ è½½ï¼Œ`eager` å€¼è¡¨ç¤ºä¸ºå½“å‰ `resultMap` ç«‹å³åŠ è½½ã€‚

  ğŸŒ° ä¾‹å­ï¼Œå…³é—­å»¶è¿ŸåŠ è½½åï¼š

:::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }" 

::: tab java 

mapper é…ç½®ä¸­ï¼š

```xml
<resultMap id="getEmpAndDeptByStepResultMapOne" type="Emp">
    <id property="eid" column="eid"></id>
    <result property="empName" column="emp_name"></result>
    <result property="age" column="age"></result>
    <result property="sex" column="sex"></result>
    <result property="email" column="email"></result>
    <association property="dept" select="com.mybatis.mapper.DeptMapper.getEmpAndDeptByStepTwo"
                 column="did" fetchType="eager"></association>
</resultMap>
```

:::

::: tab result

è¿è¡Œå‰é¢ä¾‹å­ï¼šåˆ†åˆ«æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯å’Œéƒ¨é—¨ä¿¡æ¯æ—¶ï¼š

```sql
DEBUG 03-08 14:03:48,605 ==>  Preparing: select * from emp where eid = ? (BaseJdbcLogger.java:137) 
DEBUG 03-08 14:03:48,636 ==> Parameters: 3(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-08 14:03:48,655 ====>  Preparing: select * from dept where did = ? (BaseJdbcLogger.java:137) 
DEBUG 03-08 14:03:48,656 ====> Parameters: 3(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-08 14:03:48,660 <====      Total: 1 (BaseJdbcLogger.java:137) 
DEBUG 03-08 14:03:48,660 <==      Total: 1 (BaseJdbcLogger.java:137) 
ç‹äº”
-----------
Dept{did=3, deptName='C'}
```

:::

::::



### ä¸€å¯¹å¤šæ˜ å°„å…³ç³»



ğŸŒ° å‘˜å·¥ä¸éƒ¨é—¨çš„å…³ç³»ï¼š

+  å¤šå¯¹ä¸€æ—¶ï¼Œå¯¹åº”ä¸€ä¸ªå¯¹è±¡ï¼Œä¾‹å¦‚èŒå‘˜å¯¹åº”ä¸€ä¸ªéƒ¨é—¨ã€‚
+ ä¸€å¯¹å¤šæ—¶ï¼Œå¯¹åº”ä¸€ä¸ªé›†åˆï¼Œä¾‹å¦‚éƒ¨é—¨å¯¹åº”å¤šä¸ªèŒå‘˜ã€‚

**æ–¹æ³•ä¸€ï¼š é›†åˆæŸ¥è¯¢ `collection` **

æŸ¥è¯¢éƒ¨é—¨ä»¥åŠéƒ¨é—¨ä¸­æ‰€æœ‰å‘˜å·¥çš„ä¿¡æ¯ï¼š

+ mapper é…ç½®ï¼š

```xml
<!--Dept getDeptAndEmp(@Param("did") Integer did);-->
<select id="getDeptAndEmp" resultMap="DeptAndEmpResultMap">
    select * from dept left join emp on dept.did = emp.did where dept.did = #{did}
</select>
```

:star: `ResultMap` é…ç½®ï¼š

```xml
<resultMap id="DeptAndEmpResultMap" type="Dept">
    <id property="did" column="did"></id>
    <result property="deptName" column="dept_name"></result>
    <collection property="emps" ofType="Emp">
        <id property="eid" column="eid"></id>
        <result property="empName" column="emp_name"></result>
        <result property="age" column="age"></result>
        <result property="sex" column="sex"></result>
        <result property="email" column="emalil"></result>
    </collection>
</resultMap>
```

> `collection`ï¼šå¤„ç†ä¸€å¯¹å¤šçš„æ˜ å°„å…³ç³»ã€‚
>
> `ofType`ï¼šä¸ `javaType` å¯¹åº”è®¾ç½® `collection` æ ‡ç­¾æ‰€å¤„ç†çš„é›†åˆå±æ€§ä¸­å­˜å‚¨æ•°æ®çš„ç±»å‹ã€‚ï¼ˆä¾‹å¦‚ï¼Œé›†åˆç±»å‹ä¸ºå‘˜å·¥å®ä½“ç±»å‹ï¼‰

:::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }" 

::: tab java

```java
@Test
public void testGetDeptAndEmp(){
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    DeptMapper mapper = sqlSession.getMapper(DeptMapper.class);
    Dept deptAndEmp = mapper.getDeptAndEmp(2);
    System.out.println(deptAndEmp);
}
```

:::

::: tab result

```sql
DEBUG 03-09 10:13:31,325 ==>  Preparing: select * from dept left join emp on dept.did = emp.did where dept.did = ? (BaseJdbcLogger.java:137) 
DEBUG 03-09 10:13:31,357 ==> Parameters: 2(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-09 10:13:31,386 <==      Total: 2 (BaseJdbcLogger.java:137) 
Dept{did=2, deptName='B', emps=[Emp{eid=2, empName='æå››', age=18, sex='å¥³', email='null', dept=null}, Emp{eid=5, empName='ç”°ä¸ƒ', age=20, sex='å¥³', email='null', dept=null}]}
```

:::

::::

æ–¹æ³•äºŒï¼šåˆ†å¸ƒæŸ¥è¯¢ã€‚

ä¾‹å­ï¼š å…ˆæŸ¥è¯¢å‡ºéƒ¨é—¨ä¿¡æ¯ï¼Œåœ¨æŸ¥è¯¢å‡ºéƒ¨é—¨ä¸­çš„å‘˜å·¥ä¿¡æ¯ã€‚

+ ç¬¬ä¸€æ­¥ï¼šæŸ¥è¯¢éƒ¨é—¨ä¿¡æ¯

```xml
<!--Dept getDeptAndEmpByStepOne(@Param("did") Integer did);-->
<select id="getDeptAndEmpByStepOne" resultMap="deptAndEmpByStepResultMap">
    select * from dept where did = #{did}
</select>
```

:star: `ResultMap` é…ç½®ï¼š

```xml
<resultMap id="deptAndEmpByStepResultMap" type="Dept">
    <id property="did" column="did"></id>
    <result property="deptName" column="dept_name"></result>
    <collection property="emps" select="com.mybatis.mapper.EmpMapper.getDeptAndEmpByStepTwo" column="did"></collection>
</resultMap>
```

> `collection` æ ‡ç­¾é…ç½®å±æ€§ä¸ `association` å±æ€§ç±»ä¼¼ã€‚

+ æ ¹æ®éƒ¨é—¨ `id` è·å–å‘˜å·¥ä¿¡æ¯ï¼š

```xml
<!--List<Emp> getDeptAndEmpByStepTwo(@Param("did")Integer did);-->
<select id="getDeptAndEmpByStepTwo" resultType="Emp">
    select *
    from emp
    where did = #{did}
</select>
```

+ æµ‹è¯•ï¼š

:::: tabs cache-lifetime="5" :options="{ useUrlFragment: false }" 

::: tab java

```java
@Test
public void testGetDeptAndEmpByStep(){
    SqlSession sqlSession = SqlSessionUtils.getSqlSession();
    DeptMapper mapper = sqlSession.getMapper(DeptMapper.class);
    Dept dept = mapper.getDeptAndEmpByStepOne(1);
    System.out.println(dept);
}}
```

:::

::: tab result

```sql
DEBUG 03-09 10:24:58,173 ==>  Preparing: select * from dept where did = ? (BaseJdbcLogger.java:137) 
DEBUG 03-09 10:24:58,204 ==> Parameters: 1(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-09 10:24:58,256 <==      Total: 1 (BaseJdbcLogger.java:137) 
DEBUG 03-09 10:24:58,257 ==>  Preparing: select * from emp where did = ? (BaseJdbcLogger.java:137) 
DEBUG 03-09 10:24:58,258 ==> Parameters: 1(Integer) (BaseJdbcLogger.java:137) 
DEBUG 03-09 10:24:58,262 <==      Total: 2 (BaseJdbcLogger.java:137) 
Dept{did=1, deptName='A', emps=[Emp{eid=1, empName='å¼ ä¸‰', age=20, sex='ç”·', email='123@qq.com', dept=null}, Emp{eid=4, empName='èµµå…­', age=18, sex='ç”·', email='455@163.com', dept=null}]}
```

> å¯ä»¥çœ‹åˆ°è¿è¡Œäº†ä¸¤æ¬¡æŸ¥è¯¢ SQL è¯­å¥ï¼Œè¿›è¡Œäº†åˆ†æ­¥æŸ¥è¯¢ã€‚

:::

::::



ğŸŒ° `User` ä¸ `PhoneCard` çš„å…³ç³»ï¼šä¸€ä¸ª `User` å¯ä»¥å¯¹åº”å¤šä¸ª `PhoneCrad` ï¼š

::: details

+ `User` ç±» å’Œ `PhoneCard` ç±»ï¼š

```java
public class User {
    private int id;
    private String name;
    private int age;
    private String sex;
    private String address;
    private List<PhoneCard> phoneCardList;
}
```

```Java
public class PhoneCard {
    private int pid;
    private String phoneNo;
    private int uid;
    private User user;
```

**æ–¹æ³•ä¸€ï¼šåˆ†æ­¥æŸ¥è¯¢**ï¼š

+ `UserMapper` ï¼š

```java
public interface UserMapper {
    List<User> findAll();
    User findById(int id);
}
```

```xml
<mapper namespace="com.simon.mapper.UserMapper">
    <resultMap id="UserMap" type="User">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="age" column="age"/>
        <result property="sex" column="sex"/>
        <result property="address" column="address"/>
        <collection property="phoneCardList" ofType="PhoneCard"
                    column="id" select="com.simon.mapper.PhoneCardMapper.findByUid"/>
    </resultMap>
    <!--List<User> findAll();-->
    <select id="findAll" resultMap="UserMap">
        SELECT *
        FROM user
    </select>

    <!--User findById(int id);-->
    <select id="findById" resultMap="UserMap">
        SELECT *
        FROM user
        WHERE id = #{id}
    </select>

</mapper>
```

+ `PhoneCardMapper` ï¼š

```java
public interface PhoneCardMapper {
    List<PhoneCard> findAll();
    List<PhoneCard> findByUid(int uid);
}
```

```xml
<mapper namespace="com.simon.mapper.PhoneCardMapper">
    <resultMap id="PhoneCardMap" type="PhoneCard">
        <id property="pid" column="pid"/>
        <result property="phoneNo" column="phone_no"/>
        <result property="uid" column="uid"/>
        <association property="user" javaType="User" column="uid"
                    select="com.simon.mapper.UserMapper.findById"/>
    </resultMap>

    <select id="findAll" resultMap="PhoneCardMap">
        SELECT *
        FROM phonecard
    </select>

    <select id="findByUid" resultMap="PhoneCardMap">
        SELECT *
        FROM phonecard
        WHERE uid = #{uid}
    </select>
</mapper>
```

:::



### å¤šå¯¹å¤šæ˜ å°„å…³ç³»



ğŸŒ° ç”¨æˆ· / åœ°ç‚¹ / é—¨ç¥¨ï¼šä¸€ä¸ªç”¨æˆ·åˆ°å¤šä¸ªåœ°æ–¹æ¸¸ç©ï¼Œä¸€ä¸ªåœ°æ–¹æœ‰å¤šä¸ªç”¨æˆ·æ¥ç©ï¼Œæœ‰ä¸­é—´è¡¨ `ticket` ï¼Œæ‰€ä»¥ä½¿ç”¨ **ä¸€ä¸ª `association` ï¼Œä¸€ä¸ª `collection` æ¥å®ç°** ï¼š

::: details

```sql
create table spot
(
    sid     int      not null,
    address char(10) not null
);

INSERT INTO spot (sid, address) VALUES (1, 'æ•…å®«');
INSERT INTO spot (sid, address) VALUES (2, 'ç§¦å²­');
INSERT INTO spot (sid, address) VALUES (3, 'è¥¿æ¹–');
INSERT INTO spot (sid, address) VALUES (4, 'æ¡‚æ—');
```

```sql
create table ticket
(
    tid int not null,
    uid int not null
);

INSERT INTO ticket (uid, tid) VALUES (1, 1);
INSERT INTO ticket (uid, tid) VALUES (1, 4);
INSERT INTO ticket (uid, tid) VALUES (2, 1);
INSERT INTO ticket (uid, tid) VALUES (2, 2);
INSERT INTO ticket (uid, tid) VALUES (2, 3);
INSERT INTO ticket (uid, tid) VALUES (3, 2);
INSERT INTO ticket (uid, tid) VALUES (5, 1);
INSERT INTO ticket (uid, tid) VALUES (5, 4);
```

+ `TicketMapper` ï¼š

```xml
<mapper namespace="com.simon.mapper.TicketMapper">
    <resultMap id="TicketMap" type="Ticket">
        <id property="tid" column="tid"/>
        <id property="uid" column="uid"/>
        <association property="user" javaType="User"
                     column="uid" select="com.simon.mapper.UserMapper.findById"/>
        <association property="spot" javaType="Spot"
                     column="tid" select="com.simon.mapper.SpotMapper.findBySid"/>
    </resultMap>

    <select id="findByUid" resultMap="TicketMap">
        SELECT * FROM ticket WHERE uid = #{uid}
    </select>

    <select id="findByTid" resultMap="TicketMap">
        SELECT * FROM ticket WHERE tid = #{tid}
    </select>
</mapper>
```

+ `UserMapper`ï¼š

```xml
<mapper namespace="com.simon.mapper.UserMapper">
    <resultMap id="UserMap" type="User">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="age" column="age"/>
        <result property="sex" column="sex"/>
        <result property="address" column="address"/>
        <!--<association property="idCard" javaType="IdCard" column="id" select="com.simon.mapper.IdCardMapper.findByUid"/>-->
        <!--<collection property="phoneCardList" ofType="PhoneCard"
                    column="id" select="com.simon.mapper.PhoneCardMapper.findByUid"/>-->
        <collection property="ticketList" ofType="Ticket"
                    column="id" select="com.simon.mapper.TicketMapper.findByUid"/>
    </resultMap>
    <!--List<User> findAll();-->
    <select id="findAll" resultMap="UserMap">
        SELECT *
        FROM user
    </select>

    <!--User findById(int id);-->
    <select id="findById" resultMap="UserMap">
        SELECT *
        FROM user
        WHERE id = #{id}
    </select>
</mapper>
```

+ `SpotMapper`ï¼š

```xml
<mapper namespace="com.simon.mapper.SpotMapper">
    <resultMap id="SpotMap" type="Spot">
        <id property="sid" column="sid"/>
        <result property="address" column="address"/>
        <collection property="ticketList" ofType="Ticket"
                    column="sid" select="com.simon.mapper.TicketMapper.findByTid"/>
    </resultMap>

    <select id="findAll" resultMap="SpotMap">
        SELECT *
        FROM spot
    </select>

    <select id="findBySid" resultMap="SpotMap">
        SELECT *
        FROM spot
        WHERE sid = #{sid}
    </select>
</mapper>
```

+ åˆ†åˆ«åœ¨ `UserMapperTest` å’Œ `SpotMapperTest` ä¸­æµ‹è¯•ï¼Œé€šè¿‡ `Ticket` ä¸­é—´è¡¨æŸ¥è¯¢ï¼š

+ æµ‹è¯•ç”±ç”¨æˆ·æŸ¥æ‰€åˆ°çš„åœ°ç‚¹ï¼š

```java
@Test
public void testFindAll() {
    List<User> userList = userMapper.findAll();
    for (User user : userList) {
        if (user != null) {
            System.out.println(user);
            for (Ticket ticket : user.getTicketList()) {
                System.out.println(ticket);
                if (ticket != null) {
                    System.out.println(ticket.getSpot());
                }
            }
        }
    }
}
```

+ æµ‹è¯•ç”±åœ°ç‚¹æŸ¥è¯¢å“ªäº›ç”¨æˆ·åˆ°è¿‡ï¼š

```java
@Test
public void findAll() {
    List<Spot> spotList = spotMapper.findAll();
    for (Spot spot : spotList) {
        if (spot != null) {
            System.out.println(spot);
            for (Ticket ticket : spot.getTicketList()) {
                if(ticket!=null) {
                    System.out.println(ticket.getUser());
                }
            }
        }
    }
}
```

:::

+ å¯¹äºä¸€äº›ç®€å•çš„æŸ¥è¯¢ï¼Œå¯ä»¥ä¸å¿…å¦‚åŒå‰é¢é‚£æ ·æŒ‰éƒ¨å°±ç­æŠŠæ‰€æœ‰æ˜ å°„ç¼–å†™ï¼Œ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨è¿æ¥æŸ¥è¯¢å®Œæˆï¼š
+ ğŸŒ° æŸ¥è¯¢å»è¿‡æŸåœ°çš„ç”¨æˆ·ï¼š
+  `SpotMapper` ä¸­ï¼š

```xml
<select id="findBySpotName" resultType="User" parameterType="String">
    SELECT user.name
    FROM user,
         spot,
         ticket
    WHERE user.id = ticket.uid
    AND spot.sid = ticket.tid AND spot.address = #{spotName}
</select>
```



## æ³¨è§£å®ç°å…³è”æ˜ å°„



ğŸŒ° ä½¿ç”¨æ³¨è§£å®ç° ç”¨æˆ· ä¸ ç”µè¯å¡çš„å…³è”ï¼š

::: details 

> `@Many` æ³¨è§£ï¼šå®ç° XML é…ç½®æ–‡ä»¶ä¸­ `collection` çš„åŠŸèƒ½

+ `UserMapper` ï¼š

```java
public interface UserMapper {

    @Select("SELECT * FROM user")
    @Results(id = "UserMap", value = {
            @Result(id = true, column = "id", property = "id"),
            @Result(column = "name", property = "name"),
            @Result(column = "age", property = "age"),
            @Result(column = "sex", property = "sex"),
            @Result(column = "address", property = "address"),
            @Result(column = "id", property = "phoneCardList",
                many = @Many(select = "com.simon.mapper.PhoneCardMapper.findByUid",
                fetchType = FetchType.EAGER))
    })
    List<User> findAll();

    @Select("SELECT * FROM user WHERE id = #{id}")
    @ResultMap("UserMap")
    User findById(int id);
}
```



> `@One` æ³¨è§£ï¼šå®ç° XML é…ç½®æ–‡ä»¶ä¸­çš„ `association` çš„åŠŸèƒ½ã€‚

+ `PhoneCardMapper` ï¼š

```java
public interface PhoneCardMapper {
    @Select("SELECT * FROM phonecard")
    @Results(id = "PhoneCardMap", value = {
            @Result(id = true, column = "pid", property = "pid"),
            @Result(column = "phone_no", property = "phoneNo"),
            @Result(column = "uid", property = "uid"),
            @Result(column = "uid", property = "user", one = @One(
                    select = "com.simon.mapper.UserMapper.findById",
                    fetchType = FetchType.EAGER
            ))
    })
    List<PhoneCard> findAll();

    @Select("SELECT * FROM phonecard WHERE uid = #{uid}")
    @ResultMap("PhoneCardMap")
    List<PhoneCard> findByUid(int uid);
}
```

:::