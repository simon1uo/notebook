---
title:  ğŸŒ’ è·å–å“åº”æ•°æ®
date: 2022-06-11 15:38:55
permalink: /pages/f3a9f8/
categories:
  -  ğŸš¶ğŸ» å‰ç«¯å·©å›ºåŸºç¡€
  -  ğŸšŸ axios
  -  ğŸ’½ ä½¿ç”¨ TypeScript é‡æ„ axios åº“
tags:
  - 
---
## éœ€æ±‚åˆ†æ

å‰é¢çš„å®ç°ä¸­ï¼Œå‘é€çš„è¯·æ±‚éƒ½å¯ä»¥ä»ç½‘ç»œå±‚é¢æ¥æ”¶åˆ°æœåŠ¡å™¨ç«¯è¿”å›çš„æ•°æ®ï¼›**ä½†æ˜¯ä»£ç å±‚é¢å¹¶æ²¡æœ‰å¯¹å“åº”æ•°æ®è¿›è¡Œä»»ä½•çš„å¤„ç†**ã€‚

éœ€è¦æ”¯æŒå¯¹å“åº”æ•°æ®çš„å¤„ç†ï¼Œå¹¶ä¸”æ”¯æŒ `Promise` çš„é“¾å¼è°ƒç”¨çš„æ–¹å¼ï¼Œå¦‚ä¸‹ï¼š
```typescript
axios({
  method: 'post',
  url: '/base/post',
  headers: {
    'content-type': 'application/json'
  },
  data: {
    a: 1,
    b: 2
  }
}).then((res) => {
  console.log(res)
})
```

> å¯ä»¥è·å–åˆ° `res` å¯¹è±¡ï¼Œå¹¶ä¸” `res` å¯¹è±¡ä¸­åŒ…æ‹¬æœåŠ¡å™¨è¿”å›çš„æ•°æ® `data`ï¼ŒHTTP å“åº”çŠ¶æ€ç  `status`ï¼Œ å“åº”å¤´ `headers`ã€è¯·æ±‚é…ç½®å¯¹è±¡ `config` ä»¥åŠè¯·æ±‚çš„ `XMLHttpRequest` å¯¹è±¡å®ä¾‹ `request`ã€‚



## å®šä¹‰æ¥å£ç±»å‹ `AxiosReponse`

å¦‚ä¸‹ï¼š
```typescript
export interface AxiosResponse {
  data: any
  status: number
  statusText: string
  headers: any
  config: AxiosRequestConfig
  request: any
}
```

å¦å¤– `axios` å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª `Promise` å¯¹è±¡ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ª `AxiosPromise` æ¥å£ï¼Œç»§æ‰¿äº `Promise<AxiosResponse>` è¿™ä¸ªæ³›å‹æ¥å£ï¼š

```typescript
export interface AxiosPromise extends Promise<AxiosResponse> {
  
}
```

> æ­¤æ—¶ï¼Œå½“ `axios` è¿”å›çš„æ˜¯ `AxiosPromise` ç±»å‹ï¼Œé‚£ä¹ˆ `resolve` å‡½æ•°ä¸­çš„å‚æ•°æ˜¯ä¸€ä¸ª `AxiosResponse` ç±»å‹ã€‚



å¯¹äº AJAX è¯·æ±‚çš„ `response` ï¼Œå¯ä»¥æŒ‡å®šå®ƒçš„æ•°æ®ç±»å‹ï¼Œé€šè¿‡è®¾ç½® `XMLHttpRequest` å¯¹è±¡çš„ `responseType` å±æ€§ï¼Œå¯ä»¥ç»™ `axiosRequestConfig` ç±»å‹æ·»åŠ ä¸€ä¸ªå¯é€‰å±æ€§ï¼š

```typescript
export interface AxiosRequestConfig {
  // ...
  responseType?: XMLHttpRequestResponseType
}
```

> `responseType` çš„ç±»å‹æ˜¯ä¸€ä¸ª `XMLHttpRequestResponseType` ç±»å‹ï¼Œå®ƒçš„å®šä¹‰æ˜¯ `"" | "arraybuffer" | "blob" | "document" | "json" | "text"` å­—ç¬¦ä¸²å­—é¢é‡ç±»å‹ã€‚



## å®ç°è·å–ç›¸åº”æ•°æ®çš„é€»è¾‘

åœ¨ `src/xhr.ts` ä¸­ï¼Œæ·»åŠ  `onreadystatechange` äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå¹¶ä¸”è®© `xhr` å‡½æ•°è¿”å›çš„æ˜¯ `AxiosPromise` ç±»å‹ï¼š

```typescript
import { AxiosPromise, AxiosRequestConfig, AxiosResponse } from './types'

export default function xhr(config: AxiosRequestConfig): AxiosPromise {
  return new Promise(resolve => {
    const { data = null, url, method = 'get', headers, responseType } = config

    const request = new XMLHttpRequest()

    if (responseType) {
      request.responseType = responseType
    }

    request.open(method.toUpperCase(), url, true)

    request.onreadystatechange = function handleLoad() {
      if(request.readyState !== 4) {
        return
      }

      const responseHeaders = request.getAllResponseHeaders()
      const responseData = responseType && responseType !== 'text' ? request.response : request.responseText
      const response: AxiosResponse = {
        data: responseData,
        status: request.status,
        statusText: request.statusText,
        headers: responseHeaders,
        config,
        request
      }

      resolve(response)
    }

    Object.keys(headers).forEach(name => {
      if (data === null && name.toLowerCase() === 'content-type') {
        delete headers[name]
      } else {
        request.setRequestHeader(name, headers[name])
      }
    })

    request.send(data)
  })
}

```

> + éœ€è¦åˆ¤æ–­ å¦‚æœ `config` é…ç½®äº† `responseType`ï¼Œéœ€è¦å°†å®ƒè®¾ç½®åˆ° `xhr` çš„ `requset.responseType`ï¼›
> + åœ¨ `onreadystatechange` äº‹ä»¶å‡½æ•°ä¸­ï¼Œæ„é€ äº† `AxiosResponse` ç±»å‹çš„ `response` å¯¹è±¡ï¼Œå¹¶æŠŠå®ƒ `resolve` å‡ºå»ã€‚

ä¿®æ”¹äº† `xhr` å‡½æ•°ï¼ŒåŒæ ·è¦ä¿®æ”¹å¯¹åº”çš„ `axios` å‡½æ•°ï¼š

`src/index.ts`ï¼š

```typescript
function axios(config: AxiosRequestConfig): AxiosPromise {
  processConfig(config)
  return xhr(config)
}
```

> è‡³æ­¤å®ç°äº† `axios` çš„ `Promise` åŒ–ã€‚



## ç¼–å†™æµ‹è¯• DEMO

`examples/base/app.ts`ï¼Œæ·»åŠ ï¼š

```typescript
axios({
  method: 'post',
  url: '/base/post',
  data: {
    a: 1,
    b: 2
  }
}).then((res) => {
  console.log(res)
})

axios({
  method: 'post',
  url: '/base/post',
  responseType: 'json',
  data: {
    a: 3,
    b: 4
  }
}).then((res) => {
  console.log(res)
})
```

> è¿è¡Œåå¯ä»¥çœ‹åˆ°å¯ä»¥æ­£å¸¸ `log` è¾“å‡ºè¿™ä¸ª `res` å“åº”å¯¹è±¡ï¼Œ å…¶ä¸­åŒ…å« `AxiosRepsonse` ç±»å‹å®šä¹‰çš„é‚£äº›å±æ€§ï¼Œä¸è¿‡å‘ç°ä¸¤ä¸ªé—®é¢˜ï¼š
>
> + ç¬¬ä¸€ä¸ª `headers` å±æ€§æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œéœ€è¦è§£æä¸º JSON å¯¹è±¡ï¼›
> + ç¬¬ä¸€ä¸ªè¯·æ±‚ä¸­ï¼Œ`res` å“åº”å¯¹è±¡ä¸­çš„ `data` å¾—åˆ°çš„æ•°æ®æ˜¯ä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼Œéœ€è¦è½¬æ¢ä¸ºå¯¹è±¡ç±»å‹ã€‚