---
title:  ğŸŒ˜ å®ç°æ‹¦æˆªå™¨
date: 2022-06-11 17:40:39
permalink: /pages/291f04/
categories:
  -  ğŸš¶ğŸ» å‰ç«¯å·©å›ºåŸºç¡€
  -  ğŸšŸ axios
  -  ğŸ’½ ä½¿ç”¨ TypeScript é‡æ„ axios åº“
tags:
  - 
---



## éœ€æ±‚åˆ†æ

è¦å¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œæ‹¦æˆªã€‚

å®ç°å¦‚ä¸‹çš„åŠŸèƒ½ï¼š

```typescript
// æ·»åŠ ä¸€ä¸ªè¯·æ±‚æ‹¦æˆªå™¨
axios.interceptors.request.use(function (config) {
  // åœ¨å‘é€è¯·æ±‚ä¹‹å‰å¯ä»¥åšä¸€äº›äº‹æƒ…
  return config;
}, function (error) {
  // å¤„ç†è¯·æ±‚é”™è¯¯
  return Promise.reject(error);
});
// æ·»åŠ ä¸€ä¸ªå“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(function (response) {
  // å¤„ç†å“åº”æ•°æ®
  return response;
}, function (error) {
  // å¤„ç†å“åº”é”™è¯¯
  return Promise.reject(error);
});
```

> åœ¨ `axios` å¯¹è±¡ä¸Šæœ‰ä¸€ä¸ª `interceptors` å¯¹è±¡å±æ€§ï¼Œè¯¥å±æ€§åˆæœ‰ `request` å’Œ `response` 2 ä¸ªå±æ€§ï¼Œå®ƒä»¬éƒ½æœ‰ä¸€ä¸ª `use` æ–¹æ³•ï¼Œ`use` æ–¹æ³•æ”¯æŒ 2 ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ç±»ä¼¼ Promise çš„ `resolve` å‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°ç±»ä¼¼ Promise çš„ `reject` å‡½æ•°ã€‚
> å¯ä»¥åœ¨ `resolve` å‡½æ•°å’Œ `reject` å‡½æ•°ä¸­æ‰§è¡ŒåŒæ­¥ä»£ç æˆ–è€…å¼‚æ­¥ä»£ç é€»è¾‘ã€‚

å¹¶ä¸”å¯ä»¥æ·»åŠ å¤šä¸ªæ‹¦æˆªå™¨ï¼Œæ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåºæ˜¯é“¾å¼ä¾æ¬¡æ‰§è¡Œçš„æ–¹å¼ã€‚å¯¹äº `request` æ‹¦æˆªå™¨ï¼Œåæ·»åŠ çš„æ‹¦æˆªå™¨ä¼šåœ¨è¯·æ±‚å‰çš„è¿‡ç¨‹å…ˆæ‰§è¡Œï¼›å¯¹äº `response` æ‹¦æˆªå™¨ï¼Œå…ˆæ·»åŠ çš„æ‹¦æˆªå™¨ä¼šåœ¨å“åº”åå…ˆæ‰§è¡Œï¼›

```typescript
axios.interceptors.request.use(config => {
  config.headers.test += '1'
  return config
})
axios.interceptors.request.use(config => {
  config.headers.test += '2'
  return config
})
```

ä¹Ÿå¯ä»¥æ”¯æŒåˆ é™¤æŸä¸ªæ‹¦æˆªå™¨ï¼Œå¦‚ä¸‹ï¼š

```typescript
const myInterceptor = axios.interceptors.request.use(function () {/*...*/})
axios.interceptors.request.eject(myInterceptor)
```



## æ•´ä½“è®¾è®¡

![20200105110744](https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/qn5IXD.jpeg)

æ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªé“¾å¼è°ƒç”¨çš„è¿‡ç¨‹ï¼Œè€Œä¸”æ¯ä¸€ä¸ªæ‹¦æˆªå™¨éƒ½å¯ä»¥æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å¤„ç†ï¼Œè‡ªç„¶æƒ³åˆ°ä½¿ç”¨ Promise é“¾çš„æ–¹å¼å®ç°æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ã€‚

è¿™ä¸ª Promise é“¾çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¯·æ±‚æ‹¦æˆªå™¨ `resolve` å‡½æ•°å¤„ç†çš„æ˜¯ `config` å¯¹è±¡ï¼Œå“åº”æ‹¦æˆªå™¨ `resolve` å‡½æ•°å¤„ç†çš„æ˜¯ `response` å¯¹è±¡ï¼›

äº†è§£è¿™ä¸ªè¿‡ç¨‹åï¼Œå…ˆè¦åˆ›å»ºä¸€ä¸ª **æ‹¦æˆªå™¨ç®¡ç†ç±»**ï¼Œå…è®¸æ·»åŠ ã€åˆ é™¤å’Œéå†æ‹¦æˆªå™¨ã€‚

## æ‹¦æˆªå™¨ç®¡ç†ç±»å®ç°

æ ¹æ®éœ€æ±‚ï¼Œ`axios` æ‹¥æœ‰ä¸€ä¸ª `interceptors` å¯¹è±¡å±æ€§ï¼Œè¯¥å±æ€§åˆæœ‰ `request` å’Œ `response` 2 ä¸ªå±æ€§ï¼Œå®ƒä»¬å¯¹å¤–æä¾›ä¸€ä¸ª `use` æ–¹æ³•æ¥æ·»åŠ æ‹¦æˆªå™¨ï¼Œå¯ä»¥æŠŠè¿™ä¸¤ä¸ªå±æ€§çœ‹åšæ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨ç®¡ç†å¯¹è±¡ã€‚

`user` æ–¹æ³•æ”¯æŒä¸¤ä¸ªå‚æ•°ï¼Œå¯¹äº `resolve` å‡½æ•°çš„å‚æ•°ï¼Œè¯·æ±‚æ‹¦æˆªå™¨æ˜¯ `AxiosRequestConfig` ç±»å‹çš„ï¼›å¯¹äº `reject` å‡½æ•°çš„å‚æ•°ç±»å‹åˆ™æ˜¯ `any` ç±»å‹çš„ã€‚

### å®šä¹‰æ¥å£

```typescript
export interface AxiosInterceptorManager<T> {
  use(resolved: ResolvedFn<T>, rejected?: RejectedFn): number

  eject(id: number): void
}

export interface ResolvedFn<T = any> {
  (val: T): T | Promise<T>
}

export interface RejectedFn {
  (error: any): any
}
```

> å®šä¹‰ `AxiosInterceptorManager` æ³›å‹æ¥å£ï¼Œå¯¹äº `resolve` å‡½æ•°çš„å‚æ•°ï¼Œè¯·æ±‚æ‹¦æˆªå™¨å’Œå“åº”æ‹¦æˆªå™¨æ˜¯ä¸åŒçš„ã€‚

ä¿®æ”¹ `Aixos` çš„ç±»å‹ï¼š

```typescript
export interface Axios {
  interceptors: {
    request: AxiosInterceptorManager<AxiosRequestConfig>,
    response: AxiosInterceptorManager<AxiosResponse>
  }

  // ... 
}
```

### ä»£ç å®ç°

å®šä¹‰æ–°çš„ç±» `src/core/InterceptorManager`

```typescript
import { RejectedFn, ResolvedFn } from '../types'

interface Interceptor<T> {
  resolved: ResolvedFn<T>
  rejected: RejectedFn
}

export default class InterceptorManager<T> {
  private interceptors: Array<Interceptor<T> | null>

  constructor() {
    this.interceptors = []
  }

  use(resolved: ResolvedFn<T>, rejected?: RejectedFn): number {
    this.interceptors.push({
      resolved,
      rejected
    })

    return this.interceptors.length - 1
  }

  forEach(fn: (interceptor: Interceptor<T>) => void): void {
    this.interceptors.forEach(interceptor => {
      if (interceptor != null) fn(interceptor)
    })
  }

  eject(id: number): void {
    if (this.interceptors[id]) {
      this.interceptors[id] = null
    }
  }
}
```

> å®šä¹‰ `InterceptorManager` æ³›å‹ç±»ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªç§æœ‰å±æ€§ `interceptors` æ•°ç»„ï¼Œå­˜å‚¨æ‹¦æˆªå™¨ã€‚è¯¥ç±»å¯¹å¤–æä¾›ä¸‰ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­ `use` æ¥å£æ·»åŠ æ‹¦æˆªå™¨åˆ° `interceptors`ï¼Œè¿”å›ä¸€ä¸ª `id` ç”¨äºåˆ é™¤ï¼›`forEach` æ¥å£éå† `interceptors`ï¼Œæ”¯æŒä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œéå†çš„è¿‡ç¨‹ä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œå¹¶æŠŠæ¯ä¸€ä¸ª `interceptor` ä½œä¸ºå‡½æ•°çš„å‚æ•°ä¼ å…¥ï¼›`eject` æ¥å£åˆ é™¤æ‹¦æˆªå™¨ï¼Œé€šè¿‡ä¼ å…¥çš„æ‹¦æˆªå™¨ `id` åˆ é™¤ã€‚



### é“¾å¼è°ƒç”¨å®ç°

é¦–å…ˆåœ¨ `src/core/Axios` å®šä¹‰ä¸€ä¸ª `interceptors` å±æ€§ï¼Œç±»å‹å¦‚ä¸‹æ¥å£ï¼š
```typescript
interface Interceptors {
  request: InterceptorManager<AxiosRequestConfig>
  response: InterceptorManager<AxiosResponse>
}
```

> `Interceptors` ç±»å‹æœ‰ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªè¯·æ±‚æ‹¦æˆªå™¨ç®¡ç†ç±»å®ä¾‹ï¼Œå¦ä¸€ä¸ªæ˜¯å“åº”æ‹¦æˆªå™¨ç®¡ç†ç±»å®ä¾‹ã€‚åœ¨å®ä¾‹åŒ– `Aixos` æ—¶ï¼Œåœ¨å®ƒçš„æ„é€ å™¨å»åˆå§‹åŒ–è¿™ä¸ª `interceptors` å®ä¾‹å±æ€§ã€‚



ç„¶åä¿®æ”¹ `src/core/Axios` ä¸­ `Axios` ç±»ä¸­çš„ `request` æ–¹æ³•é€»è¾‘ï¼Œæ·»åŠ æ‹¦æˆªå™¨é“¾å¼è°ƒç”¨çš„é€»è¾‘ï¼š

```typescript
interface PromiseChain<T> {
  resolved: ResolvedFn<T> | ((config: AxiosRequestConfig) => AxiosPromise)
  rejected?: RejectedFn
}
```

> å®šä¹‰ `PromiseChain` æ¥å£ã€‚

```typescript
request(url: any, config?: any): AxiosPromise {
  if (typeof url === 'string') {
    if (!config) {
      config = {}
    }
    config.url = url
  } else {
    config = url
  }

  const chain: PromiseChain<any>[] = [
    {
      resolved: dispatchRequest,
      rejected: undefined
    }
  ]

  this.interceptors.request.forEach(interceptor => {
    chain.unshift(interceptor)
  })

  this.interceptors.response.forEach(interceptor => {
    chain.push(interceptor)
  })

  let promise = Promise.resolve(config)
  while (chain.length) {
    const { resolved, rejected } = chain.shift()!
    promise = promise.then(resolved, rejected)
  }

  return promise
}
```

> é¦–å…ˆæ„é€ ä¸€ä¸ª `PromiseChain` ç±»å‹çš„æ•°ç»„ `chain`ï¼Œå¹¶ä¸”æŠŠ `dispatchRequest` å‡½æ•°èµ‹å€¼ç»™ `resolved`ï¼›æ¥ç€å…ˆéå†è¯·æ±‚æ‹¦æˆªå™¨æ’å…¥åˆ° `chain` çš„å‰é¢ï¼›ç„¶åå†éå†å“åº”æ‹¦æˆªå™¨æ’å…¥åˆ° `chain` çš„åé¢ã€‚
>
> æ¥ä¸‹æ¥å®šä¹‰ä¸€ä¸ªå·²ç» `resolve` çš„ `Promise`ï¼Œå¾ªç¯è¿™ä¸ª `chain`ï¼Œæ‹¿åˆ°æ¯ä¸ªæ‹¦æˆªå™¨å¯¹è±¡ï¼ŒæŠŠå®ƒä»¬çš„ `resolved` å‡½æ•°å’Œ `rejected` å‡½æ•°æ·»åŠ åˆ° `promise.then` çš„å‚æ•°ä¸­ï¼Œè¿™æ ·å°±ç›¸å½“äºé€šè¿‡ `Promise` çš„é“¾å¼è°ƒç”¨æ–¹å¼ï¼Œå®ç°äº†æ‹¦æˆªå™¨ä¸€å±‚å±‚çš„é“¾å¼è°ƒç”¨ã€‚
>
> è¦æ³¨æ„ **æ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåº**ã€‚è¯·æ±‚æ‹¦æˆªå™¨å…ˆæ‰§è¡Œåæ·»åŠ çš„ï¼Œå†æ‰§è¡Œå…ˆæ·»åŠ çš„ï¼›å¯¹äºå“åº”æ‹¦æˆªå™¨ï¼Œå…ˆæ‰§è¡Œå…ˆæ·»åŠ çš„ï¼Œåæ‰§è¡Œåæ·»åŠ çš„ã€‚



## ç¼–å†™ DEMO ä»£ç 



`examples/interceptor/app.ts`ï¼š

```typescript
import axios from '../../src/index'

axios.interceptors.request.use(config => {
  config.headers.test += '1'
  return config
})

axios.interceptors.request.use(config => {
  config.headers.test += '2'
  return config
})

axios.interceptors.request.use(config => {
  config.headers.test += '3'
  return config
})

axios.interceptors.response.use(res => {
  res.data += '1'
  return res
})

let interceptor = axios.interceptors.response.use(res => {
  res.data += '2'
  return res
})

axios.interceptors.response.use(res => {
  res.data += '3'
  return res
})

axios.interceptors.response.eject(interceptor)

axios({
  url: '/interceptor/get',
  method: 'get',
  headers: {
    test: ''
  }
}).then((res)=>{
  console.log(res.data)
})
```

> è¿è¡Œåï¼Œå¯ä»¥æŸ¥çœ‹åˆ° è¯·æ±‚å¤´ä¸­æ·»åŠ äº†å­—æ®µ `test`ï¼Œä»¥åŠå†…å®¹ä¸º `321`ï¼Œè¯´æ˜è¯·æ±‚æ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåºæ­£ç¡®ï¼›æœ€åæ§åˆ¶å°è¾“å‡ºçš„å†…å®¹ä¸º `13`ï¼Œè¯´æ˜ å“åº”æ‹¦æˆªå™¨æ ¹æ® `id` åˆ é™¤æˆåŠŸï¼Œå¹¶ä¸”æ‰§è¡Œé¡ºåºæ­£ç¡®ã€‚
>
> æ‹¦æˆªå™¨æ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„åŠŸèƒ½ï¼Œåœ¨å®é™…çš„å·¥ä½œä¸­å¯ä»¥åˆ©ç”¨å®ƒæ·»åŠ ç™»å½•æƒé™è®¤è¯çš„åŠŸèƒ½ç­‰ã€‚
