---
title:  ğŸŒ• éƒ¨ç½²ä¸å‘å¸ƒ
date: 2022-06-18 16:05:56
permalink: /pages/2b07f0/
categories:
  -  ğŸš¶ğŸ» å‰ç«¯å·©å›ºåŸºç¡€
  -  ğŸšŸ axios
  -  ğŸ’½ ä½¿ç”¨ TypeScript é‡æ„ axios åº“
tags:
  - 
---
> è‡³æ­¤ï¼Œæ‰€æœ‰çš„ axios é‡æ„çš„ä»£ç ç¼–å†™å’Œå•å…ƒæµ‹è¯•éƒ½å®Œæˆäº†ã€‚è¿™å·²ç»æ˜¯ä¸€ä¸ªå‡ ä¹æˆç†Ÿå¯ä¾›ä½¿ç”¨çš„ TypeScript åº“äº†ã€‚
>
> åœ¨ç›®å‰ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰äººéƒ½ä¼šä½¿ç”¨ TypeScript å¼€å‘ï¼Œä»ç„¶æœ‰å¤§é‡çš„ JavaScript ç”¨æˆ·ï¼Œå®ƒä»¬æ˜¯ä¸èƒ½ç›´æ¥å¼•ç”¨ TypeScript ä»£ç çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆå¯¹æºç åšç¼–è¯‘å’Œæ‰“åŒ…ï¼Œç„¶åå†å‘å¸ƒã€‚
>
> å¦‚æœè¦å°†è¿™ä¸ªåŒ…å‘å¸ƒåˆ° npm æºï¼Œéœ€è¦æ³¨å†Œè´¦å·ï¼Œå¹¶ä¸”åœ¨ç»ˆç«¯ä½¿ç”¨ `npm login` ç™»å½•ã€‚



## ç¼–è¯‘ä¸æ‰“åŒ…

åˆ©ç”¨ [rollup](https://github.com/rollup/rollup) æ¥æ‰“åŒ…

> å®ƒæ˜¯ä¸€ä¸ªéå¸¸è‘—åçš„ç¼–è¯‘æ‰“åŒ…å·¥å…·ï¼ŒVue.js ä¹Ÿæ˜¯åˆ©ç”¨ rollup ç¼–è¯‘æ‰“åŒ…çš„ã€‚ç›¸æ¯” webpackï¼Œå®ƒéå¸¸é€‚åˆå»ç¼–è¯‘å’Œæ‰“åŒ…ä¸€äº› JS åº“ã€‚

> ç”±äºä½¿ç”¨ `typescript-library-starter` åˆå§‹åŒ–æˆ‘ä»¬çš„é¡¹ç›®ï¼Œæˆ‘ä»¬å·²ç»æ‹¥æœ‰äº† **rollup** æ‰“åŒ…çš„ç›¸å…³é…ç½®å’Œç›¸å…³æ’ä»¶çš„å®‰è£…ã€‚

å¯¹ç”Ÿæˆçš„ `rollup.config.ts` åšå°å°çš„ä¿®æ”¹ï¼š

+ å°† `libraryName` ä¿®æ”¹ä¸ºé¡¹ç›®åç§°ï¼›
+ `input` ä¿®æ”¹ä¸º `src/index.ts`ã€‚

> + `input`ï¼š è¡¨ç¤ºæ‰“åŒ…å…¥å£æ–‡ä»¶ã€‚
> + `output`ï¼šè¡¨ç¤ºè¾“å‡ºçš„ç›®æ ‡æ–‡ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œå¯ä»¥æŒ‡å®šè¾“å‡ºçš„æ ¼å¼ï¼Œæ¯”å¦‚ `umd` æ ¼å¼ã€`es` æ¨¡å¼ç­‰ã€‚
> + `external`ï¼šå¤–éƒ¨ä¾èµ–ï¼Œå¯ä»¥ä¸è¢«æ‰“åŒ…è¿›å»ã€‚
> + `watch`ï¼šç›‘å¬æ–‡ä»¶çš„å˜åŒ–ï¼Œé‡æ–°ç¼–è¯‘ï¼Œåªæœ‰åœ¨ç¼–è¯‘çš„æ—¶å€™å¼€å¯ `--watch` æ‰ç”Ÿæ•ˆã€‚
> + `plugins`ï¼š
> + ç¼–è¯‘è¿‡ç¨‹ä¸­ä½¿ç”¨çš„æ’ä»¶ï¼Œå…¶ä¸­ `rollup-plugin-typescript2` å°±æ˜¯ç”¨æ¥ç¼–è¯‘ TypeScript æ–‡ä»¶ï¼Œ`useTsconfigDeclarationDir` è¡¨ç¤ºä½¿ç”¨ `tsconfig.json` æ–‡ä»¶ä¸­å®šä¹‰çš„ `declarationDir`ã€‚æ›´å¤šæ’ä»¶å¯ä»¥æŸ¥é˜…æ–‡æ¡£ã€‚



ä¿®æ”¹ `package.json`ï¼Œç¡®ä¿ä¸€ä¸‹ï¼š

```typescript
"main": "dist/axios-typescript.umd.js",
"module": "dist/axios-typescript.es5.js",
"typings": "dist/types/axios-typescript.d.ts",
```

ä¸ºé¡¹ç›®åç§°ã€‚



ç„¶ååœ¨åœ¨æ§åˆ¶å°æ‰§è¡Œ `npm run build`ï¼Œä¼šç¼–è¯‘è¾“å‡º `dist` ç›®å½•ï¼Œå…¶ä¸­ ï¼š

+ `lib` ç›®å½•æ˜¯å•ä¸ª `.ts` æ–‡ä»¶ç¼–è¯‘åçš„ `.js` æ–‡ä»¶ã€‚
+ `types` ç›®å½•æ˜¯æ‰€æœ‰ `.ts` æ–‡ä»¶ç¼–è¯‘åç”Ÿäº§çš„ `.d.ts` å£°æ˜æ–‡ä»¶ã€‚
+ `axios.es5.js` æ˜¯ç¼–è¯‘åç”Ÿæˆçš„ es æ¨¡å¼çš„å…¥å£æ–‡ä»¶ï¼Œç”¨åœ¨ `package.json` çš„ `module` å­—æ®µï¼Œ`axios.umd.js` æ–‡ä»¶æ˜¯ç¼–è¯‘åç”Ÿæˆçš„ `umd` æ¨¡å¼çš„å…¥å£æ–‡ä»¶ï¼Œç”¨åœ¨ `package.json` çš„ `main` å­—æ®µã€‚



## è‡ªå®šä¹‰éƒ¨ç½²

> ç”±äº `semantic-release` æ’ä»¶è¿‡äºé»‘ç›’ä¹Ÿç•¥å¾®é‡é‡ï¼Œè‡ªå·±ç¼–å†™è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬æ›´åŠ çµæ´»æ„ä¹‰æ›´å¤§ã€‚



é¦–å…ˆä¿®æ”¹ `package.json`ï¼š

> éœ€è¦ä¸ºè¿™ä¸ªåŒ…å‘½åä¸€ä¸ª npm ä¸­æ²¡æœ‰è¢«å ç”¨çš„åå­—ã€‚å¯ä»¥ä½¿ç”¨ `npm view` æœç´¢åŒ…åæ˜¯å¦å­˜åœ¨ã€‚

å¦‚æœè¦å…³è”è¿™ä¸ªå‘å¸ƒçš„åŒ…å¯¹åº”çš„ä»“åº“ï¼Œå¯ä»¥é…ç½® `repository` å­—æ®µã€‚

æ·»åŠ ä¸¤ä¸ª `npm scripts`ï¼š

```json
{
  "prepub": "npm run test:prod && npm run build",
  "pub": "sh release.sh"
}
```

> + å½“è¿è¡Œ `npm run pub` çš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆæ‰§è¡Œ `prepub` è„šæœ¬ï¼Œåœ¨ `prepub` ä¸­è¿è¡Œäº† `test:prod` å’Œ `build` 2 ä¸ªè„šæœ¬ã€‚`&&` ç¬¦å·è¡¨ç¤ºå‰é¢ä¸€ä¸ªå‘½ä»¤æ‰§è¡ŒæˆåŠŸåæ‰ä¼šæ‰§è¡Œåé¢çš„ä»»åŠ¡ã€‚
> + `npm run test:prod` å®é™…ä¸Šè¿è¡Œäº† `npm run lint && npm run test -- --no-cache`ã€‚ å…ˆè¿è¡Œ `lint` å»æ ¡éªŒçš„æºç å’Œæµ‹è¯•æ–‡ä»¶æ˜¯å¦éµå¾ª `tslint` è§„èŒƒï¼Œå†è¿è¡Œ `test` å»è·‘æµ‹è¯•ã€‚
> + `npm run build` å®é™…ä¸Šè¿è¡Œäº† `tsc --module commonjs`ã€`rollup -c rollup.config.ts` å’Œ `typedoc --out docs --target es6 --theme minimal --mode file src`ã€‚å…ˆè¿è¡Œ `tsc` å»ç¼–è¯‘çš„ `TypeScript` æ–‡ä»¶ï¼Œ`dist/lib` å’Œ `dist/types` ä¸‹çš„æ–‡ä»¶å°±æ˜¯è¯¥å‘½ä»¤äº§ç”Ÿçš„ï¼Œç„¶åè¿è¡Œ `rollup` å»æ„å»º `axios.umd.js` åŠ `axios.es.js`ï¼Œæœ€åè¿è¡Œ `typedoc` å»æ„å»ºé¡¹ç›®çš„æ–‡æ¡£ã€‚
> + è¿è¡Œå®Œ `prepub` åå°±ä¼šå†è¿è¡Œ `pub` å‘½ä»¤ï¼Œå®é™…ä¸Šæ‰§è¡Œäº† `sh release.sh` å‘½ä»¤ã€‚



### ç¼–å†™éƒ¨ç½²è„šæœ¬

åˆ›å»ºæ–‡ä»¶ `release.sh`ï¼š

```shell
#!/usr/bin/env sh
set -e
echo "Enter release version: "
read VERSION
read -p "Releasing $VERSION - are you sure? (y/n)" -n 1 -r
echo  # (optional) move to a new line
if [[ $REPLY =~ ^[Yy]$ ]]
then
  echo "Releasing $VERSION ..."

  # commit
  git add -A
  git commit -m "[build] $VERSION"
  npm version $VERSION --message "[release] $VERSION"
  git push origin master

  # publish
  npm publish
fi
```

> + `#!/usr/bin/env sh` ç”¨æ¥è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ª shell è„šæœ¬ã€‚
>
> + `set -e` å‘Šè¯‰è„šæœ¬å¦‚æœæ‰§è¡Œç»“æœä¸ä¸º true åˆ™é€€å‡ºã€‚
>
> + `read VERSION` è¡¨ç¤ºä»æ ‡å‡†è¾“å…¥è¯»å–å€¼ï¼Œå¹¶èµ‹å€¼ç»™ `$VERSION` å˜é‡ã€‚
>
> + `read -p "Releasing $VERSION - are you sure? (y/n)" -n 1 -r`ï¼Œå…¶ä¸­ `read -p` è¡¨ç¤ºç»™å‡ºæç¤ºç¬¦ï¼Œåé¢æ¥ç€ `Releasing $VERSION - are you sure? (y/n)` æç¤ºç¬¦ï¼›`-n 1` è¡¨ç¤ºé™å®šæœ€å¤šå¯ä»¥æœ‰ 1 ä¸ªå­—ç¬¦å¯ä»¥ä½œä¸ºæœ‰æ•ˆè¯»å…¥ï¼›`-r` è¡¨ç¤ºç¦æ­¢åæ–œçº¿çš„è½¬ä¹‰åŠŸèƒ½ã€‚å› ä¸º `read` å¹¶æ²¡æœ‰æŒ‡å®šå˜é‡åï¼Œé‚£ä¹ˆé»˜è®¤è¿™ä¸ªè¾“å…¥è¯»å–å€¼ä¼šèµ‹å€¼ç»™ `$REPLY` å˜é‡ã€‚
>
> + `if [[ $REPLY =~ ^[Yy]$ ]]` è¡¨ç¤º shell è„šæœ¬ä¸­çš„æµç¨‹æ§åˆ¶è¯­å¥ï¼Œåˆ¤æ–­ `$REPLY` æ˜¯ä¸æ˜¯å¤§å°å†™çš„ `y`ï¼Œå¦‚æœæ»¡è¶³ï¼Œåˆ™èµ°åˆ°åé¢çš„ `then` é€»è¾‘ã€‚
>
> + `git add -A` è¡¨ç¤ºæŠŠä»£ç æ‰€æœ‰å˜åŒ–æäº¤åˆ°æš‚å­˜åŒºã€‚
>
>   `git commit -m "[build] $VERSION"` è¡¨ç¤ºæäº¤ä»£ç ï¼Œæäº¤æ³¨é‡Šæ˜¯ `[build] $VERSION`ã€‚
>
>   `npm version $VERSION --message "[release] $VERSION"` æ˜¯ä¿®æ”¹ `package.json` ä¸­çš„ `version` å­—æ®µåˆ° `$VERSION`ï¼Œå¹¶ä¸”æäº¤ä¸€æ¡ä¿®æ”¹è®°å½•ï¼Œæäº¤æ³¨é‡Šæ˜¯ `[release] $VERSION`ã€‚
>
>   `git push origin master` æ˜¯æŠŠä»£ç å‘å¸ƒåˆ°ä¸»å¹²åˆ†æ”¯ã€‚
>
>   `npm publish` æ˜¯æŠŠä»“åº“å‘å¸ƒåˆ° `npm` ä¸Šï¼Œæˆ‘ä»¬ä¼šæŠŠ `dist` ç›®å½•ä¸‹çš„ä»£ç éƒ½å‘å¸ƒåˆ° `npm` ä¸Šï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ `package.json` ä¸­é…ç½®çš„æ˜¯ `files` æ˜¯ `["dist"]`



