---
title:  ğŸŒ“ å®ç°åˆå¹¶é»˜è®¤é…ç½®
date: 2022-06-16 00:51:11
permalink: /pages/1e5c77/
categories:
  -  ğŸš¶ğŸ» å‰ç«¯å·©å›ºåŸºç¡€
  -  ğŸšŸ axios
  -  ğŸ’½ ä½¿ç”¨ TypeScript é‡æ„ axios åº“
tags:
  - 
---



## éœ€æ±‚åˆ†æ

åœ¨å‰é¢ï¼Œå‘é€è¯·æ±‚çš„æ—¶å€™å¯ä»¥ä¼ å…¥ä¸€ä¸ªé…ç½®ï¼Œå†³å®šè¯·æ±‚çš„ä¸åŒè¡Œä¸ºã€‚è¦ä½¿ å®ƒå¯ä»¥æœ‰é»˜è®¤é…ç½®ï¼Œå®šä¹‰ä¸€äº›é»˜è®¤çš„è¡Œä¸ºï¼Œè¿™æ ·åœ¨å‘é€æ¯ä¸ªè¯·æ±‚ï¼Œç”¨æˆ·ä¼ é€’çš„é…ç½®å¯ä»¥å’Œé»˜è®¤é…ç½®åšä¸€å±‚åˆå¹¶ã€‚

ä¸ `axios` åº“ç›¸åŒï¼Œåº”è¯¥ç»™æ¯ä¸€ä¸ª `aixos` å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¦‚ä¸‹çš„ `defaults` å±æ€§ï¼Œè¡¨ç¤ºé»˜è®¤é…ç½®ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥ä¿®æ”¹è¿™äº›é»˜è®¤é…ç½®ï¼š

```typescript
axios.defaults.headers.common['test'] = 123
axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded'
axios.defaults.timeout = 2000
```

> å…¶ä¸­ `headers` çš„é»˜è®¤é…ç½®æ”¯æŒ `common` å’Œä¸€äº›è¯·æ±‚æ–¹æ³• `method` çš„å­—æ®µï¼Œ `common` è¡¨ç¤ºå¯¹äºä»»ä½•ç±»å‹çš„è¯·æ±‚éƒ½è¦æ·»åŠ è¯¥å±æ€§ï¼Œ`method` è¡¨ç¤ºåªæœ‰è¯¥ç±»å‹çš„è¯·æ±‚æ–¹æ³•æ‰ä¼šæ·»åŠ å¯¹åº”çš„å±æ€§ã€‚



## é»˜è®¤é…ç½®

### å®šä¹‰é»˜è®¤é…ç½®

åˆ›å»ºæ–‡ä»¶ `src/defaults.ts`ï¼š

```typescript
import { AxiosRequestConfig } from './types'

const defaults: AxiosRequestConfig = {
  method: 'get',
  timeout: 0,
  headers: {
    common: {
      Accept: 'application/json, text/plain, */*'
    }
  }
}

const methodsNoData = ['delete', 'get', 'head', 'options']
methodsNoData.forEach(method => {
  defaults.headers[method] = {}
})

const methodsWithData = ['post', 'put', 'patch']
methodsWithData.forEach(method => {
  defaults.headers[method] = {
    'Content-Type': 'application/x-www-form-urlencoded'
  }
})

export default defaults
```

> å®šä¹‰äº† `defaults` å¸¸é‡ï¼ŒåŒ…å«é»˜è®¤è¯·æ±‚çš„æ–¹æ³•ã€è¶…æ—¶æ—¶é—´ã€ä»¥åŠ `headers` é…ç½®ã€‚åˆ†åˆ«æ ¹æ®è¯·æ±‚æ–¹æ³•æ˜¯å¦ä¼šæºå¸¦æ•°æ®ï¼Œå¯¹åº”çš„æƒ…å†µæ·»åŠ è¯·æ±‚å¤´çš„ `Content-Type`ã€‚



### æ·»åŠ åˆ° `axios` å¯¹è±¡ä¸­

ç»™ `axios` å¯¹è±¡æ·»åŠ  `defaults` å±æ€§ï¼Œè¡¨ç¤ºé»˜è®¤é…ç½®ï¼š

åœ¨ `src/core/Axios.ts` ä¸­ï¼š

```typescript
export default class Axios {
  defaults: AxiosRequestConfig
  interceptors: Interceptors


  constructor(initConfig: AxiosRequestConfig) {
    this.defaults = initConfig
    this.interceptors = {
      request: new InterceptorManager<AxiosRequestConfig>(),
      response: new InterceptorManager<AxiosResponse>()
    }
  }
  
  // ... 
}
```

> åœ¨ `Aixos` ç±»ä¸­æ·»åŠ ä¸€ä¸ª `defaults` æˆå‘˜å±æ€§ï¼Œå¹¶ä¸”è®© `Axios` çš„æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ª `initConfig` **åˆå§‹åŒ–é…ç½®å¯¹è±¡**ï¼ŒæŠŠ `initConfig` èµ‹å€¼ç»™ `this.defaults`ã€‚

ç„¶åä¿®æ”¹ `createInstance` çš„æ–¹æ³•ï¼Œæ”¯æŒä¼ å…¥ä¸€ä¸ª `config` é…ç½®å¯¹è±¡ã€‚

åœ¨ `src/axios.ts` ä¸­ï¼š

```typescript
import { AxiosInstance, AxiosRequestConfig } from './types'
import Axios from './core/Axios'
import { extend } from './helpers/util'
import defaults from './defaults'

function createInstance(config: AxiosRequestConfig): AxiosInstance {
  const context = new Axios(config)
  const instance = Axios.prototype.request.bind(context)

  extend(instance, context)

  return instance as AxiosInstance
}

const axios = createInstance(defaults)

export default axios
```

> è¿™æ ·åœ¨æ‰§è¡Œ `createInstance` åˆ›å»º `axios` å¯¹è±¡æ—¶ï¼Œå°±å¯ä»¥ä¼ å…¥ä¸€ä¸ªé»˜è®¤çš„é…ç½®äº†ã€‚



### é…ç½®åˆå¹¶åŠç­–ç•¥

å®šä¹‰äº†é»˜è®¤é…ç½®ä¹‹åï¼Œ**å‘é€æ¯ä¸ªè¯·æ±‚çš„æ—¶å€™éœ€è¦æŠŠè‡ªå®šä¹‰é…ç½®å’Œé»˜è®¤é…ç½®åšåˆå¹¶**ã€‚å¹¶ä¸æ˜¯ç®€å•çš„æŠŠä¸¤ä¸ªæ™®é€šå¯¹è±¡åˆå¹¶ï¼Œå¯¹äºä¸åŒå­—æ®µçš„åˆå¹¶ï¼Œä¼šæœ‰ä¸åŒçš„åˆå¹¶ç­–ç•¥ã€‚

ğŸŒ° ä¾‹å­ï¼š

```typescript
// é»˜è®¤é…ç½®
config1 = {
  method: 'get',
  timeout: 0,
  headers: {
    common: {
      Accept: 'application/json, text/plain, */*'
    }
  }
}

config2 = {
  url: '/config/post',
  method: 'post',
  data: {
    a: 1
  },
  headers: {
    test: '321'
  }
}

// åˆå¹¶å
merged = {
  url: '/config/post',
  method: 'post',
  data: {
    a: 1
  },
  timeout: 0,
  headers: {
    common: {
      Accept: 'application/json, text/plain, */*'
    }
    test: '321'
  }
}
```

> å¯¹äºæ–°çš„é…ç½®è¦è¦†ç›–æ‰é»˜è®¤çš„é…ç½®ï¼Œè€Œæ²¡æœ‰è®¾ç½®çš„é…ç½®ï¼ŒæŒ‰ç…§é»˜è®¤é…ç½®è¿›è¡Œé…ç½®ã€‚



### åˆå¹¶æ–¹æ³•

æ•´ä½“æ€è·¯ï¼Œå¯¹ `config1` å’Œ `config2` çš„å±æ€§éå†ï¼Œæ‰§è¡Œ `mereField` æ–¹æ³•åšåˆå¹¶ï¼Œè¿™é‡Œ `config1` ä»£è¡¨é»˜è®¤é…ç½®ï¼Œ`config2` ä»£è¡¨è‡ªå®šä¹‰é…ç½®ã€‚

éå†è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ `config2[key]` è¿™ç§ç¼©é˜´çš„æ–¹å¼è®¿é—®ï¼Œæ‰€ä»¥éœ€è¦ç»™ `AxiosRequestConfig` çš„æ¥å£å®šä¹‰**æ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²ç´¢å¼•ç­¾å**ï¼š

```typescript
export interface AxiosRequestConfig {
  // ...
  
  [propName: string]: any
}
```



### é»˜è®¤åˆå¹¶ç­–ç•¥

```typescript
function defaultStart(val1: any, val2: any):any {
  return typeof val2 !== 'undefined' ? val2 : val1
}
```

> å¦‚æœæœ‰ `val2` åˆ™è¿”å› `val2` ï¼Œå¦åˆ™è¿”å› `val1`ã€‚æ„å‘³ç€å¦‚æœå­˜åœ¨è‡ªå®šä¹‰é…ç½®å°±æ˜¯ç”¨è‡ªå®šä¹‰é…ç½®çš„å­—æ®µï¼Œå¦åˆ™å°±æ˜¯ç”¨é»˜è®¤é…ç½®ï¼›



### åªæ¥å—è‡ªå®šä¹‰é…ç½®åˆå¹¶ç­–ç•¥

å¯¹äºä¸€äº› å±æ€§ï¼š`url`ã€`prams`ã€`data`ï¼Œåˆå¹¶ç­–ç•¥å¦‚ä¸‹ï¼š

```typescript
function fromVal2Strat(val1: any, val2: any):any{
  if(typeof val2 !== 'undefined') {
    return val2
  }
}

const stratKeysFromVal2 = ['url', 'params', 'data']
stratKeysFromVal2.forEach(key => {
  strats[key] = fromVal2Strat
})
```

> å¯¹äºè¿™äº›å±æ€§ï¼Œé»˜è®¤é…ç½®æ˜¾ç„¶æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºå®ƒä»¬ä¸æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯å¼ºç›¸å…³çš„ï¼Œ**æ‰€ä»¥åªèƒ½ä»è‡ªå®šä¹‰é…ç½®ä¸­è·å–**ã€‚



### å¤æ‚å¯¹è±¡åˆå¹¶ç­–ç•¥

å¯¹äº `headers` è¿™ç±»çš„å¤æ‚å¯¹è±¡å±æ€§ï¼Œ**éœ€è¦ä½¿ç”¨æ·±æ‹·è´çš„æ–¹å¼**ï¼ŒåŒæ—¶ä¹Ÿå¤„ç†äº†å…¶å®ƒä¸€äº›æƒ…å†µï¼Œå› ä¸ºå®ƒä»¬ä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªéå¯¹è±¡çš„æ™®é€šå€¼ã€‚è¦ä½¿ç”¨è®¤è¯æˆæƒçš„æ—¶å€™ï¼Œ`auth` å±æ€§ä¹Ÿæ˜¯è¿™ä¸ªåˆå¹¶ç­–ç•¥ã€‚

å¯¹äºä¸€äº›å±æ€§ä¾‹å¦‚ `headers`ï¼Œåˆå¹¶ç­–ç•¥å¦‚ä¸‹ï¼š

```typescript
function deepMergeStrat(val1: any, val2: any):any {
  if(isPlainObject(val2)) {
    return deepMerge(val1, val2)
  } else if (typeof val2 !== 'undefined') {
    return val2
  } else if (isPlainObject(val1)) {
    return deepMerge(val1)
  } else if (typeof val1 !== 'undefined') {
    return val1
  }
}

const stratKeysDeepMerge = ['headers']
stratKeysDeepMerge.forEach(key => {
  strats[key] = deepMergeStrat
})
```



æœ€å `src/core/mergeConfig.ts` çš„å†…å®¹ä¸ºï¼š

```typescript
import { AxiosRequestConfig } from '../types'
import { deepMerge, isPlainObject } from '../helpers/util'

const strats = Object.create(null)
function defaultStrat(val1: any, val2: any):any {
  return typeof val2 !== 'undefined' ? val2 : val1
}

function fromVal2Strat(val1: any, val2: any):any{
  if(typeof val2 !== 'undefined') {
    return val2
  }
}

const stratKeysFromVal2 = ['url', 'params', 'data']
stratKeysFromVal2.forEach(key => {
  strats[key] = fromVal2Strat
})

function deepMergeStrat(val1: any, val2: any):any {
  if(isPlainObject(val2)) {
    return deepMerge(val1, val2)
  } else if (typeof val2 !== 'undefined') {
    return val2
  } else if (isPlainObject(val1)) {
    return deepMerge(val1)
  } else if (typeof val1 !== 'undefined') {
    return val1
  }
}

const stratKeysDeepMerge = ['headers']
stratKeysDeepMerge.forEach(key => {
  strats[key] = deepMergeStrat
})


export default function mergeConfig(
  config1: AxiosRequestConfig,
  config2?: AxiosRequestConfig
): AxiosRequestConfig {
  if(!config2) {
    config2 = {}
  }

  const config = Object.create(null)

  for(let key in config2) {
    if (!config[key]) {
      mergeField(key)
    }
  }

  function mergeField(key: string): void {
    const strat = strats[key] || defaultStrat
    config[key] = strat(config)
  }

  return config
}
```



æœ€ååœ¨ `request` æ–¹æ³•ä¸­æ·»åŠ åˆå¹¶é…ç½®çš„é€»è¾‘ã€‚

```typescript
config = mergeConfig(this.defaults, config)
```



### æ‰å¹³åŒ– `headers`

ç»è¿‡åˆå¹¶ä¹‹åçš„é…ç½®ä¸­ï¼Œ`headers` æ˜¯ä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼Œå¤šäº† `common`ã€`post`ã€`get` ç­‰å±æ€§ï¼Œè€Œè¿™äº›å±æ€§ä¸­çš„å€¼æœ€ç»ˆåº”è¯¥è¦çœŸæ­£æ·»åŠ åˆ°è¯·æ±‚çš„ `headers` ä¸­ï¼š

> ğŸŒ° ä¾‹å­ï¼š
>
> ```typescript
> headers: {
>   common: {
>     Accept: 'application/json, text/plain, */*'
>   },
>   post: {
>     'Content-Type':'application/x-www-form-urlencoded'
>   }
> }
> ```
>
> è¦ä½¿å®ƒå‹æˆä¸€çº§ï¼š
>
> ```typescript
> headers: {
>   Accept: 'application/json, text/plain, */*',
>  'Content-Type':'application/x-www-form-urlencoded'
> }
> ```

æ³¨æ„ï¼Œå¯¹äº `common` å®šä¹‰çš„ `header` å­—æ®µï¼Œéƒ½è¦æå–ï¼Œè€Œå¯¹äº `get`ã€`post` è¿™ç±»æå–ï¼Œéœ€è¦å’Œè¯¥æ¬¡è¯·æ±‚æ–¹æ³•å¯¹åº”ã€‚



åœ¨ `src/helpers/headers.ts` å®ç° `flatterHeaders` æ–¹æ³•ï¼š

```typescript
export function flatterHeaders(headers: any, method: Method): any {
  if (!headers) {
    return headers
  }
  headers = deepMerge(headers.common || {}, headers[method] || {}, headers)

  const methodsToDelete = ['delete', 'get', 'head', 'options', 'post', 'put', 'patch', 'common']
  methodsToDelete.forEach(method => {
    delete headers[method]
  })

  return headers
}
```

> é€šè¿‡ `deepMerge` æ–¹æ³•ï¼ŒæŠŠ `common`ã€`post` çš„å±æ€§æ‹·è´åˆ° `headers` è¿™ä¸€çº§ä¹‹åï¼Œå†æŠŠ `common`ã€`post` è¿™äº›å±æ€§åˆ æ‰ã€‚

åœ¨é˜µé˜µå‘é€è¯·æ±‚ä¹‹å‰æ‰§è¡Œè¿™ä¸ªé€»è¾‘ï¼š

`core/dispatchRequest.ts`ï¼š

```typescript
function processConfig(config: AxiosRequestConfig): void {
  config.url = transformURL(config)
  config.headers = transformRequestHeader(config)
  config.data = transformRequestData(config)
  config.headers = flattenHeaders(config.headers, config.method!)
}
```

> è¿™æ ·ç¡®ä¿äº†é…ç½®ä¸­çš„ `headers` æ˜¯å¯ä»¥æ­£ç¡®æ·»åŠ åˆ°è¯·æ±‚çš„ `header` å½“ä¸­çš„ã€‚



## ç¼–å†™æµ‹è¯• DEMO

`examples/config/app.ts`ï¼š

```typescript
import axios from '../../src'
import qs from 'qs'

axios.defaults.headers.common['test2'] = 123

axios({
  url: '/config/post',
  method: 'post',
  data: qs.stringify({
    a: 1
  }),
  headers: {
    test: '321'
  }
}).then(res => {
  console.log(res.data)
})
```

> åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé¢å¤–å¼•å…¥ `qs` åº“ï¼Œç”¨äºæŸ¥è¯¢å­—ç¬¦ä¸²è§£æå’Œå­—ç¬¦ä¸²åŒ–ã€‚æ¯”å¦‚ï¼Œå¯¹äº `{a: 1}` ç»è¿‡å­—ç¬¦ä¸²åŒ–å˜ä¸º `a=1`ã€‚
>
> ç”±äºï¼Œç»™é»˜è®¤å€¼æ·»åŠ äº† `post` ã€å’Œ `common` çš„ `headers`ï¼Œåœ¨è¯·æ±‚å‰åšé…ç½®åˆå¹¶ï¼Œäºæ˜¯è¯·æ±‚å°±æ·»åŠ äº† `Content-Type` å­—æ®µï¼Œå€¼ä¸º `application/x-www-form-urlencoded`ï¼›å¦å¤–æ·»åŠ äº† `test2` å­—æ®µï¼Œå€¼ä¸º `123`ã€‚
