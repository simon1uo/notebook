---
title:  ğŸŒ— å®ç°å–æ¶ˆåŠŸèƒ½
date: 2022-06-17 01:17:46
permalink: /pages/0a6e3d/
categories:
  -  ğŸš¶ğŸ» å‰ç«¯å·©å›ºåŸºç¡€
  -  ğŸšŸ axios
  -  ğŸ’½ ä½¿ç”¨ TypeScript é‡æ„ axios åº“
tags:
  - 
---
## éœ€æ±‚åˆ†æ

åœ¨æœ‰äº›åœºæ™¯ï¼Œå¸Œæœ›èƒ½ **ä¸»åŠ¨å–æ¶ˆè¯·æ±‚**ã€‚

> ä¾‹å¦‚å¸¸è§çš„æœç´¢æ¡†æ¡ˆä¾‹ï¼Œç”¨æˆ·åœ¨è¾“å…¥è¿‡ç¨‹ä¸­ï¼Œè¾“å…¥æ¡†çš„å†…å®¹ä¸æ–­å˜åŒ–ã€‚æ­£å¸¸æƒ…å†µæ¯æ¬¡å˜åŒ–éƒ½åº”è¯¥å‘æœåŠ¡å™¨å‘é€ä¸€æ¬¡è¯·æ±‚ã€‚ä½†æ˜¯å½“ç”¨æˆ·è¾“å…¥è¿‡å¿«çš„æ—¶å€™ï¼Œä¸å¸Œæœ›æ¯æ¬¡å˜åŒ–è¯·æ±‚éƒ½ä¼šå‘é€å‡ºå»ã€‚é€šå¸¸è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ **é˜²æŠ–** å»¶æ—¶å‘é€è¯·æ±‚ã€‚
>
> ä½†æ˜¯æœ‰ä¸€ç§æç«¯æƒ…å†µæ˜¯ï¼Œåæ®µæ¥å£å¾ˆæ…¢ï¼Œæ¯”å¦‚è¶…è¿‡ 1s æ‰ä¼šå“åº”ï¼Œè¿™ä¸ªæ—¶å€™åŠæ—¶åšäº† 200ms çš„é˜²æŠ–ï¼Œåœ¨æ…¢æ…¢è¾“å…¥ï¼ˆæ¯æ¬¡è¾“å…¥é—´éš”è¶…è¿‡ 200msï¼‰çš„æƒ…å†µä¸‹ï¼Œåœ¨å‰é¢çš„è¯·æ±‚æ²¡æœ‰å“åº”ä¹‹å‰ï¼Œä¹Ÿæœ‰å¯èƒ½å‘å‡ºå¤šä¸ªè¯·æ±‚ã€‚å› ä¸ºæ¥å£çš„å“åº”æ—¶é•¿ä¸å®šï¼Œå¦‚æœå…ˆå‘å‡ºå»çš„è¯·æ±‚å“åº”æ—¶é•¿æ¯”åå‘å‡ºå»çš„è¯·æ±‚è¦å°±ï¼Œé‚£ä¹ˆåè¯·æ±‚çš„å“åº”å…ˆå›æ¥ï¼Œå…ˆè¯·æ±‚çš„å“åº”åå›æ¥ï¼Œå°±ä¼šå‡ºç°å‰é¢è¯·æ±‚å“åº”ç»“æœè¦†ç›–åé¢è¯·æ±‚å“åº”ç»“æœçš„æƒ…å†µï¼Œé‚£ä¹ˆé€ æˆå“åº”ç»“æœæ··ä¹±ã€‚**åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œé™¤äº†åšé˜²æŠ–ï¼Œè¿˜å¸Œæœ›åé¢çš„è¯·æ±‚å‘é€æ—¶ï¼Œå¦‚æœå‰é¢çš„è¯·æ±‚è¿˜æ²¡æœ‰å“åº”ï¼Œ å¯ä»¥æŠŠå‰é¢çš„è¯·æ±‚å–æ¶ˆã€‚**

ä» `axios` çš„å–æ¶ˆæ¥å£è®¾è®¡å±‚é¢ï¼Œå¯ä»¥å®ç°å¦‚ä¸‹ï¼š

```typescript
const CancelToken = axios.CancelToken;
const source = CancelToken.source();

axios.get('/user/12345', {
  cancelToken: source.token
}).catch(function (e) {
  if (axios.isCancel(e)) {
    console.log('Request canceled', e.message);
  } else {
    // å¤„ç†é”™è¯¯
  }
});

// å–æ¶ˆè¯·æ±‚ (è¯·æ±‚åŸå› æ˜¯å¯é€‰çš„)
source.cancel('Operation canceled by the user.');
```

> ç»™ `axios` æ·»åŠ ä¸€ä¸ª `CancelToken` å¯¹è±¡ï¼Œå®ƒæœ‰ä¸€ä¸ª `source` æ–¹æ³•è¿”å›ä¸€ä¸ª `source` å¯¹è±¡ï¼Œ`source.token` æ˜¯æ¯ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™ä¼ ç»™é…ç½®å¯¹è±¡ä¸­çš„ `cancelToken` å±æ€§ï¼Œç„¶ååœ¨è¯·æ±‚ä¸­å‘å‡ºå»åï¼Œå¯ä»¥é€šè¿‡ `cancelToken` å–æ¶ˆè¯·æ±‚ã€‚



æˆ–è€…æ”¯æŒå¦ä¸€ç§æ–¹å¼çš„è°ƒç”¨ï¼š

```typescript
const CancelToken = axios.CancelToken;
let cancel;

axios.get('/user/12345', {
  cancelToken: new CancelToken(function executor(c) {
    cancel = c;
  })
});

cancel()
```

> `axios.CancelToken` æ˜¯ä¸€ä¸ªç±»ï¼Œç›´æ¥æŠŠå®ƒå®ä¾‹åŒ–çš„å¯¹è±¡ä¼ ç»™è¯·æ±‚é…ç½®ä¸­çš„ `cancelToken` å±æ€§ï¼Œ`CancelToken` çš„æ„é€ å‡½æ•°å‚æ•°æ”¯æŒä¼ å…¥ä¸€ä¸ª `executor` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªå–æ¶ˆå‡½æ•° `c`ï¼Œå¯ä»¥åœ¨ `executor` æ–¹æ³•æ‰§è¡Œçš„å†…éƒ¨æ‹¿åˆ°è¿™ä¸ªå–æ¶ˆå‡½æ•° `c`ï¼Œèµ‹å€¼ç»™æˆ‘ä»¬å¤–éƒ¨å®šä¹‰çš„ `cancel` å˜é‡ï¼Œä¹‹åå¯ä»¥é€šè¿‡è°ƒç”¨è¿™ä¸ª `cancel` æ–¹æ³•æ¥å–æ¶ˆè¯·æ±‚ã€‚



## å¼‚æ­¥åˆ†ç¦»çš„è®¾è®¡æ–¹æ¡ˆ

é€šè¿‡éœ€æ±‚åˆ†æï¼Œå¦‚æœæƒ³è¦å®ç°å–æ¶ˆæŸæ¬¡è¯·æ±‚ï¼Œéœ€è¦ä¸ºè¯¥è¯·æ±‚é…ç½®ä¸€ä¸ª `CancelToken`ï¼Œç„¶ååœ¨å¤–éƒ¨è°ƒç”¨ä¸€ä¸ª `cancel` æ–¹æ³•ã€‚

è¯·æ±‚çš„å‘é€æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ `xhr.send` æ–¹æ³•ï¼Œ `xhr` å¯¹è±¡æä¾›äº† `abort` æ–¹æ³•ï¼Œå¯ä»¥æŠŠè¯·æ±‚å–æ¶ˆã€‚ä½†æ˜¯åœ¨å¤–éƒ¨ç¢°ä¸åˆ° `xhr` å¯¹è±¡ï¼Œè¦æƒ³æ‰§è¡Œ  `cancel` çš„æ—¶å€™ï¼Œå»æ‰§è¡Œ `xhr.abort` æ–¹æ³•ã€‚

ç›¸å½“äºåœ¨ `xhr` å¼‚æ­¥è¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œæ’å…¥ä¸€æ®µä»£ç ï¼Œå½“åœ¨å¤–éƒ¨æ‰§è¡Œ `cancel` çš„å‡½æ•°çš„æ—¶å€™ï¼Œå›å»æ‡‚è¿™æ®µä»£ç çš„æ‰§è¡Œï¼Œç„¶åæ‰§è¡Œ `xhr.abort` æ–¹æ³•å–æ¶ˆè¯·æ±‚ã€‚

åˆ©ç”¨ **Promise** å®ç°å¼‚æ­¥åˆ†ç¦»ã€‚ä¹Ÿå°±æ˜¯åœ¨ `cancelToken` ä¸­ä¿å­˜ä¸€ä¸ª `pending` çŠ¶æ€çš„ Promise å¯¹è±¡ï¼Œç„¶åå½“æ‰§è¡Œ `cancel` æ–¹æ³•æ—¶ï¼Œèƒ½å¤Ÿè®¿é—®æ­é…è¿™ä¸ª Promise å¯¹è±¡ï¼ŒæŠŠå®ƒä» `pending` çŠ¶æ€å˜æˆ `resolved` çŠ¶æ€ã€‚è¿™æ ·å°±å¯ä»¥åœ¨ `then` ä¸­å®ç°å–æ¶ˆè¯·æ±‚çš„é€»è¾‘ã€‚

> ç±»ä¼¼å¦‚ä¸‹ï¼š
>
> ```typescript
> if (cancelToken) {
>   cancelToken.promise
>   	.then(reason => {
>     	request.abort()
>     	reject(reason)
>   	})
> }
> ```



## `CancelToken` ç±»çš„å®ç°



### æ¥å£å®šä¹‰

`src/types/index.ts`ï¼š

```typescript
export interface AxiosRequestConfig {
	// ...
  cancelToken?: CancelToken
}
```

```typescript
export interface CancelToken {
  promise: Promise<string>
  reason?: string
}

export interface Canceler {
  (message?: string): void
}

export interface CancelExecutor {
  (cancel: Canceler): void
}
```

> `CancelToken` æ˜¯å®ä¾‹ç±»å‹çš„æ¥å£å®šä¹‰ï¼Œ`Canceler` æ˜¯å–æ¶ˆæ–¹æ³•çš„æ¥å£å®šä¹‰ï¼Œ`CancelExecutor` æ˜¯ `CancelToken` ç±»æ„é€ å‡½æ•°å‚æ•°çš„æ¥å£å®šä¹‰ã€‚



### ä»£ç å®ç°

åˆ›å»ºå•ç‹¬çš„ç›®å½•ç®¡ç† `cancel` ç›¸å…³çš„ä»£ç ã€‚

åˆ›å»ºæ–‡ä»¶ `cancel/CancelToken.ts` ï¼š

```typescript
import { CancelExecutor } from '../types'

interface ResolvePromise {
  (reason?: string): void
}

export default class CancelToken {
  promise: Promise<string>
  reason?: string

  constructor(executor: CancelExecutor) {
    let resolvePromise: ResolvePromise
    this.promise = new Promise<string>(resolve => {
      resolvePromise = resolve
    })

    executor(message => {
      if (this.reason) return

      this.reason = message
      resolvePromise(this.reason)
    })
  }
}
```

> åœ¨ `CancelToken` æ„é€ å‡½æ•°å†…éƒ¨ï¼Œå®ä¾‹åŒ–ä¸€ä¸ª `pending` çŠ¶æ€çš„ Promise å¯¹è±¡ï¼Œç„¶åç”¨ä¸€ä¸ª `resolvePromise` å˜é‡æŒ‡å‘ `resolve` å‡½æ•°ï¼Œæ¥ç€æ‰§è¡Œ `executor` å‡½æ•°ï¼Œä¼ å…¥ä¸€ä¸ª `cancel` å‡½æ•°ï¼Œåœ¨ `cancel` å‡½æ•°å†…éƒ¨ï¼Œè°ƒç”¨ `resolvePromise` æŠŠ Promise å¯¹è±¡ ä» `pending` å˜ä¸º `resolved`  çŠ¶æ€ã€‚



æ¥ç€åœ¨ `src/core/xhr.ts` ä¸­æ·»åŠ å–æ¶ˆè¯·æ±‚çš„é€»è¾‘ï¼š

```typescript
const { data = null, url, method = 'get', headers, responseType, timeout, cancelToken} = config
```

> åŠ å…¥ä» `config` ä¸­è·å– `cancelToken`ã€‚

```typescript
if (cancelToken) {
  cancelToken.promise.then(reason =>  {
    request.abort()
    reject(reason)
  })
}
```



## `CancelToken` æ‹“å±•é™æ€æ¥å£

### æ¥å£å®šä¹‰

åœ¨ `src/types/index.ts` ä¸­ï¼š

```typescript
export interface CancelTokenSource {
  token: CancelToken
  cancel: Canceler
}

export interface CancelTokenStatic{
  new(executor: CancelExecutor): CancelToken
  
  source(): CancelTokenSource
}
```

> å…¶ä¸­ `CancelTokenSource` ä½œä¸º `CancelToken` ç±»é™æ€æ–¹æ³• `source` å‡½æ•°çš„è¿”å›å€¼ç±»å‹ï¼Œ`CancelTokenStatic` ä½œä¸º `CancelToken` ç±»çš„ç±»ç±»å‹ã€‚



### ä»£ç å®ç°

åœ¨ `src/cancel/CancelToken.ts` ä¸­ï¼š

```typescript
export default class CancelToken {
  // ...
  static source(): CancelTokenSource {
    let cancel!: Canceler
    const token = new CancelToken(c => {
      cancel = c
    })
    return {
      cancel,
      token
    }
  }
}
```

> åœ¨ç±»ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª `source` é™æ€æ–¹æ³•ï¼Œå®šä¹‰ä¸€ä¸ª `cancel` å˜é‡å®ä¾‹åŒ–ä¸€ä¸ª `CancelToken` ç±»å‹çš„å¯¹è±¡ï¼Œç„¶ååœ¨ `executor` å‡½æ•°ä¸­ï¼ŒæŠŠ `cancel` æŒ‡å‘å‚æ•° `c` è¿™ä¸ªå–æ¶ˆå‡½æ•°ã€‚
>
> è¿™æ ·æ»¡è¶³äº†éœ€æ±‚åˆ†æä¸­ç¬¬ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œä½†æ˜¯ç¬¬ä¸€ç§ä½¿ç”¨æ–¹å¼çš„ä¾‹å­ä¸­ï¼Œåœ¨æ•è·è¯·æ±‚çš„æ—¶å€™ï¼Œé€šè¿‡ `axios.isCancel` æ¥åˆ¤æ–­é”™è¯¯å‚æ•° `e` æ˜¯ä¸æ˜¯ä¸€æ¬¡å–æ¶ˆè¯·æ±‚å¯¼è‡´çš„é”™è¯¯ã€‚è¦å¯¹å–æ¶ˆé”™è¯¯çš„åŸå› åšä¸€å±‚åŒ…è£…ï¼Œå¹¶ä¸”ç»™ `axios` æ‹“å±•é™æ€æ–¹æ³•ã€‚



## `Cancel` ç±»çš„å®ç°ä»¥åŠ `axios` çš„æ‹“å±•

### æ¥å£å®šä¹‰

```typescript
export interface Cancel {
  message?: string
}

export interface CancelStatic {
  new(message?: string): Cancel
}
```

```typescript
export interface AxiosStatic extends AxiosInstance {
  create(config?: AxiosRequestConfig): AxiosInstance
  
  CancelToken: CancelTokenStatic
  Cancel: CancelStatic
  isCancel: (value: any) => boolean
}
```

> å…¶ä¸­ `Cancel` æ˜¯å®ä¾‹ç±»å‹çš„æ¥å£å®šä¹‰ï¼›`CancelStatic` æ˜¯ç±»ç±»å‹çš„æ¥å£å®šä¹‰ï¼Œå¹¶ä¸”è¦ç»™ `axios` æ‹“å±•äº†å¤šä¸ªé™æ€æ–¹æ³•ã€‚



### ä»£ç å®ç°

åˆ›å»º `src/cancel/Cancel.ts` æ–‡ä»¶ï¼š

```typescript
export default class Cancel {
  message?: string

  constructor(message: string) {
    this.message = message
  }
}

export function isCancel(value: any): boolean {
  return value instanceof Cancel
}
```

> `Cancel` ç±»æ‹¥æœ‰ä¸€ä¸ª `message` å…¬å…±å±æ€§ã€‚`isCancel` æ–¹æ³•é€šè¿‡ `insanceof` æ¥åˆ¤æ–­ä¼ å…¥çš„å€¼æ˜¯ä¸æ˜¯ä¸€ä¸ª `Cancel` å¯¹è±¡ã€‚



ç„¶åå¯¹ `CancelToken` ç±»ä¸­çš„ `reason` ç±»å‹åšä¿®æ”¹ï¼ŒæŠŠå®ƒå˜æˆä¸€ä¸ª `Cancel` ç±»å‹çš„å®ä¾‹ã€‚

ä¿®æ”¹å®šä¹‰ï¼š`src/types/index.ts`ï¼š

```typescript
export interface CancelToken {
  promise: Promise<Cancel>
  reason?: Cancel
}
```



ç„¶åä¿®æ”¹å®ç°éƒ¨åˆ†ï¼Œ `src/cancel/CancelToken.ts`ï¼š

```typescript
interface ResolvePromise {
  (reason?: Cancel): void
}
```

```typescript
export default class CancelToken {
  promise: Promise<Cancel>
  reason?: Cancel

  constructor(executor: CancelExecutor) {
    let resolvePromise: ResolvePromise
    this.promise = new Promise<Cancel>(resolve => {
      resolvePromise = resolve
    })

    executor(message => {
      if (this.reason) return

      this.reason = new Cancel(message)
      resolvePromise(this.reason)
    })
  }
  
  // ...
}
```



ç„¶åç»™ `aixos` æ‹“å±•é™æ€æ–¹æ³•ï¼Œæä¾›ç”¨æˆ·ä½¿ç”¨ï¼š

`src/axios`ï¼š

```typescript
import CancelToken from './cancel/CancelToken'
import Cancel, { isCancel } from './cancel/Cancel'

axios.CancelToken = CancelToken
axios.Cancel = Cancel
axios.isCancel = isCancel
```



## é¢å¤–é€»è¾‘å®ç°

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦å®ç°ä¸€äº›é¢å¤–é€»è¾‘ï¼Œæ¯”å¦‚å½“ä¸€ä¸ªè¯·æ±‚æºå¸¦çš„ `cancelToken` å·²ç»è¢«ä½¿ç”¨è¿‡ï¼Œé‚£ä¹ˆç”šè‡³éƒ½å¯ä»¥ä¸å‘é€è¿™ä¸ªè¯·æ±‚ï¼Œç›´æ¥è·‘å‡ºä¸€ä¸ªå¼‚å¸¸å³å¯ï¼Œå¹¶ä¸”æŠ›å¼‚å¸¸çš„ä¿¡æ¯å°±æ˜¯å–æ¶ˆçš„åŸå› ï¼Œæ‰€ä»¥éœ€è¦ç»™ `CancelToken` æ‹“å±•ä¸€ä¸ªæ–¹æ³•ã€‚

é¦–å…ˆä¿®æ”¹å®šä¹‰éƒ¨åˆ†ã€‚

`src/types/index.ts` ï¼š

```typescript
export interface CancelToken {
  promise: Promise<Cancel>
  reason?: Cancel

  throwIfRequested(): void
}
```



ç„¶åå®ç°è¿™ä¸ªæ–¹æ³•ï¼š

`src/cancel/CancelToken.ts`ï¼š

```typescript
export default class CancelToken {
  // ... 

  throwIfRequested():void {
    if(this.reason) throw this.reason
  }
  
  // ...
}
```

> åˆ¤æ–­å¦‚æœå­˜åœ¨ `this.reason`ï¼Œè¯´æ˜è¿™ä¸ª `token` å·²ç»è¢«ä½¿ç”¨è¿‡äº†ï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯å³å¯ã€‚

æ¥ä¸‹æ¥åœ¨å‘é€è¯·æ±‚ä¹‹å‰å¢åŠ ä¸€æ®µé€»è¾‘ï¼š

`src/core/dispatchRequest.ts`ï¼š

```typescript
export default function dispatchRequest(config: AxiosRequestConfig): AxiosPromise {
  throwIfCancellationRequested(config)
  processConfig(config)

  // ...
}

function throwIfCancellationRequested(config: AxiosRequestConfig): void {
  if (config.cancelToken) {
    config.cancelToken.throwIfRequested()
  }
}
```

> å‘é€è¯·æ±‚ä¹‹å‰ï¼Œéœ€è¦æ£€æŸ¥ä¸€ä¸‹é…ç½®çš„ `cancelToken` æ˜¯å¦è¢«ä½¿ç”¨è¿‡äº†ï¼Œå¦‚æœè¢«ä½¿ç”¨è¿‡å°±ä¸ç”¨å‘é€è¯·æ±‚ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸å³å¯ã€‚



## ç¼–å†™æµ‹è¯• DEMO

`examples/server.js` æ·»åŠ  `router`ï¼š

```js
router.get('/cancel/get',function(req,res){
  setTimeout(()=>{
    res.json('hello')
  },1000)
})

router.post('/cancel/post',function(req,res){
  setTimeout(()=>{
    res.json(req.body)
  },1000)
})
```



`app.ts`ï¼š

```typescript
import axios, { Canceler } from '../../src'

const CancelToken = axios.CancelToken
const source = CancelToken.source()

axios.get('/cancel/get', {
  cancelToken: source.token
}).catch(function(e) {
  if (axios.isCancel(e)) {
    console.log('Request canceled', e.message)
  }
})


setTimeout(() => {
  source.cancel('Operation canceled by the user.')

  axios.post('/cancel/post', { a: 1 }, { cancelToken: source.token }).catch(function(e) {
    if (axios.isCancel(e)) {
      console.log(e.message)
    }
  })
}, 100)


let cancel: Canceler

axios.get('/cancel/get', {
  cancelToken: new CancelToken(c => {
    cancel = c
  })
}).catch(function(e) {
  if (axios.isCancel(e)) {
    console.log('Request canceled')
  }
})

setTimeout(() => {
  cancel()
}, 200)
```