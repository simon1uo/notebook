<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>☘️ Spring 声明式事务 | notebook</title>
        <meta name="generator" content="VuePress 1.9.7" />
        <link rel="icon" href="/notebook/favicon.ico">
    <link rel="stylesheet" href="/notebook//at.alicdn.com/t/font_3114978_qe0b39no76.css"> <meta name="description" content="a frontend notebook by Simon">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="个人学习笔记,前端学习笔记,前端学习,前端学习资源,前端学习路线,HTML,CSS,JavaScript,Vue,React">
    <meta name="theme-color" content="#204A7A">  <link rel="preload" href="/notebook/assets/css/0.styles.e8c79dc0.css" as="style"><link rel="preload" href="/notebook/assets/js/app.6a815fb9.js" as="script"><link rel="preload" href="/notebook/assets/js/2.ddc7fe92.js" as="script"><link rel="preload" href="/notebook/assets/js/3.cf638cd2.js" as="script"><link rel="preload" href="/notebook/assets/js/252.b959a851.js" as="script"> <link rel="stylesheet" href="/notebook/assets/css/0.styles.e8c79dc0.css">
    </head>
    <body class="theme-mode-light">
        <div id="app" data-server-rendered="true"><div class="theme-container have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notebook/" class="home-link router-link-active"><img src="/notebook/assets/img/logo.png" alt="notebook" class="logo"> <span class="site-name">&lt;notebook/&gt;</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notebook/" class="nav-link">🌏 首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="☕️ 前端笔记" class="dropdown-title"><a href="/notebook/front-end/" class="link-title">☕️ 前端笔记</a> <span class="title" style="display:none;">☕️ 前端笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/front-end/roadmap/" class="nav-link">🗺 前端学习路线</a></li><li class="dropdown-item"><h4>分类</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/front-end/beginning/" class="nav-link">🚶 前端入门基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/stable/" class="nav-link">🚶🏻 前端巩固基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/core-frame/" class="nav-link">🏃 前端核心框架</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🔖 关于" class="dropdown-title"><a href="/notebook/about/" class="link-title">🔖 关于</a> <span class="title" style="display:none;">🔖 关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>🚏索引</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/archives/" class="nav-link">🗄归档</a></li><li class="dropdown-subitem"><a href="/notebook/tags/" class="nav-link">🔖标签</a></li></ul></li></ul></div></div> <a href="https://github.com/simon1uo/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
        🍞 GitHub
        <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/notebook/" class="nav-link">🌏 首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="☕️ 前端笔记" class="dropdown-title"><a href="/notebook/front-end/" class="link-title">☕️ 前端笔记</a> <span class="title" style="display:none;">☕️ 前端笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/front-end/roadmap/" class="nav-link">🗺 前端学习路线</a></li><li class="dropdown-item"><h4>分类</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/front-end/beginning/" class="nav-link">🚶 前端入门基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/stable/" class="nav-link">🚶🏻 前端巩固基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/core-frame/" class="nav-link">🏃 前端核心框架</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🔖 关于" class="dropdown-title"><a href="/notebook/about/" class="link-title">🔖 关于</a> <span class="title" style="display:none;">🔖 关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>🚏索引</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/archives/" class="nav-link">🗄归档</a></li><li class="dropdown-subitem"><a href="/notebook/tags/" class="nav-link">🔖标签</a></li></ul></li></ul></div></div> <a href="https://github.com/simon1uo/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
        🍞 GitHub
        <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 🔑 数据库基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span> 🧋 Java SSM 相关</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span> 🗺 MyBatis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span> 🍃 Spring</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook/pages/2f4396/" class="sidebar-link">🪴 Spring 基础</a></li><li><a href="/notebook/pages/a8acd2/" class="sidebar-link">🌵 Spring IoC</a></li><li><a href="/notebook/pages/dad650/" class="sidebar-link">🌿 Spring AOP</a></li><li><a href="/notebook/pages/328e92/" class="sidebar-link">🎋 Spring 数据库编程</a></li><li><a href="/notebook/pages/9f2a81/" aria-current="page" class="active sidebar-link">☘️ Spring 声明式事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/notebook/pages/9f2a81/#事务" class="sidebar-link">事务</a></li><li class="sidebar-sub-header level2"><a href="/notebook/pages/9f2a81/#事务操作" class="sidebar-link">事务操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/notebook/pages/9f2a81/#准备事务操作" class="sidebar-link">准备事务操作</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/9f2a81/#引入事务场景" class="sidebar-link">引入事务场景</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/9f2a81/#事务基本操作" class="sidebar-link">事务基本操作</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/notebook/pages/9f2a81/#声明式事务" class="sidebar-link">声明式事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/notebook/pages/9f2a81/#spring-事务管理" class="sidebar-link">Spring 事务管理</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/9f2a81/#spring-事务管理-api" class="sidebar-link">Spring 事务管理 API</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/9f2a81/#注解实现声明式事务管理" class="sidebar-link">注解实现声明式事务管理</a></li><li class="sidebar-sub-header level4"><a href="/notebook/pages/9f2a81/#传播行为" class="sidebar-link">传播行为</a></li><li class="sidebar-sub-header level4"><a href="/notebook/pages/9f2a81/#隔离级别" class="sidebar-link">隔离级别</a></li><li class="sidebar-sub-header level4"><a href="/notebook/pages/9f2a81/#其他参数" class="sidebar-link">其他参数</a></li><li class="sidebar-sub-header level4"><a href="/notebook/pages/9f2a81/#完全注解开发" class="sidebar-link">完全注解开发</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/9f2a81/#使用-xml-配置实现声明式事务管理" class="sidebar-link">使用 XML 配置实现声明式事务管理</a></li></ul></li></ul></li><li><a href="/notebook/pages/30b6df/" class="sidebar-link">🪵 Spring JdbcTemplate</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span> 🚏SpringMVC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span> 🤖 SpringBoot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span> 💡 Java 补充</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-16f6d530><div class="articleInfo" data-v-16f6d530><ul class="breadcrumbs" data-v-16f6d530><li data-v-16f6d530><a href="/notebook/" title="首页" class="iconfont icon-home router-link-active" data-v-16f6d530></a></li> <li data-v-16f6d530><a href="/notebook/categories/?category=%20%F0%9F%A7%B0%20%E5%85%B6%E4%BB%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0" title="分类" data-v-16f6d530> 🧰 其他学习笔记</a></li><li data-v-16f6d530><a href="/notebook/categories/?category=%20%F0%9F%A7%8B%20Java%20SSM%20%E7%9B%B8%E5%85%B3" title="分类" data-v-16f6d530> 🧋 Java SSM 相关</a></li><li data-v-16f6d530><a href="/notebook/categories/?category=%20%F0%9F%8D%83%20Spring" title="分类" data-v-16f6d530> 🍃 Spring</a></li></ul> <div class="info" data-v-16f6d530><div title="作者" class="author iconfont icon-touxiang" data-v-16f6d530><a href="https://github.com/simon1uo" target="_blank" title="作者" class="beLink" data-v-16f6d530>Simon</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-16f6d530><a href="javascript:;" data-v-16f6d530>2022-03-30</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><!---->☘️ Spring 声明式事务<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h2> <ul><li>事务是数据库操作的<strong>最基本单元</strong>，逻辑上是一组操作，要么都成功，如果有一个失败所有操作都失败。</li> <li>典型场景：银行转帐（只要有出错，交易都会中断）。</li></ul> <blockquote><p>🔗 <strong>事务的特性</strong>：</p> <ul><li><p>原子性（<strong>A</strong>tomicity）：一个事务中的所有操作，要么都成功，要么都失败，整个过程不可分割。</p></li> <li><p>一致性（<strong>C</strong>onsistency）：事务操作之前和操作之后，总量保持不变。</p></li> <li><p>隔离性（<strong>I</strong>solation）：多事务操作时，相互之间不会产生影响。</p></li> <li><p>持久性（<strong>D</strong>urability）：事务最终提交后，数据库表中数据才会真正发生变化。</p></li></ul></blockquote> <h2 id="事务操作"><a href="#事务操作" class="header-anchor">#</a> 事务操作</h2> <p>可以按照 JavaEE 的典型三层结构实现，目前首先关注  <code>Service</code>  业务操作层和  <code>DAO</code>  数据库操作层。</p> <h3 id="准备事务操作"><a href="#准备事务操作" class="header-anchor">#</a> 准备事务操作</h3> <ul><li><p>主要步骤：</p> <ul><li>创建数据库表  <code>t_account</code>  ，添加几条交易记录。</li> <li>创建对应的  <code>Service</code>  和  <code>DAO</code>  类，完成对象创建和关系注入。</li> <li>在  <code>Service</code>  和  <code>DAO</code>  中编写相应的代码完成功能逻辑部分。</li></ul></li> <li><p>创建数据库表  <code>t_account</code>  ，添加几条交易记录。</p></li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> t_account
<span class="token punctuation">(</span>
    id       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    username <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    amount   <span class="token keyword">int</span>         <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">constraint</span> transfer_record_pk
        <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_account <span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'Lucy'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_account <span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'Mary'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>Spring 与 Mybatis 的整合使用在上一节已经详细记录步骤，在此不再赘述。</p></blockquote> <ul><li>创建  <code>TransferRecordDAO</code>  抽象类。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransferDAO</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM t_account&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE t_account set amount=amount-#{amount} where username=#{username}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">void</span> <span class="token function">transferOut</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> amount<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">&quot;update t_account set amount=amount+#{amount} where username=#{username}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">void</span> <span class="token function">transferIn</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> amount<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>创建  <code>TransferRecordService</code>  类，并完成  <code>TransferRecordDAO</code>  的注入，调用  <code>TransferRecordDAO</code>  的方法：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransferRecordService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TransferRecordDAO</span> transferRecordDAO<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getAllAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span> accounts <span class="token operator">=</span> transferDAO<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Account</span> account <span class="token operator">:</span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transferAccounts</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">,</span> <span class="token class-name">String</span> fromUser<span class="token punctuation">,</span> <span class="token class-name">String</span> toUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;transfer start ... &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transferDAO<span class="token punctuation">.</span><span class="token function">transferOut</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> fromUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transferDAO<span class="token punctuation">.</span><span class="token function">transferIn</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> toUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;transfer end ... &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>编写测试方法：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTransferAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">SpringConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TransferService</span> transferService <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;transferService&quot;</span><span class="token punctuation">,</span> <span class="token class-name">TransferService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transferService<span class="token punctuation">.</span><span class="token function">getAllAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transferService<span class="token punctuation">.</span><span class="token function">transferAccounts</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">&quot;Lucy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transferService<span class="token punctuation">.</span><span class="token function">getAllAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>以上无异常情况下， 可以完成一次交易。</p></blockquote> <h3 id="引入事务场景"><a href="#引入事务场景" class="header-anchor">#</a> 引入事务场景</h3> <p>当转账中途发生异常情况（例如，网络异常），尝试模拟异常情况：</p> <ul><li>修改  <code>TransferRecordService</code>  中的方法：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transferAccounts</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">,</span> <span class="token class-name">String</span> fromUser<span class="token punctuation">,</span> <span class="token class-name">String</span> toUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    transferRecordDAO<span class="token punctuation">.</span><span class="token function">transferOut</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> fromUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    transferRecordDAO<span class="token punctuation">.</span><span class="token function">transferIn</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> toUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>（在测试数据复原）运行测试方法，抛出无法完成操作的异常：</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>java.lang.ArithmeticException: / by zero

	at com.simon.service.TransferRecordService.transferAccounts(TransferRecordService.java:13)
	at com.simon.service.TransferRecordTest.testTransferAccounts(TransferRecordTest.java:14)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>此时出现致命性的问题，回看数据库的数据，发现转出账方被转出金额，而收账方却没有收到相应的金额。此时，事务的作用就在这里体现出来了。</strong></p> <h3 id="事务基本操作"><a href="#事务基本操作" class="header-anchor">#</a> 事务基本操作</h3> <ol><li>开启一个事务</li> <li>进行业务逻辑实现</li> <li>没有异常，则<strong>提交事务</strong></li> <li>发生异常，则<strong>回滚事务</strong></li></ol> <p>🌰 将前述转账例子  <code>TransferRecordService</code>  中的方法引入事务的基本框架：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// Step1、开启一个事务</span>
    <span class="token comment">// Step2、进行业务逻辑实现</span>
    transferRecordDao<span class="token punctuation">.</span><span class="token function">transferOut</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> fromUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//模拟网络异常而导致操作中断</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    transferRecordDao<span class="token punctuation">.</span><span class="token function">transferIn</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> toUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Step3、没有异常，则提交事务</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Step4、发生异常，则回滚事务</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="声明式事务"><a href="#声明式事务" class="header-anchor">#</a> 声明式事务</h2> <h3 id="spring-事务管理"><a href="#spring-事务管理" class="header-anchor">#</a> Spring 事务管理</h3> <p>在 Spring 中进行事务管理有两种方式：</p> <ul><li>编程式事务管理：在前述的事务基本操作实现就是典型的编程式事务管理。这种方式虽然并不好，但是可以了解这个事务的操作过程，一般由于不方便、导致代码的臃肿、维护起来麻烦而不使用这种方式。</li> <li><strong>声明式事务管理</strong>（推荐使用）：底层原理就是 <a href="/notebook/pages/dad650/">Spring AOP</a> ，在不改变原来的代码逻辑的基础上，拓展代码的功能。有两种实现方式：
<ul><li><strong>基于注解方式实现</strong>（推荐使用）</li> <li>基于 XML 配置文件实现</li></ul></li></ul> <h3 id="spring-事务管理-api"><a href="#spring-事务管理-api" class="header-anchor">#</a> Spring 事务管理 API</h3> <p>Spring 提供了一个接口代表事务管理器，针对不同的 JDBC 框架存在不同的实现类：</p> <ul><li><p><code>PlatformTransactionManager</code>  接口：即事务管理器，有多个不同的抽象类和具体实现类，可满足不同的框架。</p></li> <li><p><code>DataSourceTrasactionManager</code>  实现类： <code>JdbcTemplate</code>  和  <code>MyBatis</code>  框架使用到它。</p></li> <li><p><code>HibernateTransactionManager</code>  实现类： <code>Hibernate</code>  框架使用到它。</p></li></ul> <h3 id="注解实现声明式事务管理"><a href="#注解实现声明式事务管理" class="header-anchor">#</a> 注解实现声明式事务管理</h3> <ul><li>在 Spring 配置文件中配置事务管理器  <code>DataSourceTransactionManager</code>  的对象创建。</li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--配置事务管理器--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transactionManager<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.springframework.jdbc.datasource.DataSourceTransactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p><code>property</code>  设置的属性为目前使用的  <code>dataSource</code>  对象。</p></blockquote> <ul><li>在 Spring 配置文件中开启事务（注解方式）：
<ul><li>引入  <code>xmlns:tx</code>  的名称空间</li> <li>配置  <code>&lt;tx:annotation-driven&gt;</code>  标签开启事务注解驱动</li></ul></li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--开启事务注解--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>annotation-driven</span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p><code>transaction-manager</code>  属性配置当前的事务管理器。</p></blockquote> <p>（此处实现注解实现声明式事务管理依旧需要依靠 Spring 配置文件开启事务注解，要实现完整注解开发请看后处介绍。）</p> <p>🌰 延续前述的例子，在  <code>TransferRecordService</code>  中添加事务注解  <code>@Transactional</code> ：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransferRecordService</span> <span class="token punctuation">{</span>
	<span class="token comment">// ... </span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p>注解  <code>@Transactional</code>  中配置事务相关的参数：</p> <ul><li><p><code>propagation</code> ：事务传播行为</p></li> <li><p><code>isolation</code> ：事务隔离级别</p></li> <li><p><code>timeout</code> ：超时时间</p></li> <li><p><code>readOnly</code> ：是否只读</p></li> <li><p><code>rollbackFor</code> ：回滚</p></li> <li><p><code>noRollbackFor</code> ：不回滚</p></li></ul></li></ul> <h4 id="传播行为"><a href="#传播行为" class="header-anchor">#</a> 传播行为</h4> <ul><li><strong>事务传播行为</strong>：多事务方法直接进行调用，这个过程中事务是如何进行管理的。</li> <li><strong>事务方法</strong>：让数据表数据发生变化的操作。</li></ul> <p>事务的传播行为<strong>可以有传播属性指定</strong>。Spring 框架中定义了 7 种类传播行为：</p> <table><thead><tr><th>传播属性</th> <th>描述</th></tr></thead> <tbody><tr><td><code>REQUIRED</code></td> <td>如果有事务在运行，当前方法就在此事务内运行；否则，就启动一个新的事务，并在自己的事务内运行</td></tr> <tr><td><code>REQUIRED_NEW</code></td> <td>当前方法必须启动新事务，并在它自己的事务内运行；如果有事务正在运行，应该将它挂起</td></tr> <tr><td><code>SUPPORTS</code></td> <td>如果有事务在运行，当前方法就在此事务内运行；否则，它可以不运行在事务中</td></tr> <tr><td><code>NOT_SOPPORTED</code></td> <td>当前方法不应该运行在事务内部，如果有运行的事务，就将它挂起</td></tr> <tr><td><code>MANDATORY</code></td> <td>当前方法必须运行在事务内部，如果没有正在运行的事务，就抛出异常</td></tr> <tr><td><code>NEVER</code></td> <td>当前方法不应该运行在事务中，如果有运行的事务，就抛出异常</td></tr> <tr><td><code>NESTED</code></td> <td>如果有事务在运行，当前方法就应该在此事务的嵌套事务内运行；否则，就启动一个新的事务，并在它自己的事务内运行</td></tr></tbody></table> <p>🌰 例子：</p> <ul><li>现有有两个方法  <code>add()</code>  和  <code>update()</code>  ：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>按照不同的传播行为，可以有两种解释：
<ul><li><code>REQUIRED</code>  ：1️⃣ 如果  <code>add()</code>  方法本身有事务，调用  <code>update()</code>  方法之后， <code>update()</code>  使用当前  <code>add()</code>  方法里面事务。2️⃣ 如果  <code>add()</code>  方法本身没有事务，调用  <code>update()</code>  方法之后，创建新的事务。⚠️ 是<strong>默认事务传播行为</strong>。</li> <li><code>REQUIRED_NEW</code> ：使用  <code>add()</code>   方法调用  <code>update()</code>  方法，无论  <code>add()</code> <strong>是否有事务，都创建新的事务</strong>。</li></ul></li></ul> <p>🌰 例子：</p> <ul><li>为  <code>TransferRecordService</code>  设置事务传播行为：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransferRecordService</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="隔离级别"><a href="#隔离级别" class="header-anchor">#</a> 隔离级别</h4> <p>当不考虑事务的四个特性之一隔离性时，在并发时会产生一系列的问题。</p> <ul><li><p>有三个典型的「读」问题：脏读、不可重复读、虚（幻）读。</p> <ul><li><strong>脏读</strong>：一个未提交事务读取到了另一个未提交事务修改的数据。</li> <li><strong>不可重复读</strong>：一个未提交事务读取到了另一个已提交事务<strong>修改的数据</strong>。</li> <li><strong>虚（幻）读</strong>：一个未提交事务读取到了另一个已提交事务<strong>添加的数据</strong>。</li></ul></li> <li><p>通过设置隔离级别，解决上述的「读」问题：</p></li></ul> <table><thead><tr><th>事务隔离级别</th> <th>脏读</th> <th>不可重复读</th> <th>幻读</th></tr></thead> <tbody><tr><td><code>READ UNCOMMITTED</code> （<strong>读未提交</strong>）</td> <td>✅</td> <td>✅</td> <td>✅</td></tr> <tr><td><code>READ COMMITTED</code> （<strong>读已提交</strong>）</td> <td>❌</td> <td>❌</td> <td>✅</td></tr> <tr><td><code>REPEATABLE READ</code> （<strong>可重复读</strong>）</td> <td>❌</td> <td>❌</td> <td>✅</td></tr> <tr><td><code>SERIALIZABLE</code> （<strong>串行化</strong>）</td> <td>❌</td> <td>❌</td> <td>❌</td></tr></tbody></table> <blockquote><p>在 MySQL 中的默认事务隔离级别为  <code>REPEATABLE READ</code>  可重复读。</p></blockquote> <p>🌰 例子：</p> <ul><li>为  <code>TransferRecordService</code>  设置事务隔离级别：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>isolation <span class="token operator">=</span> <span class="token class-name">Isolation</span><span class="token punctuation">.</span>REPEATABLE_READ<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransferRecordService</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="其他参数"><a href="#其他参数" class="header-anchor">#</a> 其他参数</h4> <p><strong><code>timeout</code></strong>：设置事务的超时时间。</p> <ul><li>事务需要在一定的时间内进行提交，若设定的时间内事务未完成提交，则对事务进行回滚。</li> <li>默认值为  <code>-1</code> ，<strong>设置时间以秒为单位</strong>。</li></ul> <p>🌰 例子：</p> <ul><li>在  <code>TransferRecordService</code>  设置事务超时的时间为 5 s。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>timeout <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransferRecordService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TransferRecordDao</span> transferRecordDao<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transferAccounts</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">,</span> <span class="token class-name">String</span> fromUser<span class="token punctuation">,</span> <span class="token class-name">String</span> toUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        transferRecordDao<span class="token punctuation">.</span><span class="token function">transferOut</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> fromUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//模拟处理超时</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        transferRecordDao<span class="token punctuation">.</span><span class="token function">transferIn</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> toUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li>此时提交的事务超过设置的时间，则会抛出  <code>TransactionTimedOutException</code>  事务超时异常。</li></ul> <p><strong><code>readOnly</code></strong>：设置只读属性。</p> <ul><li>默认值  <code>false</code>  ：表示读写操作都允许，可以进行增、删、查、改的事务操作。</li> <li><code>true</code> ：表示只允许进行读取操作（查询）。</li></ul> <p>🌰 例子：</p> <ul><li>为  <code>TransferRecordService</code>  设置只读属性：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransferRecordService</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>设置只读后，则会抛出    <code>TransientDataAccessResourceException</code>  即<strong>瞬态数据访问资源异常</strong>，同时还会抛出  <code>SQLException</code>  ，并指出连接是只读的，查询导致数据修改是不允许的。</li></ul> <p><strong><code>rollbackFor</code></strong>：设置出现哪些异常才回滚。</p> <p>🌰 例子：</p> <ul><li>为  <code>TransferRecordService</code>  设置成只有抛出  <code>ArithmeticException</code>  异常时，才会进行事务的回滚操作。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">ArithmeticException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransferRecordService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TransferRecordDao</span> transferRecordDao<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transferAccounts</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">,</span> <span class="token class-name">String</span> fromUser<span class="token punctuation">,</span> <span class="token class-name">String</span> toUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        transferRecordDao<span class="token punctuation">.</span><span class="token function">transferOut</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> fromUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//模拟网络异常而导致操作中断</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
        transferRecordDao<span class="token punctuation">.</span><span class="token function">transferIn</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> toUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>noRollbackFor</code> ：与上面的属性值相反，设置出现哪些异常不进行回滚。</p> <p>🌰 例子：</p> <ul><li>为  <code>TransferRecordService</code>  设置成抛出  <code>ArithmeticException</code>  异常时，不会进行事务的回滚操作。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>noRollbackFor <span class="token operator">=</span> <span class="token class-name">ArithmeticException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransferRecordService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TransferRecordDao</span> transferRecordDao<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transferAccounts</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">,</span> <span class="token class-name">String</span> fromUser<span class="token punctuation">,</span> <span class="token class-name">String</span> toUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        transferRecordDao<span class="token punctuation">.</span><span class="token function">transferOut</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> fromUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//模拟网络异常而导致操作中断</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
        transferRecordDao<span class="token punctuation">.</span><span class="token function">transferIn</span><span class="token punctuation">(</span>amount<span class="token punctuation">,</span> toUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="完全注解开发"><a href="#完全注解开发" class="header-anchor">#</a> 完全注解开发</h4> <ul><li>创建配置类  <code>TransactionalConfig</code>  ：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span> <span class="token comment">// 表示此类为配置类</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;com.simon&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 自动扫描包</span>
<span class="token annotation punctuation">@EnableTransactionManagement</span> <span class="token comment">// 开启事务</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;classpath:jdbc.properties&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 读取外部数据库信息配置文件</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionalConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;${mysql.driverClassName}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> driverClassName<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;${mysql.url}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;${mysql.username}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;${mysql.password}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

		<span class="token comment">// 完整的配置数据库与SqlSession实例创建参照上一节笔记</span>
  	<span class="token comment">// ...</span>
  	
    <span class="token comment">// 配置事务管理器</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSourceTransactionManager</span> <span class="token function">getDataSourceTransactionManger</span><span class="token punctuation">(</span><span class="token class-name">DriverManagerDataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataSourceTransactionManager</span> transactionManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transactionManager<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> transactionManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>🌰 测试完全注解开发：</p> <ul><li>编写测试方法：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">TransactionalConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TransferRecordService</span> transferRecordService <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;transferRecordService&quot;</span><span class="token punctuation">,</span> <span class="token class-name">TransferRecordService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
transferRecordService<span class="token punctuation">.</span><span class="token function">transferAccounts</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">&quot;Lucy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="使用-xml-配置实现声明式事务管理"><a href="#使用-xml-配置实现声明式事务管理" class="header-anchor">#</a> 使用 XML 配置实现声明式事务管理</h3> <details class="custom-block details"><summary>点击查看</summary> <p>创建 Spring 配置文件用于实现声明式管理：</p> <ul><li>配置事务管理器：</li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transactionManager<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.springframework.jdbc.datasource.DataSourceTransactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>配置事务通知</li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transferAccounts<span class="token punctuation">&quot;</span></span> <span class="token attr-name">propagation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>REQUIRED<span class="token punctuation">&quot;</span></span> <span class="token attr-name">isolation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>REPEATABLE_READ<span class="token punctuation">&quot;</span></span> <span class="token attr-name">read-only</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span>
                   <span class="token attr-name">timeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>5<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rollback-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>java.lang.ArithmeticException<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>配置切入点和切面：</li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* com.simon.service.TransferRecordService.*(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>advisor</span> <span class="token attr-name">advice-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>advisor</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></details></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/simon1uo/notebook/edit/master/docs/300. 🧰 其他学习笔记/10. 🧋 Java SSM 相关/10. 🍃 Spring/05. ☘️ Spring 声明式事务.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/notebook/tags/?tag=Spring" title="标签">#Spring</a></div> <div class="last-updated"><span class="prefix">📢 上次更新:</span> <span class="time">2022/06/30, 22:33:11</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/notebook/pages/328e92/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">🎋 Spring 数据库编程</div></a> <a href="/notebook/pages/30b6df/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">🪵 Spring JdbcTemplate</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
                ←
                <a href="/notebook/pages/328e92/" class="prev">🎋 Spring 数据库编程</a></span> <span class="next"><a href="/notebook/pages/30b6df/">🪵 Spring JdbcTemplate</a>→
            </span></p></div></div></div> <!----></main></div> <div class="footer"><!----> 
        Copyright © 2020-2022
        |
        <span></span>

    theme on based
    <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="theme">Vdoing</a> powered By Vuepress
</div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
                    跟随系统
                </li><li class="iconfont icon-rijianmoshi">
                    浅色模式
                </li><li class="iconfont icon-yejianmoshi">
                    深色模式
                </li><li class="iconfont icon-yuedu">
                    阅读模式
                </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
        <script src="/notebook/assets/js/app.6a815fb9.js" defer></script><script src="/notebook/assets/js/2.ddc7fe92.js" defer></script><script src="/notebook/assets/js/3.cf638cd2.js" defer></script><script src="/notebook/assets/js/252.b959a851.js" defer></script>
    </body>
</html>
