<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>🚈 JavaScript 变量作用域与闭包 | notebook</title>
        <meta name="generator" content="VuePress 1.9.7" />
        <link rel="icon" href="/notebook/favicon.ico">
    <link rel="stylesheet" href="/notebook//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
    <script src="https://unpkg.com/@waline/client@v2/dist/waline.js"></script> <meta name="description" content="a frontend notebook by Simon">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="个人学习笔记,前端学习笔记,前端学习,前端学习资源,前端学习路线,HTML,CSS,JavaScript,Vue,React">
    <meta name="theme-color" content="#204A7A">  <link rel="preload" href="/notebook/assets/css/0.styles.29a47cad.css" as="style"><link rel="preload" href="/notebook/assets/js/app.ca29606a.js" as="script"><link rel="preload" href="/notebook/assets/js/2.f4898154.js" as="script"><link rel="preload" href="/notebook/assets/js/3.c3838318.js" as="script"><link rel="preload" href="/notebook/assets/js/90.37541a52.js" as="script"> <link rel="stylesheet" href="/notebook/assets/css/0.styles.29a47cad.css">
    </head>
    <body class="theme-mode-light">
        <div id="app" data-server-rendered="true"><div class="theme-container have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notebook/" class="home-link router-link-active"><img src="/notebook/assets/img/logo.png" alt="notebook" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notebook/" class="nav-link">🌏 首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="☕️ 前端笔记" class="dropdown-title"><a href="/notebook/front-end/" class="link-title">☕️ 前端笔记</a> <span class="title" style="display:none;">☕️ 前端笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/front-end/roadmap/" class="nav-link">🗺 前端学习路线</a></li><li class="dropdown-item"><h4>分类</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/front-end/beginning/" class="nav-link">🚶 前端入门基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/stable/" class="nav-link">🚶🏻 前端巩固基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/core-frame/" class="nav-link">🏃 前端核心框架</a></li><li class="dropdown-subitem"><a href="/notebook/pages/7b2364/front-end/interview/" class="nav-link">🪞 前端面试题收集</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🚏 索引" class="dropdown-title"><a href="/notebook/archives/" class="link-title">🚏 索引</a> <span class="title" style="display:none;">🚏 索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/archives/" class="nav-link">🗄归档</a></li><li class="dropdown-item"><!----> <a href="/notebook/tags/" class="nav-link">🔖标签</a></li></ul></div></div><div class="nav-item"><a href="/notebook/about/" class="nav-link">🔖 关于</a></div> <a href="https://github.com/simon1uo/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
            🍞 GitHub
            <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/notebook/" class="nav-link">🌏 首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="☕️ 前端笔记" class="dropdown-title"><a href="/notebook/front-end/" class="link-title">☕️ 前端笔记</a> <span class="title" style="display:none;">☕️ 前端笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/front-end/roadmap/" class="nav-link">🗺 前端学习路线</a></li><li class="dropdown-item"><h4>分类</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/front-end/beginning/" class="nav-link">🚶 前端入门基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/stable/" class="nav-link">🚶🏻 前端巩固基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/core-frame/" class="nav-link">🏃 前端核心框架</a></li><li class="dropdown-subitem"><a href="/notebook/pages/7b2364/front-end/interview/" class="nav-link">🪞 前端面试题收集</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🚏 索引" class="dropdown-title"><a href="/notebook/archives/" class="link-title">🚏 索引</a> <span class="title" style="display:none;">🚏 索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/archives/" class="nav-link">🗄归档</a></li><li class="dropdown-item"><!----> <a href="/notebook/tags/" class="nav-link">🔖标签</a></li></ul></div></div><div class="nav-item"><a href="/notebook/about/" class="nav-link">🔖 关于</a></div> <a href="https://github.com/simon1uo/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
            🍞 GitHub
            <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 🍯 ES6 基本语法</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/notebook/pages/4e50dd/" class="sidebar-link">🌱 node.js 基本使用</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📒 JavaScript 深入对象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📕 JavaScript 深入数据类型</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span> 📗 JavaScript 深入函数</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook/pages/acdd55/" class="sidebar-link">🚝  JavaScript 函数递归与堆栈</a></li><li><a href="/notebook/pages/208b1a/" class="sidebar-link">🚅 JavaScript Rest 参数与 Spread 语法</a></li><li><a href="/notebook/pages/7b2364/" aria-current="page" class="active sidebar-link">🚈 JavaScript 变量作用域与闭包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/notebook/pages/7b2364/#变量作用域" class="sidebar-link">变量作用域</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#代码块" class="sidebar-link">代码块</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#嵌套函数" class="sidebar-link">嵌套函数</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/notebook/pages/7b2364/#词法环境" class="sidebar-link">词法环境</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#对于变量" class="sidebar-link">对于变量</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#对于函数声明" class="sidebar-link">对于函数声明</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#内部和外部的词法环境" class="sidebar-link">内部和外部的词法环境</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#对于函数调用" class="sidebar-link">对于函数调用</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#闭包" class="sidebar-link">闭包</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#垃圾收集" class="sidebar-link">垃圾收集</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#实际开发" class="sidebar-link">实际开发</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/notebook/pages/7b2364/#例子" class="sidebar-link">例子</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#函数的最新内容" class="sidebar-link">函数的最新内容</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#可用的变量" class="sidebar-link">可用的变量</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#counter-独立性" class="sidebar-link">counter 独立性</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#if-内的函数" class="sidebar-link">if 内的函数</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#双括号的函数" class="sidebar-link">双括号的函数</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#变量是否可见" class="sidebar-link">变量是否可见</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#通过嵌套返回函数筛选数组元素" class="sidebar-link">通过嵌套返回函数筛选数组元素</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#通过嵌套返回函数按字段排序对象" class="sidebar-link">通过嵌套返回函数按字段排序对象</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/7b2364/#函数大军" class="sidebar-link">函数大军</a></li></ul></li></ul></li><li><a href="/notebook/pages/b89842/" class="sidebar-link">🚂 JavaScript 全局对象</a></li><li><a href="/notebook/pages/577e1c/" class="sidebar-link">🚆 JavaScript 函数对象</a></li><li><a href="/notebook/pages/b022f1/" class="sidebar-link">🚞 JavaScript 创建函数 new Function</a></li><li><a href="/notebook/pages/222f6f/" class="sidebar-link">🚠 JavaScript 中的调度函数</a></li><li><a href="/notebook/pages/23d75e/" class="sidebar-link">🚃 JavaScript 装饰器模式和转发</a></li><li><a href="/notebook/pages/9c420b/" class="sidebar-link">🚡 JavaScript 函数绑定</a></li><li><a href="/notebook/pages/92a793/" class="sidebar-link">🛺 JavaScript 深入箭头函数</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📘 JavaScript 原型与继承</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📙 JavaScript 类</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📓 JavaScript DOM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 🍯 JavaScript AJAX 网络请求</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 🚇 JavaScript Promise</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📔 JavaScript 其他内容</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 🏃 JavaScript 进阶高级</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> ʦ TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 🚟 axios</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-16f6d530><div class="articleInfo" data-v-16f6d530><ul class="breadcrumbs" data-v-16f6d530><li data-v-16f6d530><a href="/notebook/" title="首页" class="iconfont icon-home router-link-active" data-v-16f6d530></a></li> <li data-v-16f6d530><a href="/notebook/front-end/stable/# 🚶🏻 前端巩固基础" data-v-16f6d530> 🚶🏻 前端巩固基础</a></li><li data-v-16f6d530><a href="/notebook/front-end/stable/# 📗 JavaScript 深入函数" data-v-16f6d530> 📗 JavaScript 深入函数</a></li></ul> <div class="info" data-v-16f6d530><div title="作者" class="author iconfont icon-touxiang" data-v-16f6d530><a href="https://github.com/simon1uo" target="_blank" title="作者" class="beLink" data-v-16f6d530>Simon Luo</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-16f6d530><a href="javascript:;" data-v-16f6d530>2022-05-08</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><!---->🚈 JavaScript 变量作用域与闭包<!----></h1> <!----> <div class="theme-vdoing-content content__default"><blockquote><p>普遍 JavaScript 有三种声明变量的方法： <code>let</code>  /  <code>const</code>  /  <code>var</code> （已经不被推荐使用），这里一般使用  <code>let</code>  或者  <code>const</code>  声明变量解释 变量的作用域。（因为  <code>var</code>  的声明变量比较特殊。）</p></blockquote> <h2 id="变量作用域"><a href="#变量作用域" class="header-anchor">#</a> 变量作用域</h2> <h3 id="代码块"><a href="#代码块" class="header-anchor">#</a> 代码块</h3> <p><code>{ }</code>  看作是一个代码块，如果在这个代码块中声明变量，那么这个变量就只能在这个代码块中 <strong>可见</strong>。</p> <p>🌰 例子 ：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token string">'hello'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token comment">// Error: msg is not defined</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>🌰 例子 / 利用 <strong>代码块的特性</strong> 声明仅属于该代码块的变量：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token string">'hello'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token punctuation">{</span>
  <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token string">'goodbye'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>如果  <code>msg</code>  不分别放在对应的代码块，则会报错。因为使用  <code>let</code>  声明变量，不能重复声明同一个变量名称的变量，否则报错。</p></blockquote> <p>🌰 例子 / 对于  <code>if</code>  /  <code>for</code>  /  <code>while</code>  的  <code>{ ... }</code>  中声明的变量也仅在内部可见。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> phrase <span class="token operator">=</span> <span class="token string">'hello'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>phrase<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>phrase<span class="token punctuation">)</span> <span class="token comment">// phrase 变量不可见</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>就算是， <code>if</code>  条件符合运行后也是取不到  <code>phrase</code>  变量。</p></blockquote> <p>对于  <code>for</code> ：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>虽然变量  <code>i</code>  的声明不在  <code>{ ... }</code>  内，但是在  <code>for</code>  中声明的变量也被视为块的一部分。</p></blockquote> <h3 id="嵌套函数"><a href="#嵌套函数" class="header-anchor">#</a> 嵌套函数</h3> <p>如果一个函数是在另一个函数中创建的，该函数就被称为「嵌套」函数。</p> <p>🌰 例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sayHiBye</span><span class="token punctuation">(</span><span class="token parameter">firstName<span class="token punctuation">,</span> lastName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">getFullName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> firstName <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> lastName<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, &quot;</span> <span class="token operator">+</span> <span class="token function">getFullName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Bye, &quot;</span> <span class="token operator">+</span> <span class="token function">getFullName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>这里创建的 <strong>嵌套</strong> 函数  <code>getFullName()</code>  是为了更加方便，可以访问外部变量，因此可以返回全名。嵌套函数在 JavaScript 中很常见。</p></blockquote> <p>🌰 例子 / 返回一个嵌套函数作为新对象的属性或者作为结果返回，之后可以在其他地方使用。不论在哪里调用，它仍然可以访问相同的外部变量：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">makeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> count<span class="token operator">++</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p><code>makeCounter</code>  创建了一个返回  <code>counter</code>  嵌套函数，该函数在每次调用时返回下一个数字。</p></blockquote> <p>嵌套函数稍加变型就可以有很强的实际用途，比如可以封装一个 <strong>随机数生成器</strong> 生成用于自动化测试的随机数值。</p> <h2 id="词法环境"><a href="#词法环境" class="header-anchor">#</a> 词法环境</h2> <h3 id="对于变量"><a href="#对于变量" class="header-anchor">#</a> 对于变量</h3> <p>在 JavaScript 中，每个运行的函数、代码块  <code>{...}</code>  以及整个脚本，都有一个被称为 <strong>词法环境</strong> 的内部（隐藏）的关联对象。有两部分组成：</p> <ul><li><strong>环境记录</strong>：存储所有局部变量作为其 <strong>属性</strong>（包括一些信息，例如  <code>this</code>  的值）的对象。</li> <li>对 <strong>外部词法环境</strong> 的引用，与外部代码 <strong>相关联</strong>。</li></ul> <p><strong>「一个变量」</strong> 只是这个特殊的<strong>内部对象</strong>的一个属性。所以 「<strong>获取或者修改变量</strong>」 意味着 <strong>「获取或修改 词法环境 的一个属性」</strong>。</p> <ul><li>变量是 <strong>词法环境</strong> 的属性，与当前正在执行的代码有关。</li> <li>操作变量实际上是操作该对象的属性。</li></ul> <p>🌰 例子 ：一个变量被声明和修改值的过程：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// excution start  ---- phrase &lt;uninitialized&gt; =&gt; null</span>

<span class="token keyword">let</span> phrase<span class="token punctuation">;</span> <span class="token comment">//     ---- phrase: undefiend</span>

phrase <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token comment">// ---- phrase: 'hello'</span>
phrase <span class="token operator">=</span> <span class="token string">'bye'</span>  <span class="token comment">// ---- phrase: 'bye'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><p>起初当脚本开始运行，词法环境先填充了所有声明的变量。</p> <p>最初，它们处于「未初始化（Uninitialized）」状态。这是一种特殊的内部状态，这意味着引擎知道变量，但是在用  <code>let</code>  声明前，不能引用它。几乎就像变量不存在一样。</p></li> <li><p>然后执行  <code>let phrase</code>  定义。它尚未被赋值，因此它的值为  <code>undefined</code> 。从这一刻起，就可以使用变量了。</p></li> <li><p><code>phrase</code>  被赋予了一个值。</p></li> <li><p><code>phrase</code>  的值被修改。</p></li></ul> <blockquote><p>词法环境是一个 <strong>规范对象</strong>： 意味着它仅仅是存在于 编程语言规范 中的 理论上 存在的，用于描述事物如何运作的对象，并不能在代码中获取该对象并且直接对其进行操作。</p> <p>但是 JavaScript 引擎同样可以对它优化，比如 清除未被使用的变量以节省内存和执行其他内部技巧等。但是显性行为仍然不能直接操作。</p></blockquote> <h3 id="对于函数声明"><a href="#对于函数声明" class="header-anchor">#</a> 对于函数声明</h3> <p>函数与变量相同，也可以看作是一个 <strong>值</strong>。不同之处在于 <strong>函数声明的初始化会被立即完成</strong>。</p> <p>当创建了一个词法环境，函数声明会立即变为 <strong>即用型函数</strong>（不像  <code>let</code>  那样直到声明处才可用）。这就是为什么函数可以在声明之前调用函数声明。</p> <p>🌰 例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// execution start --- phrase &lt;uninitialized&gt; outer=&gt;null</span>
<span class="token comment">//                      say: function</span>

<span class="token keyword">let</span> phrase <span class="token operator">=</span> <span class="token string">'hello'</span> <span class="token comment">// --- ...</span>

<span class="token keyword">function</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>phrase<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p><strong>这种行为只使用函数声明</strong>。不使用将函数分配给变量的函数表达式，如  <code>let say = function(name)</code>  。</p></blockquote> <h3 id="内部和外部的词法环境"><a href="#内部和外部的词法环境" class="header-anchor">#</a> 内部和外部的词法环境</h3> <p>在一个函数运行时，在调用刚开始时，会自动创建一个 <strong>新的词法环境</strong> 以存储这个调用的 <strong>局部变量和参数</strong>。</p> <p>🌰 例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> phrase <span class="token operator">=</span> <span class="token string">'hello'</span>

<span class="token keyword">function</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>phrase<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">say</span><span class="token punctuation">(</span><span class="token string">'John'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// lexical environment of the call</span>
<span class="token comment">// name: 'john' outer=&gt;| say: function    outer=&gt; null</span>
<span class="token comment">//                     | phrase: 'hello'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>在这个函数调用期间，有两个词法环境，内部一个（函数调用）和外部一个（全局）。</p> <ul><li>内部词法环境与函数当前的执行相对应。具有一个单独的属性  <code>name</code> （函数的参数）。调用该函数传入的是  <code>John</code> ，所以  <code>name</code>  为  <code>John</code> 。</li> <li>外部词法环境是全局词法环境。具有  <code>phrase</code>  变量和函数本身。</li></ul></blockquote> <p>内部词法环境引用了  <code>outer</code>  外部的词法环境。<strong>当代码要访问一个变量时，首先会搜索内部词法环境，然后搜索外部环境，然后搜索更外部的环境，以此类推，直到全局词法环境。</strong></p> <p>如果在任何地方都找不到这个变量，那么在严格模式下就会报错（在非严格模式下，为了向下兼容，给未定义的变量赋值会创建一个全局变量）。</p> <p>在上面的例子中，搜索的过程：对于  <code>name</code>  变量，当  <code>say</code>  中的  <code>console.log()</code>  试图访问  <code>name</code>  时，会立即在内部词法环境中找到它；当它试图访问  <code>phrase</code>  时，然而内部没有  <code>phrase</code> ，所以它顺着对 <strong>外部词法环境的引用</strong> 找到了它。</p> <h3 id="对于函数调用"><a href="#对于函数调用" class="header-anchor">#</a> 对于函数调用</h3> <p>在  <code>makeCounter</code>  例子中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">makeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> count<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token function">makeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/V0LU22.png" alt="image-20220509144248862"></p> <p>在每次  <code>makeCounter()</code>  调用的开始，都会创建一个新的词法环境对象，以存储该  <code>makeCounter</code>  运行时的变量。因此有两层的 <strong>嵌套</strong> 词法环境。</p> <p>不同的是，在执行  <code>makeCounter()</code>  的过程中创建了一个仅占一行的嵌套函数： <code>return count++</code> ，尚未运行它，仅创建了它。</p> <p>所有的函数在「诞生」时都会记住创建它们的词法环境。：所有函数都有名为  <code>[[Environment]]</code>  的 <strong>隐藏属性</strong>，该属性保存了对创建该函数的词法环境的引用。</p> <p><img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/BieJ4y.png" alt="image-20220509144307948"></p> <p>因此， <code>counter.[[Environment]]</code>  有对  <code>{count: 0}</code>  词法环境的引用。这就是函数记住它创建于何处的方式，与函数被在哪儿调用无关。</p> <p><code>[[Environment]]</code> <strong>引用在函数创建时被设置并永久保存</strong>。</p> <p>当调用  <code>counter()</code>  时，会为该调用创建一个 <strong>新的词法环境</strong>，并且其外部词法环境引用获取于  <code>counter.[[Environment]]</code> ：</p> <p><img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/lC1noQ.png" alt="image-20220509144332128"></p> <p>现在，当  <code>counter()</code>  中的代码查找  <code>count</code>  变量时，它首先搜索自己的词法环境（为空，因为那里没有局部变量），然后是外部  <code>makeCounter()</code>  的词法环境，并且在哪里找到就在哪里修改。</p> <p>在变量所在的词法环境中更新变量，执行后的状态：</p> <p><img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/sDqk4R.png" alt="image-20220509144426707"></p> <p>如果调用  <code>counter()</code>  多次， <code>count</code>  变量将在同一位置增加到  <code>2</code> ， <code>3</code>  等。</p> <h3 id="闭包"><a href="#闭包" class="header-anchor">#</a> 闭包</h3> <p>记住 <strong>外部变量</strong> 并且可以访问这些变量的 <strong>函数</strong>。在 JavaScript 中，所有的函数都是 「天生」闭包（一个例外：）</p> <p>JavaScript 中的函数会自动通过隐藏的  <code>[[Environment]]</code>  属性记住创建它们的位置，所以它们都可以访问外部变量。</p> <p>🍎 什么是闭包？</p> <blockquote><ul><li>闭包的定义。</li> <li>JavaScript 中的函数为什么都是闭包。</li> <li>关于  <code>[[Environment]]</code>  属性和词法环境原理的技术细节。</li></ul></blockquote> <h3 id="垃圾收集"><a href="#垃圾收集" class="header-anchor">#</a> 垃圾收集</h3> <p>通常在函数调用完成后，会将 <strong>词法环境和其中的所有变量</strong> 从内存中删除。因为现在没有任何对它们的引用了（「不可达」）。与 JavaScript 中的任何其他对象一样，词法环境仅在可达时才会被保留在内存中。</p> <p>但是，如果有一个嵌套的函数在函数结束后 <strong>仍可达</strong>，则它将具有 <strong>引用词法环境</strong> 的  <code>[[Environment]]</code>  属性。</p> <p>🌰 例子 / 即便在外部函数执行完成后，它的词法环境仍然可达：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> g <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// g.[[Environment]] 存储了对相应 f() 调用的词法环境的引用</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>注意，如果多次调用  <code>f()</code> ，并且返回的函数被保存，那么所有相应的词法环境对象也会保留在内存中。</p> <p>多次调用  <code>f()</code> ：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></blockquote> <p>当嵌套函数被删除后，其封闭的词法环境（以及其中的  <code>value</code> ）也会被从内存中删除：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> g <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// g 函数存在时，该值会被保留在内存中</span>
g <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token comment">// g 函数不存在，从内存中删除</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="实际开发"><a href="#实际开发" class="header-anchor">#</a> 实际开发</h3> <p>理论上当函数可达时，它外部的所有变量也都将存在。</p> <p>但在实际中，JavaScript 引擎会试图优化它。它们会分析变量的使用情况，如果从代码中可以明显看出有未使用的外部变量，那么就会将其删除。</p> <p>🌰 例子 / 在 <strong>V8 引擎中（Chrome，Edge，Opera）</strong>，<strong>此类变量在调试中将不可用。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">debugger</span><span class="token punctuation">;</span> <span class="token comment">// 在 Console 中：输入 alert(value); No such variable!</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> g<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> g <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>虽然理论上应该可以访问，但是引擎把它优化掉了。</p></blockquote> <p>🌰 例子 / 引擎优化坑导致有趣的调试问题，有同名的外部变量但是不是预期的变量。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token string">'surprise'</span>

<span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token string">'the closest value'</span>
  
  <span class="token keyword">function</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">debugger</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">return</span> g
<span class="token punctuation">}</span>

<span class="token keyword">let</span> g <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="例子"><a href="#例子" class="header-anchor">#</a> 例子</h2> <h3 id="函数的最新内容"><a href="#函数的最新内容" class="header-anchor">#</a> 函数的最新内容</h3> <blockquote><p>函数 sayHi 使用外部变量。当函数运行时，将使用哪个值？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'john'</span>

<span class="token keyword">function</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Hi, &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

name <span class="token operator">=</span> <span class="token string">&quot;Pete&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></blockquote> <details class="custom-block details"><summary>点击查看</summary> <p>浏览器和服务器端开发中都很常见。一个函数可能被计划在创建之后一段时间后才执行，例如在用户行为或网络请求之后。</p> <p>旧变量值不会保存在任何地方。当一个函数想要一个变量时，它会从自己的词法环境或外部词法环境中获取当前值。</p></details> <h3 id="可用的变量"><a href="#可用的变量" class="header-anchor">#</a> 可用的变量</h3> <blockquote><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">makeWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">&quot;Pete&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// create a function</span>
<span class="token keyword">let</span> work <span class="token operator">=</span> <span class="token function">makeWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// call it</span>
<span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></blockquote> <details class="custom-block details"><summary>点击查看</summary> <p>函数  <code>work()</code>  在其被创建的位置通过外部词法环境引用获取  <code>name</code> ：</p> <p><img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/SexY7n.png" alt="image-20220509150752513"></p> <p>但如果在  <code>makeWorker()</code>  中没有  <code>let name</code> ，那么将继续向外搜索并最终找到全局变量，正如可以从上图中看到的那样。在这种情况下，结果将是  <code>&quot;John&quot;</code> 。</p></details> <h3 id="counter-独立性"><a href="#counter-独立性" class="header-anchor">#</a> <code>counter</code>  独立性</h3> <blockquote><p>用相同的  <code>makeCounter</code>  函数创建了两个计数器（counters）： <code>counter</code>  和  <code>counter2</code> 。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>unction <span class="token function">makeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> count<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token function">makeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> counter2 <span class="token operator">=</span> <span class="token function">makeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></blockquote> <details class="custom-block details"><summary>点击查看</summary> <p>函数  <code>counter</code>  和  <code>counter2</code>  是通过  <code>makeCounter</code>  的不同调用创建的。</p> <p>因此，它们具有独立的外部词法环境，每一个都有自己的  <code>count</code> 。</p></details> <h3 id="if-内的函数"><a href="#if-内的函数" class="header-anchor">#</a> <code>if</code>  内的函数</h3> <blockquote><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> phrase <span class="token operator">=</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>phrase<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></blockquote> <details class="custom-block details"><summary>点击查看</summary> <p>在  <code>if</code>  代码块中定义函数  <code>sayHi</code> ，所以它只存在于  <code>if</code>  中。外部是没有  <code>sayHi</code>  的。所以运行会报错。</p></details> <h3 id="双括号的函数"><a href="#双括号的函数" class="header-anchor">#</a> 双括号的函数</h3> <blockquote><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></blockquote> <details class="custom-block details"><summary>点击查看</summary> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></details> <h3 id="变量是否可见"><a href="#变量是否可见" class="header-anchor">#</a> 变量是否可见</h3> <blockquote><p>在下面这段代码中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></blockquote> <details class="custom-block details"><summary>点击查看</summary> <p>可以看出「<strong>不存在变量</strong>」和「<strong>未初始化</strong>」 变量之间的特殊差异。</p> <ul><li>从程序执行进入代码块（或函数）的那一刻起，变量就开始进入「未初始化」状态。它一直保持未初始化状态，直至程序执行到相应的  <code>let</code>  语句。</li> <li>一个变量从技术的角度来讲是存在的，但是在  <code>let</code>  之前还不能使用。</li></ul> <p>所以上面的代码：虽然知道 局部变量  <code>x</code> ，但是  <code>x</code>  一直处于未初始化的状态（无法使用），直到死区结束。</p> <blockquote><p>死区：变量暂时无法使用的区域，从代码块到  <code>let</code>  。</p></blockquote></details> <h3 id="通过嵌套返回函数筛选数组元素"><a href="#通过嵌套返回函数筛选数组元素" class="header-anchor">#</a> 通过嵌套返回函数筛选数组元素</h3> <blockquote><p><code>arr.filter(func)</code>  方法可以通过函数  <code>func</code>  过滤函数，如果函数返回  <code>true</code> ，则元素会被返回到结果数据。</p> <p>制造一系列 “即用型” 过滤器：</p> <ul><li><code>inBetween(a, b)</code>  —— 在  <code>a</code>  和  <code>b</code>  之间或与它们相等（包括）。</li> <li><code>inArray([...])</code>  —— 包含在给定的数组中。</li></ul> <p>用法如下所示：</p> <ul><li><code>arr.filter(inBetween(3,6))</code>  —— 只挑选范围在 3 到 6 的值。</li> <li><code>arr.filter(inArray([1,2,3]))</code>  —— 只挑选与  <code>[1,2,3]</code>  中的元素匹配的元素。</li></ul></blockquote> <details class="custom-block details"><summary>点击查看</summary> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">inBetween</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">&gt;=</span> a <span class="token operator">||</span> x <span class="token operator">&lt;=</span> b
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">inArray</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></details> <h3 id="通过嵌套返回函数按字段排序对象"><a href="#通过嵌套返回函数按字段排序对象" class="header-anchor">#</a> 通过嵌套返回函数按字段排序对象</h3> <blockquote><p>有一组要排序的对象：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> users <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token literal-property property">surname</span><span class="token operator">:</span> <span class="token string">&quot;Johnson&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Pete&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token literal-property property">surname</span><span class="token operator">:</span> <span class="token string">&quot;Peterson&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Ann&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token literal-property property">surname</span><span class="token operator">:</span> <span class="token string">&quot;Hathaway&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>通常做法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>user<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>name <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>name <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>user<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>age <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>age <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>要实现 <strong>只输入一个字段名称</strong>，就实现排序，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>users<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token function">byField</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
users<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token function">byField</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></blockquote> <p>:::</p> <p>编写函数  <code>byField</code> ：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">byField</span><span class="token punctuation">(</span><span class="token parameter">fieldName</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">[</span>fieldName<span class="token punctuation">]</span> <span class="token operator">&gt;</span> b<span class="token punctuation">[</span>fieldName<span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>:::</p> <h3 id="函数大军"><a href="#函数大军" class="header-anchor">#</a> 函数大军</h3> <blockquote><p>在下面代码中，期望每次循环到的 添加到数组中的 输出 <code>shooter</code>  的编号函数。<strong>但是最后调用时的都是同样的值</strong>？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">makeArmy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> shooters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token function-variable function">shooter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    shooters<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>shooter<span class="token punctuation">)</span>
    i<span class="token operator">++</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">return</span> shooters
<span class="token punctuation">}</span>

<span class="token keyword">let</span> army <span class="token operator">=</span> <span class="token function">makeArmy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
army<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 10</span>
army<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></blockquote> <details class="custom-block details"><summary>点击查看</summary> <p>分析代码的运行过程：</p> <ol><li><p>首先创建了空数组  <code>shooters</code> 。</p></li> <li><p>在  <code>while</code>  循环中，通过  <code>shooters.push(shooter)</code>  填充  <code>shooter</code>  函数，相当于：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>shooters <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p>然后返回这个数组。</p></li> <li><p>创建数组并且填充数组之后，试图对数组中的任意数组项的函数进行调用。</p></li></ol> <p><strong>所有的数组项函数都输出同一个数值  <code>i</code>  的原因，因为  <code>i</code>  是来自这个函数的外部 词法环境的。</strong></p> <ul><li>所有的  <code>shooter</code>  函数都是在  <code>makeArmy()</code>  的词法环境中被创建的。</li> <li>当  <code>army[5]()</code>  被调用时， <code>makeArmy</code>  已经运行完了，最后  <code>i</code>  的值为  <code>10</code> （ <code>while</code>  循环在  <code>i=10</code>  时停止）。</li> <li>因此，所有的  <code>shooter</code>  函数获得的都是外部词法环境中的同一个值，即最后的  <code>i=10</code> 。</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/lXRACS.png" alt="image-20220509171707254"></p> <p>在  <code>while {...}</code>  块的每次迭代中，都会创建一个新的词法环境。</p> <p>要解决这个问题，可以通过</p> <ul><li><p>将  <code>i</code>  的值复制到  <code>while {...}</code>  块内的变量中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ... </span>
<span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> 
<span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token keyword">let</span> <span class="token function-variable function">shooter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// shooter 函数</span>
        <span class="token function">alert</span><span class="token punctuation">(</span> j <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 应该显示它自己的编号</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    shooters<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>shooter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">// ... </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p><code>let j = i</code>  声明了一个 “局部迭代” 变量  <code>j</code> ，并将  <code>i</code>  复制到其中。原始类型是「按值」复制的，因此实际上得到的是属于当前循环迭代的独立的  <code>i</code>  的副本。</p> <p>shooter 函数正确运行了，因为  <code>i</code>  值的位置更近了（译注：指转到了更内部的词法环境）。不是在  <code>makeArmy()</code>  的词法环境中，而是在与当前循环迭代相对应的词法环境中：</p> <p><img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/HHub2z.png" alt="image-20220509171920737"></p></blockquote></li> <li><p>使用  <code>for</code>  循环替代  <code>while</code>  循环：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">makeArmy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> shooters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token function-variable function">shooter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// shooter 函数</span>
      <span class="token function">alert</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 应该显示它自己的编号</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    shooters<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>shooter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> shooters<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p><code>for</code>  循环在每次迭代中，都会生成一个带有自己的变量  <code>i</code>  的新词法环境。因此，在每次迭代中生成的  <code>shooter</code>  函数引用的都是自己的  <code>i</code> 。</p> <p><img src="https://cdn.jsdelivr.net/gh/simon1uo/image-flow@master/image/youxoY.png" alt="image-20220509172053687"></p></blockquote></li></ul></details></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/simon1uo/notebook/edit/master/docs/101. 🚶🏻 前端巩固基础/33. 📗 JavaScript 深入函数/03. 🚈 JavaScript 变量作用域与闭包.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">📢 上次更新:</span> <span class="time">2022/07/19, 23:55:11</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/notebook/pages/208b1a/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">🚅 JavaScript Rest 参数与 Spread 语法</div></a> <a href="/notebook/pages/b89842/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">🚂 JavaScript 全局对象</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
                    ←
                    <a href="/notebook/pages/208b1a/" class="prev">🚅 JavaScript Rest 参数与 Spread 语法</a></span> <span class="next"><a href="/notebook/pages/b89842/">🚂 JavaScript 全局对象</a>→
                </span></p></div></div></div> <!----></main></div> <div class="footer"><!----> 
            Copyright © 2020-2022
            |
            <span>wrote with ❤️ by <a href="https://simon1uo.github.io">Simon</a></br></span>

        theme based on
        <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="theme">Vdoing</a> powered By Vuepress
    </div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
                        跟随系统
                    </li><li class="iconfont icon-rijianmoshi">
                        浅色模式
                    </li><li class="iconfont icon-yejianmoshi">
                        深色模式
                    </li><li class="iconfont icon-yuedu">
                        阅读模式
                    </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
        <script src="/notebook/assets/js/app.ca29606a.js" defer></script><script src="/notebook/assets/js/2.f4898154.js" defer></script><script src="/notebook/assets/js/3.c3838318.js" defer></script><script src="/notebook/assets/js/90.37541a52.js" defer></script>
    </body>
</html>
