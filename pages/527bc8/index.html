<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>🥃 JavaScript 长轮询 WebSocket | notebook</title>
        <meta name="generator" content="VuePress 1.9.7" />
        <link rel="icon" href="/notebook/favicon.ico">
    <link rel="stylesheet" href="/notebook//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
    <script src="https://unpkg.com/@waline/client@v2/dist/waline.js"></script> <meta name="description" content="a frontend notebook by Simon">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="个人学习笔记,前端学习笔记,前端学习,前端学习资源,前端学习路线,HTML,CSS,JavaScript,Vue,React">
    <meta name="theme-color" content="#204A7A">  <link rel="preload" href="/notebook/assets/css/0.styles.29a47cad.css" as="style"><link rel="preload" href="/notebook/assets/js/app.c1e92184.js" as="script"><link rel="preload" href="/notebook/assets/js/2.f4898154.js" as="script"><link rel="preload" href="/notebook/assets/js/3.c3838318.js" as="script"><link rel="preload" href="/notebook/assets/js/125.6a4cc473.js" as="script"> <link rel="stylesheet" href="/notebook/assets/css/0.styles.29a47cad.css">
    </head>
    <body class="theme-mode-light">
        <div id="app" data-server-rendered="true"><div class="theme-container have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notebook/" class="home-link router-link-active"><img src="/notebook/assets/img/logo.png" alt="notebook" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notebook/" class="nav-link">🌏 首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="☕️ 前端笔记" class="dropdown-title"><a href="/notebook/front-end/" class="link-title">☕️ 前端笔记</a> <span class="title" style="display:none;">☕️ 前端笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/front-end/roadmap/" class="nav-link">🗺 前端学习路线</a></li><li class="dropdown-item"><h4>分类</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/front-end/beginning/" class="nav-link">🚶 前端入门基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/stable/" class="nav-link">🚶🏻 前端巩固基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/core-frame/" class="nav-link">🏃 前端核心框架</a></li><li class="dropdown-subitem"><a href="/notebook/pages/527bc8/front-end/interview/" class="nav-link">🪞 前端面试题收集</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🚏 索引" class="dropdown-title"><a href="/notebook/archives/" class="link-title">🚏 索引</a> <span class="title" style="display:none;">🚏 索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/archives/" class="nav-link">🗄归档</a></li><li class="dropdown-item"><!----> <a href="/notebook/tags/" class="nav-link">🔖标签</a></li></ul></div></div><div class="nav-item"><a href="/notebook/about/" class="nav-link">🔖 关于</a></div> <a href="https://github.com/simon1uo/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
            🍞 GitHub
            <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/notebook/" class="nav-link">🌏 首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="☕️ 前端笔记" class="dropdown-title"><a href="/notebook/front-end/" class="link-title">☕️ 前端笔记</a> <span class="title" style="display:none;">☕️ 前端笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/front-end/roadmap/" class="nav-link">🗺 前端学习路线</a></li><li class="dropdown-item"><h4>分类</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/notebook/front-end/beginning/" class="nav-link">🚶 前端入门基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/stable/" class="nav-link">🚶🏻 前端巩固基础</a></li><li class="dropdown-subitem"><a href="/notebook/front-end/core-frame/" class="nav-link">🏃 前端核心框架</a></li><li class="dropdown-subitem"><a href="/notebook/pages/527bc8/front-end/interview/" class="nav-link">🪞 前端面试题收集</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🚏 索引" class="dropdown-title"><a href="/notebook/archives/" class="link-title">🚏 索引</a> <span class="title" style="display:none;">🚏 索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notebook/archives/" class="nav-link">🗄归档</a></li><li class="dropdown-item"><!----> <a href="/notebook/tags/" class="nav-link">🔖标签</a></li></ul></div></div><div class="nav-item"><a href="/notebook/about/" class="nav-link">🔖 关于</a></div> <a href="https://github.com/simon1uo/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
            🍞 GitHub
            <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 🍯 ES6 基本语法</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/notebook/pages/4e50dd/" class="sidebar-link">🌱 node.js 基本使用</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📒 JavaScript 深入对象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📕 JavaScript 深入数据类型</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📗 JavaScript 深入函数</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📘 JavaScript 原型与继承</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📙 JavaScript 类</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📓 JavaScript DOM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span> 🍯 JavaScript AJAX 网络请求</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notebook/pages/e0da75/" class="sidebar-link">🥢 JavaScript Fetch</a></li><li><a href="/notebook/pages/def96d/" class="sidebar-link">🥤 JavaScript Fetch API</a></li><li><a href="/notebook/pages/162aa2/" class="sidebar-link">🧉 JavaScript URL 对象</a></li><li><a href="/notebook/pages/644542/" class="sidebar-link">🍶 JavaScript XMLHttpRequest</a></li><li><a href="/notebook/pages/527bc8/" aria-current="page" class="active sidebar-link">🥃 JavaScript 长轮询 WebSocket</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/notebook/pages/527bc8/#常规轮询" class="sidebar-link">常规轮询</a></li><li class="sidebar-sub-header level2"><a href="/notebook/pages/527bc8/#长轮询" class="sidebar-link">长轮询</a></li><li class="sidebar-sub-header level2"><a href="/notebook/pages/527bc8/#websocket" class="sidebar-link">WebSocket</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/notebook/pages/527bc8/#建立连接" class="sidebar-link">建立连接</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/527bc8/#数据传输" class="sidebar-link">数据传输</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/527bc8/#限速" class="sidebar-link">限速</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/527bc8/#关闭连接" class="sidebar-link">关闭连接</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/527bc8/#连接状态" class="sidebar-link">连接状态</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/notebook/pages/527bc8/#server-sent-events" class="sidebar-link">Server Sent Events</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/notebook/pages/527bc8/#获取消息" class="sidebar-link">获取消息</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/527bc8/#跨源请求" class="sidebar-link">跨源请求</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/527bc8/#重新连接" class="sidebar-link">重新连接</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/527bc8/#连接-id" class="sidebar-link">连接 id</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/527bc8/#连接状态-2" class="sidebar-link">连接状态</a></li><li class="sidebar-sub-header level3"><a href="/notebook/pages/527bc8/#连接事件" class="sidebar-link">连接事件</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 🚇 JavaScript Promise</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 📔 JavaScript 其他内容</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 🏃 JavaScript 进阶高级</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> ʦ TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> 🚟 axios</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-16f6d530><div class="articleInfo" data-v-16f6d530><ul class="breadcrumbs" data-v-16f6d530><li data-v-16f6d530><a href="/notebook/" title="首页" class="iconfont icon-home router-link-active" data-v-16f6d530></a></li> <li data-v-16f6d530><a href="/notebook/front-end/stable/# 🚶🏻 前端巩固基础" data-v-16f6d530> 🚶🏻 前端巩固基础</a></li><li data-v-16f6d530><a href="/notebook/front-end/stable/# 🍯 JavaScript AJAX 网络请求" data-v-16f6d530> 🍯 JavaScript AJAX 网络请求</a></li></ul> <div class="info" data-v-16f6d530><div title="作者" class="author iconfont icon-touxiang" data-v-16f6d530><a href="https://github.com/simon1uo" target="_blank" title="作者" class="beLink" data-v-16f6d530>Simon Luo</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-16f6d530><a href="javascript:;" data-v-16f6d530>2022-06-01</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><!---->🥃 JavaScript 长轮询 WebSocket<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p>长轮询是 <strong>与服务器保持持久连接</strong> 的最简单的方式，它不使用任何特定的协议。（例如 WebSocket 或者 Server Sent Event）比较容易实现，适用较多场景。</p> <h2 id="常规轮询"><a href="#常规轮询" class="header-anchor">#</a> 常规轮询</h2> <p>定期轮询是从服务器获取新信息的最简单的方式（定期向服务器发送请求）。作为响应，服务器首先通知自己，客户端处于在线状态，然后发送目前为止的消息包。</p> <p>使用定期轮询的缺点：</p> <ul><li>消息传递存在延迟（两个请求之间）；</li> <li>即使没有消息，服务器也会每隔 10 秒被请求轰炸一次，即使用户切换到其他地方或者处于休眠状态，也是如此。就性能而言，这是一个很大的负担。</li></ul> <blockquote><p>对于小型服务或许可行。</p></blockquote> <h2 id="长轮询"><a href="#长轮询" class="header-anchor">#</a> 长轮询</h2> <p>是轮询服务器的一种更好的方式，容易实现，<strong>可以无延迟传递消息</strong>。长轮询流程为：</p> <ul><li>请求发送到服务器；</li> <li>服务器在<strong>有消息时之前不会关闭连接</strong>；</li> <li>当消息出现时，服务器将对其做出响应；</li> <li>浏览器立即发送新的请求。</li></ul> <p>对于此方法，浏览器发出一个请求并与服务器之间建立起一个 <strong>挂起的连接</strong> 的情况是标准的。仅在有消息被传递时，才会重新建立连接。</p> <img src="/Users/Simon/Library/Application%20Support/typora-user-images/image-20220601161138146.png" alt="image-20220601161138146" style="zoom:50%;"> <p>🌰 例子 / 实现长轮询客户端的函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;/subsribe&quot;</span><span class="token punctuation">)</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">502</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 502 超时错误</span>
    <span class="token comment">// 超时导致连接挂起时间过长，远程服务器或者代理会关闭该连接</span>
    <span class="token comment">// 重新连接</span>
    <span class="token keyword">await</span> <span class="token function">subsribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 发生错误时</span>
    <span class="token function">showMessage</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">)</span> 
    
    <span class="token comment">// 一秒后重新连接</span>
    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">subsribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取消息</span>
    <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 显示消息</span>
    <span class="token function">showMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    <span class="token comment">// 调用 subsribe() 获取下一条消息</span>
    <span class="token keyword">await</span> <span class="token function">subsribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><blockquote><p><code>subscribe</code>  函数发起了一个  <code>fetch</code> ，然后等待响应，处理它，并再次调用自身。</p></blockquote> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>对于服务器，应该可以处理许多挂起的连接。某些服务器架构是每个连接对应一个进程，导致进程数和连接数一样多，而每个进程都会消耗相当多的内存。因此，过多的连接会消耗掉全部内存。</p></div> <p>长轮询的使用场景：</p> <ul><li>在消息很少的情况下，长轮询很有效。</li> <li>如果消息比较频繁，那么上面描绘的请求 - 接收消息的图表就会变成锯状状。每个消息都是一个单独的请求，并带有 header，身份验证等增加了开销。此时，应该选择另一种方法（WebSocket 或者 Server Sent Events）</li></ul> <h2 id="websocket"><a href="#websocket" class="header-anchor">#</a> WebSocket</h2> <p>是一个提供浏览器和服务器之间 <strong>建立持久连接</strong> 来 <strong>交换数据</strong> 的方法协议。数据可以作为「数据包」在两个方向上传递，而不会断开连接和其他 HTTP 请求。</p> <p>对于需要连续数据交换的服务，例如网络游戏，实时交易系统等，WebSocket 尤其有用。</p> <ul><li>WebSocket 没有跨源限制。</li> <li>浏览器对 WebSocket 支持很好。</li> <li>可以发送 / 接收字符串和二进制数据。</li></ul> <p>创建 WebSocket 连接，需要在 URL <strong>使用特殊的协议  <code>ws</code></strong>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://javascript.info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>加密的  <code>wss://</code>  协议，类似于 HTTPS。</p> <p><code>wss://</code>  协议不仅是被加密的，而且更可靠。因为  <code>ws://</code>  中数据不是加密的，对于任何中间人来说其数据都是可见的。并且，旧的代理服务器不了解 WebSocket，可能会因为奇怪的 header 而中止连接； <code>wss://</code>  是基于 TLS 的 WebSocket，类似于 HTTPS 是基于 TLS 的 HTTP），<strong>传输安全层在发送方对数据进行了加密，在接收方进行解密</strong>。因此，数据包是通过代理加密传输的。它们看不到传输的里面的内容，且会让这些数据通过。</p></blockquote> <p>WebSocket 被建立后，就可以监听  <code>socket</code>  的事件：</p> <ul><li><code>open</code> ：连接已建立；</li> <li><code>message</code> ：接收到数据；</li> <li><code>error</code> ：连接出错；</li> <li><code>close</code> ：连接已关闭；</li></ul> <p>使用 WebSocket 发送数据使用  <code>socket.send(data)</code>  方法。</p> <p>🌰 例子 / 使用 WebSocket 发送数据：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;wss://javascript.info/article/websocket/demo/hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

socket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;[open] Connection established&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Sending to server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;My name is John&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送消息</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

socket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[message] Data received from server: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

socket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>wasClean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[close] Connection closed cleanly, code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> reason=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 例如服务器进程被杀死或网络中断</span>
    <span class="token comment">// 在这种情况下，event.code 通常为 1006</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'[close] Connection died'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

socket<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[error] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="建立连接"><a href="#建立连接" class="header-anchor">#</a> 建立连接</h3> <p>当  <code>new WebSocket(url)</code>  创建时，建立起了连接。</p> <p>连接期间，浏览器使用响应头 header 发送请求询问服务器是否支持 WebSocket， 如果支持才会以 WebSocket 协议继续进行。</p> <p>🌰 例子 /  <code>new WebSocket(&quot;wss://javascript.info/chat&quot;)</code>  请求头内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /chat
Host: javascript.info
Origin: https://javascript.info
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Key: Iv8io/9s+lYFgZWcXczP8Q==
Sec-WebSocket-Version: 13
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><ul><li><code>Origin</code> ：客户端页面的源。WebSocket 对象是 <strong>原生支持跨源</strong> 的。没有特殊的 header 或其他限制。~~ 旧的服务器无法处理 WebSocket，因此不存在兼容性问题。~~ 但是  <code>Origin</code>  很重要，它允许服务器决定是否使用 WebSocket 与该网站通信；</li> <li><code>Connection: Upgrade</code> ：表示客户端想要 <strong>更改协议</strong>；</li> <li><code>Upgrade: websocket</code>  ：更改请求的协议为 <strong><code>websocket</code></strong>；</li> <li><code>Sec-WebSocket-Key</code>  ：浏览器随机生成的安全密钥。</li> <li><code>Sec-WebSocket-Version</code>  ：WebSocket 协议版本，当前为 13。`</li></ul></blockquote> <p><strong>注意不可以模拟 WebSocket 握手</strong>，例如使用  <code>XMLHttpRequest</code>  或  <code>fetch</code>  设置这些请求头的内容。</p> <p>如果服务器同意切换为 WebSocket 协议，则响应头内容为（响应码为  <code>101</code> ）：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: hsBlbuDTkk24srzEOTBUlZAlC2g=
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>同时，这里的  <code>Sec-WebSocket-Accept</code>  是  <code>Sec-WebSocket-Key</code> ，<strong>浏览器使用它保证响应与请求相对应</strong>。</p></blockquote> <p>然后就可以使用 WebSocket 协议传输数据。并且之后可以看到，它的结构不是 HTTP。</p> <p>WebSocket 拓展和子协议：</p> <details class="custom-block details"><summary>点击查看</summary> <p>WebSocket 的其他 header： <code>Sec-WebSocket-Extensions</code>  和  <code>Sec-WebSocket-Protocol</code> ，它们描述了扩展和子协议。</p> <ul><li><p><code>Sec-WebSocket-Extensions: deflate-frame</code>  ：表示浏览器 <strong>支持数据压缩</strong>。这个拓展与数据传输有关，拓展了 WebSocket 的协议的功能。</p> <p><code>Sec-WebSocket-Extensions</code>  header 由浏览器自动发送，其中包含其支持的所有扩展的列表。</p></li> <li><p><code>Sec-WebSocket-Protocol: soap, wamp</code> ：表示不仅要传输数据，还要传输 SOAP / WAMP 协议中的数据。</p> <p>这个可选的 header 是使用  <code>new WebSocket</code>  的第二个参数设置的。它是子协议数组，例如，如果想使用 SOAP 或 WAMP：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;wss://javascript.info/chat&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;soap&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wamp&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <p><strong>服务器应该使用同意使用的协议和扩展的列表进行响应</strong>。</p> <p>例如：</p> <ul><li><p>请求头 header：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /chat
Host: javascript.info
Upgrade: websocket
Connection: Upgrade
Origin: https://javascript.info
Sec-WebSocket-Key: Iv8io/9s+lYFgZWcXczP8Q==
Sec-WebSocket-Version: 13
Sec-WebSocket-Extensions: deflate-frame
Sec-WebSocket-Protocol: soap, wamp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>响应头 header：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: hsBlbuDTkk24srzEOTBUlZAlC2g=
Sec-WebSocket-Extensions: deflate-frame
Sec-WebSocket-Protocol: soap
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul></details> <h3 id="数据传输"><a href="#数据传输" class="header-anchor">#</a> 数据传输</h3> <p>WebSocket 通信由  <code>frames</code> （即数据片段）组成，可以从任何一方发送，并且有以下几种类型：</p> <ul><li><code>text frames</code> ：<strong>文本数据</strong>。</li> <li><code>binary data frames</code> ：<strong>二进制数据</strong>。</li> <li><code>ping/pong frames</code> ：用于检查服务器发送的链接。浏览器会自动响应它们。</li> <li><code>conection close frames</code>  …</li></ul> <p>在浏览器里，<strong>仅仅使用 文本数据或者二进制数据</strong>。</p> <p>使用 WebSocket 的  <code>.send</code>  方法发送文本或者二进制数据：</p> <ul><li><code>socket.send(body)</code>  调用允许  <code>body</code>  是字符串或二进制格式，包括  <code>Blob</code> ， <code>ArrayBuffer</code>  等。不需要额外的设置：直接发送它们就可以了。</li></ul> <p>当接收到数据，文本总是以 <strong>字符串</strong> 形式呈现。对于二进制数据，在  <code>Blob</code>  和  <code>ArrayBuffer</code>  格式之间选择。（由  <code>socket.binaryType</code>  属性设置的，默认为  <code>&quot;blob&quot;</code> ，因此二进制数据通常以  <code>Blob</code>  对象呈现。）</p> <blockquote><p><code>Blob</code>  高级二进制对象，可以直接与  <code>&lt;a&gt;</code> ， <code>&lt;img&gt;</code>  及其他标签集成在一起。所以为默认的格式。</p> <p>要访问单个数据字节，可以修改为  <code>arrayBuffer</code> ：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>socket<span class="token punctuation">.</span>binaryType <span class="token operator">=</span> <span class="token string">&quot;arraybuffer&quot;</span><span class="token punctuation">;</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// event.data 可以是文本（如果是文本），也可以是 arraybuffer（如果是二进制数据）</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></blockquote> <h3 id="限速"><a href="#限速" class="header-anchor">#</a> 限速</h3> <blockquote><p>如果应用程序正在生成大量的数据，但是用户的网速很慢。</p> <p>此时，可以反复调用  <code>socket.send(data)</code> 。但是数据将会被缓存（缓冲存储）在内存中，并且只能在网速允许的情况下尽快将数据发送出去。</p></blockquote> <p><code>socket.bufferedAmount</code>  属性储存了 <strong>目前已缓冲的字节数</strong>，等待通过网络发送。</p> <p>🌰 例子 / 使用该属性查看  <code>socket</code>  是否真的可以用于传输：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>bufferedAmount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">moreData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>每 100 ms 检查一次  <code>socket</code> 。仅当所有现有的数据都<strong>已被发送出去时</strong>（即缓存中没有数据），再发送更多数据。</p></blockquote> <h3 id="关闭连接"><a href="#关闭连接" class="header-anchor">#</a> 关闭连接</h3> <p>通常，当一方想要关闭连接时（浏览器和服务器都具有相同的权限），它们会发送一个带有 <strong>数字码</strong> 和文本形式的原因的  <code>connection close frame</code>  。</p> <p>关闭连接的方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">[</span>code<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>reason<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><code>[code]</code> ：<strong>可选的</strong> 特殊的 WebSocket 关闭码。</li> <li><code>[reason]</code> ：<strong>可选的</strong> 描述关闭原因的字符串。</li></ul> <p>当另一方通过  <code>close</code>  事件处理器获取了 关闭码和关闭原因 时。例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 关闭方：</span>
socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">&quot;Work complete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 另一方</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// event.code === 1000</span>
  <span class="token comment">// event.reason === &quot;Work complete&quot;</span>
  <span class="token comment">// event.wasClean === true (clean close)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>可以通过  <code>event</code>  获取这些属性。</p></blockquote> <p>通常的 WebSocket 关闭码：</p> <details class="custom-block details"><summary>点击查看</summary> <blockquote><ul><li><code>1000</code>  ：默认，<strong>正常关闭</strong>（如果没有指明  <code>code</code>  时使用它），</li> <li><code>1006</code>  ：没有办法手动设定这个数字码，表示连接丢失（没有 close frame）。</li></ul> <p>其他数字码，例如：</p> <ul><li><code>1001</code> ：一方正在离开，例如服务器正在关闭，或者浏览器离开了该页面，</li> <li><code>1009</code>  ：消息太大，无法处理，</li> <li><code>1011</code>  ： 服务器上发生意外错误，</li> <li>……。</li></ul> <p><a href="https://tools.ietf.org/html/rfc6455#section-7.4.1" target="_blank" rel="noopener noreferrer">RFC6455, §7.4.1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>注意，小于  <code>1000</code>  的码都是被保留的，如果我们尝试设置这样的码，将会出现错误。</p></details> <h3 id="连接状态"><a href="#连接状态" class="header-anchor">#</a> 连接状态</h3> <p>要获取连接状态，可以通过带有值的  <code>socket.readyState</code>  属性：</p> <ul><li><strong><code>0</code></strong> —— “CONNECTING”：连接还未建立，</li> <li><strong><code>1</code></strong> —— “OPEN”：通信中，</li> <li><strong><code>2</code></strong> —— “CLOSING”：连接关闭中，</li> <li><strong><code>3</code></strong> —— “CLOSED”：连接已关闭。</li></ul> <h2 id="server-sent-events"><a href="#server-sent-events" class="header-anchor">#</a> Server Sent Events</h2> <p>Server-Sent Event 规范描述了一个内建的类  <code>EventSource</code> 。能保持服务器的连接，并且允许从中接收事件。（与 WebSocket 连接类似，是持久的连接）</p> <blockquote><p>WebSocket 与 EventSource 的区别：</p> <table><thead><tr><th style="text-align:left;"><code>WebSocket</code></th> <th style="text-align:left;"><code>EventSource</code></th></tr></thead> <tbody><tr><td style="text-align:left;">双向：客户端和服务端都能交换消息</td> <td style="text-align:left;"><strong>单向</strong>：仅服务端能发送消息</td></tr> <tr><td style="text-align:left;">二进制和文本数据</td> <td style="text-align:left;"><strong>仅文本数据</strong></td></tr> <tr><td style="text-align:left;">WebSocket 协议</td> <td style="text-align:left;"><strong>常规 HTTP 协议</strong></td></tr></tbody></table> <p>相比 WebSocket， EventSource 更加简单。</p> <p>当需要从服务器接收一个数据流，可能是 聊天消息或者其他信息。 <code>EventSource</code>  支持自动重新连接，而在  <code>WebSocket</code>  需要手动实现。并且它支持常规的 HTTP 协议。</p></blockquote> <h3 id="获取消息"><a href="#获取消息" class="header-anchor">#</a> 获取消息</h3> <p>使用  <code>new EventSource(url)</code> 。浏览器将会连接到  <code>url</code>  并保持连接打开，等待事件。</p> <p>服务器响应的状态码应该为 200，header 为  <code>Content-Type: text/event-stream</code> ，然后保持此连接并以一种特殊的格式写入消息。例如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>data: Message 1

data: Message 2

data: Message 3
data: of two lines
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><code>data</code> ：消息文本， <code>:</code>  后的空格可选；</li> <li>消息以两个换行符  <code>\n\n</code>  分隔。</li> <li>要发送一个换行符  <code>\n</code>  的消息，在要换行的位置立即再发送一个  <code>data:</code> （上面的第三条消息）。</li></ul> <p>实际运用中，复杂的消息一般使用 JSON 编码后发送。换行符在其中编码为  <code>\n</code> ，因此不需要多行  <code>data:</code>  消息。</p> <p>🌰 例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">&quot;user&quot;</span><span class="token operator">:</span><span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;First line\n Second line&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对于这样类型的信息，都会生成一个  <code>message</code>  事件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> eventSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">&quot;/events/subsribe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

eventSource<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;new Message&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span> 
  <span class="token comment">// 对于上面的数据流将打印三次</span>
<span class="token punctuation">}</span>
<span class="token comment">// 或 eventSource.addEventListener('message', ...)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="跨源请求"><a href="#跨源请求" class="header-anchor">#</a> 跨源请求</h3> <p><code>EventSource</code>  支持跨源请求，就像  <code>fetch</code>  和任何其他网络方法。</p> <p>所以 EventSource 可以使用任何 URL：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">&quot;https://another-site.com/events&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>远程服务器将会获取到  <code>Origin</code>  header，并且必须以  <code>Access-Control-Allow-Origin</code>  响应来处理。要传递凭证（credentials），应该设置附加选项  <code>withCredentials</code> ，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">&quot;https://another-site.com/events&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">withCredentials</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="重新连接"><a href="#重新连接" class="header-anchor">#</a> 重新连接</h3> <p><code>new EventSource</code>  连接到服务器，如果连接断开，则重新连接。每次重新连接之间有一点小的延迟，默认为几秒钟。</p> <p>服务器可以使用  <code>retry:</code>  来 <strong>设置需要的延迟响应时间</strong>（以毫秒为单位）。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>retry: 15000
data: Hello, I set the reconnection delay to 15 seconds
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><code>retry:</code>  既可以与某些数据一起出现，也可以作为独立的消息出现。</li></ul> <p>在重新连接之前，浏览器需要等待设定的延迟响应时间。例如，如果浏览器知道（从操作系统）<strong>此时没有网络连接</strong>，它会等到连接出现，然后重试。</p> <ul><li><p>如果服务器想要浏览器 <strong>停止重新连接</strong>，那么应该使用 HTTP 状态码 204 进行响应；</p></li> <li><p>如果浏览器想要 <strong>关闭连接</strong>，则应该调用  <code>eventSource.close()</code> ；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> eventSource <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

eventSource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>如果响应具有不正确的  <code>Content-Type</code>  或者 HTTP 状态码不是 301，307，200 和 204，则不会进行重新连接。在这种情况下，将会发出  <code>error</code>  错误事件，并且浏览器不会重新连接。</p></li></ul> <blockquote><p>当连接被关闭时，则无法「重新打开」该连接。如果要重新连接，就要重新创建  <code>new EventSource()</code> 。</p></blockquote> <h3 id="连接-id"><a href="#连接-id" class="header-anchor">#</a> 连接 id</h3> <p>当一个连接由于网络问题而中断时，客户端和服务器都无法确定哪些消息已经收到哪些没有收到。为了正确地恢复连接，每条消息都应该有一个  <code>id</code>  字段，如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>data: Message 1
id: 1

data: Message 2
id: 2

data: Message 3
data: of two lines
id: 3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>当收到具有  <code>id</code>  的消息时，浏览器会：</p> <ul><li>将属性  <code>eventSource.lastEventId</code> <strong>设置为其值</strong>。</li> <li>重新连接后，发送带有  <code>id</code>  的 header  <code>Last-Event-ID</code> ，以便服务器可以重新发送后面的消息。</li></ul> <blockquote><p>注意： <code>id</code>  被服务器附加到  <code>data</code>  消息后，以确保在收到消息后  <code>lastEventId</code>  会被更新。</p></blockquote> <h3 id="连接状态-2"><a href="#连接状态-2" class="header-anchor">#</a> 连接状态</h3> <p><code>EventSource</code>  对象有  <code>readyState</code>  连接状态属性，该属性具有：</p> <ul><li><code>EventSource.CONNECTING = 0;</code>  ：连接中或者重新连接中；</li> <li><code>EventSource.OPEN = 1;</code> ：已连接；</li> <li><code>EventSource.CLOSED = 2;</code>  ：连接已关闭；</li></ul> <p>对象创建完成或者连接断开后，它始终是  <code>EventSource.CONNECTING</code> （等于  <code>0</code> ）。</p> <p>可以通过<strong>查询该属性</strong>获得  <code>EventSource</code>  的状态。</p> <h3 id="连接事件"><a href="#连接事件" class="header-anchor">#</a> 连接事件</h3> <p><code>EventSource</code>  的对象会默认生成三个事件：</p> <ul><li><code>message</code>  ：<strong>收到消息</strong>，可以用  <code>event.data</code>  访问。</li> <li><code>open</code>  ：<strong>连接已打开</strong>。</li> <li><code>error</code>  ：<strong>无法建立连接</strong>，例如，服务器返回 HTTP 500 状态码。</li></ul> <p>服务器可以在事件开始时使用  <code>event: ...</code>  指定另一种类型事件。</p> <p>🌰 例子：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>event: join
data: Bob

data: Hello

event: leave
data: Bob
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>处理自定义事件  <code>join</code> ，必须使用  <code>addEventListener</code> ：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>eventSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'join'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Joined </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

eventSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Said: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

eventSource<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'leave'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Left </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/simon1uo/notebook/edit/master/docs/101. 🚶🏻 前端巩固基础/37. 🍯 JavaScript AJAX 网络请求/05. 🥃 JavaScript 长轮询 WebSocket.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">📢 上次更新:</span> <span class="time">2022/09/02, 09:25:12</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/notebook/pages/644542/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">🍶 JavaScript XMLHttpRequest</div></a> <a href="/notebook/pages/1d9ea1/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">⛴  JavaScript 回调函数引入</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
                    ←
                    <a href="/notebook/pages/644542/" class="prev">🍶 JavaScript XMLHttpRequest</a></span> <span class="next"><a href="/notebook/pages/1d9ea1/">⛴  JavaScript 回调函数引入</a>→
                </span></p></div></div></div> <!----></main></div> <div class="footer"><!----> 
            Copyright © 2020-2022
            |
            <span>wrote with ❤️ by <a href="https://simon1uo.github.io">Simon</a></br></span>

        theme based on
        <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="theme">Vdoing</a> powered By Vuepress
    </div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
                        跟随系统
                    </li><li class="iconfont icon-rijianmoshi">
                        浅色模式
                    </li><li class="iconfont icon-yejianmoshi">
                        深色模式
                    </li><li class="iconfont icon-yuedu">
                        阅读模式
                    </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
        <script src="/notebook/assets/js/app.c1e92184.js" defer></script><script src="/notebook/assets/js/2.f4898154.js" defer></script><script src="/notebook/assets/js/3.c3838318.js" defer></script><script src="/notebook/assets/js/125.6a4cc473.js" defer></script>
    </body>
</html>
